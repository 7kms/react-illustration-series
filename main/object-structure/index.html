<!DOCTYPE html><html><head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<meta name="keywords" content="react, react原理, 图解react, react fiber原理, react hook原理, react 合成事件, react 基本包结构">
<meta name="description" content="图解React原理系列, 以react核心包结构和运行机制为主线索进行展开. 包括react 基本包结构, react 工作循环, react 启动模式, react fiber原理, react hook原理, react 合成事件等核心内容">
<link rel="shortcut icon" href="/km@2x.png">
<link rel="stylesheet" href="/umi.eb36fa83.css">
<title data-rh="true">高频对象</title>
<meta data-rh="true" property="og:title" content="高频对象"/><meta data-rh="true" name="description" content="在 React 应用中, 有很多特定的对象或数据结构. 了解这些内部的设计, 可以更容易理解 react 运行原理. 本章主要列举从 react 启动到渲染过程出现频率较高, 影响范围较大的对象, 它们贯穿整个 react 运行时."/><meta data-rh="true" property="og:description" content="在 React 应用中, 有很多特定的对象或数据结构. 了解这些内部的设计, 可以更容易理解 react 运行原理. 本章主要列举从 react 启动到渲染过程出现频率较高, 影响范围较大的对象, 它们贯穿整个 react 运行时."/>
</head>
<body>
<noscript><b>Enable JavaScript to run this app.</b></noscript><div id="root"><!--$?--><template id="B:0"></template><div></div><!--/$--></div><script>window.__UMI_LOADER_DATA__ = {}</script>
<script src="/umi.c14ba5aa.js"></script>

</body></html><div hidden id="S:0"><!--$?--><template id="B:1"></template><div></div><!--/$--></div><script>function $RC(a,b){a=document.getElementById(a);b=document.getElementById(b);b.parentNode.removeChild(b);if(a){a=a.previousSibling;var f=a.parentNode,c=a.nextSibling,e=0;do{if(c&&8===c.nodeType){var d=c.data;if("/$"===d)if(0===e)break;else e--;else"$"!==d&&"$?"!==d&&"$!"!==d||e++}d=c.nextSibling;f.removeChild(c);c=d}while(c);for(;b.firstChild;)f.insertBefore(b.firstChild,c);a.data="$";a._reactRetry&&a._reactRetry()}};$RC("B:0","S:0")</script><div hidden id="S:1"><div class="dumi-default-doc-layout"><div class="dumi-default-header"><div class="dumi-default-header-content"><section class="dumi-default-header-left"><a class="dumi-default-logo" href="/"><img src="/logo.png" alt="图解React"/>图解React<!-- --></a></section><section class="dumi-default-header-right"><ul class="dumi-default-navbar"><li><a class="active" href="/main/macro-structure">原理解析</a></li><li><a href="/algorithm/diff">高频算法</a></li><li><a href="/interview/01-setstate">面试题</a></li></ul><div class="dumi-default-header-right-aside"><div class="dumi-default-search-bar"><svg viewBox="64 64 896 896" class="dumi-default-search-bar-svg"><path d="M909.6 854.5 649.9 594.8C690.2 542.7 712 479 712 412c0-80.2-31.3-155.4-87.9-212.1-56.6-56.7-132-87.9-212.1-87.9s-155.5 31.3-212.1 87.9C143.2 256.5 112 331.8 112 412c0 80.1 31.3 155.5 87.9 212.1C256.5 680.8 331.8 712 412 712c67 0 130.6-21.8 182.7-62l259.7 259.6a8.2 8.2 0 0 0 11.6 0l43.6-43.5a8.2 8.2 0 0 0 0-11.6zM570.4 570.4C528 612.7 471.8 636 412 636s-116-23.3-158.4-65.6C211.3 528 188 471.8 188 412s23.3-116.1 65.6-158.4C296 211.3 352.2 188 412 188s116.1 23.2 158.4 65.6S636 352.2 636 412s-23.3 116.1-65.6 158.4z"></path></svg><input class="dumi-default-search-bar-input" placeholder="输入关键字搜索..."/><span class="dumi-default-search-shortcut">⌘<!-- --> K<!-- --></span></div><span class="dumi-default-color-switch" data-dumi-tooltip="亮色模式" data-dumi-tooltip-bottom="true"><svg viewBox="0 0 16 16"><path d="M8 13a1 1 0 0 1 1 1v1a1 1 0 1 1-2 0v-1a1 1 0 0 1 1-1ZM8 3a1 1 0 0 1-1-1V1a1 1 0 1 1 2 0v1a1 1 0 0 1-1 1Zm7 4a1 1 0 1 1 0 2h-1a1 1 0 1 1 0-2h1ZM3 8a1 1 0 0 1-1 1H1a1 1 0 1 1 0-2h1a1 1 0 0 1 1 1Zm9.95 3.536.707.707a1 1 0 0 1-1.414 1.414l-.707-.707a1 1 0 0 1 1.414-1.414Zm-9.9-7.072-.707-.707a1 1 0 0 1 1.414-1.414l.707.707A1 1 0 0 1 3.05 4.464Zm9.9 0a1 1 0 0 1-1.414-1.414l.707-.707a1 1 0 0 1 1.414 1.414l-.707.707Zm-9.9 7.072a1 1 0 0 1 1.414 1.414l-.707.707a1 1 0 0 1-1.414-1.414l.707-.707ZM8 4a4 4 0 1 0 0 8 4 4 0 0 0 0-8Zm0 6.5a2.5 2.5 0 1 1 0-5 2.5 2.5 0 0 1 0 5Z"></path></svg><select><option value="light" selected="">亮色模式<!-- --></option><option value="dark">暗色模式<!-- --></option><option value="auto">跟随系统<!-- --></option></select></span><a class="dumi-default-icon" data-dumi-tooltip="GitHub" data-dumi-tooltip-bottom="true" target="_blank" href="https://github.com/7kms/react-illustration-series" rel="noreferrer"><svg viewBox="64 64 896 896"><path d="M511.6 76.3C264.3 76.2 64 276.4 64 523.5 64 718.9 189.3 885 363.8 946c23.5 5.9 19.9-10.8 19.9-22.2v-77.5c-135.7 15.9-141.2-73.9-150.3-88.9C215 726 171.5 718 184.5 703c30.9-15.9 62.4 4 98.9 57.9 26.4 39.1 77.9 32.5 104 26 5.7-23.5 17.9-44.5 34.7-60.8-140.6-25.2-199.2-111-199.2-213 0-49.5 16.3-95 48.3-131.7-20.4-60.5 1.9-112.3 4.9-120 58.1-5.2 118.5 41.6 123.2 45.3 33-8.9 70.7-13.6 112.9-13.6 42.4 0 80.2 4.9 113.5 13.9 11.3-8.6 67.3-48.8 121.3-43.9 2.9 7.7 24.7 58.3 5.5 118 32.4 36.8 48.9 82.7 48.9 132.3 0 102.2-59 188.1-200 212.9a127.5 127.5 0 0 1 38.1 91v112.5c.8 9 0 17.9 15 17.9 177.1-59.7 304.6-227 304.6-424.1 0-247.2-200.4-447.3-447.5-447.3z"></path></svg></a></div></section><button type="button" class="dumi-default-header-menu-btn"><svg viewBox="64 64 896 896"><path d="M904 160H120c-4.4 0-8 3.6-8 8v64c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-64c0-4.4-3.6-8-8-8zm0 624H120c-4.4 0-8 3.6-8 8v64c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-64c0-4.4-3.6-8-8-8zm0-312H120c-4.4 0-8 3.6-8 8v64c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-64c0-4.4-3.6-8-8-8z"></path></svg></button></div></div><div class="dumi-default-doc-layout-mobile-bar"><button type="button" class="dumi-default-sidebar-btn"><svg viewBox="64 64 896 896"><path d="M120 230h496c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm0 424h496c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm784 140H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0-424H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8z"></path></svg>侧边菜单<!-- --></button></div><main><div class="dumi-default-sidebar"><dl class="dumi-default-sidebar-group"><dt>基本概念</dt><dd><a title="宏观包结构" class="" href="/main/macro-structure">宏观包结构</a></dd><dd><a title="两大工作循环" class="" href="/main/workloop">两大工作循环</a></dd><dd><a title="高频对象" aria-current="page" class="active" href="/main/object-structure">高频对象</a></dd></dl><dl class="dumi-default-sidebar-group"><dt>运行核心</dt><dd><a title="启动过程" class="" href="/main/bootstrap">启动过程</a></dd><dd><a title="reconciler 运作流程" class="" href="/main/reconciler-workflow">reconciler 运作流程</a></dd><dd><a title="优先级管理" class="" href="/main/priority">优先级管理</a></dd><dd><a title="调度原理" class="" href="/main/scheduler">调度原理</a></dd><dd><a title="fiber 树构造(基础准备)" class="" href="/main/fibertree-prepare">fiber 树构造(基础准备)</a></dd><dd><a title="fiber 树构造(初次创建)" class="" href="/main/fibertree-create">fiber 树构造(初次创建)</a></dd><dd><a title="fiber 树构造(对比更新)" class="" href="/main/fibertree-update">fiber 树构造(对比更新)</a></dd><dd><a title="fiber 树渲染" class="" href="/main/fibertree-commit">fiber 树渲染</a></dd></dl><dl class="dumi-default-sidebar-group"><dt>状态管理</dt><dd><a title="状态与副作用" class="" href="/main/state-effects">状态与副作用</a></dd><dd><a title="Hook 原理(概览)" class="" href="/main/hook-summary">Hook 原理(概览)</a></dd><dd><a title="Hook 原理(状态Hook)" class="" href="/main/hook-state">Hook 原理(状态Hook)</a></dd><dd><a title="Hook 原理(副作用Hook)" class="" href="/main/hook-effect">Hook 原理(副作用Hook)</a></dd><dd><a title="context 原理" class="" href="/main/context">context 原理</a></dd></dl><dl class="dumi-default-sidebar-group"><dt>交互</dt><dd><a title="合成事件" class="" href="/main/synthetic-event">合成事件</a></dd></dl></div><div class="dumi-default-content"><!--$?--><template id="B:2"></template><div></div><!--/$--><div class="dumi-default-footer">Copyright © 2023 | Powered by <a href="https://d.umijs.org" target="_blank" rel="noreferrer">dumi</a></div></div></main></div></div><script>$RC("B:1","S:1")</script><div hidden id="S:2"><div class="markdown"><h1 id="react-应用中的高频对象"><a aria-hidden="true" tabindex="-1" href="#react-应用中的高频对象"><span class="icon icon-link"></span></a>React 应用中的高频对象<!-- --></h1><p>在 React 应用中, 有很多特定的对象或数据结构. 了解这些内部的设计, 可以更容易理解 react 运行原理. 本章主要列举从 react 启动到渲染过程出现频率较高, 影响范围较大的对象, 它们贯穿整个 react 运行时.</p><p>其他过程的重要对象:</p><ul><li>如<!-- --><code>事件对象</code>(位于<!-- --><code>react-dom/events</code>保障 react 应用能够响应 ui 交互), 在事件机制章节中详细解读.<!-- --></li><li>如<!-- --><code>ReactContext, ReactProvider, ReactConsumer</code>对象, 在 context 机制章节中详细解读.<!-- --></li></ul><h2 id="react-包"><a aria-hidden="true" tabindex="-1" href="#react-包"><span class="icon icon-link"></span></a>react 包<!-- --></h2><p>在<!-- --><a href="/main/macro-structure">React 应用的宏观包结构</a>中介绍过, 此包定义 react 组件(<!-- --><code>ReactElement</code>)的必要函数, 提供一些操作<!-- --><code>ReactElement</code>对象的 api.<!-- --></p><p>所以这个包的核心需要理解<!-- --><code>ReactElement</code>对象, 假设有如下入口函数:<!-- --></p><div class="dumi-default-source-code"><button type="button" class="dumi-default-source-code-copy"><svg viewBox="64 64 896 896"><path d="M832 64H296c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h496v688c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8V96c0-17.7-14.3-32-32-32zM704 192H192c-17.7 0-32 14.3-32 32v530.7c0 8.5 3.4 16.6 9.4 22.6l173.3 173.3c2.2 2.2 4.7 4 7.4 5.5v1.9h4.2c3.5 1.3 7.2 2 11 2H704c17.7 0 32-14.3 32-32V224c0-17.7-14.3-32-32-32zM350 856.2 263.9 770H350v86.2zM664 888H414V746c0-22.1-17.9-40-40-40H232V264h432v624z"></path></svg></button><pre class="prism-code language-js"><div class=""><div class=""><span class="token comment">// 入口函数</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token maybe-class-name">ReactDOM</span><span class="token punctuation">.</span><span class="token method function property-access">render</span><span class="token punctuation">(</span><span class="token operator">&lt;</span><span class="token maybe-class-name">App</span><span class="token plain"> </span><span class="token operator">/</span><span class="token operator">&gt;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token dom variable">document</span><span class="token punctuation">.</span><span class="token method function property-access">getElementById</span><span class="token punctuation">(</span><span class="token string">&#x27;root&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div></div></pre></div><p>可以简单的认为, 包括<!-- --><code>&lt;App/&gt;</code>及其所有子节点都是<!-- --><code>ReactElement</code>对象(在 render 之后才会生成子节点, 后文详细解读), 每个<!-- --><code>ReactElement</code>对象的区别在于 type 不同.<!-- --></p><h3 id="reactelement-对象"><a aria-hidden="true" tabindex="-1" href="#reactelement-对象"><span class="icon icon-link"></span></a><a href="https://github.com/facebook/react/blob/v17.0.2/packages/react/src/ReactElement.js#L126-L146">ReactElement 对象</a></h3><blockquote><p>其 type 定义在<!-- --><a href="https://github.com/facebook/react/blob/v17.0.2/packages/shared/ReactElementType.js#L15"><code>shared</code>包中<!-- --></a>.<!-- --></p></blockquote><p>所有采用<!-- --><code>jsx</code>语法书写的节点, 都会被编译器转换, 最终会以<!-- --><code>React.createElement(...)</code>的方式, 创建出来一个与之对应的<!-- --><code>ReactElement</code>对象.<!-- --></p><p><code>ReactElement</code>对象的数据结构如下:<!-- --></p><div class="dumi-default-source-code"><button type="button" class="dumi-default-source-code-copy"><svg viewBox="64 64 896 896"><path d="M832 64H296c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h496v688c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8V96c0-17.7-14.3-32-32-32zM704 192H192c-17.7 0-32 14.3-32 32v530.7c0 8.5 3.4 16.6 9.4 22.6l173.3 173.3c2.2 2.2 4.7 4 7.4 5.5v1.9h4.2c3.5 1.3 7.2 2 11 2H704c17.7 0 32-14.3 32-32V224c0-17.7-14.3-32-32-32zM350 856.2 263.9 770H350v86.2zM664 888H414V746c0-22.1-17.9-40-40-40H232V264h432v624z"></path></svg></button><pre class="prism-code language-ts"><div class=""><div class=""><span class="token keyword">export</span><span class="token plain"> </span><span class="token keyword">type</span><span class="token plain"> </span><span class="token class-name">ReactElement</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token operator">|</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token comment">// 用于辨别ReactElement对象</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  $</span><span class="token keyword">typeof</span><span class="token operator">:</span><span class="token plain"> </span><span class="token builtin">any</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">
</span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token comment">// 内部属性</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  type</span><span class="token operator">:</span><span class="token plain"> </span><span class="token builtin">any</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token comment">// 表明其种类</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  key</span><span class="token operator">:</span><span class="token plain"> </span><span class="token builtin">any</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  ref</span><span class="token operator">:</span><span class="token plain"> </span><span class="token builtin">any</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  props</span><span class="token operator">:</span><span class="token plain"> </span><span class="token builtin">any</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">
</span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token comment">// ReactFiber 记录创建本对象的Fiber节点, 还未与Fiber树关联之前, 该属性为null</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  _owner</span><span class="token operator">:</span><span class="token plain"> </span><span class="token builtin">any</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">
</span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token comment">// __DEV__ dev环境下的一些额外信息, 如文件路径, 文件名, 行列信息等</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  _store</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain">validated</span><span class="token operator">:</span><span class="token plain"> </span><span class="token builtin">boolean</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token operator">...</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  _self</span><span class="token operator">:</span><span class="token plain"> React$Element</span><span class="token operator">&lt;</span><span class="token builtin">any</span><span class="token operator">&gt;</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  _shadowChildren</span><span class="token operator">:</span><span class="token plain"> </span><span class="token builtin">any</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  _source</span><span class="token operator">:</span><span class="token plain"> Source</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token operator">|</span><span class="token punctuation">}</span><span class="token punctuation">;</span></div></div></pre></div><p>需要特别注意 2 个属性:</p><ol><li><p><code>key</code>属性在<!-- --><code>reconciler</code>阶段会用到, 目前只需要知道所有的<!-- --><code>ReactElement</code>对象都有 key 属性(且<!-- --><a href="https://github.com/facebook/react/blob/v17.0.2/packages/react/src/ReactElement.js#L348-L357">其默认值是 null</a>, 这点十分重要, 在 diff 算法中会使用到).<!-- --></p></li><li><p><code>type</code>属性决定了节点的种类:<!-- --></p></li></ol><ul><li>它的值可以是字符串(代表<!-- --><code>div,span</code>等 dom 节点), 函数(代表<!-- --><code>function, class</code>等节点), 或者 react 内部定义的节点类型(<!-- --><code>portal,context,fragment</code>等)<!-- --></li><li>在<!-- --><code>reconciler</code>阶段, 会根据 type 执行不同  的逻辑(在 fiber 构建阶段详细解读).
<!-- --><ul><li>如 type 是一个字符串类型, 则直接使用.</li><li>如 type 是一个<!-- --><code>ReactComponent</code>类型, 则会调用其 render 方法获取子节点.<!-- --></li><li>如 type 是一个<!-- --><code>function</code>类型,则会调用该方法获取子节点<!-- --></li><li>...</li></ul></li></ul><p>在<!-- --><code>v17.0.2</code>中, <!-- --><a href="https://github.com/facebook/react/blob/v17.0.2/packages/shared/ReactSymbols.js#L16-L37">定义了 20 种</a>内部节点类型. 根据运行时环境不同, 分别采用 16 进制的字面量和<!-- --><code>Symbol</code>进行表示.<!-- --></p><h3 id="reactcomponent对象"><a aria-hidden="true" tabindex="-1" href="#reactcomponent对象"><span class="icon icon-link"></span></a><a href="https://github.com/facebook/react/blob/v17.0.2/packages/react/src/ReactBaseClasses.js#L20-L30">ReactComponent</a>对象<!-- --></h3><p>对于<!-- --><code>ReactElement</code>来讲, <!-- --><code>ReactComponent</code>仅仅是诸多<!-- --><code>type</code>类型中的一种.<!-- --></p><p>对于开发者来讲, <!-- --><code>ReactComponent</code>使用非常高频(在状态组件章节中详细解读), 在本节只是先证明它只是一种特殊的<!-- --><code>ReactElement</code>.<!-- --></p><p>这里用一个简单的示例, 通过查看编译后的代码来说明</p><div class="dumi-default-source-code"><button type="button" class="dumi-default-source-code-copy"><svg viewBox="64 64 896 896"><path d="M832 64H296c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h496v688c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8V96c0-17.7-14.3-32-32-32zM704 192H192c-17.7 0-32 14.3-32 32v530.7c0 8.5 3.4 16.6 9.4 22.6l173.3 173.3c2.2 2.2 4.7 4 7.4 5.5v1.9h4.2c3.5 1.3 7.2 2 11 2H704c17.7 0 32-14.3 32-32V224c0-17.7-14.3-32-32-32zM350 856.2 263.9 770H350v86.2zM664 888H414V746c0-22.1-17.9-40-40-40H232V264h432v624z"></path></svg></button><pre class="prism-code language-js"><div class=""><div class=""><span class="token keyword">class</span><span class="token plain"> </span><span class="token class-name">App</span><span class="token plain"> </span><span class="token keyword">extends</span><span class="token plain"> </span><span class="token class-name">React</span><span class="token class-name punctuation">.</span><span class="token class-name">Component</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token keyword control-flow">return</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token operator">&lt;</span><span class="token plain">div className</span><span class="token operator">=</span><span class="token string">&quot;app&quot;</span><span class="token operator">&gt;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">        </span><span class="token operator">&lt;</span><span class="token plain">header</span><span class="token operator">&gt;</span><span class="token plain">header</span><span class="token operator">&lt;</span><span class="token operator">/</span><span class="token plain">header</span><span class="token operator">&gt;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">        </span><span class="token operator">&lt;</span><span class="token maybe-class-name">Content</span><span class="token plain"> </span><span class="token operator">/</span><span class="token operator">&gt;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">        </span><span class="token operator">&lt;</span><span class="token plain">footer</span><span class="token operator">&gt;</span><span class="token plain">footer</span><span class="token operator">&lt;</span><span class="token operator">/</span><span class="token plain">footer</span><span class="token operator">&gt;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token operator">&lt;</span><span class="token operator">/</span><span class="token plain">div</span><span class="token operator">&gt;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">
</span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token keyword">class</span><span class="token plain"> </span><span class="token class-name">Content</span><span class="token plain"> </span><span class="token keyword">extends</span><span class="token plain"> </span><span class="token class-name">React</span><span class="token class-name punctuation">.</span><span class="token class-name">Component</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token keyword control-flow">return</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token operator">&lt;</span><span class="token maybe-class-name">React</span><span class="token punctuation">.</span><span class="token property-access maybe-class-name">Fragment</span><span class="token operator">&gt;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">        </span><span class="token operator">&lt;</span><span class="token plain">p</span><span class="token operator">&gt;</span><span class="token number">1</span><span class="token operator">&lt;</span><span class="token operator">/</span><span class="token plain">p</span><span class="token operator">&gt;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">        </span><span class="token operator">&lt;</span><span class="token plain">p</span><span class="token operator">&gt;</span><span class="token number">2</span><span class="token operator">&lt;</span><span class="token operator">/</span><span class="token plain">p</span><span class="token operator">&gt;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">        </span><span class="token operator">&lt;</span><span class="token plain">p</span><span class="token operator">&gt;</span><span class="token number">3</span><span class="token operator">&lt;</span><span class="token operator">/</span><span class="token plain">p</span><span class="token operator">&gt;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token operator">&lt;</span><span class="token operator">/</span><span class="token maybe-class-name">React</span><span class="token punctuation">.</span><span class="token property-access maybe-class-name">Fragment</span><span class="token operator">&gt;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">
</span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token keyword module">export</span><span class="token plain"> </span><span class="token keyword module">default</span><span class="token plain"> </span><span class="token maybe-class-name">App</span><span class="token punctuation">;</span></div></div></pre></div><p>编译之后的代码(此处只编译了 jsx 语法, 并没有将 class 语法编译成 es5 中的 function), 可以更直观的看出调用逻辑.</p><p><code>createElement</code>函数的第一个参数将作为创建<!-- --><code>ReactElement</code>的<!-- --><code>type</code>. 可以看到<!-- --><code>Content</code>这个变量被编译器命名为<!-- --><code>App_Content</code>, 并作为第一个参数(引用传递), 传入了<!-- --><code>createElement</code>.<!-- --></p><div class="dumi-default-source-code"><button type="button" class="dumi-default-source-code-copy"><svg viewBox="64 64 896 896"><path d="M832 64H296c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h496v688c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8V96c0-17.7-14.3-32-32-32zM704 192H192c-17.7 0-32 14.3-32 32v530.7c0 8.5 3.4 16.6 9.4 22.6l173.3 173.3c2.2 2.2 4.7 4 7.4 5.5v1.9h4.2c3.5 1.3 7.2 2 11 2H704c17.7 0 32-14.3 32-32V224c0-17.7-14.3-32-32-32zM350 856.2 263.9 770H350v86.2zM664 888H414V746c0-22.1-17.9-40-40-40H232V264h432v624z"></path></svg></button><pre class="prism-code language-js"><div class=""><div class=""><span class="token keyword">class</span><span class="token plain"> </span><span class="token class-name">App_App</span><span class="token plain"> </span><span class="token keyword">extends</span><span class="token plain"> </span><span class="token class-name">react_default</span><span class="token class-name punctuation">.</span><span class="token class-name">a</span><span class="token class-name punctuation">.</span><span class="token class-name">Component</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token keyword control-flow">return</span><span class="token plain"> </span><span class="token comment">/*#__PURE__*/</span><span class="token plain"> react_default</span><span class="token punctuation">.</span><span class="token property-access">a</span><span class="token punctuation">.</span><span class="token method function property-access">createElement</span><span class="token punctuation">(</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token string">&#x27;div&#x27;</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">        </span><span class="token literal-property property">className</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string">&#x27;app&#x27;</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token comment">/*#__PURE__*/</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      react_default</span><span class="token punctuation">.</span><span class="token property-access">a</span><span class="token punctuation">.</span><span class="token method function property-access">createElement</span><span class="token punctuation">(</span><span class="token string">&#x27;header&#x27;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token string">&#x27;header&#x27;</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token comment">/*#__PURE__*/</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">
</span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token comment">// 此处直接将Content传入, 是一个指针传递</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      react_default</span><span class="token punctuation">.</span><span class="token property-access">a</span><span class="token punctuation">.</span><span class="token method function property-access">createElement</span><span class="token punctuation">(</span><span class="token maybe-class-name">App_Content</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token comment">/*#__PURE__*/</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      react_default</span><span class="token punctuation">.</span><span class="token property-access">a</span><span class="token punctuation">.</span><span class="token method function property-access">createElement</span><span class="token punctuation">(</span><span class="token string">&#x27;footer&#x27;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token string">&#x27;footer&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token keyword">class</span><span class="token plain"> </span><span class="token class-name">App_Content</span><span class="token plain"> </span><span class="token keyword">extends</span><span class="token plain"> </span><span class="token class-name">react_default</span><span class="token class-name punctuation">.</span><span class="token class-name">a</span><span class="token class-name punctuation">.</span><span class="token class-name">Component</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token keyword control-flow">return</span><span class="token plain"> </span><span class="token comment">/*#__PURE__*/</span><span class="token plain"> react_default</span><span class="token punctuation">.</span><span class="token property-access">a</span><span class="token punctuation">.</span><span class="token method function property-access">createElement</span><span class="token punctuation">(</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      react_default</span><span class="token punctuation">.</span><span class="token property-access">a</span><span class="token punctuation">.</span><span class="token property-access maybe-class-name">Fragment</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token keyword null nil">null</span><span class="token plain"> </span><span class="token comment">/*#__PURE__*/</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      react_default</span><span class="token punctuation">.</span><span class="token property-access">a</span><span class="token punctuation">.</span><span class="token method function property-access">createElement</span><span class="token punctuation">(</span><span class="token string">&#x27;p&#x27;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token string">&#x27;1&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token comment">/*#__PURE__*/</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">
</span></div></div><div class=""><div class=""><span class="token plain">      react_default</span><span class="token punctuation">.</span><span class="token property-access">a</span><span class="token punctuation">.</span><span class="token method function property-access">createElement</span><span class="token punctuation">(</span><span class="token string">&#x27;p&#x27;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token string">&#x27;2&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token comment">/*#__PURE__*/</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">
</span></div></div><div class=""><div class=""><span class="token plain">      react_default</span><span class="token punctuation">.</span><span class="token property-access">a</span><span class="token punctuation">.</span><span class="token method function property-access">createElement</span><span class="token punctuation">(</span><span class="token string">&#x27;p&#x27;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token string">&#x27;3&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token punctuation">}</span></div></div></pre></div><p>上述示例演示了<!-- --><code>ReactComponent</code>是诸多<!-- --><code>ReactElement</code>种类中的一种情况, 但是由于<!-- --><code>ReactComponent</code>是 class 类型, 自有它的特殊性(可<!-- --><a href="https://github.com/facebook/react/blob/v17.0.2/packages/react/src/ReactBaseClasses.js">对照源码</a>, 更容易理解).<!-- --></p><ol><li><code>ReactComponent</code>是 class 类型, 继承父类<!-- --><code>Component</code>, 拥有特殊的方法(<!-- --><code>setState</code>,<!-- --><code>forceUpdate</code>)和特殊的属性(<!-- --><code>context</code>,<!-- --><code>updater</code>等).<!-- --></li><li>在<!-- --><code>reconciler</code>阶段, 会依据<!-- --><code>ReactElement</code>对象的特征, 生成对应的 fiber 节点. 当识别到<!-- --><code>ReactElement</code>对象是 class 类型的时候, 会触发<!-- --><code>ReactComponent</code>对象的生命周期, 并调用其 <!-- --><code>render</code>方法, 生成<!-- --><code>ReactElement</code>子节点.<!-- --></li></ol><h3 id="其他reactelement"><a aria-hidden="true" tabindex="-1" href="#其他reactelement"><span class="icon icon-link"></span></a>其他<!-- --><code>ReactElement</code></h3><p>上文介绍了第一种特殊的<!-- --><code>ReactElement</code>(<!-- --><code>class</code>类型的组件), 除此之外<!-- --><code>function</code>类型的组件也需要深入了解, 因为<!-- --><code>Hook</code>只能在<!-- --><code>function</code> 类型的组件中使用.<!-- --></p><p>如果在<!-- --><code>function</code>类型的组件中没有使用<!-- --><code>Hook</code>(如: <!-- --><code>useState</code>, <!-- --><code>useEffect</code>等), 在<!-- --><code>reconciler</code>阶段所有有关<!-- --><code>Hook</code>的处理都会略过, 最后调用该<!-- --><code>function</code>拿到子节点<!-- --><code>ReactElement</code>.<!-- --></p><p>如果使用了<!-- --><code>Hook</code>, 逻辑就相对复杂, 涉及到<!-- --><code>Hook</code>创建和状态保存(有关 Hook 的原理部分, 在 Hook 原理章节中详细解读). 此处只需要了解<!-- --><code>function</code>类型的组件和<!-- --><code>class</code>类型的组件一样, 是诸多<!-- --><code>ReactElement</code>形式中的一种.<!-- --></p><h3 id="reactelement内存结构"><a aria-hidden="true" tabindex="-1" href="#reactelement内存结构"><span class="icon icon-link"></span></a><code>ReactElement</code>内存结构<!-- --></h3><p>通过前文对<!-- --><code>ReactElement</code>的介绍, 可以比较容易的画出<!-- --><code>&lt;App/&gt;</code>这个<!-- --><code>ReactElement</code>对象在内存中的结构(<!-- --><code>reconciler</code>阶段完成之后才会形成完整的结构).<!-- --></p><img width="600" src="/static/reactelement-tree.55d183ba.png"/><p>注意:</p><ul><li><code>class</code>和<!-- --><code>function</code>类型的组件,其子节点是在 render 之后(<!-- --><code>reconciler</code>阶段)才生成的. 此处只是单独表示<!-- --><code>ReactElement</code>的数据结构.<!-- --></li><li>父级对象和子级对象之间是通过<!-- --><code>props.children</code>属性进行关联的(与 fiber 树不同).<!-- --></li><li><code>ReactElement</code>虽然不能算是一个严格的树, 也不能算是一个严格的链表. 它的生成过程是自顶向下的, 是所有组件节点的总和.<!-- --></li><li><code>ReactElement</code>树(暂且用树来表述)和<!-- --><code>fiber</code>树是以<!-- --><code>props.children</code>为单位<!-- --><code>先后交替</code>生成的(在 fiber 树构建章节详细解读), 当<!-- --><code>ReactElement</code>树构造完毕, fiber 树也随后构造完毕.<!-- --></li><li><code>reconciler</code>阶段会根据<!-- --><code>ReactElement</code>的类型生成对应的<!-- --><code>fiber</code>节点(不是一一对应, 比如<!-- --><code>Fragment</code>类型的组件在生成<!-- --><code>fiber</code>节点的时候会略过).<!-- --></li></ul><h2 id="react-reconciler-包"><a aria-hidden="true" tabindex="-1" href="#react-reconciler-包"><span class="icon icon-link"></span></a><code>react-reconciler</code> 包<!-- --></h2><p>在<!-- --><a href="/main/macro-structure">宏观结构</a>中介绍过, <!-- --><code>react-reconciler</code>包是<!-- --><code>react</code>应用的中枢, 连接渲染器(<!-- --><code>react-dom</code>)和调度中心(<!-- --><code>scheduler</code>), 同时自身也负责 fiber 树的构造.<!-- --></p><p>对于此包的深入分析, 放在<!-- --><code>fiber 树构建</code>, <!-- --><code>reconciler 工作空间</code>等章节中.<!-- --></p><p>此处先要知道<!-- --><code>fiber</code>是核心, react 体系的渲染和更新都要以 fiber 作为数据模型, 如果不能理解 fiber, 也无法深入理解 react.<!-- --></p><p>本章先预览一下此包中与<!-- --><code>fiber</code>对象关联度较高的对象.<!-- --></p><h3 id="fiber-对象"><a aria-hidden="true" tabindex="-1" href="#fiber-对象"><span class="icon icon-link"></span></a>Fiber 对象<!-- --></h3><p>先看数据结构, 其 type 类型的定义在<!-- --><a href="https://github.com/facebook/react/blob/v17.0.2/packages/react-reconciler/src/ReactInternalTypes.js#L47-L174"><code>ReactInternalTypes.js</code></a>中:<!-- --></p><div class="dumi-default-source-code"><button type="button" class="dumi-default-source-code-copy"><svg viewBox="64 64 896 896"><path d="M832 64H296c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h496v688c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8V96c0-17.7-14.3-32-32-32zM704 192H192c-17.7 0-32 14.3-32 32v530.7c0 8.5 3.4 16.6 9.4 22.6l173.3 173.3c2.2 2.2 4.7 4 7.4 5.5v1.9h4.2c3.5 1.3 7.2 2 11 2H704c17.7 0 32-14.3 32-32V224c0-17.7-14.3-32-32-32zM350 856.2 263.9 770H350v86.2zM664 888H414V746c0-22.1-17.9-40-40-40H232V264h432v624z"></path></svg></button><pre class="prism-code language-js"><div class=""><div class=""><span class="token comment">// 一个Fiber对象代表一个即将渲染或者已经渲染的组件(ReactElement), 一个组件可能对应两个fiber(current和WorkInProgress)</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token comment">// 单个属性的解释在后文(在注释中无法添加超链接)</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token keyword module">export</span><span class="token plain"> type </span><span class="token maybe-class-name">Fiber</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token operator">|</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token literal-property property">tag</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">WorkTag</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token literal-property property">key</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> string</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token literal-property property">elementType</span><span class="token operator">:</span><span class="token plain"> any</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token literal-property property">type</span><span class="token operator">:</span><span class="token plain"> any</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token literal-property property">stateNode</span><span class="token operator">:</span><span class="token plain"> any</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword control-flow">return</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">Fiber</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token literal-property property">child</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">Fiber</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token literal-property property">sibling</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">Fiber</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token literal-property property">index</span><span class="token operator">:</span><span class="token plain"> number</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token literal-property property">ref</span><span class="token operator">:</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token operator">|</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token operator">|</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter literal-property property">handle</span><span class="token parameter operator">:</span><span class="token parameter"> mixed</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token operator">&amp;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"> </span><span class="token literal-property property">_stringRef</span><span class="token operator">:</span><span class="token plain"> </span><span class="token operator">?</span><span class="token plain">string</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token spread operator">...</span><span class="token plain"> </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token operator">|</span><span class="token plain"> </span><span class="token maybe-class-name">RefObject</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token literal-property property">pendingProps</span><span class="token operator">:</span><span class="token plain"> any</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token comment">// 从`ReactElement`对象传入的 props. 用于和`fiber.memoizedProps`比较可以得出属性是否变动</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token literal-property property">memoizedProps</span><span class="token operator">:</span><span class="token plain"> any</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token comment">// 上一次生成子节点时用到的属性, 生成子节点之后保持在内存中</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token literal-property property">updateQueue</span><span class="token operator">:</span><span class="token plain"> mixed</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token comment">// 存储state更新的队列, 当前节点的state改动之后, 都会创建一个update对象添加到这个队列中.</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token literal-property property">memoizedState</span><span class="token operator">:</span><span class="token plain"> any</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token comment">// 用于输出的state, 最终渲染所使用的state</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token literal-property property">dependencies</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">Dependencies</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token comment">// 该fiber节点所依赖的(contexts, events)等</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token literal-property property">mode</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">TypeOfMode</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token comment">// 二进制位Bitfield,继承至父节点,影响本fiber节点及其子树中所有节点. 与react应用的运行模式有关(有ConcurrentMode, BlockingMode, NoMode等选项).</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">
</span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token comment">// Effect 副作用相关</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token literal-property property">flags</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">Flags</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token comment">// 标志位</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token literal-property property">subtreeFlags</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">Flags</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token comment">//替代16.x版本中的 firstEffect, nextEffect. 当设置了 enableNewReconciler=true才会启用</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token literal-property property">deletions</span><span class="token operator">:</span><span class="token plain"> </span><span class="token known-class-name class-name">Array</span><span class="token operator">&lt;</span><span class="token maybe-class-name">Fiber</span><span class="token operator">&gt;</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token comment">// 存储将要被删除的子节点. 当设置了 enableNewReconciler=true才会启用</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">
</span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token literal-property property">nextEffect</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">Fiber</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token comment">// 单向链表, 指向下一个有副作用的fiber节点</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token literal-property property">firstEffect</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">Fiber</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token comment">// 指向副作用链表中的第一个fiber节点</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token literal-property property">lastEffect</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">Fiber</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token comment">// 指向副作用链表中的最后一个fiber节点</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">
</span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token comment">// 优先级相关</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token literal-property property">lanes</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">Lanes</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token comment">// 本fiber节点的优先级</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token literal-property property">childLanes</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">Lanes</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token comment">// 子节点的优先级</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token literal-property property">alternate</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">Fiber</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token comment">// 指向内存中的另一个fiber, 每个被更新过fiber节点在内存中都是成对出现(current和workInProgress)</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">
</span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token comment">// 性能统计相关(开启enableProfilerTimer后才会统计)</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token comment">// react-dev-tool会根据这些时间统计来评估性能</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  actualDuration</span><span class="token operator">?</span><span class="token operator">:</span><span class="token plain"> number</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token comment">// 本次更新过程, 本节点以及子树所消耗的总时间</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  actualStartTime</span><span class="token operator">?</span><span class="token operator">:</span><span class="token plain"> number</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token comment">// 标记本fiber节点开始构建的时间</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  selfBaseDuration</span><span class="token operator">?</span><span class="token operator">:</span><span class="token plain"> number</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token comment">// 用于最近一次生成本fiber节点所消耗的时间</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  treeBaseDuration</span><span class="token operator">?</span><span class="token operator">:</span><span class="token plain"> number</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token comment">// 生成子树所消耗的时间的总和</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token operator">|</span><span class="token punctuation">}</span><span class="token punctuation">;</span></div></div></pre></div><p>属性解释:</p><ul><li><code>fiber.tag</code>: 表示 fiber 类型, 根据<!-- --><code>ReactElement</code>组件的 type 进行生成, 在 react 内部共定义了<!-- --><a href="https://github.com/facebook/react/blob/v17.0.2/packages/react-reconciler/src/ReactWorkTags.js#L10-L35">25 种 tag</a>.<!-- --></li><li><code>fiber.key</code>: 和<!-- --><code>ReactElement</code>组件的 key 一致.<!-- --></li><li><code>fiber.elementType</code>: 一般来讲和<!-- --><code>ReactElement</code>组件的 type 一致<!-- --></li><li><code>fiber.type</code>: 一般来讲和<!-- --><code>fiber.elementType</code>一致. 一些特殊情形下, 比如在开发环境下为了兼容热更新(<!-- --><code>HotReloading</code>), 会对<!-- --><code>function, class, ForwardRef</code>类型的<!-- --><code>ReactElement</code>做一定的处理, 这种情况会区别于<!-- --><code>fiber.elementType</code>, 具体赋值关系可以查看<!-- --><a href="https://github.com/facebook/react/blob/v17.0.2/packages/react-reconciler/src/ReactFiber.old.js#L571-L574">源文件</a>.<!-- --></li><li><code>fiber.stateNode</code>: 与<!-- --><code>fiber</code>关联的局部状态节点(比如: <!-- --><code>HostComponent</code>类型指向与<!-- --><code>fiber</code>节点对应的 dom 节点; 根节点<!-- --><code>fiber.stateNode</code>指向的是<!-- --><code>FiberRoot</code>; class 类型节点其<!-- --><code>stateNode</code>指向的是 class 实例).<!-- --></li><li><code>fiber.return</code>: 指向父节点.<!-- --></li><li><code>fiber.child</code>: 指向第一个子节点.<!-- --></li><li><code>fiber.sibling</code>: 指向下一个兄弟节点.<!-- --></li><li><code>fiber.index</code>: fiber 在兄弟节点中的索引, 如果是单节点默认为 0.<!-- --></li><li><code>fiber.ref</code>: 指向在<!-- --><code>ReactElement</code>组件上设置的 ref(<!-- --><code>string</code>类型的<!-- --><code>ref</code>除外, 这种类型的<!-- --><code>ref</code>已经不推荐使用, <!-- --><code>reconciler</code>阶段会将<!-- --><code>string</code>类型的<!-- --><code>ref</code>转换成一个<!-- --><code>function</code>类型).<!-- --></li><li><code>fiber.pendingProps</code>: 输入属性, 从<!-- --><code>ReactElement</code>对象传入的 props. 用于和<!-- --><code>fiber.memoizedProps</code>比较可以得出属性是否变动.<!-- --></li><li><code>fiber.memoizedProps</code>: 上一次生成子节点时用到的属性, 生成子节点之后保持在内存中. 向下生成子节点之前叫做<!-- --><code>pendingProps</code>, 生成子节点之后会把<!-- --><code>pendingProps</code>赋值给<!-- --><code>memoizedProps</code>用于下一次比较.<!-- --><code>pendingProps</code>和<!-- --><code>memoizedProps</code>比较可以得出属性是否变动.<!-- --></li><li><code>fiber.updateQueue</code>: 存储<!-- --><code>update更新对象</code>的队列, 每一次发起更新, 都需要在该队列上创建一个<!-- --><code>update对象</code>.<!-- --></li><li><code>fiber.memoizedState</code>: 上一次生成子节点之后保持在内存中的  局部状态.<!-- --></li><li><code>fiber.dependencies</code>: 该 fiber 节点所依赖的(contexts, events)等, 在<!-- --><code>context</code>机制章节详细说明.<!-- --></li><li><code>fiber.mode</code>: 二进制位 Bitfield,继承至父节点,影响本 fiber 节点及其子树中所有节点. 与 react 应用的运行模式有关(有 ConcurrentMode, BlockingMode, NoMode 等选项).<!-- --></li><li><code>fiber.flags</code>: 标志位, 副作用标记(在 16.x 版本中叫做<!-- --><code>effectTag</code>, 相应<!-- --><a href="https://github.com/facebook/react/pull/19755">pr</a>), 在<!-- --><a href="https://github.com/facebook/react/blob/v17.0.2/packages/react-reconciler/src/ReactFiberFlags.js#L10-L41"><code>ReactFiberFlags.js</code></a>中定义了所有的标志位. <!-- --><code>reconciler</code>阶段会将所有拥有<!-- --><code>flags</code>标记的节点添加到副作用链表中, 等待 commit 阶段的处理.<!-- --></li><li><code>fiber.subtreeFlags</code>: 替代 16.x 版本中的 firstEffect, nextEffect. 默认未开启, 当设置了<!-- --><a href="https://github.com/facebook/react/blob/v17.0.2/packages/shared/ReactFeatureFlags.js#L93">enableNewReconciler=true</a> 才会启用, 本系列只跟踪稳定版的代码, 未来版本不会深入解读, <!-- --><a href="https://github.com/facebook/react/blob/v17.0.2/packages/react-reconciler/src/ReactFiberCompleteWork.new.js#L690-L714">使用示例见源码</a>.<!-- --></li><li><code>fiber.deletions</code>: 存储将要被删除的子节点. 默认未开启, 当设置了<!-- --><a href="https://github.com/facebook/react/blob/v17.0.2/packages/shared/ReactFeatureFlags.js#L93">enableNewReconciler=true</a> 才会启用, 本系列只跟踪稳定版的代码, 未来版本不会深入解读, <!-- --><a href="https://github.com/facebook/react/blob/v17.0.2/packages/react-reconciler/src/ReactChildFiber.new.js#L275-L287">使用示例见源码</a>.<!-- --></li><li><code>fiber.nextEffect</code>: 单向链表, 指向下一个有副作用的 fiber 节点.<!-- --></li><li><code>fiber.firstEffect</code>: 指向副作用链表中的第一个 fiber 节点.<!-- --></li><li><code>fiber.lastEffect</code>: 指向副作用链表中的最后一个 fiber 节点.<!-- --></li><li><code>fiber.lanes</code>: 本 fiber 节点所属的优先级, 创建 fiber 的时候设置.<!-- --></li><li><code>fiber.childLanes</code>: 子节点所属的优先级.<!-- --></li><li><code>fiber.alternate</code>: 指向内存中的另一个 fiber, 每个被更新过 fiber 节点在内存中都是成对出现(current 和 workInProgress)<!-- --></li></ul><p>通过以上 25 个属性的解释, 对<!-- --><code>fiber</code>对象有一个初步的认识.<!-- --></p><p>最后绘制一颗 fiber 树与上文中的<!-- --><code>ReactElement</code>树对照起来:<!-- --></p><div><img alt="reactelement" width="500" src="/static/reactelement-tree.55d183ba.png"/><img alt="fiber" width="500" src="/static/fiber-tree.38285610.png"/></div>
注意:
<!-- --><ul><li>这里的<!-- --><code>fiber</code>树只是为了和上文中的<!-- --><code>ReactElement</code>树对照, 所以只用观察红色虚线框内的节点. 根节点<!-- --><code>HostRootFiber</code>在<!-- --><a href="/main/bootstrap">react 应用的启动模式章节中</a>详细解读.<!-- --></li><li>其中<!-- --><code>&lt;App/&gt;</code>,<!-- --><code>&lt;Content/&gt;</code>为<!-- --><code>ClassComponent</code>类型的<!-- --><code>fiber</code>节点, 其余节点都是普通<!-- --><code>HostComponent</code>类型节点.<!-- --></li><li><code>&lt;Content/&gt;</code>的子节点在<!-- --><code>ReactElement</code>树中是<!-- --><code>React.Fragment</code>, 但是在<!-- --><code>fiber</code>树中<!-- --><code>React.Fragment</code>并没有与之对应的<!-- --><code>fiber</code>节点(<!-- --><code>reconciler</code>阶段对此类型节点做了单独处理, 所以<!-- --><code>ReactElement</code>节点和<!-- --><code>fiber</code>节点不是一对一匹配).<!-- --></li></ul><h3 id="update-与-updatequeue-对象"><a aria-hidden="true" tabindex="-1" href="#update-与-updatequeue-对象"><span class="icon icon-link"></span></a>Update 与 UpdateQueue 对象<!-- --></h3><p>在<!-- --><code>fiber</code>对象中有一个属性<!-- --><code>fiber.updateQueue</code>, 是一个链式队列(即使用链表实现的队列存储结构), 后文会根据场景表述成链表或队列.<!-- --></p><p>首先观察<!-- --><code>Update</code>对象的数据结构(<!-- --><a href="https://github.com/facebook/react/blob/v17.0.2/packages/react-reconciler/src/ReactUpdateQueue.old.js#L106-L129">对照源码</a>):<!-- --></p><div class="dumi-default-source-code"><button type="button" class="dumi-default-source-code-copy"><svg viewBox="64 64 896 896"><path d="M832 64H296c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h496v688c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8V96c0-17.7-14.3-32-32-32zM704 192H192c-17.7 0-32 14.3-32 32v530.7c0 8.5 3.4 16.6 9.4 22.6l173.3 173.3c2.2 2.2 4.7 4 7.4 5.5v1.9h4.2c3.5 1.3 7.2 2 11 2H704c17.7 0 32-14.3 32-32V224c0-17.7-14.3-32-32-32zM350 856.2 263.9 770H350v86.2zM664 888H414V746c0-22.1-17.9-40-40-40H232V264h432v624z"></path></svg></button><pre class="prism-code language-js"><div class=""><div class=""><span class="token keyword module">export</span><span class="token plain"> type </span><span class="token maybe-class-name">Update</span><span class="token operator">&lt;</span><span class="token maybe-class-name">State</span><span class="token operator">&gt;</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token operator">|</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token literal-property property">eventTime</span><span class="token operator">:</span><span class="token plain"> number</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token comment">// 发起update事件的时间(17.0.2中作为临时字段, 即将移出)</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token literal-property property">lane</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">Lane</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token comment">// update所属的优先级</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">
</span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token literal-property property">tag</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">0</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> </span><span class="token number">1</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> </span><span class="token number">2</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> </span><span class="token number">3</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token comment">//</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token literal-property property">payload</span><span class="token operator">:</span><span class="token plain"> any</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token comment">// 载荷, 根据场景可以设置成一个回调函数或者对象</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token literal-property property">callback</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> mixed</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token comment">// 回调函数</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">
</span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token literal-property property">next</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">Update</span><span class="token operator">&lt;</span><span class="token maybe-class-name">State</span><span class="token operator">&gt;</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token comment">// 指向链表中的下一个, 由于UpdateQueue是一个环形链表, 最后一个update.next指向第一个update对象</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token operator">|</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">
</span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token comment">// =============== UpdateQueue ==============</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">type </span><span class="token maybe-class-name">SharedQueue</span><span class="token operator">&lt;</span><span class="token maybe-class-name">State</span><span class="token operator">&gt;</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token operator">|</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token literal-property property">pending</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">Update</span><span class="token operator">&lt;</span><span class="token maybe-class-name">State</span><span class="token operator">&gt;</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token operator">|</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">
</span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token keyword module">export</span><span class="token plain"> type </span><span class="token maybe-class-name">UpdateQueue</span><span class="token operator">&lt;</span><span class="token maybe-class-name">State</span><span class="token operator">&gt;</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token operator">|</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token literal-property property">baseState</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">State</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token literal-property property">firstBaseUpdate</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">Update</span><span class="token operator">&lt;</span><span class="token maybe-class-name">State</span><span class="token operator">&gt;</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token literal-property property">lastBaseUpdate</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">Update</span><span class="token operator">&lt;</span><span class="token maybe-class-name">State</span><span class="token operator">&gt;</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token literal-property property">shared</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">SharedQueue</span><span class="token operator">&lt;</span><span class="token maybe-class-name">State</span><span class="token operator">&gt;</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token literal-property property">effects</span><span class="token operator">:</span><span class="token plain"> </span><span class="token known-class-name class-name">Array</span><span class="token operator">&lt;</span><span class="token maybe-class-name">Update</span><span class="token operator">&lt;</span><span class="token maybe-class-name">State</span><span class="token operator">&gt;&gt;</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token operator">|</span><span class="token punctuation">}</span><span class="token punctuation">;</span></div></div></pre></div><p>属性解释:</p><ol><li><p><code>UpdateQueue</code></p><ul><li><code>baseState</code>: 表示此队列的基础 state<!-- --></li><li><code>firstBaseUpdate</code>: 指向基础队列的队首<!-- --></li><li><code>lastBaseUpdate</code>: 指向基础队列的队尾<!-- --></li><li><code>shared</code>: 共享队列<!-- --></li><li><code>effects</code>: 用于保存有<!-- --><code>callback</code>回调函数的 update 对象, 在<!-- --><code>commit</code>之后, 会依次调用这里的回调函数.<!-- --></li></ul></li><li><p><code>SharedQueue</code></p><ul><li><code>pending</code>: 指向即将输入的<!-- --><code>update</code>队列. 在<!-- --><code>class</code>组件中调用<!-- --><code>setState()</code>之后, 会将新的 update 对象添加到这个队列中来.<!-- --></li></ul></li><li><p><code>Update</code></p><ul><li><code>eventTime</code>: 发起<!-- --><code>update</code>事件的时间(17.0.2 中作为临时字段, 即将移出)<!-- --></li><li><code>lane</code>: <!-- --><code>update</code>所属的优先级<!-- --></li><li><code>tag</code>: 表示<!-- --><code>update</code>种类, 共 4 种. <!-- --><a href="https://github.com/facebook/react/blob/v17.0.2/packages/react-reconciler/src/ReactUpdateQueue.old.js#L131-L134"><code>UpdateState,ReplaceState,ForceUpdate,CaptureUpdate</code></a></li><li><code>payload</code>: 载荷, <!-- --><code>update</code>对象真正需要更新的数据, 可以设置成一个回调函数或者对象.<!-- --></li><li><code>callback</code>: 回调函数. <!-- --><code>commit</code>完成之后会调用.<!-- --></li><li><code>next</code>: 指向链表中的下一个, 由于<!-- --><code>UpdateQueue</code>是一个环形链表, 最后一个<!-- --><code>update.next</code>指向第一个<!-- --><code>update</code>对象.<!-- --></li></ul></li></ol><p><code>updateQueue</code>是<!-- --><code>fiber</code>对象的一个属性, 所以不能脱离<!-- --><code>fiber</code>存在. 它们之间数据结构和引用关系如下:<!-- --></p><p><img alt="" src="/static/updatequeue.b3653f69.png"/></p><p>注意:</p><ul><li>此处只是展示数据结构和引用关系.对于<!-- --><code>updateQueue</code>在更新阶段的实际作用和运行逻辑, 会在状态组件(class 与 function)章节中详细解读.<!-- --></li></ul><h3 id="hook-对象"><a aria-hidden="true" tabindex="-1" href="#hook-对象"><span class="icon icon-link"></span></a>Hook 对象<!-- --></h3><p><code>Hook</code>用于<!-- --><code>function</code>组件中, 能够保持<!-- --><code>function</code>组件的状态(与<!-- --><code>class</code>组件中的<!-- --><code>state</code>在性质上是相同的, 都是为了保持组件的状态).在<!-- --><code>react@16.8</code>以后, 官方开始推荐使用<!-- --><code>Hook</code>语法, 常用的 api 有<!-- --><code>useState</code>,<!-- --><code>useEffect</code>,<!-- --><code>useCallback</code>等, 官方一共定义了<!-- --><a href="https://github.com/facebook/react/blob/v17.0.2/packages/react-reconciler/src/ReactFiberHooks.old.js#L111-L125">14 种<!-- --><code>Hook</code>类型<!-- --></a>.<!-- --></p><p>这些 api 背后都会创建一个<!-- --><code>Hook</code>对象, 先观察<!-- --><a href="https://github.com/facebook/react/blob/v17.0.2/packages/react-reconciler/src/ReactFiberHooks.old.js#L134-L140"><code>Hook</code>对象的数据结构<!-- --></a>:<!-- --></p><div class="dumi-default-source-code"><button type="button" class="dumi-default-source-code-copy"><svg viewBox="64 64 896 896"><path d="M832 64H296c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h496v688c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8V96c0-17.7-14.3-32-32-32zM704 192H192c-17.7 0-32 14.3-32 32v530.7c0 8.5 3.4 16.6 9.4 22.6l173.3 173.3c2.2 2.2 4.7 4 7.4 5.5v1.9h4.2c3.5 1.3 7.2 2 11 2H704c17.7 0 32-14.3 32-32V224c0-17.7-14.3-32-32-32zM350 856.2 263.9 770H350v86.2zM664 888H414V746c0-22.1-17.9-40-40-40H232V264h432v624z"></path></svg></button><pre class="prism-code language-js"><div class=""><div class=""><span class="token keyword module">export</span><span class="token plain"> type </span><span class="token maybe-class-name">Hook</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token operator">|</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token literal-property property">memoizedState</span><span class="token operator">:</span><span class="token plain"> any</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token literal-property property">baseState</span><span class="token operator">:</span><span class="token plain"> any</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token literal-property property">baseQueue</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">Update</span><span class="token operator">&lt;</span><span class="token plain">any</span><span class="token punctuation">,</span><span class="token plain"> any</span><span class="token operator">&gt;</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token literal-property property">queue</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">UpdateQueue</span><span class="token operator">&lt;</span><span class="token plain">any</span><span class="token punctuation">,</span><span class="token plain"> any</span><span class="token operator">&gt;</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token literal-property property">next</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">Hook</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token operator">|</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">
</span></div></div><div class=""><div class=""><span class="token plain">type </span><span class="token maybe-class-name">Update</span><span class="token operator">&lt;</span><span class="token constant">S</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token constant">A</span><span class="token operator">&gt;</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token operator">|</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token literal-property property">lane</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">Lane</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token literal-property property">action</span><span class="token operator">:</span><span class="token plain"> </span><span class="token constant">A</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token literal-property property">eagerReducer</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter constant">S</span><span class="token parameter punctuation">,</span><span class="token parameter"> </span><span class="token parameter constant">A</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token constant">S</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token literal-property property">eagerState</span><span class="token operator">:</span><span class="token plain"> </span><span class="token constant">S</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token literal-property property">next</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">Update</span><span class="token operator">&lt;</span><span class="token constant">S</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token constant">A</span><span class="token operator">&gt;</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  priority</span><span class="token operator">?</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">ReactPriorityLevel</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token operator">|</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">
</span></div></div><div class=""><div class=""><span class="token plain">type </span><span class="token maybe-class-name">UpdateQueue</span><span class="token operator">&lt;</span><span class="token constant">S</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token constant">A</span><span class="token operator">&gt;</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token operator">|</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token literal-property property">pending</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">Update</span><span class="token operator">&lt;</span><span class="token constant">S</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token constant">A</span><span class="token operator">&gt;</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token literal-property property">dispatch</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter constant">A</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> mixed</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token literal-property property">lastRenderedReducer</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter constant">S</span><span class="token parameter punctuation">,</span><span class="token parameter"> </span><span class="token parameter constant">A</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token constant">S</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token literal-property property">lastRenderedState</span><span class="token operator">:</span><span class="token plain"> </span><span class="token constant">S</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token operator">|</span><span class="token punctuation">}</span><span class="token punctuation">;</span></div></div></pre></div><p>属性解释:</p><ol><li><code>Hook</code></li></ol><ul><li><code>memoizedState</code>: 内存状态, 用于输出成最终的<!-- --><code>fiber</code>树<!-- --></li><li><code>baseState</code>: 基础状态, 当<!-- --><code>Hook.queue</code>更新过后, <!-- --><code>baseState</code>也会更新.<!-- --></li><li><code>baseQueue</code>: 基础状态队列, 在<!-- --><code>reconciler</code>阶段会辅助状态合并.<!-- --></li><li><code>queue</code>: 指向一个<!-- --><code>Update</code>队列<!-- --></li><li><code>next</code>: 指向该<!-- --><code>function</code>组件的下一个<!-- --><code>Hook</code>对象, 使得多个<!-- --><code>Hook</code>之间也构成了一个链表.<!-- --></li></ul><ol start="2"><li><code>Hook.queue</code>和 <!-- --><code>Hook.baseQueue</code>(即<!-- --><code>UpdateQueue</code>和<!-- --><code>Update</code>）是为了保证<!-- --><code>Hook</code>对象能够顺利更新, 与上文<!-- --><code>fiber.updateQueue</code>中的<!-- --><code>UpdateQueue和Update</code>是不一样的(且它们在不同的文件), 其逻辑会在状态组件(class 与 function)章节中详细解读.<!-- --></li></ol><p><code>Hook</code>与<!-- --><code>fiber</code>的关系:<!-- --></p><p>在<!-- --><code>fiber</code>对象中有一个属性<!-- --><code>fiber.memoizedState</code>指向<!-- --><code>fiber</code>节点的内存状态. 在<!-- --><code>function</code>类型的组件中, <!-- --><code>fiber.memoizedState</code>就指向<!-- --><code>Hook</code>队列(<!-- --><code>Hook</code>队列保存了<!-- --><code>function</code>类型的组件状态).<!-- --></p><p>所以<!-- --><code>Hook</code>也不能脱离<!-- --><code>fiber</code>而存在, 它们之间的引用关系如下:<!-- --></p><p><img alt="" src="/static/fiber-hook.78f3cde0.png"/></p><p>注意:</p><ul><li>此处只是展示数据结构和引用关系.对于<!-- --><code>Hook</code>在运行时的实际作用和逻辑, 会在状态组件(class 与 function)章节中详细解读.<!-- --></li></ul><h2 id="scheduler-包"><a aria-hidden="true" tabindex="-1" href="#scheduler-包"><span class="icon icon-link"></span></a>scheduler 包<!-- --></h2><p>如<!-- --><a href="/main/macro-structure">宏观结构</a>中所介绍, <!-- --><code>scheduler</code>包负责调度, 在内部维护一个任务队列(<!-- --><a href="https://github.com/facebook/react/blob/v17.0.2/packages/scheduler/src/Scheduler.js#L63">taskQueue</a>). 这个队列是一个最小堆数组(详见<!-- --><a href="/algorithm/heapsort">React 算法之堆排序</a>), 其中存储了 task 对象.<!-- --></p><h3 id="task-对象"><a aria-hidden="true" tabindex="-1" href="#task-对象"><span class="icon icon-link"></span></a>Task 对象<!-- --></h3><p><code>scheduler</code>包中, 没有为 task 对象定义 type, 其<!-- --><a href="https://github.com/facebook/react/blob/v17.0.2/packages/scheduler/src/Scheduler.js#L316-L326">定义是直接在 js 代码</a>中:<!-- --></p><div class="dumi-default-source-code"><button type="button" class="dumi-default-source-code-copy"><svg viewBox="64 64 896 896"><path d="M832 64H296c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h496v688c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8V96c0-17.7-14.3-32-32-32zM704 192H192c-17.7 0-32 14.3-32 32v530.7c0 8.5 3.4 16.6 9.4 22.6l173.3 173.3c2.2 2.2 4.7 4 7.4 5.5v1.9h4.2c3.5 1.3 7.2 2 11 2H704c17.7 0 32-14.3 32-32V224c0-17.7-14.3-32-32-32zM350 856.2 263.9 770H350v86.2zM664 888H414V746c0-22.1-17.9-40-40-40H232V264h432v624z"></path></svg></button><pre class="prism-code language-js"><div class=""><div class=""><span class="token keyword">var</span><span class="token plain"> newTask </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token literal-property property">id</span><span class="token operator">:</span><span class="token plain"> taskIdCounter</span><span class="token operator">++</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  callback</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  priorityLevel</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  startTime</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  expirationTime</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token literal-property property">sortIndex</span><span class="token operator">:</span><span class="token plain"> </span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">;</span></div></div></pre></div><p>属性解释:</p><ul><li><code>id</code>: 唯一标识<!-- --></li><li><code>callback</code>: task 最核心的字段, 指向<!-- --><code>react-reconciler</code>包所提供的回调函数.<!-- --></li><li><code>priorityLevel</code>: 优先级<!-- --></li><li><code>startTime</code>: 一个时间戳,代表 task 的开始时间(创建时间 + 延时时间).<!-- --></li><li><code>expirationTime</code>: 过期时间.<!-- --></li><li><code>sortIndex</code>: 控制 task 在队列中的次序, 值越小的越靠前.<!-- --></li></ul><p>注意<!-- --><code>task</code>中没有<!-- --><code>next</code>属性, 它不是一个链表, 其顺序是通过堆排序来实现的(小顶堆数组, 始终保证数组中的第一个<!-- --><code>task</code>对象优先级最高).<!-- --></p><p><img alt="" src="/static/taskqueue.40da8e6e.png"/></p><h2 id="总结"><a aria-hidden="true" tabindex="-1" href="#总结"><span class="icon icon-link"></span></a>总结<!-- --></h2><p>本章主要浏览了 react 运行链路中出现的高频对象, 并对它们的数据结构做出了单独解释. 提前了解这些对象的数据结构, 更加有利于之后对 react 源码的深入分析. 在后续对整个运行核心的解读中会多次引用到这些对象, 并对其在运行时的具体作用深入解读.</p></div></div><script>$RC("B:2","S:2")</script>