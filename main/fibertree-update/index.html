<!DOCTYPE html><html><head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<meta name="keywords" content="react, react原理, 图解react, react fiber原理, react hook原理, react 合成事件, react 基本包结构">
<meta name="description" content="图解React原理系列, 以react核心包结构和运行机制为主线索进行展开. 包括react 基本包结构, react 工作循环, react 启动模式, react fiber原理, react hook原理, react 合成事件等核心内容">
<link rel="shortcut icon" href="/km@2x.png">
<link rel="stylesheet" href="/umi.eb36fa83.css">
<title data-rh="true">fiber 树构造(对比更新)</title>
<meta data-rh="true" property="og:title" content="fiber 树构造(对比更新)"/><meta data-rh="true" name="description" content="在前文fiber 树构造(初次创建)一文的介绍中, 演示了fiber树构造循环中逐步构造fiber树的过程. 由于是初次创建, 所以在构造过程中, 所有节点都是新建, 并没有复用旧节点."/><meta data-rh="true" property="og:description" content="在前文fiber 树构造(初次创建)一文的介绍中, 演示了fiber树构造循环中逐步构造fiber树的过程. 由于是初次创建, 所以在构造过程中, 所有节点都是新建, 并没有复用旧节点."/>
</head>
<body>
<noscript><b>Enable JavaScript to run this app.</b></noscript><div id="root"><!--$?--><template id="B:0"></template><div></div><!--/$--></div><script>window.__UMI_LOADER_DATA__ = {}</script>
<script src="/umi.c14ba5aa.js"></script>

</body></html><div hidden id="S:0"><!--$?--><template id="B:1"></template><div></div><!--/$--></div><script>function $RC(a,b){a=document.getElementById(a);b=document.getElementById(b);b.parentNode.removeChild(b);if(a){a=a.previousSibling;var f=a.parentNode,c=a.nextSibling,e=0;do{if(c&&8===c.nodeType){var d=c.data;if("/$"===d)if(0===e)break;else e--;else"$"!==d&&"$?"!==d&&"$!"!==d||e++}d=c.nextSibling;f.removeChild(c);c=d}while(c);for(;b.firstChild;)f.insertBefore(b.firstChild,c);a.data="$";a._reactRetry&&a._reactRetry()}};$RC("B:0","S:0")</script><div hidden id="S:1"><div class="dumi-default-doc-layout"><div class="dumi-default-header"><div class="dumi-default-header-content"><section class="dumi-default-header-left"><a class="dumi-default-logo" href="/"><img src="/logo.png" alt="图解React"/>图解React<!-- --></a></section><section class="dumi-default-header-right"><ul class="dumi-default-navbar"><li><a class="active" href="/main/macro-structure">原理解析</a></li><li><a href="/algorithm/diff">高频算法</a></li><li><a href="/interview/01-setstate">面试题</a></li></ul><div class="dumi-default-header-right-aside"><div class="dumi-default-search-bar"><svg viewBox="64 64 896 896" class="dumi-default-search-bar-svg"><path d="M909.6 854.5 649.9 594.8C690.2 542.7 712 479 712 412c0-80.2-31.3-155.4-87.9-212.1-56.6-56.7-132-87.9-212.1-87.9s-155.5 31.3-212.1 87.9C143.2 256.5 112 331.8 112 412c0 80.1 31.3 155.5 87.9 212.1C256.5 680.8 331.8 712 412 712c67 0 130.6-21.8 182.7-62l259.7 259.6a8.2 8.2 0 0 0 11.6 0l43.6-43.5a8.2 8.2 0 0 0 0-11.6zM570.4 570.4C528 612.7 471.8 636 412 636s-116-23.3-158.4-65.6C211.3 528 188 471.8 188 412s23.3-116.1 65.6-158.4C296 211.3 352.2 188 412 188s116.1 23.2 158.4 65.6S636 352.2 636 412s-23.3 116.1-65.6 158.4z"></path></svg><input class="dumi-default-search-bar-input" placeholder="输入关键字搜索..."/><span class="dumi-default-search-shortcut">⌘<!-- --> K<!-- --></span></div><span class="dumi-default-color-switch" data-dumi-tooltip="亮色模式" data-dumi-tooltip-bottom="true"><svg viewBox="0 0 16 16"><path d="M8 13a1 1 0 0 1 1 1v1a1 1 0 1 1-2 0v-1a1 1 0 0 1 1-1ZM8 3a1 1 0 0 1-1-1V1a1 1 0 1 1 2 0v1a1 1 0 0 1-1 1Zm7 4a1 1 0 1 1 0 2h-1a1 1 0 1 1 0-2h1ZM3 8a1 1 0 0 1-1 1H1a1 1 0 1 1 0-2h1a1 1 0 0 1 1 1Zm9.95 3.536.707.707a1 1 0 0 1-1.414 1.414l-.707-.707a1 1 0 0 1 1.414-1.414Zm-9.9-7.072-.707-.707a1 1 0 0 1 1.414-1.414l.707.707A1 1 0 0 1 3.05 4.464Zm9.9 0a1 1 0 0 1-1.414-1.414l.707-.707a1 1 0 0 1 1.414 1.414l-.707.707Zm-9.9 7.072a1 1 0 0 1 1.414 1.414l-.707.707a1 1 0 0 1-1.414-1.414l.707-.707ZM8 4a4 4 0 1 0 0 8 4 4 0 0 0 0-8Zm0 6.5a2.5 2.5 0 1 1 0-5 2.5 2.5 0 0 1 0 5Z"></path></svg><select><option value="light" selected="">亮色模式<!-- --></option><option value="dark">暗色模式<!-- --></option><option value="auto">跟随系统<!-- --></option></select></span><a class="dumi-default-icon" data-dumi-tooltip="GitHub" data-dumi-tooltip-bottom="true" target="_blank" href="https://github.com/7kms/react-illustration-series" rel="noreferrer"><svg viewBox="64 64 896 896"><path d="M511.6 76.3C264.3 76.2 64 276.4 64 523.5 64 718.9 189.3 885 363.8 946c23.5 5.9 19.9-10.8 19.9-22.2v-77.5c-135.7 15.9-141.2-73.9-150.3-88.9C215 726 171.5 718 184.5 703c30.9-15.9 62.4 4 98.9 57.9 26.4 39.1 77.9 32.5 104 26 5.7-23.5 17.9-44.5 34.7-60.8-140.6-25.2-199.2-111-199.2-213 0-49.5 16.3-95 48.3-131.7-20.4-60.5 1.9-112.3 4.9-120 58.1-5.2 118.5 41.6 123.2 45.3 33-8.9 70.7-13.6 112.9-13.6 42.4 0 80.2 4.9 113.5 13.9 11.3-8.6 67.3-48.8 121.3-43.9 2.9 7.7 24.7 58.3 5.5 118 32.4 36.8 48.9 82.7 48.9 132.3 0 102.2-59 188.1-200 212.9a127.5 127.5 0 0 1 38.1 91v112.5c.8 9 0 17.9 15 17.9 177.1-59.7 304.6-227 304.6-424.1 0-247.2-200.4-447.3-447.5-447.3z"></path></svg></a></div></section><button type="button" class="dumi-default-header-menu-btn"><svg viewBox="64 64 896 896"><path d="M904 160H120c-4.4 0-8 3.6-8 8v64c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-64c0-4.4-3.6-8-8-8zm0 624H120c-4.4 0-8 3.6-8 8v64c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-64c0-4.4-3.6-8-8-8zm0-312H120c-4.4 0-8 3.6-8 8v64c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-64c0-4.4-3.6-8-8-8z"></path></svg></button></div></div><div class="dumi-default-doc-layout-mobile-bar"><button type="button" class="dumi-default-sidebar-btn"><svg viewBox="64 64 896 896"><path d="M120 230h496c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm0 424h496c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm784 140H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0-424H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8z"></path></svg>侧边菜单<!-- --></button></div><main><div class="dumi-default-sidebar"><dl class="dumi-default-sidebar-group"><dt>基本概念</dt><dd><a title="宏观包结构" class="" href="/main/macro-structure">宏观包结构</a></dd><dd><a title="两大工作循环" class="" href="/main/workloop">两大工作循环</a></dd><dd><a title="高频对象" class="" href="/main/object-structure">高频对象</a></dd></dl><dl class="dumi-default-sidebar-group"><dt>运行核心</dt><dd><a title="启动过程" class="" href="/main/bootstrap">启动过程</a></dd><dd><a title="reconciler 运作流程" class="" href="/main/reconciler-workflow">reconciler 运作流程</a></dd><dd><a title="优先级管理" class="" href="/main/priority">优先级管理</a></dd><dd><a title="调度原理" class="" href="/main/scheduler">调度原理</a></dd><dd><a title="fiber 树构造(基础准备)" class="" href="/main/fibertree-prepare">fiber 树构造(基础准备)</a></dd><dd><a title="fiber 树构造(初次创建)" class="" href="/main/fibertree-create">fiber 树构造(初次创建)</a></dd><dd><a title="fiber 树构造(对比更新)" aria-current="page" class="active" href="/main/fibertree-update">fiber 树构造(对比更新)</a></dd><dd><a title="fiber 树渲染" class="" href="/main/fibertree-commit">fiber 树渲染</a></dd></dl><dl class="dumi-default-sidebar-group"><dt>状态管理</dt><dd><a title="状态与副作用" class="" href="/main/state-effects">状态与副作用</a></dd><dd><a title="Hook 原理(概览)" class="" href="/main/hook-summary">Hook 原理(概览)</a></dd><dd><a title="Hook 原理(状态Hook)" class="" href="/main/hook-state">Hook 原理(状态Hook)</a></dd><dd><a title="Hook 原理(副作用Hook)" class="" href="/main/hook-effect">Hook 原理(副作用Hook)</a></dd><dd><a title="context 原理" class="" href="/main/context">context 原理</a></dd></dl><dl class="dumi-default-sidebar-group"><dt>交互</dt><dd><a title="合成事件" class="" href="/main/synthetic-event">合成事件</a></dd></dl></div><div class="dumi-default-content"><!--$?--><template id="B:2"></template><div></div><!--/$--><div class="dumi-default-footer">Copyright © 2023 | Powered by <a href="https://d.umijs.org" target="_blank" rel="noreferrer">dumi</a></div></div></main></div></div><script>$RC("B:1","S:1")</script><div hidden id="S:2"><div class="markdown"><h1 id="fiber-树构造对比更新"><a aria-hidden="true" tabindex="-1" href="#fiber-树构造对比更新"><span class="icon icon-link"></span></a>fiber 树构造(对比更新)<!-- --></h1><p>在前文<!-- --><a href="/main/fibertree-create">fiber 树构造(初次创建)</a>一文的介绍中, 演示了<!-- --><code>fiber树构造循环</code>中逐步构造<!-- --><code>fiber树</code>的过程. 由于是初次创建, 所以在构造过程中, 所有节点都是新建, 并没有复用旧节点.<!-- --></p><p>本节讨论<!-- --><code>对比更新</code>这种情况(在<!-- --><code>Legacy</code>模式下进行分析). 在阅读本节之前, 最好对<!-- --><a href="/main/fibertree-create">fiber 树构造(初次创建)</a>有一些了解, 其中有很多相似逻辑不再重复叙述, 本节重点突出<!-- --><code>对比更新</code>与<!-- --><code>初次创建</code>的不同之处.<!-- --></p><p>本节示例代码如下(<!-- --><a href="https://codesandbox.io/s/angry-williams-l1mze?file=/src/App.js">codesandbox 地址</a>):<!-- --></p><div class="dumi-default-source-code"><button type="button" class="dumi-default-source-code-copy"><svg viewBox="64 64 896 896"><path d="M832 64H296c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h496v688c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8V96c0-17.7-14.3-32-32-32zM704 192H192c-17.7 0-32 14.3-32 32v530.7c0 8.5 3.4 16.6 9.4 22.6l173.3 173.3c2.2 2.2 4.7 4 7.4 5.5v1.9h4.2c3.5 1.3 7.2 2 11 2H704c17.7 0 32-14.3 32-32V224c0-17.7-14.3-32-32-32zM350 856.2 263.9 770H350v86.2zM664 888H414V746c0-22.1-17.9-40-40-40H232V264h432v624z"></path></svg></button><pre class="prism-code language-js"><div class=""><div class=""><span class="token keyword module">import</span><span class="token plain"> </span><span class="token imports maybe-class-name">React</span><span class="token plain"> </span><span class="token keyword module">from</span><span class="token plain"> </span><span class="token string">&#x27;react&#x27;</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">
</span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token keyword">class</span><span class="token plain"> </span><span class="token class-name">App</span><span class="token plain"> </span><span class="token keyword">extends</span><span class="token plain"> </span><span class="token class-name">React</span><span class="token class-name punctuation">.</span><span class="token class-name">Component</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  state </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token literal-property property">list</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token string">&#x27;A&#x27;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token string">&#x27;B&#x27;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token string">&#x27;C&#x27;</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token function-variable function">onChange</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token plain"> </span><span class="token literal-property property">list</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token string">&#x27;C&#x27;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token string">&#x27;A&#x27;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token string">&#x27;X&#x27;</span><span class="token punctuation">]</span><span class="token plain"> </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token function">componentDidMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token template-string template-punctuation string">`</span><span class="token template-string string">App Mount</span><span class="token template-string template-punctuation string">`</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token keyword control-flow">return</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token operator">&lt;</span><span class="token operator">&gt;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">        </span><span class="token operator">&lt;</span><span class="token maybe-class-name">Header</span><span class="token plain"> </span><span class="token operator">/</span><span class="token operator">&gt;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">        </span><span class="token operator">&lt;</span><span class="token plain">button onClick</span><span class="token operator">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">onChange</span><span class="token punctuation">}</span><span class="token operator">&gt;</span><span class="token plain">change</span><span class="token operator">&lt;</span><span class="token operator">/</span><span class="token plain">button</span><span class="token operator">&gt;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">        </span><span class="token operator">&lt;</span><span class="token plain">div className</span><span class="token operator">=</span><span class="token string">&quot;content&quot;</span><span class="token operator">&gt;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">          </span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">state</span><span class="token punctuation">.</span><span class="token property-access">list</span><span class="token punctuation">.</span><span class="token method function property-access">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">            </span><span class="token operator">&lt;</span><span class="token plain">p key</span><span class="token operator">=</span><span class="token punctuation">{</span><span class="token plain">item</span><span class="token punctuation">}</span><span class="token operator">&gt;</span><span class="token punctuation">{</span><span class="token plain">item</span><span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span><span class="token plain">p</span><span class="token operator">&gt;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">          </span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">        </span><span class="token operator">&lt;</span><span class="token operator">/</span><span class="token plain">div</span><span class="token operator">&gt;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token operator">&lt;</span><span class="token operator">/</span><span class="token operator">&gt;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">
</span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token keyword">class</span><span class="token plain"> </span><span class="token class-name">Header</span><span class="token plain"> </span><span class="token keyword">extends</span><span class="token plain"> </span><span class="token class-name">React</span><span class="token class-name punctuation">.</span><span class="token class-name">PureComponent</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token keyword control-flow">return</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token operator">&lt;</span><span class="token operator">&gt;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">        </span><span class="token operator">&lt;</span><span class="token plain">h1</span><span class="token operator">&gt;</span><span class="token plain">title</span><span class="token operator">&lt;</span><span class="token operator">/</span><span class="token plain">h1</span><span class="token operator">&gt;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">        </span><span class="token operator">&lt;</span><span class="token plain">h2</span><span class="token operator">&gt;</span><span class="token plain">title2</span><span class="token operator">&lt;</span><span class="token operator">/</span><span class="token plain">h2</span><span class="token operator">&gt;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token operator">&lt;</span><span class="token operator">/</span><span class="token operator">&gt;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token keyword module">export</span><span class="token plain"> </span><span class="token keyword module">default</span><span class="token plain"> </span><span class="token maybe-class-name">App</span><span class="token punctuation">;</span></div></div></pre></div><p>在<!-- --><code>初次渲染</code>完成之后, 与<!-- --><code>fiber树</code>相关的内存结构如下(后文以此图为基础, 演示<!-- --><code>对比更新</code>过程):<!-- --></p><p><img alt="" src="/static/beforeupdate.cb26ad8c.png"/></p><h2 id="更新入口"><a aria-hidden="true" tabindex="-1" href="#更新入口"><span class="icon icon-link"></span></a>更新入口<!-- --></h2><p>前文<!-- --><a href="/main/reconciler-workflow#%E8%BE%93%E5%85%A5">reconciler 运作流程</a>中总结的 4 个阶段(从输入到输出), 其中承接输入的函数只有<!-- --><code>scheduleUpdateOnFiber</code>(<!-- --><a href="https://github.com/facebook/react/blob/v17.0.2/packages/react-reconciler/src/ReactFiberWorkLoop.old.js#L517-L619">源码地址</a>).在<!-- --><code>react-reconciler</code>对外暴露的 api 函数中, 只要涉及到需要改变 fiber 的操作(无论是<!-- --><code>首次渲染</code>或<!-- --><code>对比更新</code>), 最后都会间接调用<!-- --><code>scheduleUpdateOnFiber</code>, <!-- --><code>scheduleUpdateOnFiber</code>函数是输入链路中的<!-- --><code>必经之路</code>.<!-- --></p><h3 id="3-种更新方式"><a aria-hidden="true" tabindex="-1" href="#3-种更新方式"><span class="icon icon-link"></span></a>3 种更新方式<!-- --></h3><p>如要主动发起更新, 有 3 种常见方式:</p><ol><li><code>Class</code>组件中调用<!-- --><code>setState</code>.<!-- --></li><li><code>Function</code>组件中调用<!-- --><code>hook</code>对象暴露出的<!-- --><code>dispatchAction</code>.<!-- --></li><li>在<!-- --><code>container</code>节点上重复调用<!-- --><code>render</code>(<!-- --><a href="https://reactjs.org/docs/rendering-elements.html#react-only-updates-whats-necessary">官网示例</a>)<!-- --></li></ol><p>下面列出这 3 种更新方式的源码:</p><h4 id="setstate"><a aria-hidden="true" tabindex="-1" href="#setstate"><span class="icon icon-link"></span></a>setState<!-- --></h4><p>在<!-- --><code>Component</code>对象的原型上挂载有<!-- --><code>setState</code>(<!-- --><a href="https://github.com/facebook/react/blob/v17.0.2/packages/react/src/ReactBaseClasses.js#L57-L66">源码链接</a>):<!-- --></p><div class="dumi-default-source-code"><button type="button" class="dumi-default-source-code-copy"><svg viewBox="64 64 896 896"><path d="M832 64H296c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h496v688c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8V96c0-17.7-14.3-32-32-32zM704 192H192c-17.7 0-32 14.3-32 32v530.7c0 8.5 3.4 16.6 9.4 22.6l173.3 173.3c2.2 2.2 4.7 4 7.4 5.5v1.9h4.2c3.5 1.3 7.2 2 11 2H704c17.7 0 32-14.3 32-32V224c0-17.7-14.3-32-32-32zM350 856.2 263.9 770H350v86.2zM664 888H414V746c0-22.1-17.9-40-40-40H232V264h432v624z"></path></svg></button><pre class="prism-code language-js"><div class=""><div class=""><span class="token class-name">Component</span><span class="token punctuation">.</span><span class="token property-access">prototype</span><span class="token punctuation">.</span><span class="token method-variable function-variable method function property-access">setState</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token parameter">partialState</span><span class="token parameter punctuation">,</span><span class="token parameter"> callback</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">updater</span><span class="token punctuation">.</span><span class="token method function property-access">enqueueSetState</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span><span class="token plain"> partialState</span><span class="token punctuation">,</span><span class="token plain"> callback</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token string">&#x27;setState&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">;</span></div></div></pre></div><p>在<!-- --><a href="/main/fibertree-create">fiber 树构造(初次创建)</a>中的<!-- --><code>beginWork</code>阶段, class 类型的组件初始化完成之后, <!-- --><code>this.updater</code>对象如下(<!-- --><a href="https://github.com/facebook/react/blob/v17.0.2/packages/react-reconciler/src/ReactFiberClassComponent.old.js#L193-L225">源码链接</a>):<!-- --></p><div class="dumi-default-source-code"><button type="button" class="dumi-default-source-code-copy"><svg viewBox="64 64 896 896"><path d="M832 64H296c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h496v688c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8V96c0-17.7-14.3-32-32-32zM704 192H192c-17.7 0-32 14.3-32 32v530.7c0 8.5 3.4 16.6 9.4 22.6l173.3 173.3c2.2 2.2 4.7 4 7.4 5.5v1.9h4.2c3.5 1.3 7.2 2 11 2H704c17.7 0 32-14.3 32-32V224c0-17.7-14.3-32-32-32zM350 856.2 263.9 770H350v86.2zM664 888H414V746c0-22.1-17.9-40-40-40H232V264h432v624z"></path></svg></button><pre class="prism-code language-js"><div class=""><div class=""><span class="token keyword">const</span><span class="token plain"> classComponentUpdater </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  isMounted</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token function">enqueueSetState</span><span class="token punctuation">(</span><span class="token parameter">inst</span><span class="token parameter punctuation">,</span><span class="token parameter"> payload</span><span class="token parameter punctuation">,</span><span class="token parameter"> callback</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token comment">// 1. 获取class实例对应的fiber节点</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token keyword">const</span><span class="token plain"> fiber </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token plain">inst</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token comment">// 2. 创建update对象</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token keyword">const</span><span class="token plain"> eventTime </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">requestEventTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token keyword">const</span><span class="token plain"> lane </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">requestUpdateLane</span><span class="token punctuation">(</span><span class="token plain">fiber</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"> </span><span class="token comment">// 确定当前update对象的优先级</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token keyword">const</span><span class="token plain"> update </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">createUpdate</span><span class="token punctuation">(</span><span class="token plain">eventTime</span><span class="token punctuation">,</span><span class="token plain"> lane</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    update</span><span class="token punctuation">.</span><span class="token property-access">payload</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> payload</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">callback </span><span class="token operator">!==</span><span class="token plain"> </span><span class="token keyword nil">undefined</span><span class="token plain"> </span><span class="token operator">&amp;&amp;</span><span class="token plain"> callback </span><span class="token operator">!==</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      update</span><span class="token punctuation">.</span><span class="token property-access">callback</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> callback</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token comment">// 3. 将update对象添加到当前Fiber节点的updateQueue队列当中</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token function">enqueueUpdate</span><span class="token punctuation">(</span><span class="token plain">fiber</span><span class="token punctuation">,</span><span class="token plain"> update</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token comment">// 4. 进入reconciler运作流程中的`输入`环节</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token function">scheduleUpdateOnFiber</span><span class="token punctuation">(</span><span class="token plain">fiber</span><span class="token punctuation">,</span><span class="token plain"> lane</span><span class="token punctuation">,</span><span class="token plain"> eventTime</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"> </span><span class="token comment">// 传入的lane是update优先级</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">;</span></div></div></pre></div><h4 id="dispatchaction"><a aria-hidden="true" tabindex="-1" href="#dispatchaction"><span class="icon icon-link"></span></a>dispatchAction<!-- --></h4><blockquote><p>此处只是为了对比<!-- --><code>dispatchAction</code>和<!-- --><code>setState</code>. 有关<!-- --><code>hook</code>原理的深入分析, 在<!-- --><code>hook 原理</code>章节中详细讨论.<!-- --></p></blockquote><p>在<!-- --><code>function类型</code>组件中, 如果使用<!-- --><code>hook(useState)</code>, 则可以通过<!-- --><code>hook api</code>暴露出的<!-- --><code>dispatchAction</code>(<!-- --><a href="https://github.com/facebook/react/blob/v17.0.2/packages/react-reconciler/src/ReactFiberHooks.old.js#L1645-L1753">源码链接</a>)来更新<!-- --></p><div class="dumi-default-source-code"><button type="button" class="dumi-default-source-code-copy"><svg viewBox="64 64 896 896"><path d="M832 64H296c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h496v688c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8V96c0-17.7-14.3-32-32-32zM704 192H192c-17.7 0-32 14.3-32 32v530.7c0 8.5 3.4 16.6 9.4 22.6l173.3 173.3c2.2 2.2 4.7 4 7.4 5.5v1.9h4.2c3.5 1.3 7.2 2 11 2H704c17.7 0 32-14.3 32-32V224c0-17.7-14.3-32-32-32zM350 856.2 263.9 770H350v86.2zM664 888H414V746c0-22.1-17.9-40-40-40H232V264h432v624z"></path></svg></button><pre class="prism-code language-js"><div class=""><div class=""><span class="token keyword">function</span><span class="token plain"> dispatchAction</span><span class="token operator">&lt;</span><span class="token constant">S</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token constant">A</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token literal-property property">fiber</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">Fiber</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token literal-property property">queue</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">UpdateQueue</span><span class="token operator">&lt;</span><span class="token constant">S</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token constant">A</span><span class="token operator">&gt;</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token literal-property property">action</span><span class="token operator">:</span><span class="token plain"> </span><span class="token constant">A</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token comment">// 1. 创建update对象</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> eventTime </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">requestEventTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> lane </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">requestUpdateLane</span><span class="token punctuation">(</span><span class="token plain">fiber</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"> </span><span class="token comment">// 确定当前update对象的优先级</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> </span><span class="token literal-property property">update</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">Update</span><span class="token operator">&lt;</span><span class="token constant">S</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token constant">A</span><span class="token operator">&gt;</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    lane</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    action</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token literal-property property">eagerReducer</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token literal-property property">eagerState</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token literal-property property">next</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token keyword null nil">null</span><span class="token operator">:</span><span class="token plain"> any</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token comment">// 2. 将update对象添加到当前Hook对象的updateQueue队列当中</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> pending </span><span class="token operator">=</span><span class="token plain"> queue</span><span class="token punctuation">.</span><span class="token property-access">pending</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">pending </span><span class="token operator">===</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    update</span><span class="token punctuation">.</span><span class="token property-access">next</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> update</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword control-flow">else</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    update</span><span class="token punctuation">.</span><span class="token property-access">next</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> pending</span><span class="token punctuation">.</span><span class="token property-access">next</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    pending</span><span class="token punctuation">.</span><span class="token property-access">next</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> update</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  queue</span><span class="token punctuation">.</span><span class="token property-access">pending</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> update</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token comment">// 3. 请求调度, 进入reconciler运作流程中的`输入`环节.</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token function">scheduleUpdateOnFiber</span><span class="token punctuation">(</span><span class="token plain">fiber</span><span class="token punctuation">,</span><span class="token plain"> lane</span><span class="token punctuation">,</span><span class="token plain"> eventTime</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"> </span><span class="token comment">// 传入的lane是update优先级</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token punctuation">}</span></div></div></pre></div><h4 id="重复调用-render"><a aria-hidden="true" tabindex="-1" href="#重复调用-render"><span class="icon icon-link"></span></a>重复调用 render<!-- --></h4><div class="dumi-default-source-code"><button type="button" class="dumi-default-source-code-copy"><svg viewBox="64 64 896 896"><path d="M832 64H296c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h496v688c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8V96c0-17.7-14.3-32-32-32zM704 192H192c-17.7 0-32 14.3-32 32v530.7c0 8.5 3.4 16.6 9.4 22.6l173.3 173.3c2.2 2.2 4.7 4 7.4 5.5v1.9h4.2c3.5 1.3 7.2 2 11 2H704c17.7 0 32-14.3 32-32V224c0-17.7-14.3-32-32-32zM350 856.2 263.9 770H350v86.2zM664 888H414V746c0-22.1-17.9-40-40-40H232V264h432v624z"></path></svg></button><pre class="prism-code language-js"><div class=""><div class=""><span class="token keyword module">import</span><span class="token plain"> </span><span class="token imports maybe-class-name">ReactDOM</span><span class="token plain"> </span><span class="token keyword module">from</span><span class="token plain"> </span><span class="token string">&#x27;react-dom&#x27;</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">tick</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> element </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token operator">&lt;</span><span class="token plain">div</span><span class="token operator">&gt;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token operator">&lt;</span><span class="token plain">h1</span><span class="token operator">&gt;</span><span class="token maybe-class-name">Hello</span><span class="token punctuation">,</span><span class="token plain"> world</span><span class="token operator">!</span><span class="token operator">&lt;</span><span class="token operator">/</span><span class="token plain">h1</span><span class="token operator">&gt;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token operator">&lt;</span><span class="token plain">h2</span><span class="token operator">&gt;</span><span class="token maybe-class-name">It</span><span class="token plain"> is </span><span class="token punctuation">{</span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toLocaleTimeString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token operator">&lt;</span><span class="token operator">/</span><span class="token plain">h2</span><span class="token operator">&gt;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token operator">&lt;</span><span class="token operator">/</span><span class="token plain">div</span><span class="token operator">&gt;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token maybe-class-name">ReactDOM</span><span class="token punctuation">.</span><span class="token method function property-access">render</span><span class="token punctuation">(</span><span class="token plain">element</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token dom variable">document</span><span class="token punctuation">.</span><span class="token method function property-access">getElementById</span><span class="token punctuation">(</span><span class="token string">&#x27;root&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token plain">tick</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div></div></pre></div><p>对于重复<!-- --><code>render</code>, 在<!-- --><a href="/main/bootstrap">React 应用的启动过程</a>中已有说明, 调用路径包含<!-- --><code>updateContainer--&gt;scheduleUpdateOnFiber</code></p><blockquote><p>故无论从哪个入口进行更新, 最终都会进入<!-- --><code>scheduleUpdateOnFiber</code>, 再次证明<!-- --><code>scheduleUpdateOnFiber</code>是<!-- --><code>输入</code>阶段的必经函数(参考<!-- --><a href="/main/reconciler-workflow">reconciler 运作流程</a>).<!-- --></p></blockquote><h2 id="构造阶段"><a aria-hidden="true" tabindex="-1" href="#构造阶段"><span class="icon icon-link"></span></a>构造阶段<!-- --></h2><p>逻辑来到<!-- --><a href="https://github.com/facebook/react/blob/v17.0.2/packages/react-reconciler/src/ReactFiberWorkLoop.old.js#L517-L619">scheduleUpdateOnFiber</a>函数:<!-- --></p><div class="dumi-default-source-code"><button type="button" class="dumi-default-source-code-copy"><svg viewBox="64 64 896 896"><path d="M832 64H296c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h496v688c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8V96c0-17.7-14.3-32-32-32zM704 192H192c-17.7 0-32 14.3-32 32v530.7c0 8.5 3.4 16.6 9.4 22.6l173.3 173.3c2.2 2.2 4.7 4 7.4 5.5v1.9h4.2c3.5 1.3 7.2 2 11 2H704c17.7 0 32-14.3 32-32V224c0-17.7-14.3-32-32-32zM350 856.2 263.9 770H350v86.2zM664 888H414V746c0-22.1-17.9-40-40-40H232V264h432v624z"></path></svg></button><pre class="prism-code language-js"><div class=""><div class=""><span class="token comment">// ...省略部分代码</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token keyword module">export</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">scheduleUpdateOnFiber</span><span class="token punctuation">(</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token literal-property property">fiber</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">Fiber</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token comment">// fiber表示被更新的节点</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token literal-property property">lane</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">Lane</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token comment">// lane表示update优先级</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token literal-property property">eventTime</span><span class="token operator">:</span><span class="token plain"> number</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> root </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">markUpdateLaneFromFiberToRoot</span><span class="token punctuation">(</span><span class="token plain">fiber</span><span class="token punctuation">,</span><span class="token plain"> lane</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">lane </span><span class="token operator">===</span><span class="token plain"> </span><span class="token maybe-class-name">SyncLane</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token punctuation">(</span><span class="token plain">executionContext </span><span class="token operator">&amp;</span><span class="token plain"> </span><span class="token maybe-class-name">LegacyUnbatchedContext</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token operator">!==</span><span class="token plain"> </span><span class="token maybe-class-name">NoContext</span><span class="token plain"> </span><span class="token operator">&amp;&amp;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token punctuation">(</span><span class="token plain">executionContext </span><span class="token operator">&amp;</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token maybe-class-name">RenderContext</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> </span><span class="token maybe-class-name">CommitContext</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token operator">===</span><span class="token plain"> </span><span class="token maybe-class-name">NoContext</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token comment">// 初次渲染</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token function">performSyncWorkOnRoot</span><span class="token punctuation">(</span><span class="token plain">root</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword control-flow">else</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token comment">// 对比更新</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token function">ensureRootIsScheduled</span><span class="token punctuation">(</span><span class="token plain">root</span><span class="token punctuation">,</span><span class="token plain"> eventTime</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  mostRecentlyUpdatedRoot </span><span class="token operator">=</span><span class="token plain"> root</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token punctuation">}</span></div></div></pre></div><p><code>对比更 新</code>与<!-- --><code>初次渲染</code>的不同点:<!-- --></p><ol><li><a href="https://github.com/facebook/react/blob/v17.0.2/packages/react-reconciler/src/ReactFiberWorkLoop.old.js#L625-L667">markUpdateLaneFromFiberToRoot</a>函数, 只在<!-- --><code>对比更新</code>阶段才发挥出它的作用, 它找出了<!-- --><code>fiber树</code>中受到本次<!-- --><code>update</code>影响的所有节点, 并设置这些节点的<!-- --><code>fiber.lanes</code>或<!-- --><code>fiber.childLanes</code>(在<!-- --><code>legacy</code>模式下为<!-- --><code>SyncLane</code>)以备<!-- --><code>fiber树构造</code>阶段使用.<!-- --></li></ol><div class="dumi-default-source-code"><button type="button" class="dumi-default-source-code-copy"><svg viewBox="64 64 896 896"><path d="M832 64H296c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h496v688c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8V96c0-17.7-14.3-32-32-32zM704 192H192c-17.7 0-32 14.3-32 32v530.7c0 8.5 3.4 16.6 9.4 22.6l173.3 173.3c2.2 2.2 4.7 4 7.4 5.5v1.9h4.2c3.5 1.3 7.2 2 11 2H704c17.7 0 32-14.3 32-32V224c0-17.7-14.3-32-32-32zM350 856.2 263.9 770H350v86.2zM664 888H414V746c0-22.1-17.9-40-40-40H232V264h432v624z"></path></svg></button><pre class="prism-code language-js"><div class=""><div class=""><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">markUpdateLaneFromFiberToRoot</span><span class="token punctuation">(</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token literal-property property">sourceFiber</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">Fiber</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token comment">// sourceFiber表示被更新的节点</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token literal-property property">lane</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">Lane</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token comment">// lane表示update优先级</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token punctuation">)</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">FiberRoot</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token comment">// 1. 将update优先级设置到sourceFiber.lanes</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  sourceFiber</span><span class="token punctuation">.</span><span class="token property-access">lanes</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">mergeLanes</span><span class="token punctuation">(</span><span class="token plain">sourceFiber</span><span class="token punctuation">.</span><span class="token property-access">lanes</span><span class="token punctuation">,</span><span class="token plain"> lane</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword">let</span><span class="token plain"> alternate </span><span class="token operator">=</span><span class="token plain"> sourceFiber</span><span class="token punctuation">.</span><span class="token property-access">alternate</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">alternate </span><span class="token operator">!==</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token comment">// 同时设置sourceFiber.alternate的优先级</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    alternate</span><span class="token punctuation">.</span><span class="token property-access">lanes</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">mergeLanes</span><span class="token punctuation">(</span><span class="token plain">alternate</span><span class="token punctuation">.</span><span class="token property-access">lanes</span><span class="token punctuation">,</span><span class="token plain"> lane</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token comment">// 2. 从sourceFiber开始, 向上遍历所有节点, 直到HostRoot. 设置沿途所有节点(包括alternate)的childLanes</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword">let</span><span class="token plain"> node </span><span class="token operator">=</span><span class="token plain"> sourceFiber</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword">let</span><span class="token plain"> parent </span><span class="token operator">=</span><span class="token plain"> sourceFiber</span><span class="token punctuation">.</span><span class="token keyword control-flow">return</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword control-flow">while</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">parent </span><span class="token operator">!==</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    parent</span><span class="token punctuation">.</span><span class="token property-access">childLanes</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">mergeLanes</span><span class="token punctuation">(</span><span class="token plain">parent</span><span class="token punctuation">.</span><span class="token property-access">childLanes</span><span class="token punctuation">,</span><span class="token plain"> lane</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    alternate </span><span class="token operator">=</span><span class="token plain"> parent</span><span class="token punctuation">.</span><span class="token property-access">alternate</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">alternate </span><span class="token operator">!==</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      alternate</span><span class="token punctuation">.</span><span class="token property-access">childLanes</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">mergeLanes</span><span class="token punctuation">(</span><span class="token plain">alternate</span><span class="token punctuation">.</span><span class="token property-access">childLanes</span><span class="token punctuation">,</span><span class="token plain"> lane</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    node </span><span class="token operator">=</span><span class="token plain"> parent</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    parent </span><span class="token operator">=</span><span class="token plain"> parent</span><span class="token punctuation">.</span><span class="token keyword control-flow">return</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">node</span><span class="token punctuation">.</span><span class="token property-access">tag</span><span class="token plain"> </span><span class="token operator">===</span><span class="token plain"> </span><span class="token maybe-class-name">HostRoot</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token keyword">const</span><span class="token plain"> </span><span class="token literal-property property">root</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">FiberRoot</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> node</span><span class="token punctuation">.</span><span class="token property-access">stateNode</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token keyword control-flow">return</span><span class="token plain"> root</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword control-flow">else</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token keyword control-flow">return</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token punctuation">}</span></div></div></pre></div><h3 id="markupdatelanefromfibertoroot"><a aria-hidden="true" tabindex="-1" href="#markupdatelanefromfibertoroot"><span class="icon icon-link"></span></a>markUpdateLaneFromFiberToRoot<!-- --></h3><p>下图表示了<!-- --><code>markUpdateLaneFromFiberToRoot</code>的具体作用:<!-- --></p><ul><li>以<!-- --><code>sourceFiber</code>为起点, 设置起点的<!-- --><code>fiber.lanes</code></li><li>从起点开始, 直到<!-- --><code>HostRootFiber</code>, 设置父路径上所有节点(也包括<!-- --><code>fiber.alternate</code>)的<!-- --><code>fiber.childLanes</code>.<!-- --></li><li>通过设置<!-- --><code>fiber.lanes</code>和<!-- --><code>fiber.childLanes</code>就可以辅助判断子树是否需要更新(在下文<!-- --><code>循环构造</code>中详细说明).<!-- --></li></ul><p><img alt="" src="/static/markupdatelane.cf45aa34.png"/></p><ol start="2"><li><code>对比更新</code>没有直接调用<!-- --><code>performSyncWorkOnRoot</code>, 而是通过调度中心来处理, 由于本示例是在<!-- --><code>Legacy</code>模式下进行, 最后会同步执行<!-- --><code>performSyncWorkOnRoot</code>.(详细原理可以参考<!-- --><a href="/main/scheduler">React 调度原理(scheduler)</a>). 所以其调用链路<!-- --><code>performSyncWorkOnRoot---&gt;renderRootSync---&gt;workLoopSync</code>与<!-- --><code>初次构造</code>中的一致.<!-- --></li></ol><p>在<!-- --><a href="https://github.com/facebook/react/blob/v17.0.2/packages/react-reconciler/src/ReactFiberWorkLoop.old.js#L1490-L1553">renderRootSync</a>中:<!-- --></p><div class="dumi-default-source-code"><button type="button" class="dumi-default-source-code-copy"><svg viewBox="64 64 896 896"><path d="M832 64H296c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h496v688c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8V96c0-17.7-14.3-32-32-32zM704 192H192c-17.7 0-32 14.3-32 32v530.7c0 8.5 3.4 16.6 9.4 22.6l173.3 173.3c2.2 2.2 4.7 4 7.4 5.5v1.9h4.2c3.5 1.3 7.2 2 11 2H704c17.7 0 32-14.3 32-32V224c0-17.7-14.3-32-32-32zM350 856.2 263.9 770H350v86.2zM664 888H414V746c0-22.1-17.9-40-40-40H232V264h432v624z"></path></svg></button><pre class="prism-code language-js"><div class=""><div class=""><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">renderRootSync</span><span class="token punctuation">(</span><span class="token parameter literal-property property">root</span><span class="token parameter operator">:</span><span class="token parameter"> </span><span class="token parameter maybe-class-name">FiberRoot</span><span class="token parameter punctuation">,</span><span class="token parameter"> </span><span class="token parameter literal-property property">lanes</span><span class="token parameter operator">:</span><span class="token parameter"> </span><span class="token parameter maybe-class-name">Lanes</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> prevExecutionContext </span><span class="token operator">=</span><span class="token plain"> executionContext</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  executionContext </span><span class="token operator">|=</span><span class="token plain"> </span><span class="token maybe-class-name">RenderContext</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token comment">// 如果fiberRoot变动, 或者update.lane变动, 都会刷新栈帧, 丢 弃上一次渲染进度</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">workInProgressRoot </span><span class="token operator">!==</span><span class="token plain"> root </span><span class="token operator">||</span><span class="token plain"> workInProgressRootRenderLanes </span><span class="token operator">!==</span><span class="token plain"> lanes</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token comment">// 刷新栈帧, legacy模式下都会进入</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token function">prepareFreshStack</span><span class="token punctuation">(</span><span class="token plain">root</span><span class="token punctuation">,</span><span class="token plain"> lanes</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword control-flow">do</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token keyword control-flow">try</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token function">workLoopSync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token keyword control-flow">break</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword control-flow">catch</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">thrownValue</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token function">handleError</span><span class="token punctuation">(</span><span class="token plain">root</span><span class="token punctuation">,</span><span class="token plain"> thrownValue</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword control-flow">while</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  executionContext </span><span class="token operator">=</span><span class="token plain"> prevExecutionContext</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token comment">// 重置全局变量, 表明render结束</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  workInProgressRoot </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  workInProgressRootRenderLanes </span><span class="token operator">=</span><span class="token plain"> </span><span class="token maybe-class-name">NoLanes</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword control-flow">return</span><span class="token plain"> workInProgressRootExitStatus</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token punctuation">}</span></div></div></pre></div><p>进入循环构造(<!-- --><code>workLoopSync</code>)前, 会刷新栈帧(调用<!-- --><code>prepareFreshStack</code>)(参考<!-- --><a href="/main/fibertree-prepare#%E6%A0%88%E5%B8%A7%E7%AE%A1%E7%90%86">fiber 树构造(基础准备)</a>中<!-- --><code>栈帧管理</code>).<!-- --></p><p>此时的内存结构如下:</p><p><img alt="" src="/static/status-refreshstack.df5d88d5.png"/></p><p>注意:</p><ul><li><code>fiberRoot.current</code>指向与当前页面对应的<!-- --><code>fiber树</code>, <!-- --><code>workInProgress</code>指向正在构造的<!-- --><code>fiber树</code>.<!-- --></li><li>刷新栈帧会调用<!-- --><code>createWorkInProgress()</code>, 使得<!-- --><code>workInProgress.flags和workInProgress.effects</code>都已经被重置. 且<!-- --><code>workInProgress.child = current.child</code>. 所以在进入<!-- --><code>循环构造</code>之前, <!-- --><code>HostRootFiber</code>与<!-- --><code>HostRootFiber.alternate</code>共用一个<!-- --><code>child</code>(这里是<!-- --><code>fiber(&lt;App/&gt;)</code>).<!-- --></li></ul><h3 id="循环构造"><a aria-hidden="true" tabindex="-1" href="#循环构造"><span class="icon icon-link"></span></a>循环构造<!-- --></h3><p>回顾一下<!-- --><a href="/main/fibertree-create">fiber 树构造(初次创建)</a>中的介绍. 整个<!-- --><code>fiber树构造</code>是一个深度优先遍历(可参考<!-- --><a href="/algorithm/dfs">React 算法之深度优先遍历</a>), 其中有 2 个重要的变量<!-- --><code>workInProgress</code>和<!-- --><code>current</code>(可参考<!-- --><a href="/main/fibertree-prepare#%E5%8F%8C%E7%BC%93%E5%86%B2%E6%8A%80%E6%9C%AF">fiber 树构造(基础准备)</a>中介绍的<!-- --><code>双缓冲技术</code>):<!-- --></p><ul><li><code>workInProgress</code>和<!-- --><code>current</code>都视为指针<!-- --></li><li><code>workInProgress</code>指向当前正在构造的<!-- --><code>fiber</code>节点<!-- --></li><li><code>current = workInProgress.alternate</code>(即<!-- --><code>fiber.alternate</code>), 指向当前页面正在使用的<!-- --><code>fiber</code>节点.<!-- --></li></ul><p>在深度优先遍历中, 每个<!-- --><code>fiber</code>节点都会经历 2 个阶段:<!-- --></p><ol><li>探寻阶段 <!-- --><code>beginWork</code></li><li>回溯阶段 <!-- --><code>completeWork</code></li></ol><p>这 2 个阶段共同完成了每一个<!-- --><code>fiber</code>节点的创建(或更新), 所有<!-- --><code>fiber</code>节点则构成了<!-- --><code>fiber树</code>.<!-- --></p><div class="dumi-default-source-code"><button type="button" class="dumi-default-source-code-copy"><svg viewBox="64 64 896 896"><path d="M832 64H296c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h496v688c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8V96c0-17.7-14.3-32-32-32zM704 192H192c-17.7 0-32 14.3-32 32v530.7c0 8.5 3.4 16.6 9.4 22.6l173.3 173.3c2.2 2.2 4.7 4 7.4 5.5v1.9h4.2c3.5 1.3 7.2 2 11 2H704c17.7 0 32-14.3 32-32V224c0-17.7-14.3-32-32-32zM350 856.2 263.9 770H350v86.2zM664 888H414V746c0-22.1-17.9-40-40-40H232V264h432v624z"></path></svg></button><pre class="prism-code language-js"><div class=""><div class=""><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">workLoopSync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword control-flow">while</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">workInProgress </span><span class="token operator">!==</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token function">performUnitOfWork</span><span class="token punctuation">(</span><span class="token plain">workInProgress</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">
</span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token comment">// ... 省略部分无关代码</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">performUnitOfWork</span><span class="token punctuation">(</span><span class="token parameter literal-property property">unitOfWork</span><span class="token parameter operator">:</span><span class="token parameter"> </span><span class="token parameter maybe-class-name">Fiber</span><span class="token punctuation">)</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword">void</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token comment">// unitOfWork就是被传入的workInProgress</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> current </span><span class="token operator">=</span><span class="token plain"> unitOfWork</span><span class="token punctuation">.</span><span class="token property-access">alternate</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword">let</span><span class="token plain"> next</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  next </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">beginWork</span><span class="token punctuation">(</span><span class="token plain">current</span><span class="token punctuation">,</span><span class="token plain"> unitOfWork</span><span class="token punctuation">,</span><span class="token plain"> subtreeRenderLanes</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  unitOfWork</span><span class="token punctuation">.</span><span class="token property-access">memoizedProps</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> unitOfWork</span><span class="token punctuation">.</span><span class="token property-access">pendingProps</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">next </span><span class="token operator">===</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token comment">// 如果没有派生出新的节点, 则进入completeWork阶段, 传入的是当前unitOfWork</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token function">completeUnitOfWork</span><span class="token punctuation">(</span><span class="token plain">unitOfWork</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword control-flow">else</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    workInProgress </span><span class="token operator">=</span><span class="token plain"> next</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token punctuation">}</span></div></div></pre></div><p>注意: 在<!-- --><code>对比更新</code>过程中<!-- --><code>current = unitOfWork.alternate;</code>不为<!-- --><code>null</code>, 后续的调用逻辑中会大量使用此处传入的<!-- --><code>current</code>.<!-- --></p><h3 id="探寻阶段-beginwork"><a aria-hidden="true" tabindex="-1" href="#探寻阶段-beginwork"><span class="icon icon-link"></span></a>探寻阶段 beginWork<!-- --></h3><p><code>beginWork(current, unitOfWork, subtreeRenderLanes)</code>(<!-- --><a href="https://github.com/facebook/react/blob/v17.0.2/packages/react-reconciler/src/ReactFiberBeginWork.old.js#L3083-L3494">源码地址</a>).<!-- --></p><div class="dumi-default-source-code"><button type="button" class="dumi-default-source-code-copy"><svg viewBox="64 64 896 896"><path d="M832 64H296c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h496v688c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8V96c0-17.7-14.3-32-32-32zM704 192H192c-17.7 0-32 14.3-32 32v530.7c0 8.5 3.4 16.6 9.4 22.6l173.3 173.3c2.2 2.2 4.7 4 7.4 5.5v1.9h4.2c3.5 1.3 7.2 2 11 2H704c17.7 0 32-14.3 32-32V224c0-17.7-14.3-32-32-32zM350 856.2 263.9 770H350v86.2zM664 888H414V746c0-22.1-17.9-40-40-40H232V264h432v624z"></path></svg></button><pre class="prism-code language-js"><div class=""><div class=""><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">beginWork</span><span class="token punctuation">(</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token parameter literal-property property">current</span><span class="token parameter operator">:</span><span class="token parameter"> </span><span class="token parameter maybe-class-name">Fiber</span><span class="token parameter"> </span><span class="token parameter operator">|</span><span class="token parameter"> </span><span class="token parameter keyword null nil">null</span><span class="token parameter punctuation">,</span><span class="token parameter"></span></div></div><div class=""><div class=""><span class="token parameter">  </span><span class="token parameter literal-property property">workInProgress</span><span class="token parameter operator">:</span><span class="token parameter"> </span><span class="token parameter maybe-class-name">Fiber</span><span class="token parameter punctuation">,</span><span class="token parameter"></span></div></div><div class=""><div class=""><span class="token parameter">  </span><span class="token parameter literal-property property">renderLanes</span><span class="token parameter operator">:</span><span class="token parameter"> </span><span class="token parameter maybe-class-name">Lanes</span><span class="token parameter punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token punctuation">)</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">Fiber</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> updateLanes </span><span class="token operator">=</span><span class="token plain"> workInProgress</span><span class="token punctuation">.</span><span class="token property-access">lanes</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">current </span><span class="token operator">!==</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token comment">// 进入对比</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token keyword">const</span><span class="token plain"> oldProps </span><span class="token operator">=</span><span class="token plain"> current</span><span class="token punctuation">.</span><span class="token property-access">memoizedProps</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token keyword">const</span><span class="token plain"> newProps </span><span class="token operator">=</span><span class="token plain"> workInProgress</span><span class="token punctuation">.</span><span class="token property-access">pendingProps</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      oldProps </span><span class="token operator">!==</span><span class="token plain"> newProps </span><span class="token operator">||</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token function">hasLegacyContextChanged</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token operator">||</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token punctuation">(</span><span class="token plain">__DEV__ </span><span class="token operator">?</span><span class="token plain"> workInProgress</span><span class="token punctuation">.</span><span class="token property-access">type</span><span class="token plain"> </span><span class="token operator">!==</span><span class="token plain"> current</span><span class="token punctuation">.</span><span class="token property-access">type</span><span class="token plain"> </span><span class="token operator">:</span><span class="token plain"> </span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      didReceiveUpdate </span><span class="token operator">=</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword control-flow">else</span><span class="token plain"> </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">includesSomeLane</span><span class="token punctuation">(</span><span class="token plain">renderLanes</span><span class="token punctuation">,</span><span class="token plain"> updateLanes</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token comment">// 当前渲染优先级renderLanes不包括fiber.lanes, 表明当前fiber节点无需更新</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      didReceiveUpdate </span><span class="token operator">=</span><span class="token plain"> </span><span class="token boolean">false</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token keyword control-flow">switch</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">        workInProgress</span><span class="token punctuation">.</span><span class="token property-access">tag</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">        </span><span class="token comment">// switch 语句中包括 context相关逻辑, 本节暂不讨论(不影响分析fiber树构造)</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token comment">// 当前fiber节点无需更新, 调用bailoutOnAlreadyFinishedWork循环检测子节点是否需要更新</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token keyword control-flow">return</span><span class="token plain"> </span><span class="token function">bailoutOnAlreadyFinishedWork</span><span class="token punctuation">(</span><span class="token plain">current</span><span class="token punctuation">,</span><span class="token plain"> workInProgress</span><span class="token punctuation">,</span><span class="token plain"> renderLanes</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token comment">// 余下逻辑与初次创建共用</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token comment">// 1. 设置workInProgress优先级为NoLanes(最高优先级)</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  workInProgress</span><span class="token punctuation">.</span><span class="token property-access">lanes</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token maybe-class-name">NoLanes</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token comment">// 2. 根据workInProgress节点的类型, 用不同的方法派生出子节点</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword control-flow">switch</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    workInProgress</span><span class="token punctuation">.</span><span class="token property-access">tag</span><span class="token plain"> </span><span class="token comment">// 只列出部分case</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token keyword">case</span><span class="token plain"> </span><span class="token literal-property property">ClassComponent</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token keyword">const</span><span class="token plain"> </span><span class="token maybe-class-name">Component</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> workInProgress</span><span class="token punctuation">.</span><span class="token property-access">type</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token keyword">const</span><span class="token plain"> unresolvedProps </span><span class="token operator">=</span><span class="token plain"> workInProgress</span><span class="token punctuation">.</span><span class="token property-access">pendingProps</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token keyword">const</span><span class="token plain"> resolvedProps </span><span class="token operator">=</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">        workInProgress</span><span class="token punctuation">.</span><span class="token property-access">elementType</span><span class="token plain"> </span><span class="token operator">===</span><span class="token plain"> </span><span class="token maybe-class-name">Component</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">          </span><span class="token operator">?</span><span class="token plain"> unresolvedProps</span></div></div><div class=""><div class=""><span class="token plain">          </span><span class="token operator">:</span><span class="token plain"> </span><span class="token function">resolveDefaultProps</span><span class="token punctuation">(</span><span class="token maybe-class-name">Component</span><span class="token punctuation">,</span><span class="token plain"> unresolvedProps</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token keyword control-flow">return</span><span class="token plain"> </span><span class="token function">updateClassComponent</span><span class="token punctuation">(</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">        current</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">        workInProgress</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">        </span><span class="token maybe-class-name">Component</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">        resolvedProps</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">        renderLanes</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token keyword">case</span><span class="token plain"> </span><span class="token literal-property property">HostRoot</span><span class="token operator">:</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token keyword control-flow">return</span><span class="token plain"> </span><span class="token function">updateHostRoot</span><span class="token punctuation">(</span><span class="token plain">current</span><span class="token punctuation">,</span><span class="token plain"> workInProgress</span><span class="token punctuation">,</span><span class="token plain"> renderLanes</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token keyword">case</span><span class="token plain"> </span><span class="token literal-property property">HostComponent</span><span class="token operator">:</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token keyword control-flow">return</span><span class="token plain"> </span><span class="token function">updateHostComponent</span><span class="token punctuation">(</span><span class="token plain">current</span><span class="token punctuation">,</span><span class="token plain"> workInProgress</span><span class="token punctuation">,</span><span class="token plain"> renderLanes</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token keyword">case</span><span class="token plain"> </span><span class="token literal-property property">HostText</span><span class="token operator">:</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token keyword control-flow">return</span><span class="token plain"> </span><span class="token function">updateHostText</span><span class="token punctuation">(</span><span class="token plain">current</span><span class="token punctuation">,</span><span class="token plain"> workInProgress</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token keyword">case</span><span class="token plain"> </span><span class="token literal-property property">Fragment</span><span class="token operator">:</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token keyword control-flow">return</span><span class="token plain"> </span><span class="token function">updateFragment</span><span class="token punctuation">(</span><span class="token plain">current</span><span class="token punctuation">,</span><span class="token plain"> workInProgress</span><span class="token punctuation">,</span><span class="token plain"> renderLanes</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token punctuation">}</span></div></div></pre></div><h4 id="bailout逻辑-bailout"><a aria-hidden="true" tabindex="-1" href="#bailout逻辑-bailout"><span class="icon icon-link"></span></a><code>bailout</code>逻辑 {#bailout}<!-- --></h4><blockquote><p><code>bail out</code>英文短语翻译为<!-- --><code>解救, 纾困</code>, 在源码中, <!-- --><code>bailout</code>用于判断子树节点是否完全复用, 如果可以复用, 则会略过 fiber 树构造.<!-- --></p></blockquote><p>与<!-- --><code>初次创建</code>不同, 在<!-- --><code>对比更新</code>过程中, 如果是<!-- --><code>老节点</code>, 那么<!-- --><code>current !== null</code>, 需要进行对比, 然后决定是否复用老节点及其子树(即<!-- --><code>bailout</code>逻辑).<!-- --></p><ol><li><code>!includesSomeLane(renderLanes, updateLanes)</code>这个判断分支, 包含了<!-- --><code>渲染优先级</code>和<!-- --><code>update优先级</code>的比较(详情可以回顾<!-- --><a href="/main/fibertree-prepare#%E4%BC%98%E5%85%88%E7%BA%A7">fiber 树构造(基础准备)</a>中<!-- --><code>优先级</code>相关解读), 如果当前节点无需更新, 则会进入<!-- --><code>bailout</code>逻辑.<!-- --></li><li>最后会调用<!-- --><code>bailoutOnAlreadyFinishedWork</code>:
<!-- --><ul><li>如果同时满足<!-- --><code>!includesSomeLane(renderLanes, workInProgress.childLanes)</code>, 表明该 fiber 节点及其子树都无需更新, 可直接进入回溯阶段(<!-- --><code>completeUnitOfWork</code>)<!-- --></li><li>如果不满足<!-- --><code>!includesSomeLane(renderLanes, workInProgress.childLanes)</code>, 意味着子节点需要更新, <!-- --><code>clone</code>并返回子节点.<!-- --></li></ul></li></ol><div class="dumi-default-source-code"><button type="button" class="dumi-default-source-code-copy"><svg viewBox="64 64 896 896"><path d="M832 64H296c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h496v688c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8V96c0-17.7-14.3-32-32-32zM704 192H192c-17.7 0-32 14.3-32 32v530.7c0 8.5 3.4 16.6 9.4 22.6l173.3 173.3c2.2 2.2 4.7 4 7.4 5.5v1.9h4.2c3.5 1.3 7.2 2 11 2H704c17.7 0 32-14.3 32-32V224c0-17.7-14.3-32-32-32zM350 856.2 263.9 770H350v86.2zM664 888H414V746c0-22.1-17.9-40-40-40H232V264h432v624z"></path></svg></button><pre class="prism-code language-js"><div class=""><div class=""><span class="token comment">// 省略部分无关代码</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">bailoutOnAlreadyFinishedWork</span><span class="token punctuation">(</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token parameter literal-property property">current</span><span class="token parameter operator">:</span><span class="token parameter"> </span><span class="token parameter maybe-class-name">Fiber</span><span class="token parameter"> </span><span class="token parameter operator">|</span><span class="token parameter"> </span><span class="token parameter keyword null nil">null</span><span class="token parameter punctuation">,</span><span class="token parameter"></span></div></div><div class=""><div class=""><span class="token parameter">  </span><span class="token parameter literal-property property">workInProgress</span><span class="token parameter operator">:</span><span class="token parameter"> </span><span class="token parameter maybe-class-name">Fiber</span><span class="token parameter punctuation">,</span><span class="token parameter"></span></div></div><div class=""><div class=""><span class="token parameter">  </span><span class="token parameter literal-property property">renderLanes</span><span class="token parameter operator">:</span><span class="token parameter"> </span><span class="token parameter maybe-class-name">Lanes</span><span class="token parameter punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token punctuation">)</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">Fiber</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">includesSomeLane</span><span class="token punctuation">(</span><span class="token plain">renderLanes</span><span class="token punctuation">,</span><span class="token plain"> workInProgress</span><span class="token punctuation">.</span><span class="token property-access">childLanes</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token comment">// 渲染优先级不包括 workInProgress.childLanes, 表明子节点也无需更新. 返回null, 直接进入回溯阶段.</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token keyword control-flow">return</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword control-flow">else</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token comment">// 本fiber虽然不用更新, 但是子节点需要更新. clone并返回子节点</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token function">cloneChildFibers</span><span class="token punctuation">(</span><span class="token plain">current</span><span class="token punctuation">,</span><span class="token plain"> workInProgress</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token keyword control-flow">return</span><span class="token plain"> workInProgress</span><span class="token punctuation">.</span><span class="token property-access">child</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token punctuation">}</span></div></div></pre></div><p>注意: <!-- --><code>cloneChildFibers</code>内部调用<!-- --><code>createWorkInProgress</code>, 在构造<!-- --><code>fiber</code>节点时会优先复用<!-- --><code>workInProgress.alternate</code>(不开辟新的内存空间), 否则才会创建新的<!-- --><code>fiber</code>对象.<!-- --></p><h4 id="updatexxx函数"><a aria-hidden="true" tabindex="-1" href="#updatexxx函数"><span class="icon icon-link"></span></a><code>updateXXX</code>函数<!-- --></h4><p><code>updateXXX</code>函数(如: updateHostRoot, updateClassComponent 等)的主干逻辑与<!-- --><code>初次构造</code>过程完全一致, 总的目的是为了向下生成子节点, 并在这个过程中调用<!-- --><code>reconcileChildren</code>调和函数, 只要<!-- --><code>fiber</code>节点有副作用, 就  会把特殊操作设置到<!-- --><code>fiber.flags</code>(如:<!-- --><code>节点ref</code>,<!-- --><code>class组件的生命周期</code>,<!-- --><code>function组件的hook</code>,<!-- --><code>节点删除</code>等).<!-- --></p><p><code>对比更新</code>过程的不同之处:<!-- --></p><ol><li><code>bailoutOnAlreadyFinishedWork</code><ul><li><code>对比更新</code>时如果遇到当前节点无需更新(如: <!-- --><code>class</code>类型的节点且<!-- --><code>shouldComponentUpdate</code>返回<!-- --><code>false</code>), 会再次进入<!-- --><code>bailout</code>逻辑.<!-- --></li></ul></li><li><code>reconcileChildren</code>调和函数
<!-- --><ul><li>调和函数是<!-- --><code>updateXXX</code>函数中的一项重要逻辑, 它的作用是向下生成子节点, 并设置<!-- --><code>fiber.flags</code>.<!-- --></li><li><code>初次创建</code>时<!-- --><code>fiber</code>节点没有比较对象, 所以在向下生成子节点的时候没有任何多余的逻辑, 只管创建就行.<!-- --></li><li><code>对比更新</code>时需要把<!-- --><code>ReactElement</code>对象与<!-- --><code>旧fiber</code>对象进行比较, 来判断是否需要复用<!-- --><code>旧fiber</code>对象.<!-- --></li></ul></li></ol><p>注: 本节的重点是<!-- --><code>fiber树构造</code>, 在<!-- --><code>对比更新</code>过程中<!-- --><code>reconcileChildren()函数</code>实现的<!-- --><code>diff</code>算法十分重要, 但是它只是处于算法层面, 对于<!-- --><code>diff</code>算法的实现,在<!-- --><a href="/algorithm/diff">React 算法之调和算法</a>中单独分析.<!-- --></p><p>本节只需要先了解调和函数目的:</p><ol><li>给新增,移动,和删除节点设置<!-- --><code>fiber.flags</code>(新增,移动: <!-- --><code>Placement</code>, 删除: <!-- --><code>Deletion</code>)<!-- --></li><li>如果是需要删除的<!-- --><code>fiber</code>, <!-- --><a href="https://github.com/facebook/react/blob/v17.0.2/packages/react-reconciler/src/ReactChildFiber.old.js#L275-L294">除了自身打上<!-- --><code>Deletion</code>之外, 还要将其添加到父节点的<!-- --><code>effects</code>链表中<!-- --></a>(正常副作用队列的处理是在<!-- --><code>completeWork</code>函数, 但是该节点(被删除)会脱离<!-- --><code>fiber</code>树, 不会再进入<!-- --><code>completeWork</code>阶段, 所以在<!-- --><code>beginWork</code>阶段提前加入副作用队列).<!-- --></li></ol><h3 id="回溯阶段-completework"><a aria-hidden="true" tabindex="-1" href="#回溯阶段-completework"><span class="icon icon-link"></span></a>回溯阶段 completeWork<!-- --></h3><p><code>completeUnitOfWork(unitOfWork)函数</code>(<!-- --><a href="https://github.com/facebook/react/blob/v17.0.2/packages/react-reconciler/src/ReactFiberWorkLoop.old.js#L1670-L1802">源码地址</a>)在<!-- --><code>初次创建</code>和<!-- --><code>对比更新</code>逻辑一致, 都是处理<!-- --><code>beginWork</code> 阶段已经创建出来的 <!-- --><code>fiber</code> 节点, 最后创建(更新)DOM 对象, 并上移副作用队列.<!-- --></p><p>在这里我们重点关注<!-- --><code>completeWork</code>函数中, <!-- --><code>current !== null</code>的情况:<!-- --></p><div class="dumi-default-source-code"><button type="button" class="dumi-default-source-code-copy"><svg viewBox="64 64 896 896"><path d="M832 64H296c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h496v688c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8V96c0-17.7-14.3-32-32-32zM704 192H192c-17.7 0-32 14.3-32 32v530.7c0 8.5 3.4 16.6 9.4 22.6l173.3 173.3c2.2 2.2 4.7 4 7.4 5.5v1.9h4.2c3.5 1.3 7.2 2 11 2H704c17.7 0 32-14.3 32-32V224c0-17.7-14.3-32-32-32zM350 856.2 263.9 770H350v86.2zM664 888H414V746c0-22.1-17.9-40-40-40H232V264h432v624z"></path></svg></button><pre class="prism-code language-js"><div class=""><div class=""><span class="token comment">// ...省略无关代码</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">completeWork</span><span class="token punctuation">(</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token parameter literal-property property">current</span><span class="token parameter operator">:</span><span class="token parameter"> </span><span class="token parameter maybe-class-name">Fiber</span><span class="token parameter"> </span><span class="token parameter operator">|</span><span class="token parameter"> </span><span class="token parameter keyword null nil">null</span><span class="token parameter punctuation">,</span><span class="token parameter"></span></div></div><div class=""><div class=""><span class="token parameter">  </span><span class="token parameter literal-property property">workInProgress</span><span class="token parameter operator">:</span><span class="token parameter"> </span><span class="token parameter maybe-class-name">Fiber</span><span class="token parameter punctuation">,</span><span class="token parameter"></span></div></div><div class=""><div class=""><span class="token parameter">  </span><span class="token parameter literal-property property">renderLanes</span><span class="token parameter operator">:</span><span class="token parameter"> </span><span class="token parameter maybe-class-name">Lanes</span><span class="token parameter punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token punctuation">)</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">Fiber</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> newProps </span><span class="token operator">=</span><span class="token plain"> workInProgress</span><span class="token punctuation">.</span><span class="token property-access">pendingProps</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword control-flow">switch</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">workInProgress</span><span class="token punctuation">.</span><span class="token property-access">tag</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token keyword">case</span><span class="token plain"> </span><span class="token literal-property property">HostComponent</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token comment">// 非文本节点</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token function">popHostContext</span><span class="token punctuation">(</span><span class="token plain">workInProgress</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token keyword">const</span><span class="token plain"> rootContainerInstance </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">getRootHostContainer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token keyword">const</span><span class="token plain"> type </span><span class="token operator">=</span><span class="token plain"> workInProgress</span><span class="token punctuation">.</span><span class="token property-access">type</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">current </span><span class="token operator">!==</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"> </span><span class="token operator">&amp;&amp;</span><span class="token plain"> workInProgress</span><span class="token punctuation">.</span><span class="token property-access">stateNode</span><span class="token plain"> </span><span class="token operator">!=</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">        </span><span class="token comment">// 处理改动</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">        </span><span class="token function">updateHostComponent</span><span class="token punctuation">(</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">          current</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">          workInProgress</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">          type</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">          newProps</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">          rootContainerInstance</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">        </span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">        </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">current</span><span class="token punctuation">.</span><span class="token property-access">ref</span><span class="token plain"> </span><span class="token operator">!==</span><span class="token plain"> workInProgress</span><span class="token punctuation">.</span><span class="token property-access">ref</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">          </span><span class="token function">markRef</span><span class="token punctuation">(</span><span class="token plain">workInProgress</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">        </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword control-flow">else</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">        </span><span class="token comment">// ...省略无关代码</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token keyword control-flow">return</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token keyword">case</span><span class="token plain"> </span><span class="token literal-property property">HostText</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token comment">// 文本节点</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token keyword">const</span><span class="token plain"> newText </span><span class="token operator">=</span><span class="token plain"> newProps</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">current </span><span class="token operator">&amp;&amp;</span><span class="token plain"> workInProgress</span><span class="token punctuation">.</span><span class="token property-access">stateNode</span><span class="token plain"> </span><span class="token operator">!=</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">        </span><span class="token keyword">const</span><span class="token plain"> oldText </span><span class="token operator">=</span><span class="token plain"> current</span><span class="token punctuation">.</span><span class="token property-access">memoizedProps</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">        </span><span class="token comment">// 处理改动</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">        </span><span class="token function">updateHostText</span><span class="token punctuation">(</span><span class="token plain">current</span><span class="token punctuation">,</span><span class="token plain"> workInProgress</span><span class="token punctuation">,</span><span class="token plain"> oldText</span><span class="token punctuation">,</span><span class="token plain"> newText</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword control-flow">else</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">        </span><span class="token comment">// ...省略无关代码</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token keyword control-flow">return</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token punctuation">}</span></div></div></pre></div><div class="dumi-default-source-code"><button type="button" class="dumi-default-source-code-copy"><svg viewBox="64 64 896 896"><path d="M832 64H296c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h496v688c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8V96c0-17.7-14.3-32-32-32zM704 192H192c-17.7 0-32 14.3-32 32v530.7c0 8.5 3.4 16.6 9.4 22.6l173.3 173.3c2.2 2.2 4.7 4 7.4 5.5v1.9h4.2c3.5 1.3 7.2 2 11 2H704c17.7 0 32-14.3 32-32V224c0-17.7-14.3-32-32-32zM350 856.2 263.9 770H350v86.2zM664 888H414V746c0-22.1-17.9-40-40-40H232V264h432v624z"></path></svg></button><pre class="prism-code language-js"><div class=""><div class=""><span class="token function-variable function">updateHostComponent</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token parameter literal-property property">current</span><span class="token parameter operator">:</span><span class="token parameter"> </span><span class="token parameter maybe-class-name">Fiber</span><span class="token parameter punctuation">,</span><span class="token parameter"></span></div></div><div class=""><div class=""><span class="token parameter">  </span><span class="token parameter literal-property property">workInProgress</span><span class="token parameter operator">:</span><span class="token parameter"> </span><span class="token parameter maybe-class-name">Fiber</span><span class="token parameter punctuation">,</span><span class="token parameter"></span></div></div><div class=""><div class=""><span class="token parameter">  </span><span class="token parameter literal-property property">type</span><span class="token parameter operator">:</span><span class="token parameter"> </span><span class="token parameter maybe-class-name">Type</span><span class="token parameter punctuation">,</span><span class="token parameter"></span></div></div><div class=""><div class=""><span class="token parameter">  </span><span class="token parameter literal-property property">newProps</span><span class="token parameter operator">:</span><span class="token parameter"> </span><span class="token parameter maybe-class-name">Props</span><span class="token parameter punctuation">,</span><span class="token parameter"></span></div></div><div class=""><div class=""><span class="token parameter">  </span><span class="token parameter literal-property property">rootContainerInstance</span><span class="token parameter operator">:</span><span class="token parameter"> </span><span class="token parameter maybe-class-name">Container</span><span class="token parameter punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> oldProps </span><span class="token operator">=</span><span class="token plain"> current</span><span class="token punctuation">.</span><span class="token property-access">memoizedProps</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">oldProps </span><span class="token operator">===</span><span class="token plain"> newProps</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token keyword control-flow">return</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> </span><span class="token literal-property property">instance</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">Instance</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> workInProgress</span><span class="token punctuation">.</span><span class="token property-access">stateNode</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> currentHostContext </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">getHostContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> updatePayload </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">prepareUpdate</span><span class="token punctuation">(</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    instance</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    type</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    oldProps</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    newProps</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    rootContainerInstance</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    currentHostContext</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  workInProgress</span><span class="token punctuation">.</span><span class="token property-access">updateQueue</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">updatePayload</span><span class="token operator">:</span><span class="token plain"> any</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token comment">// 如果有属性变动, 设置fiber.flags |= Update, 等待`commit`阶段的处理</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">updatePayload</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token function">markUpdate</span><span class="token punctuation">(</span><span class="token plain">workInProgress</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token function-variable function">updateHostText</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token parameter literal-property property">current</span><span class="token parameter operator">:</span><span class="token parameter"> </span><span class="token parameter maybe-class-name">Fiber</span><span class="token parameter punctuation">,</span><span class="token parameter"></span></div></div><div class=""><div class=""><span class="token parameter">  </span><span class="token parameter literal-property property">workInProgress</span><span class="token parameter operator">:</span><span class="token parameter"> </span><span class="token parameter maybe-class-name">Fiber</span><span class="token parameter punctuation">,</span><span class="token parameter"></span></div></div><div class=""><div class=""><span class="token parameter">  </span><span class="token parameter literal-property property">oldText</span><span class="token parameter operator">:</span><span class="token parameter"> string</span><span class="token parameter punctuation">,</span><span class="token parameter"></span></div></div><div class=""><div class=""><span class="token parameter">  </span><span class="token parameter literal-property property">newText</span><span class="token parameter operator">:</span><span class="token parameter"> string</span><span class="token parameter punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token comment">// 如果有属性变动, 设置fiber.flags |= Update, 等待`commit`阶段的处理</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">oldText </span><span class="token operator">!==</span><span class="token plain"> newText</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token function">markUpdate</span><span class="token punctuation">(</span><span class="token plain">workInProgress</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">;</span></div></div></pre></div><p>可以看到在更新过程中, 如果 DOM 属性有变化, 不会再次新建 DOM 对象, 而是设置<!-- --><code>fiber.flags |= Update</code>, 等待<!-- --><code>commit</code>阶段处理(<!-- --><a href="https://github.com/facebook/react/blob/v17.0.2/packages/react-reconciler/src/ReactFiberCompleteWork.old.js#L197-L248">源码链接</a>).<!-- --></p><h3 id="过程图解"><a aria-hidden="true" tabindex="-1" href="#过程图解"><span class="icon icon-link"></span></a>过程图解<!-- --></h3><p>针对本节的示例代码, 将整个<!-- --><code>fiber</code>树构造过程表示出来:<!-- --></p><p>构造前:</p><p>在上文已经说明, 进入循环构造前会调用<!-- --><code>prepareFreshStack</code>刷新栈帧, 在进入<!-- --><code>fiber树构造</code>循环之前, 保持这这个初始化状态:<!-- --></p><p><img alt="" src="/static/unitofwork0.78707272.png"/></p><p><code>performUnitOfWork</code>第 1 次调用(只执行<!-- --><code>beginWork</code>):<!-- --></p><ul><li>执行前: <!-- --><code>workInProgress</code>指向<!-- --><code>HostRootFiber.alternate</code>对象, 此时<!-- --><code>current = workInProgress.alternate</code>指向当前页面对应的<!-- --><code>fiber</code>树.<!-- --></li><li>执行过程:
<!-- --><ul><li>因为<!-- --><code>current !== null</code>且当前节点<!-- --><code>fiber.lanes</code>不在<!-- --><code>渲染优先级</code> 范围内, 故进入<!-- --><code>bailoutOnAlreadyFinishedWork</code>逻辑<!-- --></li><li>又因为<!-- --><code>fiber.childLanes</code>处于<!-- --><code>渲染优先级</code>范围内, 证明<!-- --><code>child</code>节点需要更新, 克隆<!-- --><code>workInProgress.child</code>节点.<!-- --></li><li><code>clone</code>之后, <!-- --><code>新fiber</code>节点会丢弃<!-- --><code>旧fiber</code>上的标志位(<!-- --><code>flags</code>)和副作用(<!-- --><code>effects</code>), 其他属性会继续保留.<!-- --></li></ul></li><li>执行后: 返回被<!-- --><code>clone</code>的下级节点<!-- --><code>fiber(&lt;App/&gt;)</code>, 移动<!-- --><code>workInProgress</code>指向子节点<!-- --><code>fiber(&lt;App/&gt;)</code></li></ul><p><img alt="" src="/static/unitofwork1.0604e1ce.png"/></p><p><code>performUnitOfWork</code>第 2 次调用(只执行<!-- --><code>beginWork</code>):<!-- --></p><ul><li>执行前: <!-- --><code>workInProgress</code>指向<!-- --><code>fiber(&lt;App/&gt;)</code>节点, 且<!-- --><code>current = workInProgress.alternate</code>有值<!-- --></li><li>执行过程:
<!-- --><ul><li>当前节点<!-- --><code>fiber.lanes</code>处于<!-- --><code>渲染优先级</code>范围内, 会进入<!-- --><code>updateClassComponent()</code>函数<!-- --></li><li>在<!-- --><code>updateClassComponent()</code>函数中, 调用<!-- --><code>reconcileChildren()</code>生成下级子节点.<!-- --></li></ul></li><li>执行后: 返回下级节点<!-- --><code>fiber(&lt;Header/&gt;)</code>, 移动<!-- --><code>workInProgress</code>指向子节点<!-- --><code>fiber(&lt;Header/&gt;)</code></li></ul><p><img alt="" src="/static/unitofwork2.c4531b59.png"/></p><p><code>performUnitOfWork</code>第 3 次调用(执行<!-- --><code>beginWork</code>和<!-- --><code>completeUnitOfWork</code>):<!-- --></p><ul><li><code>beginWork</code>执行前: <!-- --><code>workInProgress</code>指向<!-- --><code>fiber(&lt;Header/&gt;)</code>, 且<!-- --><code>current = workInProgress.alternate</code>有值<!-- --></li><li><code>beginWork</code>执行过程:
<!-- --><ul><li>当前节点<!-- --><code>fiber.lanes</code>处于<!-- --><code>渲染优先级</code>范围内, 会进入<!-- --><code>updateClassComponent()</code>函数<!-- --></li><li>在<!-- --><code>updateClassComponent()</code>函数中, 由于此组件是<!-- --><code>PureComponent</code>, <!-- --><code>shouldComponentUpdate</code>判定为<!-- --><code>false</code>,故进入<!-- --><code>bailoutOnAlreadyFinishedWork</code>逻辑.<!-- --></li><li>又因为<!-- --><code>fiber.childLanes</code>不在<!-- --><code>渲染优先级</code>范围内, 证明<!-- --><code>child</code>节点也不需要更新<!-- --></li></ul></li><li><code>beginWork</code>执行后: 因为完全满足<!-- --><code>bailout</code>逻辑, 返回<!-- --><code>null</code>. 所以进入<!-- --><code>completeUnitOfWork(unitOfWork)</code>函数, 传入的参数<!-- --><code>unitOfWork</code>实际上就是<!-- --><code>workInProgress</code>(此时指向<!-- --><code>fiber(&lt;Header/&gt;)</code>)<!-- --></li></ul><p><img alt="" src="/static/unitofwork3.0.738bf83b.png"/></p><ul><li><code>completeUnitOfWork</code>执行前: <!-- --><code>workInProgress</code>指向<!-- --><code>fiber(&lt;Header/&gt;)</code></li><li><code>completeUnitOfWork</code>执行过程: 以<!-- --><code>fiber(&lt;Header/&gt;)</code>为起点, 向上回溯<!-- --></li></ul><p><code>completeUnitOfWork</code>第 1 次循环:<!-- --></p><ol><li>执行<!-- --><code>completeWork</code>函数: <!-- --><code>class</code>类型的组件无需处理.<!-- --></li><li>上移副作用队列: 由于本节点<!-- --><code>fiber(header)</code>没有副作用(<!-- --><code>fiber.flags = 0</code>), 所以执行之后副作用队列没有实质变化(目前为空).<!-- --></li><li>向上回溯: 由于还有兄弟节点, 把<!-- --><code>workInProgress</code>指向下一个兄弟节点<!-- --><code>fiber(button)</code>, 退出<!-- --><code>completeUnitOfWork</code>.<!-- --></li></ol><p><img alt="" src="/static/unitofwork3.1.34d68584.png"/></p><p><code>performUnitOfWork</code>第 4 次调用(执行<!-- --><code>beginWork</code>和<!-- --><code>completeUnitOfWork</code>):<!-- --></p><ul><li><p><code>beginWork</code>执行过程: 调用<!-- --><code>updateHostComponent</code></p><ul><li>本示例中<!-- --><code>button</code>的子节点是一个<!-- --><a href="https://github.com/facebook/react/blob/8e5adfbd7e605bda9c5e96c10e015b3dc0df688e/packages/react-dom/src/client/ReactDOMHostConfig.js#L350-L361">直接文本节点</a>,设置<!-- --><a href="https://github.com/facebook/react/blob/v17.0.2/packages/react-reconciler/src/ReactFiberBeginWork.old.js#L1147">nextChildren = null</a>(源码注释的解释是不用在开辟内存去创建一个文本节点, 同时还能减少向下遍历).<!-- --></li><li>由于<!-- --><code>nextChildren = null</code>, 经过<!-- --><code>reconcileChildren</code>阶段处理后, 返回值也是<!-- --><code>null</code></li></ul></li><li><p><code>beginWork</code>执行后: 由于下级节点为<!-- --><code>null</code>, 所以进入<!-- --><code>completeUnitOfWork(unitOfWork)</code>函数, 传入的参数<!-- --><code>unitOfWork</code>实际上就是<!-- --><code>workInProgress</code>(此时指向<!-- --><code>fiber(button)</code>节点)<!-- --></p></li><li><p><code>completeUnitOfWork</code>执行过程: 以<!-- --><code>fiber(button)</code>为起点, 向上回溯<!-- --></p></li></ul><p><code>completeUnitOfWork</code>第 1 次循环:<!-- --></p><ol><li>执行<!-- --><code>completeWork</code>函数
<!-- --><ul><li>因为<!-- --><code>fiber(button).stateNode != null</code>, 所以无需再次创建 DOM 对象. 只需要进一步调用<!-- --><code>updateHostComponent()</code>记录 DOM 属性改动情况<!-- --></li><li>在<!-- --><code>updateHostComponent()</code>函数中, 又因为<!-- --><code>oldProps === newProps</code>, 所以无需记录改动情况, 直接返回<!-- --></li></ul></li><li>上移副作用队列: 由于本节点<!-- --><code>fiber(button)</code>没有副作用(<!-- --><code>fiber.flags = 0</code>), 所 以执行之后副作用队列没有实质变化(目前为空).<!-- --></li><li>向上回溯: 由于还有兄弟节点, 把<!-- --><code>workInProgress</code>指向下一个兄弟节点<!-- --><code>fiber(div)</code>, 退出<!-- --><code>completeUnitOfWork</code>.<!-- --></li></ol><p><img alt="" src="/static/unitofwork4.99cb3fc9.png"/></p><p><code>performUnitOfWork</code>第 5 次调用(执行<!-- --><code>beginWork</code>):<!-- --></p><ul><li>执行前: <!-- --><code>workInProgress</code>指向<!-- --><code>fiber(div)</code>节点, 且<!-- --><code>current = workInProgress.alternate</code>有值<!-- --></li><li>执行过程:
<!-- --><ul><li>在<!-- --><code>updateHostComponent()</code>函数中, 调用<!-- --><code>reconcileChildren()</code>生成下级子节点.<!-- --></li><li>需要注意的是, 下级子节点是一个可迭代数组, 会把<!-- --><code>fiber.child.sibling</code>一起构造出来, 同时根据需要设置<!-- --><code>fiber.flags</code>. 在本例中, 下级节点有被删除的情况, 被删除的节点会被添加到父节点的副作用队列中(具体实现方式请参考<!-- --><a href="/algorithm/diff">React 算法之调和算法</a>).<!-- --></li></ul></li><li>执行后: 返回下级节点<!-- --><code>fiber(p)</code>, 移动<!-- --><code>workInProgress</code>指向子节点<!-- --><code>fiber(p)</code></li></ul><p><img alt="" src="/static/unitofwork5.85010b73.png"/></p><p><code>performUnitOfWork</code>第 6 次调用(执行<!-- --><code>beginWork</code>和<!-- --><code>completeUnitOfWork</code>):<!-- --></p><ul><li><p><code>beginWork</code>执行过程: 与第 4 次调用中构建<!-- --><code>fiber(button)</code>的逻辑完全一致, 因为都是直接文本节点, <!-- --><code>reconcileChildren()</code>返回的下级子节点为 null.<!-- --></p></li><li><p><code>beginWork</code>执行后: 由于下级节点为<!-- --><code>null</code>, 所以进入<!-- --><code>completeUnitOfWork(unitOfWork)</code>函数<!-- --></p></li><li><p><code>completeUnitOfWork</code>执行过程: 以<!-- --><code>fiber(p)</code>为起点, 向上回溯<!-- --></p></li></ul><p><code>completeUnitOfWork</code>第 1 次循环:<!-- --></p><ol><li>执行<!-- --><code>completeWork</code>函数
<!-- --><ul><li>因为<!-- --><code>fiber(p).stateNode != null</code>, 所以无需再次创建 DOM 对象. 在<!-- --><code>updateHostComponent()</code>函数中, 又因为节点属性没有变动, 所以无需打标记<!-- --></li></ul></li><li>上移副作用队列: 本节点<!-- --><code>fiber(p)</code>没有副作用(<!-- --><code>fiber.flags = 0</code>).<!-- --></li><li>向上回溯: 由于还有兄弟节点, 把<!-- --><code>workInProgress</code>指向下一个兄弟节点<!-- --><code>fiber(p)</code>, 退出<!-- --><code>completeUnitOfWork</code>.<!-- --></li></ol><p><img alt="" src="/static/unitofwork6.20143502.png"/></p><p><code>performUnitOfWork</code>第 7 次调用(执行<!-- --><code>beginWork</code>和<!-- --><code>completeUnitOfWork</code>):<!-- --></p><ul><li><p><code>beginWork</code>执行过程: 与第 4 次调用中构建<!-- --><code>fiber(button)</code>的逻辑完全一致, 因为都是直接文本节点, <!-- --><code>reconcileChildren()</code>返回的下级子节点为 null.<!-- --></p></li><li><p><code>beginWork</code>执行后: 由于下级节点为<!-- --><code>null</code>, 所以进入<!-- --><code>completeUnitOfWork(unitOfWork)</code>函数<!-- --></p></li><li><p><code>completeUnitOfWork</code>执行过程: 以<!-- --><code>fiber(p)</code>为起点, 向上回溯<!-- --></p></li></ul><p><code>completeUnitOfWork</code>第 1 次循环:<!-- --></p><ol><li><p>执行<!-- --><code>completeWork</code>函数:<!-- --></p><ul><li>因为<!-- --><code>fiber(p).stateNode != null</code>, 所以无需再次创建 DOM 对象. 在<!-- --><code>updateHostComponent()</code>函数中, 又因为节点属性没有变动, 所以无需打标记<!-- --></li></ul></li><li><p>上移副作用队列: 本节点<!-- --><code>fiber(p)</code>有副作用(<!-- --><code>fiber.flags = Placement</code>), 需要将其添加到父节点的副作用队列之后.<!-- --></p></li><li><p>向上回溯: 由于还有兄弟节点, 把<!-- --><code>workInProgress</code>指向下一个兄弟节点<!-- --><code>fiber(p)</code>, 退出<!-- --><code>completeUnitOfWork</code>.<!-- --></p></li></ol><p><img alt="" src="/static/unitofwork7.b78c584e.png"/></p><p><code>performUnitOfWork</code>第 8 次调用(执行<!-- --><code>beginWork</code>和<!-- --><code>completeUnitOfWork</code>):<!-- --></p><ul><li><p><code>beginWork</code>执行过程: 本节点<!-- --><code>fiber(p)</code>是一个新增节点, 其<!-- --><code>current === null</code>, 会进入<!-- --><code>updateHostComponent()</code>函数. 因为是直接文本节点, <!-- --><code>reconcileChildren()</code>返回的下级子节点为 null.<!-- --></p></li><li><p><code>beginWork</code>执行后: 由于下级节点为<!-- --><code>null</code>, 所以进入<!-- --><code>completeUnitOfWork(unitOfWork)</code>函数<!-- --></p></li><li><p><code>completeUnitOfWork</code>执行过程: 以<!-- --><code>fiber(p)</code>为起点, 向上回溯<!-- --></p></li></ul><p><code>completeUnitOfWork</code>第 1 次循环:<!-- --></p><ol><li>执行<!-- --><code>completeWork</code>函数: 由于本节点是一个新增节点,且<!-- --><code>fiber(p).stateNode === null</code>, 所以创建<!-- --><code>fiber(p)</code>节点对应的<!-- --><code>DOM</code>实例, 挂载到<!-- --><code>fiber.stateNode</code>之上.<!-- --></li><li>上移副作用队列: 本节点<!-- --><code>fiber(p)</code>有副作用(<!-- --><code>fiber.flags = Placement</code>), 需要将其添加到父节点的副作用队列之后.<!-- --></li><li>向上回溯: 由于没有兄弟节点, 把<!-- --><code>workInProgress</code>指针指向父节点<!-- --><code>fiber(div)</code>.<!-- --></li></ol><p><img alt="" src="/static/unitofwork8.4cf35690.png"/></p><p><code>completeUnitOfWork</code>第 2 次循环:<!-- --></p><ol><li>执行<!-- --><code>completeWork</code>函数: 由于<!-- --><code>div</code>组件没有属性变动, 故<!-- --><code>updateHostComponent()</code>没有设置副作用标记<!-- --></li><li>上移副作用队列: 本节点<!-- --><code>fiber(div)</code>的副作用队列添加到父节点的副作用队列之后.<!-- --></li><li>向上回溯: 由于没有兄弟节点, 把<!-- --><code>workInProgress</code>指针指向父节点<!-- --><code>fiber(&lt;App/&gt;)</code></li></ol><p><code>completeUnitOfWork</code>第 3 次循环:<!-- --></p><ol><li>执行<!-- --><code>completeWork</code>函数: class 类型的节点无需处理<!-- --></li><li>上移副作用队列: 本节点<!-- --><code>fiber(&lt;App/&gt;)</code>的副作用队列添加到父节点的副作用队列之后.<!-- --></li><li>向上回溯: 由于没有兄弟节点, 把<!-- --><code>workInProgress</code>指针指向父节点<!-- --><code>fiber(HostRootFiber)</code></li></ol><p><code>completeUnitOfWork</code>第 4 次循环:<!-- --></p><ol><li>执行<!-- --><code>completeWork</code>函数: <!-- --><code>HostRoot</code>类型的节点无需处理<!-- --></li><li>向上回溯: 由于父节点为空, 无需进入处理副作用队列的逻辑. 最后设置<!-- --><code>workInProgress=null</code>, 并退出<!-- --><code>completeUnitOfWork</code></li><li>重置<!-- --><code>fiber.childLanes</code></li></ol><p>到此整个<!-- --><code>fiber树构造循环(对比更新)</code>已经执行完毕, 拥有一棵新的<!-- --><code>fiber树</code>, 并且在<!-- --><code>fiber树</code>的根节点上挂载了副作用队列. <!-- --><code>renderRootSync</code>函数退出之前, 会重置<!-- --><code>workInProgressRoot = null</code>, 表明没有正在进行中的<!-- --><code>render</code>. 且把最新的<!-- --><code>fiber树</code>挂载到<!-- --><code>fiberRoot.finishedWork</code>上. 这时整个 fiber 树的内存结构如下(注意<!-- --><code>fiberRoot.finishedWork</code>和<!-- --><code>fiberRoot.current</code>指针,在<!-- --><code>commitRoot</code>阶段会进行处理):<!-- --></p><p><img alt="" src="/static/fibertree-beforecommit.245f5558.png"/></p><p>无论是<!-- --><code>初次构造</code>或者是<!-- --><code>对比更新</code>, 当<!-- --><code>fiber树构造</code>完成之后, 余下的逻辑几乎一致, 在<!-- --><a href="/main/fibertree-commit">fiber 树渲染</a>中继续讨论.<!-- --></p><h2 id="总结"><a aria-hidden="true" tabindex="-1" href="#总结"><span class="icon icon-link"></span></a>总结<!-- --></h2><p>本节演示了更新阶段<!-- --><code>fiber树构造(对比更新)</code>的全部过程, 跟踪了创建过程中内存引用的变化情况. 与<!-- --><code>初次构造</code>最大的不同在于<!-- --><code>fiber节点</code>是否可以复用, 其中<!-- --><code>bailout</code>逻辑是<!-- --><code>fiber子树</code>能否复用的判断依据.<!-- --></p></div></div><script>$RC("B:2","S:2")</script>