<!DOCTYPE html><html><head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<meta name="keywords" content="react, react原理, 图解react, react fiber原理, react hook原理, react 合成事件, react 基本包结构">
<meta name="description" content="图解React原理系列, 以react核心包结构和运行机制为主线索进行展开. 包括react 基本包结构, react 工作循环, react 启动模式, react fiber原理, react hook原理, react 合成事件等核心内容">
<link rel="shortcut icon" href="/km@2x.png">
<link rel="stylesheet" href="/umi.eb36fa83.css">
<title data-rh="true">fiber 树渲染</title>
<meta data-rh="true" property="og:title" content="fiber 树渲染"/><meta data-rh="true" name="description" content="在正式分析fiber树渲染之前, 再次回顾一下reconciler 运作流程的 4 个阶段:"/><meta data-rh="true" property="og:description" content="在正式分析fiber树渲染之前, 再次回顾一下reconciler 运作流程的 4 个阶段:"/>
</head>
<body>
<noscript><b>Enable JavaScript to run this app.</b></noscript><div id="root"><!--$?--><template id="B:0"></template><div></div><!--/$--></div><script>window.__UMI_LOADER_DATA__ = {}</script>
<script src="/umi.c14ba5aa.js"></script>

</body></html><div hidden id="S:0"><!--$?--><template id="B:1"></template><div></div><!--/$--></div><script>function $RC(a,b){a=document.getElementById(a);b=document.getElementById(b);b.parentNode.removeChild(b);if(a){a=a.previousSibling;var f=a.parentNode,c=a.nextSibling,e=0;do{if(c&&8===c.nodeType){var d=c.data;if("/$"===d)if(0===e)break;else e--;else"$"!==d&&"$?"!==d&&"$!"!==d||e++}d=c.nextSibling;f.removeChild(c);c=d}while(c);for(;b.firstChild;)f.insertBefore(b.firstChild,c);a.data="$";a._reactRetry&&a._reactRetry()}};$RC("B:0","S:0")</script><div hidden id="S:1"><div class="dumi-default-doc-layout"><div class="dumi-default-header"><div class="dumi-default-header-content"><section class="dumi-default-header-left"><a class="dumi-default-logo" href="/"><img src="/logo.png" alt="图解React"/>图解React<!-- --></a></section><section class="dumi-default-header-right"><ul class="dumi-default-navbar"><li><a class="active" href="/main/macro-structure">原理解析</a></li><li><a href="/algorithm/diff">高频算法</a></li><li><a href="/interview/01-setstate">面试题</a></li></ul><div class="dumi-default-header-right-aside"><div class="dumi-default-search-bar"><svg viewBox="64 64 896 896" class="dumi-default-search-bar-svg"><path d="M909.6 854.5 649.9 594.8C690.2 542.7 712 479 712 412c0-80.2-31.3-155.4-87.9-212.1-56.6-56.7-132-87.9-212.1-87.9s-155.5 31.3-212.1 87.9C143.2 256.5 112 331.8 112 412c0 80.1 31.3 155.5 87.9 212.1C256.5 680.8 331.8 712 412 712c67 0 130.6-21.8 182.7-62l259.7 259.6a8.2 8.2 0 0 0 11.6 0l43.6-43.5a8.2 8.2 0 0 0 0-11.6zM570.4 570.4C528 612.7 471.8 636 412 636s-116-23.3-158.4-65.6C211.3 528 188 471.8 188 412s23.3-116.1 65.6-158.4C296 211.3 352.2 188 412 188s116.1 23.2 158.4 65.6S636 352.2 636 412s-23.3 116.1-65.6 158.4z"></path></svg><input class="dumi-default-search-bar-input" placeholder="输入关键字搜索..."/><span class="dumi-default-search-shortcut">⌘<!-- --> K<!-- --></span></div><span class="dumi-default-color-switch" data-dumi-tooltip="亮色模式" data-dumi-tooltip-bottom="true"><svg viewBox="0 0 16 16"><path d="M8 13a1 1 0 0 1 1 1v1a1 1 0 1 1-2 0v-1a1 1 0 0 1 1-1ZM8 3a1 1 0 0 1-1-1V1a1 1 0 1 1 2 0v1a1 1 0 0 1-1 1Zm7 4a1 1 0 1 1 0 2h-1a1 1 0 1 1 0-2h1ZM3 8a1 1 0 0 1-1 1H1a1 1 0 1 1 0-2h1a1 1 0 0 1 1 1Zm9.95 3.536.707.707a1 1 0 0 1-1.414 1.414l-.707-.707a1 1 0 0 1 1.414-1.414Zm-9.9-7.072-.707-.707a1 1 0 0 1 1.414-1.414l.707.707A1 1 0 0 1 3.05 4.464Zm9.9 0a1 1 0 0 1-1.414-1.414l.707-.707a1 1 0 0 1 1.414 1.414l-.707.707Zm-9.9 7.072a1 1 0 0 1 1.414 1.414l-.707.707a1 1 0 0 1-1.414-1.414l.707-.707ZM8 4a4 4 0 1 0 0 8 4 4 0 0 0 0-8Zm0 6.5a2.5 2.5 0 1 1 0-5 2.5 2.5 0 0 1 0 5Z"></path></svg><select><option value="light" selected="">亮色模式<!-- --></option><option value="dark">暗色模式<!-- --></option><option value="auto">跟随系统<!-- --></option></select></span><a class="dumi-default-icon" data-dumi-tooltip="GitHub" data-dumi-tooltip-bottom="true" target="_blank" href="https://github.com/7kms/react-illustration-series" rel="noreferrer"><svg viewBox="64 64 896 896"><path d="M511.6 76.3C264.3 76.2 64 276.4 64 523.5 64 718.9 189.3 885 363.8 946c23.5 5.9 19.9-10.8 19.9-22.2v-77.5c-135.7 15.9-141.2-73.9-150.3-88.9C215 726 171.5 718 184.5 703c30.9-15.9 62.4 4 98.9 57.9 26.4 39.1 77.9 32.5 104 26 5.7-23.5 17.9-44.5 34.7-60.8-140.6-25.2-199.2-111-199.2-213 0-49.5 16.3-95 48.3-131.7-20.4-60.5 1.9-112.3 4.9-120 58.1-5.2 118.5 41.6 123.2 45.3 33-8.9 70.7-13.6 112.9-13.6 42.4 0 80.2 4.9 113.5 13.9 11.3-8.6 67.3-48.8 121.3-43.9 2.9 7.7 24.7 58.3 5.5 118 32.4 36.8 48.9 82.7 48.9 132.3 0 102.2-59 188.1-200 212.9a127.5 127.5 0 0 1 38.1 91v112.5c.8 9 0 17.9 15 17.9 177.1-59.7 304.6-227 304.6-424.1 0-247.2-200.4-447.3-447.5-447.3z"></path></svg></a></div></section><button type="button" class="dumi-default-header-menu-btn"><svg viewBox="64 64 896 896"><path d="M904 160H120c-4.4 0-8 3.6-8 8v64c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-64c0-4.4-3.6-8-8-8zm0 624H120c-4.4 0-8 3.6-8 8v64c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-64c0-4.4-3.6-8-8-8zm0-312H120c-4.4 0-8 3.6-8 8v64c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-64c0-4.4-3.6-8-8-8z"></path></svg></button></div></div><div class="dumi-default-doc-layout-mobile-bar"><button type="button" class="dumi-default-sidebar-btn"><svg viewBox="64 64 896 896"><path d="M120 230h496c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm0 424h496c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm784 140H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0-424H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8z"></path></svg>侧边菜单<!-- --></button></div><main><div class="dumi-default-sidebar"><dl class="dumi-default-sidebar-group"><dt>基本概念</dt><dd><a title="宏观包结构" class="" href="/main/macro-structure">宏观包结构</a></dd><dd><a title="两大工作循环" class="" href="/main/workloop">两大工作循环</a></dd><dd><a title="高频对象" class="" href="/main/object-structure">高频对象</a></dd></dl><dl class="dumi-default-sidebar-group"><dt>运行核心</dt><dd><a title="启动过程" class="" href="/main/bootstrap">启动过程</a></dd><dd><a title="reconciler 运作流程" class="" href="/main/reconciler-workflow">reconciler 运作流程</a></dd><dd><a title="优先级管理" class="" href="/main/priority">优先级管理</a></dd><dd><a title="调度原理" class="" href="/main/scheduler">调度原理</a></dd><dd><a title="fiber 树构造(基础准备)" class="" href="/main/fibertree-prepare">fiber 树构造(基础准备)</a></dd><dd><a title="fiber 树构造(初次创建)" class="" href="/main/fibertree-create">fiber 树构造(初次创建)</a></dd><dd><a title="fiber 树构造(对比更新)" class="" href="/main/fibertree-update">fiber 树构造(对比更新)</a></dd><dd><a title="fiber 树渲染" aria-current="page" class="active" href="/main/fibertree-commit">fiber 树渲染</a></dd></dl><dl class="dumi-default-sidebar-group"><dt>状态管理</dt><dd><a title="状态与副作用" class="" href="/main/state-effects">状态与副作用</a></dd><dd><a title="Hook 原理(概览)" class="" href="/main/hook-summary">Hook 原理(概览)</a></dd><dd><a title="Hook 原理(状态Hook)" class="" href="/main/hook-state">Hook 原理(状态Hook)</a></dd><dd><a title="Hook 原理(副作用Hook)" class="" href="/main/hook-effect">Hook 原理(副作用Hook)</a></dd><dd><a title="context 原理" class="" href="/main/context">context 原理</a></dd></dl><dl class="dumi-default-sidebar-group"><dt>交互</dt><dd><a title="合成事件" class="" href="/main/synthetic-event">合成事件</a></dd></dl></div><div class="dumi-default-content"><!--$?--><template id="B:2"></template><div></div><!--/$--><div class="dumi-default-footer">Copyright © 2023 | Powered by <a href="https://d.umijs.org" target="_blank" rel="noreferrer">dumi</a></div></div></main></div></div><script>$RC("B:1","S:1")</script><div hidden id="S:2"><div class="markdown"><h1 id="fiber-树渲染"><a aria-hidden="true" tabindex="-1" href="#fiber-树渲染"><span class="icon icon-link"></span></a>fiber 树渲染<!-- --></h1><p>在正式分析<!-- --><code>fiber树渲染</code>之前, 再次回顾一下<!-- --><a href="/main/reconciler-workflow">reconciler 运作流程</a>的 4 个阶段:<!-- --></p><p><img alt="" src="/static/reactfiberworkloop.b647e134.png"/></p><ol><li>输入阶段: 衔接<!-- --><code>react-dom</code>包, 承接<!-- --><code>fiber更新</code>请求(参考<!-- --><a href="/main/bootstrap">React 应用的启动过程</a>).<!-- --></li><li>注册调度任务: 与调度中心(<!-- --><code>scheduler</code>包)交互, 注册调度任务<!-- --><code>task</code>, 等待任务回调(参考<!-- --><a href="/main/scheduler">React 调度原理(scheduler)</a>).<!-- --></li><li>执行任务回调: 在内存中构造出<!-- --><code>fiber树</code>和<!-- --><code>DOM</code>对象(参考<!-- --><a href="/main/fibertree-create">fiber 树构造(初次创建)</a>和 fiber 树构造(对比更新)).<!-- --></li><li>输出: 与渲染器(<!-- --><code>react-dom</code>)交互, 渲染<!-- --><code>DOM</code>节点.<!-- --></li></ol><p>本节分析其中的第 4 阶段(输出), <!-- --><code>fiber树渲染</code>处于<!-- --><code>reconciler 运作流程</code>这一流水线的最后一环, 或者说前面的步骤都是为了最后一步服务, 所以其重要性不言而喻.<!-- --></p><p>前文已经介绍了<!-- --><code>fiber树构造</code>, 现在分析<!-- --><code>fiber树渲染</code>过程, 这个过程, 实际上是对<!-- --><code>fiber树</code>的进一步处理.<!-- --></p><h2 id="fiber-树特点"><a aria-hidden="true" tabindex="-1" href="#fiber-树特点"><span class="icon icon-link"></span></a>fiber 树特点<!-- --></h2><p>通过前文<!-- --><code>fiber树构造</code>的解读, 可以总结出<!-- --><code>fiber树</code>的基本特点:<!-- --></p><ul><li>无论是<!-- --><code>首次构造</code>或者是<!-- --><code>对比更新</code>, 最终都会在内存中生成一棵用于渲染页面的<!-- --><code>fiber树</code>(即<!-- --><code>fiberRoot.finishedWork</code>).<!-- --></li><li>这棵将要被渲染的<!-- --><code>fiber树</code>有 2 个特点:
<!-- --><ol><li>副作用队列挂载在根节点上(具体来讲是<!-- --><code>finishedWork.firstEffect</code>)<!-- --></li><li>代表最新页面的<!-- --><code>DOM</code>对象挂载在<!-- --><code>fiber树</code>中首个<!-- --><code>HostComponent</code>类型的节点上(具体来讲<!-- --><code>DOM</code>对象是挂载在<!-- --><code>fiber.stateNode</code>属性上)<!-- --></li></ol></li></ul><p>这里再次回顾前文使用过的 2 棵 fiber 树, 可以验证上述特点:</p><ol><li>初次构造</li></ol><p><img alt="" src="/static/fibertree-beforecommit.682ae607.png"/></p><ol start="2"><li>对比更新</li></ol><p><img alt="" src="/static/fibertree-beforecommit.245f5558.png"/></p><h2 id="commitroot"><a aria-hidden="true" tabindex="-1" href="#commitroot"><span class="icon icon-link"></span></a>commitRoot<!-- --></h2><p>整个渲染逻辑都在<!-- --><a href="https://github.com/facebook/react/blob/v17.0.2/packages/react-reconciler/src/ReactFiberWorkLoop.old.js#L1879-L2254">commitRoot 函数中</a>:<!-- --></p><div class="dumi-default-source-code"><button type="button" class="dumi-default-source-code-copy"><svg viewBox="64 64 896 896"><path d="M832 64H296c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h496v688c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8V96c0-17.7-14.3-32-32-32zM704 192H192c-17.7 0-32 14.3-32 32v530.7c0 8.5 3.4 16.6 9.4 22.6l173.3 173.3c2.2 2.2 4.7 4 7.4 5.5v1.9h4.2c3.5 1.3 7.2 2 11 2H704c17.7 0 32-14.3 32-32V224c0-17.7-14.3-32-32-32zM350 856.2 263.9 770H350v86.2zM664 888H414V746c0-22.1-17.9-40-40-40H232V264h432v624z"></path></svg></button><pre class="prism-code language-js"><div class=""><div class=""><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">commitRoot</span><span class="token punctuation">(</span><span class="token parameter">root</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> renderPriorityLevel </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">getCurrentPriorityLevel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token function">runWithPriority</span><span class="token punctuation">(</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token maybe-class-name">ImmediateSchedulerPriority</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    commitRootImpl</span><span class="token punctuation">.</span><span class="token method function property-access">bind</span><span class="token punctuation">(</span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"> root</span><span class="token punctuation">,</span><span class="token plain"> renderPriorityLevel</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword control-flow">return</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token punctuation">}</span></div></div></pre></div><p>在<!-- --><code>commitRoot</code>中同时使用到了<!-- --><code>渲染优先级</code>和<!-- --><code>调度优先级</code>, 有关优先级的讨论, 在前文已经做出了说明(参考<!-- --><a href="/main/priority">React 中的优先级管理</a>和<!-- --><a href="/main/fibertree-prepare#%E4%BC%98%E5%85%88%E7%BA%A7">fiber 树构造(基础准备)#优先级</a>), 本节不再赘述. 最后的实现是通过<!-- --><code>commitRootImpl</code>函数:<!-- --></p><div class="dumi-default-source-code"><button type="button" class="dumi-default-source-code-copy"><svg viewBox="64 64 896 896"><path d="M832 64H296c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h496v688c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8V96c0-17.7-14.3-32-32-32zM704 192H192c-17.7 0-32 14.3-32 32v530.7c0 8.5 3.4 16.6 9.4 22.6l173.3 173.3c2.2 2.2 4.7 4 7.4 5.5v1.9h4.2c3.5 1.3 7.2 2 11 2H704c17.7 0 32-14.3 32-32V224c0-17.7-14.3-32-32-32zM350 856.2 263.9 770H350v86.2zM664 888H414V746c0-22.1-17.9-40-40-40H232V264h432v624z"></path></svg></button><pre class="prism-code language-js"><div class=""><div class=""><span class="token comment">// ... 省略部分无关代码</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">commitRootImpl</span><span class="token punctuation">(</span><span class="token parameter">root</span><span class="token parameter punctuation">,</span><span class="token parameter"> renderPriorityLevel</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token comment">// ============ 渲染前: 准备 ============</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">
</span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> finishedWork </span><span class="token operator">=</span><span class="token plain"> root</span><span class="token punctuation">.</span><span class="token property-access">finishedWork</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> lanes </span><span class="token operator">=</span><span class="token plain"> root</span><span class="token punctuation">.</span><span class="token property-access">finishedLanes</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">
</span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token comment">// 清空FiberRoot对象上的属性</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  root</span><span class="token punctuation">.</span><span class="token property-access">finishedWork</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  root</span><span class="token punctuation">.</span><span class="token property-access">finishedLanes</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token maybe-class-name">NoLanes</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  root</span><span class="token punctuation">.</span><span class="token property-access">callbackNode</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">
</span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">root </span><span class="token operator">===</span><span class="token plain"> workInProgressRoot</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token comment">// 重置全局变量</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    workInProgressRoot </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    workInProgress </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    workInProgressRootRenderLanes </span><span class="token operator">=</span><span class="token plain"> </span><span class="token maybe-class-name">NoLanes</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">
</span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token comment">// 再次更新副作用队列</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword">let</span><span class="token plain"> firstEffect</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">finishedWork</span><span class="token punctuation">.</span><span class="token property-access">flags</span><span class="token plain"> </span><span class="token operator">&gt;</span><span class="token plain"> </span><span class="token maybe-class-name">PerformedWork</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token comment">// 默认情况下fiber节点的副作用队列是不包括自身的</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token comment">// 如果根节点有副作用, 则将根节点添加到副作用队列的末尾</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">finishedWork</span><span class="token punctuation">.</span><span class="token property-access">lastEffect</span><span class="token plain"> </span><span class="token operator">!==</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      finishedWork</span><span class="token punctuation">.</span><span class="token property-access">lastEffect</span><span class="token punctuation">.</span><span class="token property-access">nextEffect</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> finishedWork</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      firstEffect </span><span class="token operator">=</span><span class="token plain"> finishedWork</span><span class="token punctuation">.</span><span class="token property-access">firstEffect</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword control-flow">else</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      firstEffect </span><span class="token operator">=</span><span class="token plain"> finishedWork</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword control-flow">else</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    firstEffect </span><span class="token operator">=</span><span class="token plain"> finishedWork</span><span class="token punctuation">.</span><span class="token property-access">firstEffect</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">
</span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token comment">// ============ 渲染 ============</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword">let</span><span class="token plain"> firstEffect </span><span class="token operator">=</span><span class="token plain"> finishedWork</span><span class="token punctuation">.</span><span class="token property-access">firstEffect</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">firstEffect </span><span class="token operator">!==</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token keyword">const</span><span class="token plain"> prevExecutionContext </span><span class="token operator">=</span><span class="token plain"> executionContext</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    executionContext </span><span class="token operator">|=</span><span class="token plain"> </span><span class="token maybe-class-name">CommitContext</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token comment">// 阶段1: dom突变之前</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    nextEffect </span><span class="token operator">=</span><span class="token plain"> firstEffect</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token keyword control-flow">do</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token function">commitBeforeMutationEffects</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword control-flow">while</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">nextEffect </span><span class="token operator">!==</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">
</span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token comment">// 阶段2: dom突变, 界面发生改变</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    nextEffect </span><span class="token operator">=</span><span class="token plain"> firstEffect</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token keyword control-flow">do</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token function">commitMutationEffects</span><span class="token punctuation">(</span><span class="token plain">root</span><span class="token punctuation">,</span><span class="token plain"> renderPriorityLevel</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword control-flow">while</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">nextEffect </span><span class="token operator">!==</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token comment">// 恢复界面状态</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token function">resetAfterCommit</span><span class="token punctuation">(</span><span class="token plain">root</span><span class="token punctuation">.</span><span class="token property-access">containerInfo</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token comment">// 切换current指针</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    root</span><span class="token punctuation">.</span><span class="token property-access">current</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> finishedWork</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">
</span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token comment">// 阶段3: layout阶段, 调用生命周期componentDidUpdate和回调函数等</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    nextEffect </span><span class="token operator">=</span><span class="token plain"> firstEffect</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token keyword control-flow">do</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token function">commitLayoutEffects</span><span class="token punctuation">(</span><span class="token plain">root</span><span class="token punctuation">,</span><span class="token plain"> lanes</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword control-flow">while</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">nextEffect </span><span class="token operator">!==</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    nextEffect </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    executionContext </span><span class="token operator">=</span><span class="token plain"> prevExecutionContext</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">
</span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token comment">// ============ 渲染后: 重置与清理 ============</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">rootDoesHavePassiveEffects</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token comment">// 有被动作用(使用useEffect), 保存一些全局变量</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword control-flow">else</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token comment">// 分解副作用队列链表, 辅助垃圾回收</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token comment">// 如果有被动作用(使用useEffect), 会把分解操作放在flushPassiveEffects函数中</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    nextEffect </span><span class="token operator">=</span><span class="token plain"> firstEffect</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token keyword control-flow">while</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">nextEffect </span><span class="token operator">!==</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token keyword">const</span><span class="token plain"> nextNextEffect </span><span class="token operator">=</span><span class="token plain"> nextEffect</span><span class="token punctuation">.</span><span class="token property-access">nextEffect</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      nextEffect</span><span class="token punctuation">.</span><span class="token property-access">nextEffect</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">nextEffect</span><span class="token punctuation">.</span><span class="token property-access">flags</span><span class="token plain"> </span><span class="token operator">&amp;</span><span class="token plain"> </span><span class="token maybe-class-name">Deletion</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">        </span><span class="token function">detachFiberAfterEffects</span><span class="token punctuation">(</span><span class="token plain">nextEffect</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      nextEffect </span><span class="token operator">=</span><span class="token plain"> nextNextEffect</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token comment">// 重置一些全局变量(省略这部分代码)...</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token comment">// 下面代码用于检测是否有新的更新任务</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token comment">// 比如在componentDidMount函数中, 再次调用setState()</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">
</span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token comment">// 1. 检测常规(异步)任务, 如果有则会发起异步调度(调度中心`scheduler`只能异步调用)</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token function">ensureRootIsScheduled</span><span class="token punctuation">(</span><span class="token plain">root</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token comment">// 2. 检测同步任务, 如果有则主动调用flushSyncCallbackQueue(无需再次等待scheduler调度), 再次进入fiber树构造循环</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token function">flushSyncCallbackQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">
</span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword control-flow">return</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token punctuation">}</span></div></div></pre></div><p><code>commitRootImpl</code>函数中, 可以根据是否调用渲染, 把整个<!-- --><code>commitRootImpl</code>分为 3 段(分别是<!-- --><code>渲染前</code>, <!-- --><code>渲染</code>, <!-- --><code>渲染后</code>).<!-- --></p><h3 id="渲染前"><a aria-hidden="true" tabindex="-1" href="#渲染前"><span class="icon icon-link"></span></a>渲染前<!-- --></h3><p>为接下来正式渲染, 做一些准备工作. 主要包括:</p><ol><li>设置全局状态(如: 更新<!-- --><code>fiberRoot</code>上的属性)<!-- --></li><li>重置全局变量(如: <!-- --><code>workInProgressRoot</code>, <!-- --><code>workInProgress</code>等)<!-- --></li><li>再次更新副作用队列: 只针对根节点<!-- --><code>fiberRoot.finishedWork</code><ul><li>默认情况下根节点的副作用队列是不包括自身的, 如果根节点有副作用, 则将根节点添加到副作用队列的末尾</li><li>注意只是延长了副作用队列, 但是<!-- --><code>fiberRoot.lastEffect</code>指针并没有改变.<!-- --><br/>
比如首次构造时, 根节点拥有<!-- --><code>Snapshot</code>标记:<!-- --></li></ul></li></ol><p><img alt="" src="/static/fiber-effectlist.8d5718d2.png"/></p><h3 id="渲染"><a aria-hidden="true" tabindex="-1" href="#渲染"><span class="icon icon-link"></span></a>渲染<!-- --></h3><p><code>commitRootImpl</code>函数中, 渲染阶段的主要逻辑是处理副作用队列, 将最新的 DOM 节点(已经在内存中, 只是还没渲染)渲染到界面上.<!-- --></p><p>整个渲染过程被分为 3 个函数分布实现:</p><ol><li><code>commitBeforeMutationEffects</code><ul><li>dom 变更之前, 处理副作用队列中带有<!-- --><code>Snapshot</code>,<!-- --><code>Passive</code>标记的<!-- --><code>fiber</code>节点.<!-- --></li></ul></li><li><code>commitMutationEffects</code><ul><li>dom 变更, 界面得到更新. 处理副作用队列中带有<!-- --><code>Placement</code>, <!-- --><code>Update</code>, <!-- --><code>Deletion</code>, <!-- --><code>Hydrating</code>标记的<!-- --><code>fiber</code>节点.<!-- --></li></ul></li><li><code>commitLayoutEffects</code><ul><li>dom 变更后, 处理副作用队列中带有<!-- --><code>Update | Callback</code>标记的<!-- --><code>fiber</code>节点.<!-- --></li></ul></li></ol><p>通过上述源码分析, 可以把<!-- --><code>commitRootImpl</code>的职责概括为 2 个方面:<!-- --></p><ol><li>处理副作用队列. (步骤 1,2,3 都会处理, 只是处理节点的标识<!-- --><code>fiber.flags</code>不同).<!-- --></li><li>调用渲染器, 输出最终结果. (在步骤 2: <!-- --><code>commitMutationEffects</code>中执行).<!-- --></li></ol><p>所以<!-- --><code>commitRootImpl</code>是处理<!-- --><code>fiberRoot.finishedWork</code>这棵即将被渲染的<!-- --><code>fiber</code>树, 理论上无需关心这棵<!-- --><code>fiber</code>树是如何产生的(可以是<!-- --><code>首次构造</code>产生, 也可以是<!-- --><code>对比更新</code>产生). 为了清晰简便, 在下文的所有图示都使用<!-- --><code>初次创建的fiber树结构</code>来进行演示.<!-- --></p><p>这 3 个函数处理的对象是<!-- --><code>副作用队列</code>和<!-- --><code>DOM对象</code>.<!-- --></p><p>所以无论<!-- --><code>fiber树</code>结构有多么复杂, 到了<!-- --><code>commitRoot</code>阶段, 实际起作用的只有 2 个节点:<!-- --></p><ul><li><code>副作用队列</code>所在节点: 根节点, 即<!-- --><code>HostRootFiber</code>节点.<!-- --></li><li><code>DOM对象</code>所在节点: 从上至下首个<!-- --><code>HostComponent</code>类型的<!-- --><code>fiber</code>节点, 此节点 <!-- --><code>fiber.stateNode</code>实际上指向最新的 DOM 树.<!-- --></li></ul><p>下图为了清晰, 省略了一些无关引用, 只留下<!-- --><code>commitRoot</code>阶段实际会用到的<!-- --><code>fiber</code>节点:<!-- --></p><p><img alt="" src="/static/fiber-noredundant.e418337c.png"/></p><h4 id="commitbeforemutationeffects"><a aria-hidden="true" tabindex="-1" href="#commitbeforemutationeffects"><span class="icon icon-link"></span></a>commitBeforeMutationEffects<!-- --></h4><p>第一阶段: dom 变更之前, 处理副作用队列中带有<!-- --><code>Snapshot</code>,<!-- --><code>Passive</code>标记的<!-- --><code>fiber</code>节点.<!-- --></p><div class="dumi-default-source-code"><button type="button" class="dumi-default-source-code-copy"><svg viewBox="64 64 896 896"><path d="M832 64H296c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h496v688c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8V96c0-17.7-14.3-32-32-32zM704 192H192c-17.7 0-32 14.3-32 32v530.7c0 8.5 3.4 16.6 9.4 22.6l173.3 173.3c2.2 2.2 4.7 4 7.4 5.5v1.9h4.2c3.5 1.3 7.2 2 11 2H704c17.7 0 32-14.3 32-32V224c0-17.7-14.3-32-32-32zM350 856.2 263.9 770H350v86.2zM664 888H414V746c0-22.1-17.9-40-40-40H232V264h432v624z"></path></svg></button><pre class="prism-code language-js"><div class=""><div class=""><span class="token comment">// ... 省略部分无关代码</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">commitBeforeMutationEffects</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword control-flow">while</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">nextEffect </span><span class="token operator">!==</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token keyword">const</span><span class="token plain"> current </span><span class="token operator">=</span><span class="token plain"> nextEffect</span><span class="token punctuation">.</span><span class="token property-access">alternate</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token keyword">const</span><span class="token plain"> flags </span><span class="token operator">=</span><span class="token plain"> nextEffect</span><span class="token punctuation">.</span><span class="token property-access">flags</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token comment">// 处理`Snapshot`标记</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token plain">flags </span><span class="token operator">&amp;</span><span class="token plain"> </span><span class="token maybe-class-name">Snapshot</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token operator">!==</span><span class="token plain"> </span><span class="token maybe-class-name">NoFlags</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token function">commitBeforeMutationEffectOnFiber</span><span class="token punctuation">(</span><span class="token plain">current</span><span class="token punctuation">,</span><span class="token plain"> nextEffect</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token comment">// 处理`Passive`标记</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token plain">flags </span><span class="token operator">&amp;</span><span class="token plain"> </span><span class="token maybe-class-name">Passive</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token operator">!==</span><span class="token plain"> </span><span class="token maybe-class-name">NoFlags</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token comment">// Passive标记只在使用了hook, useEffect会出现. 所以此处是针对hook对象的处理</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token plain">rootDoesHavePassiveEffects</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">        rootDoesHavePassiveEffects </span><span class="token operator">=</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">        </span><span class="token function">scheduleCallback</span><span class="token punctuation">(</span><span class="token maybe-class-name">NormalSchedulerPriority</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">          </span><span class="token function">flushPassiveEffects</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">          </span><span class="token keyword control-flow">return</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">        </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    nextEffect </span><span class="token operator">=</span><span class="token plain"> nextEffect</span><span class="token punctuation">.</span><span class="token property-access">nextEffect</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token punctuation">}</span></div></div></pre></div><p>注意：<!-- --><code>commitBeforeMutationEffectOnFiber</code>实际上对应了<!-- --><code>commitBeforeMutationLifeCycles</code>函数，在导入时进行了重命名<!-- --></p><ol><li>处理<!-- --><code>Snapshot</code>标记<!-- --></li></ol><div class="dumi-default-source-code"><button type="button" class="dumi-default-source-code-copy"><svg viewBox="64 64 896 896"><path d="M832 64H296c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h496v688c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8V96c0-17.7-14.3-32-32-32zM704 192H192c-17.7 0-32 14.3-32 32v530.7c0 8.5 3.4 16.6 9.4 22.6l173.3 173.3c2.2 2.2 4.7 4 7.4 5.5v1.9h4.2c3.5 1.3 7.2 2 11 2H704c17.7 0 32-14.3 32-32V224c0-17.7-14.3-32-32-32zM350 856.2 263.9 770H350v86.2zM664 888H414V746c0-22.1-17.9-40-40-40H232V264h432v624z"></path></svg></button><pre class="prism-code language-js"><div class=""><div class=""><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">commitBeforeMutationLifeCycles</span><span class="token punctuation">(</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token parameter literal-property property">current</span><span class="token parameter operator">:</span><span class="token parameter"> </span><span class="token parameter maybe-class-name">Fiber</span><span class="token parameter"> </span><span class="token parameter operator">|</span><span class="token parameter"> </span><span class="token parameter keyword null nil">null</span><span class="token parameter punctuation">,</span><span class="token parameter"></span></div></div><div class=""><div class=""><span class="token parameter">  </span><span class="token parameter literal-property property">finishedWork</span><span class="token parameter operator">:</span><span class="token parameter"> </span><span class="token parameter maybe-class-name">Fiber</span><span class="token parameter punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token punctuation">)</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword">void</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword control-flow">switch</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">finishedWork</span><span class="token punctuation">.</span><span class="token property-access">tag</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token keyword">case</span><span class="token plain"> </span><span class="token literal-property property">FunctionComponent</span><span class="token operator">:</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token keyword">case</span><span class="token plain"> </span><span class="token literal-property property">ForwardRef</span><span class="token operator">:</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token keyword">case</span><span class="token plain"> </span><span class="token literal-property property">SimpleMemoComponent</span><span class="token operator">:</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token keyword">case</span><span class="token plain"> </span><span class="token literal-property property">Block</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token keyword control-flow">return</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token keyword">case</span><span class="token plain"> </span><span class="token literal-property property">ClassComponent</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">finishedWork</span><span class="token punctuation">.</span><span class="token property-access">flags</span><span class="token plain"> </span><span class="token operator">&amp;</span><span class="token plain"> </span><span class="token maybe-class-name">Snapshot</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">        </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">current </span><span class="token operator">!==</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">          </span><span class="token keyword">const</span><span class="token plain"> prevProps </span><span class="token operator">=</span><span class="token plain"> current</span><span class="token punctuation">.</span><span class="token property-access">memoizedProps</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">          </span><span class="token keyword">const</span><span class="token plain"> prevState </span><span class="token operator">=</span><span class="token plain"> current</span><span class="token punctuation">.</span><span class="token property-access">memoizedState</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">          </span><span class="token keyword">const</span><span class="token plain"> instance </span><span class="token operator">=</span><span class="token plain"> finishedWork</span><span class="token punctuation">.</span><span class="token property-access">stateNode</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">
</span></div></div><div class=""><div class=""><span class="token plain">          </span><span class="token keyword">const</span><span class="token plain"> snapshot </span><span class="token operator">=</span><span class="token plain"> instance</span><span class="token punctuation">.</span><span class="token method function property-access">getSnapshotBeforeUpdate</span><span class="token punctuation">(</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">            finishedWork</span><span class="token punctuation">.</span><span class="token property-access">elementType</span><span class="token plain"> </span><span class="token operator">===</span><span class="token plain"> finishedWork</span><span class="token punctuation">.</span><span class="token property-access">type</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">              </span><span class="token operator">?</span><span class="token plain"> prevProps</span></div></div><div class=""><div class=""><span class="token plain">              </span><span class="token operator">:</span><span class="token plain"> </span><span class="token function">resolveDefaultProps</span><span class="token punctuation">(</span><span class="token plain">finishedWork</span><span class="token punctuation">.</span><span class="token property-access">type</span><span class="token punctuation">,</span><span class="token plain"> prevProps</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">            prevState</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">          </span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">          instance</span><span class="token punctuation">.</span><span class="token property-access">__reactInternalSnapshotBeforeUpdate</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> snapshot</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">        </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token keyword control-flow">return</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token keyword">case</span><span class="token plain"> </span><span class="token literal-property property">HostRoot</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">supportsMutation</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">        </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">finishedWork</span><span class="token punctuation">.</span><span class="token property-access">flags</span><span class="token plain"> </span><span class="token operator">&amp;</span><span class="token plain"> </span><span class="token maybe-class-name">Snapshot</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">          </span><span class="token keyword">const</span><span class="token plain"> root </span><span class="token operator">=</span><span class="token plain"> finishedWork</span><span class="token punctuation">.</span><span class="token property-access">stateNode</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">          </span><span class="token function">clearContainer</span><span class="token punctuation">(</span><span class="token plain">root</span><span class="token punctuation">.</span><span class="token property-access">containerInfo</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">        </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token keyword control-flow">return</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token keyword">case</span><span class="token plain"> </span><span class="token literal-property property">HostComponent</span><span class="token operator">:</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token keyword">case</span><span class="token plain"> </span><span class="token literal-property property">HostText</span><span class="token operator">:</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token keyword">case</span><span class="token plain"> </span><span class="token literal-property property">HostPortal</span><span class="token operator">:</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token keyword">case</span><span class="token plain"> </span><span class="token literal-property property">IncompleteClassComponent</span><span class="token operator">:</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token keyword control-flow">return</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token punctuation">}</span></div></div></pre></div><p>从源码中可以看到, 与<!-- --><code>Snapshot</code>标记相关的类型只有<!-- --><code>ClassComponent</code>和<!-- --><code>HostRoot</code>.<!-- --></p><ul><li>对于<!-- --><code>ClassComponent</code>类型节点, 调用了<!-- --><code>instance.getSnapshotBeforeUpdate</code>生命周期函数<!-- --></li><li>对于<!-- --><code>HostRoot</code>类型节点, 调用<!-- --><code>clearContainer</code>清空了容器节点(即<!-- --><code>div#root</code>这个 dom 节点).<!-- --></li></ul><ol start="2"><li>处理<!-- --><code>Passive</code>标记<!-- --></li></ol><p><code>Passive</code>标记只会在使用了<!-- --><code>hook</code>对象的<!-- --><code>function</code>类型的节点上存在, 后续的执行过程在<!-- --><code>hook原理</code>章节中详细说明. 此处我们需要了解在<!-- --><code>commitRoot</code>的第一个阶段, 为了处理<!-- --><code>hook</code>对象(如<!-- --><code>useEffect</code>), 通过<!-- --><code>scheduleCallback</code>单独注册了一个调度任务<!-- --><code>task</code>, 等待调度中心<!-- --><code>scheduler</code>处理.<!-- --></p><p>注意: 通过调度中心<!-- --><code>scheduler</code>调度的任务<!-- --><code>task</code>均是通过<!-- --><code>MessageChannel</code>触发, 都是异步执行(可参考<!-- --><a href="/main/scheduler">React 调度原理(scheduler)</a>).<!-- --></p><p>小测试:</p><div class="dumi-default-source-code"><button type="button" class="dumi-default-source-code-copy"><svg viewBox="64 64 896 896"><path d="M832 64H296c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h496v688c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8V96c0-17.7-14.3-32-32-32zM704 192H192c-17.7 0-32 14.3-32 32v530.7c0 8.5 3.4 16.6 9.4 22.6l173.3 173.3c2.2 2.2 4.7 4 7.4 5.5v1.9h4.2c3.5 1.3 7.2 2 11 2H704c17.7 0 32-14.3 32-32V224c0-17.7-14.3-32-32-32zM350 856.2 263.9 770H350v86.2zM664 888H414V746c0-22.1-17.9-40-40-40H232V264h432v624z"></path></svg></button><pre class="prism-code language-js"><div class=""><div class=""><span class="token comment">// 以下示例代码中的输出顺序为 1, 3, 4, 2</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function maybe-class-name">Test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token known-class-name class-name">Promise</span><span class="token punctuation">.</span><span class="token method function property-access">resolve</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword control-flow">return</span><span class="token plain"> </span><span class="token operator">&lt;</span><span class="token plain">div</span><span class="token operator">&gt;</span><span class="token plain">test</span><span class="token operator">&lt;</span><span class="token operator">/</span><span class="token plain">div</span><span class="token operator">&gt;</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token punctuation">}</span></div></div></pre></div><h4 id="commitmutationeffects"><a aria-hidden="true" tabindex="-1" href="#commitmutationeffects"><span class="icon icon-link"></span></a>commitMutationEffects<!-- --></h4><p>第二阶段: dom 变更, 界面得到更新. 处理副作用队列中带有<!-- --><code>ContentReset</code>, <!-- --><code>Ref</code>, <!-- --><code>Placement</code>, <!-- --><code>Update</code>, <!-- --><code>Deletion</code>, <!-- --><code>Hydrating</code>标记的<!-- --><code>fiber</code>节点.<!-- --></p><div class="dumi-default-source-code"><button type="button" class="dumi-default-source-code-copy"><svg viewBox="64 64 896 896"><path d="M832 64H296c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h496v688c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8V96c0-17.7-14.3-32-32-32zM704 192H192c-17.7 0-32 14.3-32 32v530.7c0 8.5 3.4 16.6 9.4 22.6l173.3 173.3c2.2 2.2 4.7 4 7.4 5.5v1.9h4.2c3.5 1.3 7.2 2 11 2H704c17.7 0 32-14.3 32-32V224c0-17.7-14.3-32-32-32zM350 856.2 263.9 770H350v86.2zM664 888H414V746c0-22.1-17.9-40-40-40H232V264h432v624z"></path></svg></button><pre class="prism-code language-js"><div class=""><div class=""><span class="token comment">// ...省略部分无关代码</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">commitMutationEffects</span><span class="token punctuation">(</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token parameter literal-property property">root</span><span class="token parameter operator">:</span><span class="token parameter"> </span><span class="token parameter maybe-class-name">FiberRoot</span><span class="token parameter punctuation">,</span><span class="token parameter"></span></div></div><div class=""><div class=""><span class="token parameter">  </span><span class="token parameter literal-property property">renderPriorityLevel</span><span class="token parameter operator">:</span><span class="token parameter"> </span><span class="token parameter maybe-class-name">ReactPriorityLevel</span><span class="token parameter punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token comment">// 处理Ref</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">flags </span><span class="token operator">&amp;</span><span class="token plain"> </span><span class="token maybe-class-name">Ref</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token keyword">const</span><span class="token plain"> current </span><span class="token operator">=</span><span class="token plain"> nextEffect</span><span class="token punctuation">.</span><span class="token property-access">alternate</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">current </span><span class="token operator">!==</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token comment">// 先清空ref, 在commitRoot的第三阶段(dom变更后), 再重新赋值</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token function">commitDetachRef</span><span class="token punctuation">(</span><span class="token plain">current</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token comment">// 处理DOM突变</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword control-flow">while</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">nextEffect </span><span class="token operator">!==</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token keyword">const</span><span class="token plain"> flags </span><span class="token operator">=</span><span class="token plain"> nextEffect</span><span class="token punctuation">.</span><span class="token property-access">flags</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token keyword">const</span><span class="token plain"> primaryFlags </span><span class="token operator">=</span><span class="token plain"> flags </span><span class="token operator">&amp;</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token maybe-class-name">Placement</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> </span><span class="token maybe-class-name">Update</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> </span><span class="token maybe-class-name">Deletion</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> </span><span class="token maybe-class-name">Hydrating</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token keyword control-flow">switch</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">primaryFlags</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token keyword">case</span><span class="token plain"> </span><span class="token literal-property property">Placement</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">        </span><span class="token comment">// 新增节点</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">        </span><span class="token function">commitPlacement</span><span class="token punctuation">(</span><span class="token plain">nextEffect</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">        nextEffect</span><span class="token punctuation">.</span><span class="token property-access">flags</span><span class="token plain"> </span><span class="token operator">&amp;=</span><span class="token plain"> </span><span class="token operator">~</span><span class="token maybe-class-name">Placement</span><span class="token punctuation">;</span><span class="token plain"> </span><span class="token comment">// 注意Placement标记会被清除</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">        </span><span class="token keyword control-flow">break</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token keyword">case</span><span class="token plain"> </span><span class="token literal-property property">PlacementAndUpdate</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">        </span><span class="token comment">// Placement</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">        </span><span class="token function">commitPlacement</span><span class="token punctuation">(</span><span class="token plain">nextEffect</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">        nextEffect</span><span class="token punctuation">.</span><span class="token property-access">flags</span><span class="token plain"> </span><span class="token operator">&amp;=</span><span class="token plain"> </span><span class="token operator">~</span><span class="token maybe-class-name">Placement</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">        </span><span class="token comment">// Update</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">        </span><span class="token keyword">const</span><span class="token plain"> current </span><span class="token operator">=</span><span class="token plain"> nextEffect</span><span class="token punctuation">.</span><span class="token property-access">alternate</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">        </span><span class="token function">commitWork</span><span class="token punctuation">(</span><span class="token plain">current</span><span class="token punctuation">,</span><span class="token plain"> nextEffect</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">        </span><span class="token keyword control-flow">break</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token keyword">case</span><span class="token plain"> </span><span class="token literal-property property">Update</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">        </span><span class="token comment">// 更新节点</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">        </span><span class="token keyword">const</span><span class="token plain"> current </span><span class="token operator">=</span><span class="token plain"> nextEffect</span><span class="token punctuation">.</span><span class="token property-access">alternate</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">        </span><span class="token function">commitWork</span><span class="token punctuation">(</span><span class="token plain">current</span><span class="token punctuation">,</span><span class="token plain"> nextEffect</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">        </span><span class="token keyword control-flow">break</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token keyword">case</span><span class="token plain"> </span><span class="token literal-property property">Deletion</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">        </span><span class="token comment">// 删除节点</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">        </span><span class="token function">commitDeletion</span><span class="token punctuation">(</span><span class="token plain">root</span><span class="token punctuation">,</span><span class="token plain"> nextEffect</span><span class="token punctuation">,</span><span class="token plain"> renderPriorityLevel</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">        </span><span class="token keyword control-flow">break</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    nextEffect </span><span class="token operator">=</span><span class="token plain"> nextEffect</span><span class="token punctuation">.</span><span class="token property-access">nextEffect</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token punctuation">}</span></div></div></pre></div><p>处理 DOM 突变:</p><ol><li><code>新增</code>: 函数调用栈 <!-- --><code>commitPlacement</code> -&gt; <!-- --><code>insertOrAppendPlacementNode</code> -&gt; <!-- --><code>appendChild</code></li><li><code>更新</code>: 函数调用栈 <!-- --><code>commitWork</code> -&gt; <!-- --><code>commitUpdate</code></li><li><code>删除</code>: 函数调用栈 <!-- --><code>commitDeletion</code> -&gt; <!-- --><code>removeChild</code></li></ol><p>最终会调用<!-- --><code>appendChild, commitUpdate, removeChild</code>这些<!-- --><code>react-dom</code>包中的函数. 它们是<!-- --><a href="https://github.com/facebook/react/blob/v17.0.2/packages/react-reconciler/README.md#practical-examples"><code>HostConfig</code>协议<!-- --></a>(<!-- --><a href="https://github.com/facebook/react/blob/v17.0.2/packages/react-dom/src/client/ReactDOMHostConfig.js">源码在 ReactDOMHostConfig.js 中</a>)中规定的标准函数, 在渲染器<!-- --><code>react-dom</code>包中进行实现. 这些函数就是直接操作 DOM, 所以执行之后, 界面也会得到更新.<!-- --></p><p>注意: <!-- --><code>commitMutationEffects</code>执行之后, 在<!-- --><code>commitRootImpl</code>函数中切换当前<!-- --><code>fiber</code>树(<!-- --><code>root.current = finishedWork</code>),保证<!-- --><code>fiberRoot.current</code>指向代表当前界面的<!-- --><code>fiber树</code>.<!-- --></p><p><img alt="" src="/static/fiber-switch.ff0ba556.png"/></p><h4 id="commitlayouteffects"><a aria-hidden="true" tabindex="-1" href="#commitlayouteffects"><span class="icon icon-link"></span></a>commitLayoutEffects<!-- --></h4><p>第三阶段: dom 变更后, 处理副作用队列中带有<!-- --><code>Update, Callback, Ref</code>标记的<!-- --><code>fiber</code>节点.<!-- --></p><div class="dumi-default-source-code"><button type="button" class="dumi-default-source-code-copy"><svg viewBox="64 64 896 896"><path d="M832 64H296c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h496v688c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8V96c0-17.7-14.3-32-32-32zM704 192H192c-17.7 0-32 14.3-32 32v530.7c0 8.5 3.4 16.6 9.4 22.6l173.3 173.3c2.2 2.2 4.7 4 7.4 5.5v1.9h4.2c3.5 1.3 7.2 2 11 2H704c17.7 0 32-14.3 32-32V224c0-17.7-14.3-32-32-32zM350 856.2 263.9 770H350v86.2zM664 888H414V746c0-22.1-17.9-40-40-40H232V264h432v624z"></path></svg></button><pre class="prism-code language-js"><div class=""><div class=""><span class="token comment">// ...省略部分无关代码</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">commitLayoutEffects</span><span class="token punctuation">(</span><span class="token parameter literal-property property">root</span><span class="token parameter operator">:</span><span class="token parameter"> </span><span class="token parameter maybe-class-name">FiberRoot</span><span class="token parameter punctuation">,</span><span class="token parameter"> </span><span class="token parameter literal-property property">committedLanes</span><span class="token parameter operator">:</span><span class="token parameter"> </span><span class="token parameter maybe-class-name">Lanes</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword control-flow">while</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">nextEffect </span><span class="token operator">!==</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token keyword">const</span><span class="token plain"> flags </span><span class="token operator">=</span><span class="token plain"> nextEffect</span><span class="token punctuation">.</span><span class="token property-access">flags</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token comment">// 处理 Update和Callback标记</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">flags </span><span class="token operator">&amp;</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token maybe-class-name">Update</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> </span><span class="token maybe-class-name">Callback</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token keyword">const</span><span class="token plain"> current </span><span class="token operator">=</span><span class="token plain"> nextEffect</span><span class="token punctuation">.</span><span class="token property-access">alternate</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token function">commitLayoutEffectOnFiber</span><span class="token punctuation">(</span><span class="token plain">root</span><span class="token punctuation">,</span><span class="token plain"> current</span><span class="token punctuation">,</span><span class="token plain"> nextEffect</span><span class="token punctuation">,</span><span class="token plain"> committedLanes</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">flags </span><span class="token operator">&amp;</span><span class="token plain"> </span><span class="token maybe-class-name">Ref</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token comment">// 重新设置ref</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token function">commitAttachRef</span><span class="token punctuation">(</span><span class="token plain">nextEffect</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    nextEffect </span><span class="token operator">=</span><span class="token plain"> nextEffect</span><span class="token punctuation">.</span><span class="token property-access">nextEffect</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token punctuation">}</span></div></div></pre></div><p>核心逻辑都在<!-- --><code>commitLayoutEffectOnFiber-&gt;commitLifeCycles</code>函数中.<!-- --></p><div class="dumi-default-source-code"><button type="button" class="dumi-default-source-code-copy"><svg viewBox="64 64 896 896"><path d="M832 64H296c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h496v688c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8V96c0-17.7-14.3-32-32-32zM704 192H192c-17.7 0-32 14.3-32 32v530.7c0 8.5 3.4 16.6 9.4 22.6l173.3 173.3c2.2 2.2 4.7 4 7.4 5.5v1.9h4.2c3.5 1.3 7.2 2 11 2H704c17.7 0 32-14.3 32-32V224c0-17.7-14.3-32-32-32zM350 856.2 263.9 770H350v86.2zM664 888H414V746c0-22.1-17.9-40-40-40H232V264h432v624z"></path></svg></button><pre class="prism-code language-js"><div class=""><div class=""><span class="token comment">// ...省略部分无关代码</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">commitLifeCycles</span><span class="token punctuation">(</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token parameter literal-property property">finishedRoot</span><span class="token parameter operator">:</span><span class="token parameter"> </span><span class="token parameter maybe-class-name">FiberRoot</span><span class="token parameter punctuation">,</span><span class="token parameter"></span></div></div><div class=""><div class=""><span class="token parameter">  </span><span class="token parameter literal-property property">current</span><span class="token parameter operator">:</span><span class="token parameter"> </span><span class="token parameter maybe-class-name">Fiber</span><span class="token parameter"> </span><span class="token parameter operator">|</span><span class="token parameter"> </span><span class="token parameter keyword null nil">null</span><span class="token parameter punctuation">,</span><span class="token parameter"></span></div></div><div class=""><div class=""><span class="token parameter">  </span><span class="token parameter literal-property property">finishedWork</span><span class="token parameter operator">:</span><span class="token parameter"> </span><span class="token parameter maybe-class-name">Fiber</span><span class="token parameter punctuation">,</span><span class="token parameter"></span></div></div><div class=""><div class=""><span class="token parameter">  </span><span class="token parameter literal-property property">committedLanes</span><span class="token parameter operator">:</span><span class="token parameter"> </span><span class="token parameter maybe-class-name">Lanes</span><span class="token parameter punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token punctuation">)</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword">void</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword control-flow">switch</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">finishedWork</span><span class="token punctuation">.</span><span class="token property-access">tag</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token keyword">case</span><span class="token plain"> </span><span class="token literal-property property">ClassComponent</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token keyword">const</span><span class="token plain"> instance </span><span class="token operator">=</span><span class="token plain"> finishedWork</span><span class="token punctuation">.</span><span class="token property-access">stateNode</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">finishedWork</span><span class="token punctuation">.</span><span class="token property-access">flags</span><span class="token plain"> </span><span class="token operator">&amp;</span><span class="token plain"> </span><span class="token maybe-class-name">Update</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">        </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">current </span><span class="token operator">===</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">          </span><span class="token comment">// 初次渲染: 调用 componentDidMount</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">          instance</span><span class="token punctuation">.</span><span class="token method function property-access">componentDidMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">        </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword control-flow">else</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">          </span><span class="token keyword">const</span><span class="token plain"> prevProps </span><span class="token operator">=</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">            finishedWork</span><span class="token punctuation">.</span><span class="token property-access">elementType</span><span class="token plain"> </span><span class="token operator">===</span><span class="token plain"> finishedWork</span><span class="token punctuation">.</span><span class="token property-access">type</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">              </span><span class="token operator">?</span><span class="token plain"> current</span><span class="token punctuation">.</span><span class="token property-access">memoizedProps</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">              </span><span class="token operator">:</span><span class="token plain"> </span><span class="token function">resolveDefaultProps</span><span class="token punctuation">(</span><span class="token plain">finishedWork</span><span class="token punctuation">.</span><span class="token property-access">type</span><span class="token punctuation">,</span><span class="token plain"> current</span><span class="token punctuation">.</span><span class="token property-access">memoizedProps</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">          </span><span class="token keyword">const</span><span class="token plain"> prevState </span><span class="token operator">=</span><span class="token plain"> current</span><span class="token punctuation">.</span><span class="token property-access">memoizedState</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">          </span><span class="token comment">// 更新阶段: 调用 componentDidUpdate</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">          instance</span><span class="token punctuation">.</span><span class="token method function property-access">componentDidUpdate</span><span class="token punctuation">(</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">            prevProps</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">            prevState</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">            instance</span><span class="token punctuation">.</span><span class="token property-access">__reactInternalSnapshotBeforeUpdate</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">          </span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">        </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token keyword">const</span><span class="token plain"> </span><span class="token literal-property property">updateQueue</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">UpdateQueue</span><span class="token operator">&lt;</span><span class="token operator">*</span><span class="token operator">&gt;</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">        </span><span class="token punctuation">(</span><span class="token plain">finishedWork</span><span class="token punctuation">.</span><span class="token property-access">updateQueue</span><span class="token operator">:</span><span class="token plain"> any</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">updateQueue </span><span class="token operator">!==</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">        </span><span class="token comment">// 处理update回调函数 如: this.setState({}, callback)</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">        </span><span class="token function">commitUpdateQueue</span><span class="token punctuation">(</span><span class="token plain">finishedWork</span><span class="token punctuation">,</span><span class="token plain"> updateQueue</span><span class="token punctuation">,</span><span class="token plain"> instance</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token keyword control-flow">return</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token keyword">case</span><span class="token plain"> </span><span class="token literal-property property">HostComponent</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token keyword">const</span><span class="token plain"> </span><span class="token literal-property property">instance</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">Instance</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> finishedWork</span><span class="token punctuation">.</span><span class="token property-access">stateNode</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">current </span><span class="token operator">===</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"> </span><span class="token operator">&amp;&amp;</span><span class="token plain"> finishedWork</span><span class="token punctuation">.</span><span class="token property-access">flags</span><span class="token plain"> </span><span class="token operator">&amp;</span><span class="token plain"> </span><span class="token maybe-class-name">Update</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">        </span><span class="token keyword">const</span><span class="token plain"> type </span><span class="token operator">=</span><span class="token plain"> finishedWork</span><span class="token punctuation">.</span><span class="token property-access">type</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">        </span><span class="token keyword">const</span><span class="token plain"> props </span><span class="token operator">=</span><span class="token plain"> finishedWork</span><span class="token punctuation">.</span><span class="token property-access">memoizedProps</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">        </span><span class="token comment">// 设置focus等原生状态</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">        </span><span class="token function">commitMount</span><span class="token punctuation">(</span><span class="token plain">instance</span><span class="token punctuation">,</span><span class="token plain"> type</span><span class="token punctuation">,</span><span class="token plain"> props</span><span class="token punctuation">,</span><span class="token plain"> finishedWork</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token keyword control-flow">return</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token punctuation">}</span></div></div></pre></div><p>在<!-- --><code>commitLifeCycles</code>函数中:<!-- --></p><ul><li>对于<!-- --><code>ClassComponent</code>节点, 调用生命周期函数<!-- --><code>componentDidMount</code>或<!-- --><code>componentDidUpdate</code>, 调用<!-- --><code>update.callback</code>回调函数.<!-- --></li><li>对于<!-- --><code>HostComponent</code>节点, 如有<!-- --><code>Update</code>标记, 需要设置一些原生状态(如: <!-- --><code>focus</code>等)<!-- --></li></ul><h3 id="渲染后"><a aria-hidden="true" tabindex="-1" href="#渲染后"><span class="icon icon-link"></span></a>渲染后<!-- --></h3><p>执行完上述步骤之后, 本次渲染任务就已经完成了. 在渲染完成后, 需要做一些重置和清理工作:</p><ol><li><p>清除副作用队列</p><ul><li>由于副作用队列是一个链表, 由于单个<!-- --><code>fiber</code>对象的引用关系, 无法被<!-- --><code>gc回收</code>.<!-- --></li><li>将链表全部拆开, 当<!-- --><code>fiber</code>对象不再使用的时候, 可以被<!-- --><code>gc回收</code>.<!-- --></li></ul></li></ol><p><img alt="" src="/static/clear-effectlist.a691ce6e.png"/></p><ol start="2"><li>检测更新
<!-- --><ul><li>在整个渲染过程中, 有可能产生新的<!-- --><code>update</code>(比如在<!-- --><code>componentDidMount</code>函数中, 再次调用<!-- --><code>setState()</code>).<!-- --></li><li>如果是常规(异步)任务, 不用特殊处理, 调用<!-- --><code>ensureRootIsScheduled</code>确保任务已经注册到调度中心即可.<!-- --></li><li>如果是同步任务, 则主动调用<!-- --><code>flushSyncCallbackQueue</code>(无需再次等待 scheduler 调度), 再次进入 fiber 树构造循环<!-- --></li></ul></li></ol><div class="dumi-default-source-code"><button type="button" class="dumi-default-source-code-copy"><svg viewBox="64 64 896 896"><path d="M832 64H296c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h496v688c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8V96c0-17.7-14.3-32-32-32zM704 192H192c-17.7 0-32 14.3-32 32v530.7c0 8.5 3.4 16.6 9.4 22.6l173.3 173.3c2.2 2.2 4.7 4 7.4 5.5v1.9h4.2c3.5 1.3 7.2 2 11 2H704c17.7 0 32-14.3 32-32V224c0-17.7-14.3-32-32-32zM350 856.2 263.9 770H350v86.2zM664 888H414V746c0-22.1-17.9-40-40-40H232V264h432v624z"></path></svg></button><pre class="prism-code language-js"><div class=""><div class=""><span class="token comment">// 清除副作用队列</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">rootDoesHavePassiveEffects</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token comment">// 有被动作用(使用useEffect), 保存一些全局变量</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword control-flow">else</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token comment">// 分解副作用队列链表, 辅助垃圾回收.</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token comment">// 如果有被动作用(使用useEffect), 会把分解操作放在flushPassiveEffects函数中</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  nextEffect </span><span class="token operator">=</span><span class="token plain"> firstEffect</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword control-flow">while</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">nextEffect </span><span class="token operator">!==</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token keyword">const</span><span class="token plain"> nextNextEffect </span><span class="token operator">=</span><span class="token plain"> nextEffect</span><span class="token punctuation">.</span><span class="token property-access">nextEffect</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    nextEffect</span><span class="token punctuation">.</span><span class="token property-access">nextEffect</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">nextEffect</span><span class="token punctuation">.</span><span class="token property-access">flags</span><span class="token plain"> </span><span class="token operator">&amp;</span><span class="token plain"> </span><span class="token maybe-class-name">Deletion</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token function">detachFiberAfterEffects</span><span class="token punctuation">(</span><span class="token plain">nextEffect</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    nextEffect </span><span class="token operator">=</span><span class="token plain"> nextNextEffect</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token comment">// 重置一些全局变量(省略这部分代码)...</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token comment">// 下面代码用于检测是否有新的更新任务</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token comment">// 比如在componentDidMount函数中, 再次调用setState()</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">
</span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token comment">// 1. 检测常规(异步)任务, 如果有则会发起异步调度(调度中心`scheduler`只能异步调用)</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token function">ensureRootIsScheduled</span><span class="token punctuation">(</span><span class="token plain">root</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token comment">// 2. 检测同步任务, 如果有则主动调用flushSyncCallbackQueue(无需再次等待scheduler调度), 再次进入fiber树构造循环</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token function">flushSyncCallbackQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div></div></pre></div><h2 id="总结"><a aria-hidden="true" tabindex="-1" href="#总结"><span class="icon icon-link"></span></a>总结<!-- --></h2><p>本节分析了<!-- --><code>fiber 树渲染</code>的处理过程, 从宏观上看<!-- --><code>fiber 树渲染</code>位于<!-- --><code>reconciler 运作流程</code>中的输出阶段, 是整个<!-- --><code>reconciler 运作流程</code>的链路中最后一环(从输入到输出). 本节根据源码, 具体从<!-- --><code>渲染前, 渲染, 渲染后</code>三个方面分解了<!-- --><code>commitRootImpl</code>函数. 其中最核心的<!-- --><code>渲染</code>逻辑又分为了 3 个函数, 这 3 个函数共同处理了有副作用<!-- --><code>fiber</code>节点, 并通过渲染器<!-- --><code>react-dom</code>把最新的 DOM 对象渲染到界面上.<!-- --></p></div></div><script>$RC("B:2","S:2")</script>