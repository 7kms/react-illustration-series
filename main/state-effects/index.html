<!DOCTYPE html><html><head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<meta name="keywords" content="react, react原理, 图解react, react fiber原理, react hook原理, react 合成事件, react 基本包结构">
<meta name="description" content="图解React原理系列, 以react核心包结构和运行机制为主线索进行展开. 包括react 基本包结构, react 工作循环, react 启动模式, react fiber原理, react hook原理, react 合成事件等核心内容">
<link rel="shortcut icon" href="/km@2x.png">
<link rel="stylesheet" href="/umi.eb36fa83.css">
<title data-rh="true">状态与副作用</title>
<meta data-rh="true" property="og:title" content="状态与副作用"/><meta data-rh="true" name="description" content="在前文我们已经分析了fiber树从构造到渲染的关键过程. 本节我们站在fiber对象的视角, 考虑一个具体的fiber节点如何影响最终的渲染."/><meta data-rh="true" property="og:description" content="在前文我们已经分析了fiber树从构造到渲染的关键过程. 本节我们站在fiber对象的视角, 考虑一个具体的fiber节点如何影响最终的渲染."/>
</head>
<body>
<noscript><b>Enable JavaScript to run this app.</b></noscript><div id="root"><!--$?--><template id="B:0"></template><div></div><!--/$--></div><script>window.__UMI_LOADER_DATA__ = {}</script>
<script src="/umi.c14ba5aa.js"></script>

</body></html><div hidden id="S:0"><!--$?--><template id="B:1"></template><div></div><!--/$--></div><script>function $RC(a,b){a=document.getElementById(a);b=document.getElementById(b);b.parentNode.removeChild(b);if(a){a=a.previousSibling;var f=a.parentNode,c=a.nextSibling,e=0;do{if(c&&8===c.nodeType){var d=c.data;if("/$"===d)if(0===e)break;else e--;else"$"!==d&&"$?"!==d&&"$!"!==d||e++}d=c.nextSibling;f.removeChild(c);c=d}while(c);for(;b.firstChild;)f.insertBefore(b.firstChild,c);a.data="$";a._reactRetry&&a._reactRetry()}};$RC("B:0","S:0")</script><div hidden id="S:1"><div class="dumi-default-doc-layout"><div class="dumi-default-header"><div class="dumi-default-header-content"><section class="dumi-default-header-left"><a class="dumi-default-logo" href="/"><img src="/logo.png" alt="图解React"/>图解React<!-- --></a></section><section class="dumi-default-header-right"><ul class="dumi-default-navbar"><li><a class="active" href="/main/macro-structure">原理解析</a></li><li><a href="/algorithm/diff">高频算法</a></li><li><a href="/interview/01-setstate">面试题</a></li></ul><div class="dumi-default-header-right-aside"><div class="dumi-default-search-bar"><svg viewBox="64 64 896 896" class="dumi-default-search-bar-svg"><path d="M909.6 854.5 649.9 594.8C690.2 542.7 712 479 712 412c0-80.2-31.3-155.4-87.9-212.1-56.6-56.7-132-87.9-212.1-87.9s-155.5 31.3-212.1 87.9C143.2 256.5 112 331.8 112 412c0 80.1 31.3 155.5 87.9 212.1C256.5 680.8 331.8 712 412 712c67 0 130.6-21.8 182.7-62l259.7 259.6a8.2 8.2 0 0 0 11.6 0l43.6-43.5a8.2 8.2 0 0 0 0-11.6zM570.4 570.4C528 612.7 471.8 636 412 636s-116-23.3-158.4-65.6C211.3 528 188 471.8 188 412s23.3-116.1 65.6-158.4C296 211.3 352.2 188 412 188s116.1 23.2 158.4 65.6S636 352.2 636 412s-23.3 116.1-65.6 158.4z"></path></svg><input class="dumi-default-search-bar-input" placeholder="输入关键字搜索..."/><span class="dumi-default-search-shortcut">⌘<!-- --> K<!-- --></span></div><span class="dumi-default-color-switch" data-dumi-tooltip="亮色模式" data-dumi-tooltip-bottom="true"><svg viewBox="0 0 16 16"><path d="M8 13a1 1 0 0 1 1 1v1a1 1 0 1 1-2 0v-1a1 1 0 0 1 1-1ZM8 3a1 1 0 0 1-1-1V1a1 1 0 1 1 2 0v1a1 1 0 0 1-1 1Zm7 4a1 1 0 1 1 0 2h-1a1 1 0 1 1 0-2h1ZM3 8a1 1 0 0 1-1 1H1a1 1 0 1 1 0-2h1a1 1 0 0 1 1 1Zm9.95 3.536.707.707a1 1 0 0 1-1.414 1.414l-.707-.707a1 1 0 0 1 1.414-1.414Zm-9.9-7.072-.707-.707a1 1 0 0 1 1.414-1.414l.707.707A1 1 0 0 1 3.05 4.464Zm9.9 0a1 1 0 0 1-1.414-1.414l.707-.707a1 1 0 0 1 1.414 1.414l-.707.707Zm-9.9 7.072a1 1 0 0 1 1.414 1.414l-.707.707a1 1 0 0 1-1.414-1.414l.707-.707ZM8 4a4 4 0 1 0 0 8 4 4 0 0 0 0-8Zm0 6.5a2.5 2.5 0 1 1 0-5 2.5 2.5 0 0 1 0 5Z"></path></svg><select><option value="light" selected="">亮色模式<!-- --></option><option value="dark">暗色模式<!-- --></option><option value="auto">跟随系统<!-- --></option></select></span><a class="dumi-default-icon" data-dumi-tooltip="GitHub" data-dumi-tooltip-bottom="true" target="_blank" href="https://github.com/7kms/react-illustration-series" rel="noreferrer"><svg viewBox="64 64 896 896"><path d="M511.6 76.3C264.3 76.2 64 276.4 64 523.5 64 718.9 189.3 885 363.8 946c23.5 5.9 19.9-10.8 19.9-22.2v-77.5c-135.7 15.9-141.2-73.9-150.3-88.9C215 726 171.5 718 184.5 703c30.9-15.9 62.4 4 98.9 57.9 26.4 39.1 77.9 32.5 104 26 5.7-23.5 17.9-44.5 34.7-60.8-140.6-25.2-199.2-111-199.2-213 0-49.5 16.3-95 48.3-131.7-20.4-60.5 1.9-112.3 4.9-120 58.1-5.2 118.5 41.6 123.2 45.3 33-8.9 70.7-13.6 112.9-13.6 42.4 0 80.2 4.9 113.5 13.9 11.3-8.6 67.3-48.8 121.3-43.9 2.9 7.7 24.7 58.3 5.5 118 32.4 36.8 48.9 82.7 48.9 132.3 0 102.2-59 188.1-200 212.9a127.5 127.5 0 0 1 38.1 91v112.5c.8 9 0 17.9 15 17.9 177.1-59.7 304.6-227 304.6-424.1 0-247.2-200.4-447.3-447.5-447.3z"></path></svg></a></div></section><button type="button" class="dumi-default-header-menu-btn"><svg viewBox="64 64 896 896"><path d="M904 160H120c-4.4 0-8 3.6-8 8v64c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-64c0-4.4-3.6-8-8-8zm0 624H120c-4.4 0-8 3.6-8 8v64c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-64c0-4.4-3.6-8-8-8zm0-312H120c-4.4 0-8 3.6-8 8v64c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-64c0-4.4-3.6-8-8-8z"></path></svg></button></div></div><div class="dumi-default-doc-layout-mobile-bar"><button type="button" class="dumi-default-sidebar-btn"><svg viewBox="64 64 896 896"><path d="M120 230h496c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm0 424h496c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm784 140H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0-424H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8z"></path></svg>侧边菜单<!-- --></button></div><main><div class="dumi-default-sidebar"><dl class="dumi-default-sidebar-group"><dt>基本概念</dt><dd><a title="宏观包结构" class="" href="/main/macro-structure">宏观包结构</a></dd><dd><a title="两大工作循环" class="" href="/main/workloop">两大工作循环</a></dd><dd><a title="高频对象" class="" href="/main/object-structure">高频对象</a></dd></dl><dl class="dumi-default-sidebar-group"><dt>运行核心</dt><dd><a title="启动过程" class="" href="/main/bootstrap">启动过程</a></dd><dd><a title="reconciler 运作流程" class="" href="/main/reconciler-workflow">reconciler 运作流程</a></dd><dd><a title="优先级管理" class="" href="/main/priority">优先级管理</a></dd><dd><a title="调度原理" class="" href="/main/scheduler">调度原理</a></dd><dd><a title="fiber 树构造(基础准备)" class="" href="/main/fibertree-prepare">fiber 树构造(基础准备)</a></dd><dd><a title="fiber 树构造(初次创建)" class="" href="/main/fibertree-create">fiber 树构造(初次创建)</a></dd><dd><a title="fiber 树构造(对比更新)" class="" href="/main/fibertree-update">fiber 树构造(对比更新)</a></dd><dd><a title="fiber 树渲染" class="" href="/main/fibertree-commit">fiber 树渲染</a></dd></dl><dl class="dumi-default-sidebar-group"><dt>状态管理</dt><dd><a title="状态与副作用" aria-current="page" class="active" href="/main/state-effects">状态与副作用</a></dd><dd><a title="Hook 原理(概览)" class="" href="/main/hook-summary">Hook 原理(概览)</a></dd><dd><a title="Hook 原理(状态Hook)" class="" href="/main/hook-state">Hook 原理(状态Hook)</a></dd><dd><a title="Hook 原理(副作用Hook)" class="" href="/main/hook-effect">Hook 原理(副作用Hook)</a></dd><dd><a title="context 原理" class="" href="/main/context">context 原理</a></dd></dl><dl class="dumi-default-sidebar-group"><dt>交互</dt><dd><a title="合成事件" class="" href="/main/synthetic-event">合成事件</a></dd></dl></div><div class="dumi-default-content"><!--$?--><template id="B:2"></template><div></div><!--/$--><div class="dumi-default-footer">Copyright © 2023 | Powered by <a href="https://d.umijs.org" target="_blank" rel="noreferrer">dumi</a></div></div></main></div></div><script>$RC("B:1","S:1")</script><div hidden id="S:2"><div class="markdown"><h1 id="状态与副作用"><a aria-hidden="true" tabindex="-1" href="#状态与副作用"><span class="icon icon-link"></span></a>状态与副作用<!-- --></h1><p>在前文我们已经分析了<!-- --><code>fiber树</code>从<!-- --><code>构造</code>到<!-- --><code>渲染</code>的关键过程. 本节我们站在<!-- --><code>fiber</code>对象的视角, 考虑一个具体的<!-- --><code>fiber</code>节点如何影响最终的渲染.<!-- --></p><p>回顾<!-- --><a href="https://github.com/facebook/react/blob/v17.0.2/packages/react-reconciler/src/ReactInternalTypes.js#L47-L174">fiber 数据结构</a>, 并结合前文<!-- --><code>fiber树构造</code>系列的解读, 我们注意到<!-- --><code>fiber</code>众多属性中, 有 2 类属性十分关键:<!-- --></p><ol><li><p><code>fiber</code>节点的自身状态: 在<!-- --><code>renderRootSync[Concurrent]</code>阶段, 为子节点提供确定的输入数据, 直接影响子节点的生成.<!-- --></p></li><li><p><code>fiber</code>节点的副作用: 在<!-- --><code>commitRoot</code>阶段, 如果<!-- --><code>fiber</code>被标记有副作用, 则副作用相关函数会被(同步/异步)调用.<!-- --></p></li></ol><div class="dumi-default-source-code"><button type="button" class="dumi-default-source-code-copy"><svg viewBox="64 64 896 896"><path d="M832 64H296c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h496v688c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8V96c0-17.7-14.3-32-32-32zM704 192H192c-17.7 0-32 14.3-32 32v530.7c0 8.5 3.4 16.6 9.4 22.6l173.3 173.3c2.2 2.2 4.7 4 7.4 5.5v1.9h4.2c3.5 1.3 7.2 2 11 2H704c17.7 0 32-14.3 32-32V224c0-17.7-14.3-32-32-32zM350 856.2 263.9 770H350v86.2zM664 888H414V746c0-22.1-17.9-40-40-40H232V264h432v624z"></path></svg></button><pre class="prism-code language-js"><div class=""><div class=""><span class="token keyword module">export</span><span class="token plain"> type </span><span class="token maybe-class-name">Fiber</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token operator">|</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token comment">// 1. fiber节点自身状态相关</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token literal-property property">pendingProps</span><span class="token operator">:</span><span class="token plain"> any</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token literal-property property">memoizedProps</span><span class="token operator">:</span><span class="token plain"> any</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token literal-property property">updateQueue</span><span class="token operator">:</span><span class="token plain"> mixed</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token literal-property property">memoizedState</span><span class="token operator">:</span><span class="token plain"> any</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">
</span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token comment">// 2. fiber节点副作用(Effect)相关</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token literal-property property">flags</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">Flags</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token literal-property property">subtreeFlags</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">Flags</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token comment">// v17.0.2未启用</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token literal-property property">deletions</span><span class="token operator">:</span><span class="token plain"> </span><span class="token known-class-name class-name">Array</span><span class="token operator">&lt;</span><span class="token maybe-class-name">Fiber</span><span class="token operator">&gt;</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token comment">// v17.0.2未启用</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token literal-property property">nextEffect</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">Fiber</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token literal-property property">firstEffect</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">Fiber</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token literal-property property">lastEffect</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">Fiber</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token operator">|</span><span class="token punctuation">}</span><span class="token punctuation">;</span></div></div></pre></div><h2 id="状态"><a aria-hidden="true" tabindex="-1" href="#状态"><span class="icon icon-link"></span></a>状态<!-- --></h2><p>与<!-- --><code>状态</code>相关有 4 个属性:<!-- --></p><ol><li><code>fiber.pendingProps</code>: 输入属性, 从<!-- --><code>ReactElement</code>对象传入的 props. 它和<!-- --><code>fiber.memoizedProps</code>比较可以得出属性是否变动.<!-- --></li><li><code>fiber.memoizedProps</code>: 上一次生成子节点时用到的属性, 生成子节点之后保持在内存中. 向下生成子节点之前叫做<!-- --><code>pendingProps</code>, 生成子节点之后会把<!-- --><code>pendingProps</code>赋值给<!-- --><code>memoizedProps</code>用于下一次比较.<!-- --><code>pendingProps</code>和<!-- --><code>memoizedProps</code>比较可以得出属性是否变动.<!-- --></li><li><code>fiber.updateQueue</code>: 存储<!-- --><code>update更新对象</code>的队列, 每一次发起更新, 都需要在该队列上创建一个<!-- --><code>update对象</code>.<!-- --></li><li><code>fiber.memoizedState</code>: 上一次生成子节点之后保持在内存中的局部状态.<!-- --></li></ol><p>它们的作用只局限于<!-- --><code>fiber树构造</code>阶段, 直接影响子节点的生成.<!-- --></p><h2 id="副作用"><a aria-hidden="true" tabindex="-1" href="#副作用"><span class="icon icon-link"></span></a>副作用<!-- --></h2><p>与<!-- --><code>副作用</code>相关有 4 个属性:<!-- --></p><ol><li><code>fiber.flags</code>: 标志位, 表明该<!-- --><code>fiber</code>节点有副作用(在 v17.0.2 中共定义了<!-- --><a href="https://github.com/facebook/react/blob/v17.0.2/packages/react-reconciler/src/ReactFiberFlags.js#L13">28 种副作用</a>).<!-- --></li><li><code>fiber.nextEffect</code>: 单向链表, 指向下一个副作用 <!-- --><code>fiber</code>节点.<!-- --></li><li><code>fiber.firstEffect</code>: 单向链表, 指向第一个副作用 <!-- --><code>fiber</code> 节点.<!-- --></li><li><code>fiber.lastEffect</code>: 单向链表, 指向最后一个副作用 <!-- --><code>fiber</code> 节点.<!-- --></li></ol><p>通过前文<!-- --><code>fiber树构造</code>我们知道, 单个<!-- --><code>fiber</code>节点的副作用队列最后都会上移到根节点上. 所以在<!-- --><code>commitRoot</code>阶段中, <!-- --><code>react</code>提供了 3 种处理副作用的方式(详见<!-- --><a href="/main/fibertree-commit#%E6%B8%B2%E6%9F%93">fiber 树渲染</a>).<!-- --></p><p>另外, <!-- --><code>副作用</code>的设计可以理解为对<!-- --><code>状态</code>功能不足的补充.<!-- --></p><ul><li><code>状态</code>是一个<!-- --><code>静态</code>的功能, 它只能为子节点提供数据源.<!-- --></li><li>而<!-- --><code>副作用</code>是一个<!-- --><code>动态</code>功能, 由于它的调用时机是在<!-- --><code>fiber树渲染阶段</code>, 故它拥有更多的能力, 能轻松获取<!-- --><code>突变前快照, 突变后的DOM节点等</code>. 甚至通过<!-- --><code>调用api</code>发起新的一轮<!-- --><code>fiber树构造</code>, 进而改变更多的<!-- --><code>状态</code>, 引发更多的<!-- --><code>副作用</code>.<!-- --></li></ul><h2 id="外部-api"><a aria-hidden="true" tabindex="-1" href="#外部-api"><span class="icon icon-link"></span></a>外部 api<!-- --></h2><p><code>fiber</code>对象的这 2 类属性, 可以影响到渲染结果, 但是<!-- --><code>fiber</code>结构始终是一个内核中的结构, 对于外部来讲是无感知的, 对于调用方来讲, 甚至都无需知道<!-- --><code>fiber</code>结构的存在. 所以正常只有通过暴露<!-- --><code>api</code>来直接或间接的修改这 2 类属性.<!-- --></p><p>从<!-- --><code>react</code>包暴露出的<!-- --><code>api</code>来归纳, 只有 2 类组件支持修改:<!-- --></p><blockquote><p>本节只讨论使用<!-- --><code>api</code>的目的是修改<!-- --><code>fiber</code>的<!-- --><code>状态</code>和<!-- --><code>副作用</code>, 进而可以改变整个渲染结果. 本节先介绍 api 与<!-- --><code>状态</code>和<!-- --><code>副作用</code>的联系, 有关<!-- --><code>api</code>的具体实现会在<!-- --><code>class组件</code>,<!-- --><code>Hook原理</code>章节中详细分析.<!-- --></p></blockquote><h3 id="class-组件"><a aria-hidden="true" tabindex="-1" href="#class-组件"><span class="icon icon-link"></span></a>class 组件<!-- --></h3><div class="dumi-default-source-code"><button type="button" class="dumi-default-source-code-copy"><svg viewBox="64 64 896 896"><path d="M832 64H296c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h496v688c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8V96c0-17.7-14.3-32-32-32zM704 192H192c-17.7 0-32 14.3-32 32v530.7c0 8.5 3.4 16.6 9.4 22.6l173.3 173.3c2.2 2.2 4.7 4 7.4 5.5v1.9h4.2c3.5 1.3 7.2 2 11 2H704c17.7 0 32-14.3 32-32V224c0-17.7-14.3-32-32-32zM350 856.2 263.9 770H350v86.2zM664 888H414V746c0-22.1-17.9-40-40-40H232V264h432v624z"></path></svg></button><pre class="prism-code language-js"><div class=""><div class=""><span class="token keyword">class</span><span class="token plain"> </span><span class="token class-name">App</span><span class="token plain"> </span><span class="token keyword">extends</span><span class="token plain"> </span><span class="token class-name">React</span><span class="token class-name punctuation">.</span><span class="token class-name">Component</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">state</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token comment">// 初始状态</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token literal-property property">a</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">1</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token function-variable function">changeState</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token plain"> </span><span class="token literal-property property">a</span><span class="token operator">:</span><span class="token plain"> </span><span class="token operator">++</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">state</span><span class="token punctuation">.</span><span class="token property-access">a</span><span class="token plain"> </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"> </span><span class="token comment">// 进入reconciler流程</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">
</span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token comment">// 生命周期函数: 状态相关</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword">static</span><span class="token plain"> </span><span class="token function">getDerivedStateFromProps</span><span class="token punctuation">(</span><span class="token parameter">nextProps</span><span class="token parameter punctuation">,</span><span class="token parameter"> prevState</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">&#x27;getDerivedStateFromProps&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token keyword control-flow">return</span><span class="token plain"> prevState</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">
</span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token comment">// 生命周期函数: 状态相关</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token function">shouldComponentUpdate</span><span class="token punctuation">(</span><span class="token parameter">newProps</span><span class="token parameter punctuation">,</span><span class="token parameter"> newState</span><span class="token parameter punctuation">,</span><span class="token parameter"> nextContext</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">&#x27;shouldComponentUpdate&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token keyword control-flow">return</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">
</span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token comment">// 生命周期函数: 副作用相关 fiber.flags |= Update</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token function">componentDidMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">&#x27;componentDidMount&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">
</span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token comment">// 生命周期函数: 副作用相关 fiber.flags |= Snapshot</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token function">getSnapshotBeforeUpdate</span><span class="token punctuation">(</span><span class="token parameter">prevProps</span><span class="token parameter punctuation">,</span><span class="token parameter"> prevState</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">&#x27;getSnapshotBeforeUpdate&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">
</span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token comment">// 生命周期函数: 副作用相关 fiber.flags |= Update</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token function">componentDidUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">&#x27;componentDidUpdate&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">
</span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token comment">// 返回下级ReactElement对象</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token keyword control-flow">return</span><span class="token plain"> </span><span class="token operator">&lt;</span><span class="token plain">button onClick</span><span class="token operator">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">changeState</span><span class="token punctuation">}</span><span class="token operator">&gt;</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">state</span><span class="token punctuation">.</span><span class="token property-access">a</span><span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span><span class="token plain">button</span><span class="token operator">&gt;</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token punctuation">}</span></div></div></pre></div><ol><li><p>状态相关: <!-- --><code>fiber树构造</code>阶段.<!-- --></p><ol><li>构造函数: <!-- --><code>constructor</code>实例化时执行, 可以设置初始 state, 只执行一次.<!-- --></li><li>生命周期: <!-- --><code>getDerivedStateFromProps</code>在<!-- --><code>fiber树构造</code>阶段(<!-- --><code>renderRootSync[Concurrent]</code>)执行, 可以修改 state(<!-- --><a href="https://github.com/facebook/react/blob/v17.0.2/packages/react-reconciler/src/ReactFiberClassComponent.old.js#L867-L875">链接</a>).<!-- --></li><li>生命周期: <!-- --><code>shouldComponentUpdate</code>在, <!-- --><code>fiber树构造</code>阶段(<!-- --><code>renderRootSync[Concurrent]</code>)执行, 返回值决定是否执行 render(<!-- --><a href="https://github.com/facebook/react/blob/v17.0.2/packages/react-reconciler/src/ReactFiberClassComponent.old.js#L1135-L1143">链接</a>).<!-- --></li></ol></li><li><p>副作用相关: <!-- --><code>fiber树渲染</code>阶段.<!-- --></p><ol><li>生命周期: <!-- --><code>getSnapshotBeforeUpdate</code>在<!-- --><code>fiber树渲染</code>阶段(<!-- --><code>commitRoot-&gt;commitBeforeMutationEffects-&gt;commitBeforeMutationEffectOnFiber</code>)执行(<!-- --><a href="https://github.com/facebook/react/blob/v17.0.2/packages/react-reconciler/src/ReactFiberCommitWork.old.js#L264">链接</a>).<!-- --></li><li>生命周期: <!-- --><code>componentDidMount</code>在<!-- --><code>fiber树渲染</code>阶段(<!-- --><code>commitRoot-&gt;commitLayoutEffects-&gt;commitLayoutEffectOnFiber</code>)执行(<!-- --><a href="https://github.com/facebook/react/blob/v17.0.2/packages/react-reconciler/src/ReactFiberCommitWork.old.js#L533">链接</a>).<!-- --></li><li>生命周期: <!-- --><code>componentDidUpdate</code>在<!-- --><code>fiber树渲染</code>阶段(<!-- --><code>commitRoot-&gt;commitLayoutEffects-&gt;commitLayoutEffectOnFiber</code>)执行(<!-- --><a href="https://github.com/facebook/react/blob/v17.0.2/packages/react-reconciler/src/ReactFiberCommitWork.old.js#L587">链接</a>).<!-- --></li></ol></li></ol><p>可以看到, 官方<!-- --><code>api</code>提供的<!-- --><code>class组件</code>生命周期函数实际上也是围绕<!-- --><code>fiber树构造</code>和<!-- --><code>fiber树渲染</code>来提供的.<!-- --></p><h3 id="function-组件"><a aria-hidden="true" tabindex="-1" href="#function-组件"><span class="icon icon-link"></span></a>function 组件<!-- --></h3><p>注: <!-- --><code>function组件</code>与<!-- --><code>class组件</code>最大的不同是: <!-- --><code>class组件</code>会实例化一个<!-- --><code>instance</code>所以拥有独立的局部状态; 而<!-- --><code>function组件</code>不会实例化, 它只是被直接调用, 故无法维护一份独立的局部状态, 只能依靠<!-- --><code>Hook</code>对象间接实现局部状态(有关更多<!-- --><code>Hook</code>实现细节, 在<!-- --><code>Hook原理</code>章节中详细讨论).<!-- --></p><p>在<!-- --><code>v17.0.2</code>中共定义了<!-- --><a href="https://github.com/facebook/react/blob/v17.0.2/packages/react-reconciler/src/ReactFiberHooks.old.js#L111-L125">14 种 Hook</a>, 其中最常用的<!-- --><code>useState, useEffect, useLayoutEffect等</code></p><div class="dumi-default-source-code"><button type="button" class="dumi-default-source-code-copy"><svg viewBox="64 64 896 896"><path d="M832 64H296c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h496v688c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8V96c0-17.7-14.3-32-32-32zM704 192H192c-17.7 0-32 14.3-32 32v530.7c0 8.5 3.4 16.6 9.4 22.6l173.3 173.3c2.2 2.2 4.7 4 7.4 5.5v1.9h4.2c3.5 1.3 7.2 2 11 2H704c17.7 0 32-14.3 32-32V224c0-17.7-14.3-32-32-32zM350 856.2 263.9 770H350v86.2zM664 888H414V746c0-22.1-17.9-40-40-40H232V264h432v624z"></path></svg></button><pre class="prism-code language-js"><div class=""><div class=""><span class="token keyword">function</span><span class="token plain"> </span><span class="token function maybe-class-name">App</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token comment">// 状态相关: 初始状态</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token plain">a</span><span class="token punctuation">,</span><span class="token plain"> setA</span><span class="token punctuation">]</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> </span><span class="token function-variable function">changeState</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token function">setA</span><span class="token punctuation">(</span><span class="token operator">++</span><span class="token plain">a</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"> </span><span class="token comment">// 进入reconciler流程</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">
</span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token comment">// 副作用相关: fiber.flags |= Update | Passive;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token template-string template-punctuation string">`</span><span class="token template-string string">useEffect</span><span class="token template-string template-punctuation string">`</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">
</span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token comment">// 副作用相关: fiber.flags |= Update;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token function">useLayoutEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token template-string template-punctuation string">`</span><span class="token template-string string">useLayoutEffect</span><span class="token template-string template-punctuation string">`</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">
</span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token comment">// 返回下级ReactElement对象</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword control-flow">return</span><span class="token plain"> </span><span class="token operator">&lt;</span><span class="token plain">button onClick</span><span class="token operator">=</span><span class="token punctuation">{</span><span class="token plain">changeState</span><span class="token punctuation">}</span><span class="token operator">&gt;</span><span class="token punctuation">{</span><span class="token plain">a</span><span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span><span class="token plain">button</span><span class="token operator">&gt;</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token punctuation">}</span></div></div></pre></div><ol><li>状态相关: <!-- --><code>fiber树构造</code>阶段.
<!-- --><ol><li><code>useState</code>在<!-- --><code>fiber树构造</code>阶段(<!-- --><code>renderRootSync[Concurrent]</code>)执行, 可以修改<!-- --><code>Hook.memoizedState</code>.<!-- --></li></ol></li><li>副作用相关: <!-- --><code>fiber树渲染</code>阶段.
<!-- --><ol><li><code>useEffect</code>在<!-- --><code>fiber树渲染</code>阶段(<!-- --><code>commitRoot-&gt;commitBeforeMutationEffects-&gt;commitBeforeMutationEffectOnFiber</code>)执行(注意是异步执行, <!-- --><a href="https://github.com/facebook/react/blob/v17.0.2/packages/react-reconciler/src/ReactFiberWorkLoop.old.js#L2290-L2295">链接</a>).<!-- --></li><li><code>useLayoutEffect</code>在<!-- --><code>fiber树渲染</code>阶段(<!-- --><code>commitRoot-&gt;commitLayoutEffects-&gt;commitLayoutEffectOnFiber-&gt;commitHookEffectListMount</code>)执行(同步执行, <!-- --><a href="https://github.com/facebook/react/blob/v17.0.2/packages/react-reconciler/src/ReactFiberCommitWork.old.js#L481">链接</a>).<!-- --></li></ol></li></ol><h3 id="细节与误区"><a aria-hidden="true" tabindex="-1" href="#细节与误区"><span class="icon icon-link"></span></a>细节与误区<!-- --></h3><p>这里有 2 个细节:</p><ol><li><code>useEffect(function(){}, [])</code>中的函数是<!-- --><a href="https://github.com/facebook/react/blob/v17.0.2/packages/react-reconciler/src/ReactFiberWorkLoop.old.js#L2290-L2295">异步执行</a>, 因为它经 过了调度中心(具体实现可以回顾<!-- --><a href="/main/scheduler">调度原理</a>).<!-- --></li><li><code>useLayoutEffect</code>和<!-- --><code>Class组件</code>中的<!-- --><code>componentDidMount,componentDidUpdate</code>从调用时机上来讲是等价的, 因为他们都在<!-- --><code>commitRoot-&gt;commitLayoutEffects</code>函数中被调用.
<!-- --><ul><li>误区: 虽然官网文档推荐尽可能使用标准的 <!-- --><code>useEffect</code> 以避免阻塞视觉更新 , 所以很多开发者使用<!-- --><code>useEffect</code>来代替<!-- --><code>componentDidMount,componentDidUpdate</code>是不准确的, 如果完全类比, <!-- --><code>useLayoutEffect</code>比<!-- --><code>useEffect</code>更符合<!-- --><code>componentDidMount,componentDidUpdate</code>的定义.<!-- --></li></ul></li></ol><p>为了验证上述结论, 可以查看<!-- --><a href="https://codesandbox.io/s/fervent-napier-1ysb5">codesandbox 中的例子</a>.<!-- --></p><h2 id="总结"><a aria-hidden="true" tabindex="-1" href="#总结"><span class="icon icon-link"></span></a>总结<!-- --></h2><p>本节从<!-- --><code>fiber</code>视角出发, 总结了<!-- --><code>fiber</code>节点中可以影响最终渲染结果的 2 类属性(<!-- --><code>状态</code>和<!-- --><code>副作用</code>).并且归纳了<!-- --><code>class</code>和<!-- --><code>function</code>组件中, 直接或间接更改<!-- --><code>fiber</code>属性的常用方式. 最后从<!-- --><code>fiber树构造和渲染</code>的角度对<!-- --><code>class的生命周期函数</code>与<!-- --><code>function的Hooks函数</code>进行了比较.<!-- --></p></div></div><script>$RC("B:2","S:2")</script>