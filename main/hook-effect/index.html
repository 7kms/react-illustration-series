<!DOCTYPE html><html><head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<meta name="keywords" content="react, react原理, 图解react, react fiber原理, react hook原理, react 合成事件, react 基本包结构">
<meta name="description" content="图解React原理系列, 以react核心包结构和运行机制为主线索进行展开. 包括react 基本包结构, react 工作循环, react 启动模式, react fiber原理, react hook原理, react 合成事件等核心内容">
<link rel="shortcut icon" href="/km@2x.png">
<link rel="stylesheet" href="/umi.eb36fa83.css">
<title data-rh="true">Hook 原理(副作用Hook)</title>
<meta data-rh="true" property="og:title" content="Hook 原理(副作用Hook)"/><meta data-rh="true" name="description" content="本节建立在前文Hook 原理(概览)和Hook 原理(状态 Hook)的基础之上, 重点讨论useEffect, useLayoutEffect等标准的副作用Hook."/><meta data-rh="true" property="og:description" content="本节建立在前文Hook 原理(概览)和Hook 原理(状态 Hook)的基础之上, 重点讨论useEffect, useLayoutEffect等标准的副作用Hook."/>
</head>
<body>
<noscript><b>Enable JavaScript to run this app.</b></noscript><div id="root"><!--$?--><template id="B:0"></template><div></div><!--/$--></div><script>window.__UMI_LOADER_DATA__ = {}</script>
<script src="/umi.c14ba5aa.js"></script>

</body></html><div hidden id="S:0"><!--$?--><template id="B:1"></template><div></div><!--/$--></div><script>function $RC(a,b){a=document.getElementById(a);b=document.getElementById(b);b.parentNode.removeChild(b);if(a){a=a.previousSibling;var f=a.parentNode,c=a.nextSibling,e=0;do{if(c&&8===c.nodeType){var d=c.data;if("/$"===d)if(0===e)break;else e--;else"$"!==d&&"$?"!==d&&"$!"!==d||e++}d=c.nextSibling;f.removeChild(c);c=d}while(c);for(;b.firstChild;)f.insertBefore(b.firstChild,c);a.data="$";a._reactRetry&&a._reactRetry()}};$RC("B:0","S:0")</script><div hidden id="S:1"><div class="dumi-default-doc-layout"><div class="dumi-default-header"><div class="dumi-default-header-content"><section class="dumi-default-header-left"><a class="dumi-default-logo" href="/"><img src="/logo.png" alt="图解React"/>图解React<!-- --></a></section><section class="dumi-default-header-right"><ul class="dumi-default-navbar"><li><a class="active" href="/main/macro-structure">原理解析</a></li><li><a href="/algorithm/diff">高频算法</a></li><li><a href="/interview/01-setstate">面试题</a></li></ul><div class="dumi-default-header-right-aside"><div class="dumi-default-search-bar"><svg viewBox="64 64 896 896" class="dumi-default-search-bar-svg"><path d="M909.6 854.5 649.9 594.8C690.2 542.7 712 479 712 412c0-80.2-31.3-155.4-87.9-212.1-56.6-56.7-132-87.9-212.1-87.9s-155.5 31.3-212.1 87.9C143.2 256.5 112 331.8 112 412c0 80.1 31.3 155.5 87.9 212.1C256.5 680.8 331.8 712 412 712c67 0 130.6-21.8 182.7-62l259.7 259.6a8.2 8.2 0 0 0 11.6 0l43.6-43.5a8.2 8.2 0 0 0 0-11.6zM570.4 570.4C528 612.7 471.8 636 412 636s-116-23.3-158.4-65.6C211.3 528 188 471.8 188 412s23.3-116.1 65.6-158.4C296 211.3 352.2 188 412 188s116.1 23.2 158.4 65.6S636 352.2 636 412s-23.3 116.1-65.6 158.4z"></path></svg><input class="dumi-default-search-bar-input" placeholder="输入关键字搜索..."/><span class="dumi-default-search-shortcut">⌘<!-- --> K<!-- --></span></div><span class="dumi-default-color-switch" data-dumi-tooltip="亮色模式" data-dumi-tooltip-bottom="true"><svg viewBox="0 0 16 16"><path d="M8 13a1 1 0 0 1 1 1v1a1 1 0 1 1-2 0v-1a1 1 0 0 1 1-1ZM8 3a1 1 0 0 1-1-1V1a1 1 0 1 1 2 0v1a1 1 0 0 1-1 1Zm7 4a1 1 0 1 1 0 2h-1a1 1 0 1 1 0-2h1ZM3 8a1 1 0 0 1-1 1H1a1 1 0 1 1 0-2h1a1 1 0 0 1 1 1Zm9.95 3.536.707.707a1 1 0 0 1-1.414 1.414l-.707-.707a1 1 0 0 1 1.414-1.414Zm-9.9-7.072-.707-.707a1 1 0 0 1 1.414-1.414l.707.707A1 1 0 0 1 3.05 4.464Zm9.9 0a1 1 0 0 1-1.414-1.414l.707-.707a1 1 0 0 1 1.414 1.414l-.707.707Zm-9.9 7.072a1 1 0 0 1 1.414 1.414l-.707.707a1 1 0 0 1-1.414-1.414l.707-.707ZM8 4a4 4 0 1 0 0 8 4 4 0 0 0 0-8Zm0 6.5a2.5 2.5 0 1 1 0-5 2.5 2.5 0 0 1 0 5Z"></path></svg><select><option value="light" selected="">亮色模式<!-- --></option><option value="dark">暗色模式<!-- --></option><option value="auto">跟随系统<!-- --></option></select></span><a class="dumi-default-icon" data-dumi-tooltip="GitHub" data-dumi-tooltip-bottom="true" target="_blank" href="https://github.com/7kms/react-illustration-series" rel="noreferrer"><svg viewBox="64 64 896 896"><path d="M511.6 76.3C264.3 76.2 64 276.4 64 523.5 64 718.9 189.3 885 363.8 946c23.5 5.9 19.9-10.8 19.9-22.2v-77.5c-135.7 15.9-141.2-73.9-150.3-88.9C215 726 171.5 718 184.5 703c30.9-15.9 62.4 4 98.9 57.9 26.4 39.1 77.9 32.5 104 26 5.7-23.5 17.9-44.5 34.7-60.8-140.6-25.2-199.2-111-199.2-213 0-49.5 16.3-95 48.3-131.7-20.4-60.5 1.9-112.3 4.9-120 58.1-5.2 118.5 41.6 123.2 45.3 33-8.9 70.7-13.6 112.9-13.6 42.4 0 80.2 4.9 113.5 13.9 11.3-8.6 67.3-48.8 121.3-43.9 2.9 7.7 24.7 58.3 5.5 118 32.4 36.8 48.9 82.7 48.9 132.3 0 102.2-59 188.1-200 212.9a127.5 127.5 0 0 1 38.1 91v112.5c.8 9 0 17.9 15 17.9 177.1-59.7 304.6-227 304.6-424.1 0-247.2-200.4-447.3-447.5-447.3z"></path></svg></a></div></section><button type="button" class="dumi-default-header-menu-btn"><svg viewBox="64 64 896 896"><path d="M904 160H120c-4.4 0-8 3.6-8 8v64c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-64c0-4.4-3.6-8-8-8zm0 624H120c-4.4 0-8 3.6-8 8v64c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-64c0-4.4-3.6-8-8-8zm0-312H120c-4.4 0-8 3.6-8 8v64c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-64c0-4.4-3.6-8-8-8z"></path></svg></button></div></div><div class="dumi-default-doc-layout-mobile-bar"><button type="button" class="dumi-default-sidebar-btn"><svg viewBox="64 64 896 896"><path d="M120 230h496c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm0 424h496c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm784 140H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0-424H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8z"></path></svg>侧边菜单<!-- --></button></div><main><div class="dumi-default-sidebar"><dl class="dumi-default-sidebar-group"><dt>基本概念</dt><dd><a title="宏观包结构" class="" href="/main/macro-structure">宏观包结构</a></dd><dd><a title="两大工作循环" class="" href="/main/workloop">两大工作循环</a></dd><dd><a title="高频对象" class="" href="/main/object-structure">高频对象</a></dd></dl><dl class="dumi-default-sidebar-group"><dt>运行核心</dt><dd><a title="启动过程" class="" href="/main/bootstrap">启动过程</a></dd><dd><a title="reconciler 运作流程" class="" href="/main/reconciler-workflow">reconciler 运作流程</a></dd><dd><a title="优先级管理" class="" href="/main/priority">优先级管理</a></dd><dd><a title="调度原理" class="" href="/main/scheduler">调度原理</a></dd><dd><a title="fiber 树构造(基础准备)" class="" href="/main/fibertree-prepare">fiber 树构造(基础准备)</a></dd><dd><a title="fiber 树构造(初次创建)" class="" href="/main/fibertree-create">fiber 树构造(初次创建)</a></dd><dd><a title="fiber 树构造(对比更新)" class="" href="/main/fibertree-update">fiber 树构造(对比更新)</a></dd><dd><a title="fiber 树渲染" class="" href="/main/fibertree-commit">fiber 树渲染</a></dd></dl><dl class="dumi-default-sidebar-group"><dt>状态管理</dt><dd><a title="状态与副作用" class="" href="/main/state-effects">状态与副作用</a></dd><dd><a title="Hook 原理(概览)" class="" href="/main/hook-summary">Hook 原理(概览)</a></dd><dd><a title="Hook 原理(状态Hook)" class="" href="/main/hook-state">Hook 原理(状态Hook)</a></dd><dd><a title="Hook 原理(副作用Hook)" aria-current="page" class="active" href="/main/hook-effect">Hook 原理(副作用Hook)</a></dd><dd><a title="context 原理" class="" href="/main/context">context 原理</a></dd></dl><dl class="dumi-default-sidebar-group"><dt>交互</dt><dd><a title="合成事件" class="" href="/main/synthetic-event">合成事件</a></dd></dl></div><div class="dumi-default-content"><!--$?--><template id="B:2"></template><div></div><!--/$--><div class="dumi-default-footer">Copyright © 2023 | Powered by <a href="https://d.umijs.org" target="_blank" rel="noreferrer">dumi</a></div></div></main></div></div><script>$RC("B:1","S:1")</script><div hidden id="S:2"><div class="markdown"><h1 id="hook-原理副作用-hook"><a aria-hidden="true" tabindex="-1" href="#hook-原理副作用-hook"><span class="icon icon-link"></span></a>Hook 原理(副作用 Hook)<!-- --></h1><p>本节建立在前文<!-- --><a href="/main/hook-summary">Hook 原理(概览)</a>和<!-- --><a href="/main/hook-state">Hook 原理(状态 Hook)</a>的基础之上, 重点讨论<!-- --><code>useEffect, useLayoutEffect</code>等标准的<!-- --><code>副作用Hook</code>.<!-- --></p><h2 id="创建-hook"><a aria-hidden="true" tabindex="-1" href="#创建-hook"><span class="icon icon-link"></span></a>创建 Hook<!-- --></h2><p>在<!-- --><code>fiber</code>初次构造阶段, <!-- --><code>useEffect</code>对应源码<!-- --><a href="https://github.com/facebook/react/blob/v17.0.2/packages/react-reconciler/src/ReactFiberHooks.old.js#L1232-L1248">mountEffect</a>, <!-- --><code>useLayoutEffect</code>对应源码<!-- --><a href="https://github.com/facebook/react/blob/v17.0.2/packages/react-reconciler/src/ReactFiberHooks.old.js#L1268-L1273">mountLayoutEffect</a></p><p><code>mountEffect</code>:<!-- --></p><div class="dumi-default-source-code"><button type="button" class="dumi-default-source-code-copy"><svg viewBox="64 64 896 896"><path d="M832 64H296c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h496v688c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8V96c0-17.7-14.3-32-32-32zM704 192H192c-17.7 0-32 14.3-32 32v530.7c0 8.5 3.4 16.6 9.4 22.6l173.3 173.3c2.2 2.2 4.7 4 7.4 5.5v1.9h4.2c3.5 1.3 7.2 2 11 2H704c17.7 0 32-14.3 32-32V224c0-17.7-14.3-32-32-32zM350 856.2 263.9 770H350v86.2zM664 888H414V746c0-22.1-17.9-40-40-40H232V264h432v624z"></path></svg></button><pre class="prism-code language-js"><div class=""><div class=""><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">mountEffect</span><span class="token punctuation">(</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token function-variable function">create</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> </span><span class="token keyword">void</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token literal-property property">deps</span><span class="token operator">:</span><span class="token plain"> </span><span class="token known-class-name class-name">Array</span><span class="token operator">&lt;</span><span class="token plain">mixed</span><span class="token operator">&gt;</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> </span><span class="token keyword">void</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token punctuation">)</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword">void</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword control-flow">return</span><span class="token plain"> </span><span class="token function">mountEffectImpl</span><span class="token punctuation">(</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token maybe-class-name">UpdateEffect</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> </span><span class="token maybe-class-name">PassiveEffect</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token comment">// fiberFlags</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token maybe-class-name">HookPassive</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token comment">// hookFlags</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    create</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    deps</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token punctuation">}</span></div></div></pre></div><p><code>mountLayoutEffect</code>:<!-- --></p><div class="dumi-default-source-code"><button type="button" class="dumi-default-source-code-copy"><svg viewBox="64 64 896 896"><path d="M832 64H296c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h496v688c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8V96c0-17.7-14.3-32-32-32zM704 192H192c-17.7 0-32 14.3-32 32v530.7c0 8.5 3.4 16.6 9.4 22.6l173.3 173.3c2.2 2.2 4.7 4 7.4 5.5v1.9h4.2c3.5 1.3 7.2 2 11 2H704c17.7 0 32-14.3 32-32V224c0-17.7-14.3-32-32-32zM350 856.2 263.9 770H350v86.2zM664 888H414V746c0-22.1-17.9-40-40-40H232V264h432v624z"></path></svg></button><pre class="prism-code language-js"><div class=""><div class=""><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">mountLayoutEffect</span><span class="token punctuation">(</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token function-variable function">create</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> </span><span class="token keyword">void</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token literal-property property">deps</span><span class="token operator">:</span><span class="token plain"> </span><span class="token known-class-name class-name">Array</span><span class="token operator">&lt;</span><span class="token plain">mixed</span><span class="token operator">&gt;</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> </span><span class="token keyword">void</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token punctuation">)</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword">void</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword control-flow">return</span><span class="token plain"> </span><span class="token function">mountEffectImpl</span><span class="token punctuation">(</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token maybe-class-name">UpdateEffect</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token comment">// fiberFlags</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token maybe-class-name">HookLayout</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token comment">// hookFlags</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    create</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    deps</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token punctuation">}</span></div></div></pre></div><p>可见<!-- --><code>mountEffect</code>和<!-- --><code>mountLayoutEffect</code>内部都直接调用<!-- --><a href="https://github.com/facebook/react/blob/v17.0.2/packages/react-reconciler/src/ReactFiberHooks.old.js#L1193-L1203">mountEffectImpl</a>, 只是参数不同.<!-- --></p><p><code>mountEffectImpl</code>:<!-- --></p><div class="dumi-default-source-code"><button type="button" class="dumi-default-source-code-copy"><svg viewBox="64 64 896 896"><path d="M832 64H296c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h496v688c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8V96c0-17.7-14.3-32-32-32zM704 192H192c-17.7 0-32 14.3-32 32v530.7c0 8.5 3.4 16.6 9.4 22.6l173.3 173.3c2.2 2.2 4.7 4 7.4 5.5v1.9h4.2c3.5 1.3 7.2 2 11 2H704c17.7 0 32-14.3 32-32V224c0-17.7-14.3-32-32-32zM350 856.2 263.9 770H350v86.2zM664 888H414V746c0-22.1-17.9-40-40-40H232V264h432v624z"></path></svg></button><pre class="prism-code language-js"><div class=""><div class=""><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">mountEffectImpl</span><span class="token punctuation">(</span><span class="token parameter">fiberFlags</span><span class="token parameter punctuation">,</span><span class="token parameter"> hookFlags</span><span class="token parameter punctuation">,</span><span class="token parameter"> create</span><span class="token parameter punctuation">,</span><span class="token parameter"> deps</span><span class="token punctuation">)</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword">void</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token comment">// 1. 创建hook</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> hook </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">mountWorkInProgressHook</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> nextDeps </span><span class="token operator">=</span><span class="token plain"> deps </span><span class="token operator">===</span><span class="token plain"> </span><span class="token keyword nil">undefined</span><span class="token plain"> </span><span class="token operator">?</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"> </span><span class="token operator">:</span><span class="token plain"> deps</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token comment">// 2. 设置workInProgress的副作用标记</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  currentlyRenderingFiber</span><span class="token punctuation">.</span><span class="token property-access">flags</span><span class="token plain"> </span><span class="token operator">|=</span><span class="token plain"> fiberFlags</span><span class="token punctuation">;</span><span class="token plain"> </span><span class="token comment">// fiberFlags 被标记到workInProgress</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token comment">// 2. 创建Effect, 挂载到hook.memoizedState上</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  hook</span><span class="token punctuation">.</span><span class="token property-access">memoizedState</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">pushEffect</span><span class="token punctuation">(</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token maybe-class-name">HookHasEffect</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> hookFlags</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token comment">// hookFlags用于创建effect</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    create</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token keyword nil">undefined</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    nextDeps</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token punctuation">}</span></div></div></pre></div><p><code>mountEffectImpl</code>逻辑:<!-- --></p><ol><li>创建<!-- --><code>hook</code></li><li>设置<!-- --><code>workInProgress</code>的副作用标记: <!-- --><code>flags |= fiberFlags</code></li><li>创建<!-- --><code>effect</code>(在<!-- --><code>pushEffect</code>中), 挂载到<!-- --><code>hook.memoizedState</code>上, 即 <!-- --><code>hook.memoizedState = effect</code><ul><li>注意: <!-- --><code>状态Hook</code>中<!-- --><code>hook.memoizedState = state</code></li></ul></li></ol><h3 id="创建-effect"><a aria-hidden="true" tabindex="-1" href="#创建-effect"><span class="icon icon-link"></span></a>创建 Effect<!-- --></h3><p><a href="https://github.com/facebook/react/blob/v17.0.2/packages/react-reconciler/src/ReactFiberHooks.old.js#L1150-L1176">pushEffect</a>:<!-- --></p><div class="dumi-default-source-code"><button type="button" class="dumi-default-source-code-copy"><svg viewBox="64 64 896 896"><path d="M832 64H296c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h496v688c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8V96c0-17.7-14.3-32-32-32zM704 192H192c-17.7 0-32 14.3-32 32v530.7c0 8.5 3.4 16.6 9.4 22.6l173.3 173.3c2.2 2.2 4.7 4 7.4 5.5v1.9h4.2c3.5 1.3 7.2 2 11 2H704c17.7 0 32-14.3 32-32V224c0-17.7-14.3-32-32-32zM350 856.2 263.9 770H350v86.2zM664 888H414V746c0-22.1-17.9-40-40-40H232V264h432v624z"></path></svg></button><pre class="prism-code language-js"><div class=""><div class=""><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">pushEffect</span><span class="token punctuation">(</span><span class="token parameter">tag</span><span class="token parameter punctuation">,</span><span class="token parameter"> create</span><span class="token parameter punctuation">,</span><span class="token parameter"> destroy</span><span class="token parameter punctuation">,</span><span class="token parameter"> deps</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token comment">// 1. 创建effect对象</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> </span><span class="token literal-property property">effect</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">Effect</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    tag</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    create</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    destroy</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    deps</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token literal-property property">next</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token keyword null nil">null</span><span class="token operator">:</span><span class="token plain"> any</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token comment">// 2. 把effect对象添加到环形链表末尾</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword">let</span><span class="token plain"> </span><span class="token literal-property property">componentUpdateQueue</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> </span><span class="token maybe-class-name">FunctionComponentUpdateQueue</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token punctuation">(</span><span class="token plain">currentlyRenderingFiber</span><span class="token punctuation">.</span><span class="token property-access">updateQueue</span><span class="token operator">:</span><span class="token plain"> any</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">componentUpdateQueue </span><span class="token operator">===</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token comment">// 新建 workInProgress.updateQueue 用于挂载effect对象</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    componentUpdateQueue </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">createFunctionComponentUpdateQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    currentlyRenderingFiber</span><span class="token punctuation">.</span><span class="token property-access">updateQueue</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">componentUpdateQueue</span><span class="token operator">:</span><span class="token plain"> any</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token comment">// updateQueue.lastEffect是一个环形链表</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    componentUpdateQueue</span><span class="token punctuation">.</span><span class="token property-access">lastEffect</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> effect</span><span class="token punctuation">.</span><span class="token property-access">next</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> effect</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword control-flow">else</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token keyword">const</span><span class="token plain"> lastEffect </span><span class="token operator">=</span><span class="token plain"> componentUpdateQueue</span><span class="token punctuation">.</span><span class="token property-access">lastEffect</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">lastEffect </span><span class="token operator">===</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      componentUpdateQueue</span><span class="token punctuation">.</span><span class="token property-access">lastEffect</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> effect</span><span class="token punctuation">.</span><span class="token property-access">next</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> effect</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword control-flow">else</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token keyword">const</span><span class="token plain"> firstEffect </span><span class="token operator">=</span><span class="token plain"> lastEffect</span><span class="token punctuation">.</span><span class="token property-access">next</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      lastEffect</span><span class="token punctuation">.</span><span class="token property-access">next</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> effect</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      effect</span><span class="token punctuation">.</span><span class="token property-access">next</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> firstEffect</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      componentUpdateQueue</span><span class="token punctuation">.</span><span class="token property-access">lastEffect</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> effect</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token comment">// 3. 返回effect</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword control-flow">return</span><span class="token plain"> effect</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token punctuation">}</span></div></div></pre></div><p><code>pushEffect</code>逻辑:<!-- --></p><ol><li>创建<!-- --><code>effect</code>.<!-- --></li><li>把<!-- --><code>effect</code>对象添加到环形链表末尾.<!-- --></li><li>返回<!-- --><code>effect</code>.<!-- --></li></ol><p><code>effect</code>的数据结构:<!-- --></p><div class="dumi-default-source-code"><button type="button" class="dumi-default-source-code-copy"><svg viewBox="64 64 896 896"><path d="M832 64H296c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h496v688c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8V96c0-17.7-14.3-32-32-32zM704 192H192c-17.7 0-32 14.3-32 32v530.7c0 8.5 3.4 16.6 9.4 22.6l173.3 173.3c2.2 2.2 4.7 4 7.4 5.5v1.9h4.2c3.5 1.3 7.2 2 11 2H704c17.7 0 32-14.3 32-32V224c0-17.7-14.3-32-32-32zM350 856.2 263.9 770H350v86.2zM664 888H414V746c0-22.1-17.9-40-40-40H232V264h432v624z"></path></svg></button><pre class="prism-code language-js"><div class=""><div class=""><span class="token keyword module">export</span><span class="token plain"> type </span><span class="token maybe-class-name">Effect</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token operator">|</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token literal-property property">tag</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">HookFlags</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token function-variable function">create</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> </span><span class="token keyword">void</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token literal-property property">destroy</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> </span><span class="token keyword">void</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token literal-property property">deps</span><span class="token operator">:</span><span class="token plain"> </span><span class="token known-class-name class-name">Array</span><span class="token operator">&lt;</span><span class="token plain">mixed</span><span class="token operator">&gt;</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token literal-property property">next</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">Effect</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token operator">|</span><span class="token punctuation">}</span><span class="token punctuation">;</span></div></div></pre></div><ul><li><p><code>effect.tag</code>: 使用位掩码形式, 代表<!-- --><code>effect</code>的类型(<!-- --><a href="https://github.com/facebook/react/blob/v17.0.2/packages/react-reconciler/src/ReactHookEffectTags.js#L12-L19">源码</a>).<!-- --></p><div class="dumi-default-source-code"><button type="button" class="dumi-default-source-code-copy"><svg viewBox="64 64 896 896"><path d="M832 64H296c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h496v688c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8V96c0-17.7-14.3-32-32-32zM704 192H192c-17.7 0-32 14.3-32 32v530.7c0 8.5 3.4 16.6 9.4 22.6l173.3 173.3c2.2 2.2 4.7 4 7.4 5.5v1.9h4.2c3.5 1.3 7.2 2 11 2H704c17.7 0 32-14.3 32-32V224c0-17.7-14.3-32-32-32zM350 856.2 263.9 770H350v86.2zM664 888H414V746c0-22.1-17.9-40-40-40H232V264h432v624z"></path></svg></button><pre class="prism-code language-js"><div class=""><div class=""><span class="token keyword module">export</span><span class="token plain"> </span><span class="token keyword">const</span><span class="token plain"> </span><span class="token maybe-class-name">NoFlags</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token comment">/*  */</span><span class="token plain"> </span><span class="token number">0b000</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token keyword module">export</span><span class="token plain"> </span><span class="token keyword">const</span><span class="token plain"> </span><span class="token maybe-class-name">HasEffect</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token comment">/* */</span><span class="token plain"> </span><span class="token number">0b001</span><span class="token punctuation">;</span><span class="token plain"> </span><span class="token comment">// 有副作用, 可以被触发</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token keyword module">export</span><span class="token plain"> </span><span class="token keyword">const</span><span class="token plain"> </span><span class="token maybe-class-name">Layout</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token comment">/*    */</span><span class="token plain"> </span><span class="token number">0b010</span><span class="token punctuation">;</span><span class="token plain"> </span><span class="token comment">// Layout, dom突变后同步触发</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token keyword module">export</span><span class="token plain"> </span><span class="token keyword">const</span><span class="token plain"> </span><span class="token maybe-class-name">Passive</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token comment">/*   */</span><span class="token plain"> </span><span class="token number">0b100</span><span class="token punctuation">;</span><span class="token plain"> </span><span class="token comment">// Passive, dom突变前异步触发</span></div></div></pre></div></li><li><p><code>effect.create</code>: 实际上就是通过<!-- --><code>useEffect()</code>所传入的函数.<!-- --></p></li><li><p><code>effect.deps</code>: 依赖项, 如果依赖项变动, 会创建新的<!-- --><code>effect</code>.<!-- --></p></li></ul><p><code>renderWithHooks</code>执行完成后, 我们可以画出<!-- --><code>fiber</code>,<!-- --><code>hook</code>,<!-- --><code>effect</code>三者的引用关系:<!-- --></p><p><img alt="" src="/static/renderwithhooks-create.5c2a7f78.png"/></p><p>现在<!-- --><code>workInProgress.flags</code>被打上了标记, 最后会在<!-- --><code>fiber树渲染</code>阶段的<!-- --><code>commitRoot</code>函数中处理. (这期间的所有过程可以回顾前文<!-- --><code>fiber树构造/fiber树渲染</code>系列, 此处不再赘述)<!-- --></p><h3 id="useeffect--uselayouteffect"><a aria-hidden="true" tabindex="-1" href="#useeffect--uselayouteffect"><span class="icon icon-link"></span></a>useEffect &amp; useLayoutEffect<!-- --></h3><p>站在<!-- --><code>fiber,hook,effect</code>的视角, 无需关心这个<!-- --><code>hook</code>是通过<!-- --><code>useEffect</code>还是<!-- --><code>useLayoutEffect</code>创建的. 只需要关心内部<!-- --><code>fiber.flags</code>,<!-- --><code>effect.tag</code>的状态.<!-- --></p><p>所以<!-- --><code>useEffect</code>与<!-- --><code>useLayoutEffect</code>的区别如下:<!-- --></p><ol><li><code>fiber.flags</code>不同<!-- --></li></ol><ul><li>使用<!-- --><code>useEffect</code>时: <!-- --><code>fiber.flags = UpdateEffect | PassiveEffect</code>.<!-- --></li><li>使用<!-- --><code>useLayoutEffect</code>时: <!-- --><code>fiber.flags = UpdateEffect</code>.<!-- --></li></ul><ol start="2"><li><code>effect.tag</code>不同<!-- --></li></ol><ul><li>使用<!-- --><code>useEffect</code>时: <!-- --><code>effect.tag = HookHasEffect | HookPassive</code>.<!-- --></li><li>使用<!-- --><code>useLayoutEffect</code>时: <!-- --><code>effect.tag = HookHasEffect | HookLayout</code>.<!-- --></li></ul><h2 id="处理-effect-回调"><a aria-hidden="true" tabindex="-1" href="#处理-effect-回调"><span class="icon icon-link"></span></a>处理 Effect 回调<!-- --></h2><p>完成<!-- --><code>fiber树构造</code>后, 逻辑会进入<!-- --><code>渲染</code>阶段. 通过<!-- --><a href="/main/fibertree-commit">fiber 树渲染</a>中的介绍, 在<!-- --><code>commitRootImpl</code>函数中, 整个渲染过程被 3 个函数分布实现:<!-- --></p><ol><li><a href="https://github.com/facebook/react/blob/v17.0.2/packages/react-reconciler/src/ReactFiberWorkLoop.old.js#L2256-L2300">commitBeforeMutationEffects</a></li><li><a href="https://github.com/facebook/react/blob/v17.0.2/packages/react-reconciler/src/ReactFiberWorkLoop.old.js#L2302-L2383">commitMutationEffects</a></li><li><a href="https://github.com/facebook/react/blob/v17.0.2/packages/react-reconciler/src/ReactFiberWorkLoop.old.js#L2385-L2432">commitLayoutEffects</a></li></ol><p>这 3 个函数会处理<!-- --><code>fiber.flags</code>, 也会根据情况处理<!-- --><code>fiber.updateQueue.lastEffect</code></p><h3 id="commitbeforemutationeffects"><a aria-hidden="true" tabindex="-1" href="#commitbeforemutationeffects"><span class="icon icon-link"></span></a>commitBeforeMutationEffects<!-- --></h3><p>第一阶段: dom 变更之前, 处理副作用队列中带有<!-- --><code>Passive</code>标记的<!-- --><code>fiber</code>节点.<!-- --></p><div class="dumi-default-source-code"><button type="button" class="dumi-default-source-code-copy"><svg viewBox="64 64 896 896"><path d="M832 64H296c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h496v688c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8V96c0-17.7-14.3-32-32-32zM704 192H192c-17.7 0-32 14.3-32 32v530.7c0 8.5 3.4 16.6 9.4 22.6l173.3 173.3c2.2 2.2 4.7 4 7.4 5.5v1.9h4.2c3.5 1.3 7.2 2 11 2H704c17.7 0 32-14.3 32-32V224c0-17.7-14.3-32-32-32zM350 856.2 263.9 770H350v86.2zM664 888H414V746c0-22.1-17.9-40-40-40H232V264h432v624z"></path></svg></button><pre class="prism-code language-js"><div class=""><div class=""><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">commitBeforeMutationEffects</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword control-flow">while</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">nextEffect </span><span class="token operator">!==</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token comment">// ...省略无关代码, 只保留Hook相关</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">
</span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token comment">// 处理`Passive`标记</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token keyword">const</span><span class="token plain"> flags </span><span class="token operator">=</span><span class="token plain"> nextEffect</span><span class="token punctuation">.</span><span class="token property-access">flags</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token plain">flags </span><span class="token operator">&amp;</span><span class="token plain"> </span><span class="token maybe-class-name">Passive</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token operator">!==</span><span class="token plain"> </span><span class="token maybe-class-name">NoFlags</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token plain">rootDoesHavePassiveEffects</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">        rootDoesHavePassiveEffects </span><span class="token operator">=</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">        </span><span class="token function">scheduleCallback</span><span class="token punctuation">(</span><span class="token maybe-class-name">NormalSchedulerPriority</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">          </span><span class="token function">flushPassiveEffects</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">          </span><span class="token keyword control-flow">return</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">        </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    nextEffect </span><span class="token operator">=</span><span class="token plain"> nextEffect</span><span class="token punctuation">.</span><span class="token property-access">nextEffect</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token punctuation">}</span></div></div></pre></div><p>注意: 由于<!-- --><code>flushPassiveEffects</code>被包裹在<!-- --><code>scheduleCallback</code>回调中, 由<!-- --><code>调度中心</code>来处理, 且参数是<!-- --><code>NormalSchedulerPriority</code>, 故这是一个异步回调(具体原理可以回顾<!-- --><a href="/main/scheduler">React 调度原理(scheduler)</a>).<!-- --></p><p>由于<!-- --><code>scheduleCallback(NormalSchedulerPriority,callback)</code>是异步的, <!-- --><code>flushPassiveEffects</code>并不会立即执行. 此处先跳过<!-- --><code>flushPassiveEffects</code>的分析, 继续跟进<!-- --><code>commitRoot</code>.<!-- --></p><h3 id="commitmutationeffects"><a aria-hidden="true" tabindex="-1" href="#commitmutationeffects"><span class="icon icon-link"></span></a>commitMutationEffects<!-- --></h3><p>第二阶段: dom 变更, 界面得到更新.</p><div class="dumi-default-source-code"><button type="button" class="dumi-default-source-code-copy"><svg viewBox="64 64 896 896"><path d="M832 64H296c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h496v688c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8V96c0-17.7-14.3-32-32-32zM704 192H192c-17.7 0-32 14.3-32 32v530.7c0 8.5 3.4 16.6 9.4 22.6l173.3 173.3c2.2 2.2 4.7 4 7.4 5.5v1.9h4.2c3.5 1.3 7.2 2 11 2H704c17.7 0 32-14.3 32-32V224c0-17.7-14.3-32-32-32zM350 856.2 263.9 770H350v86.2zM664 888H414V746c0-22.1-17.9-40-40-40H232V264h432v624z"></path></svg></button><pre class="prism-code language-js"><div class=""><div class=""><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">commitMutationEffects</span><span class="token punctuation">(</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token parameter literal-property property">root</span><span class="token parameter operator">:</span><span class="token parameter"> </span><span class="token parameter maybe-class-name">FiberRoot</span><span class="token parameter punctuation">,</span><span class="token parameter"></span></div></div><div class=""><div class=""><span class="token parameter">  </span><span class="token parameter literal-property property">renderPriorityLevel</span><span class="token parameter operator">:</span><span class="token parameter"> </span><span class="token parameter maybe-class-name">ReactPriorityLevel</span><span class="token parameter punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token comment">// ...省略无关代码, 只保留Hook相关</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword control-flow">while</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">nextEffect </span><span class="token operator">!==</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token keyword">const</span><span class="token plain"> flags </span><span class="token operator">=</span><span class="token plain"> nextEffect</span><span class="token punctuation">.</span><span class="token property-access">flags</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token keyword">const</span><span class="token plain"> primaryFlags </span><span class="token operator">=</span><span class="token plain"> flags </span><span class="token operator">&amp;</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token maybe-class-name">Placement</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> </span><span class="token maybe-class-name">Update</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> </span><span class="token maybe-class-name">Deletion</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> </span><span class="token maybe-class-name">Hydrating</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token keyword control-flow">switch</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">primaryFlags</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token keyword">case</span><span class="token plain"> </span><span class="token literal-property property">Update</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">        </span><span class="token comment">// useEffect,useLayoutEffect都会设置Update标记</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">        </span><span class="token comment">// 更新节点</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">        </span><span class="token keyword">const</span><span class="token plain"> current </span><span class="token operator">=</span><span class="token plain"> nextEffect</span><span class="token punctuation">.</span><span class="token property-access">alternate</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">        </span><span class="token function">commitWork</span><span class="token punctuation">(</span><span class="token plain">current</span><span class="token punctuation">,</span><span class="token plain"> nextEffect</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">        </span><span class="token keyword control-flow">break</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    nextEffect </span><span class="token operator">=</span><span class="token plain"> nextEffect</span><span class="token punctuation">.</span><span class="token property-access">nextEffect</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">
</span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">commitWork</span><span class="token punctuation">(</span><span class="token parameter literal-property property">current</span><span class="token parameter operator">:</span><span class="token parameter"> </span><span class="token parameter maybe-class-name">Fiber</span><span class="token parameter"> </span><span class="token parameter operator">|</span><span class="token parameter"> </span><span class="token parameter keyword null nil">null</span><span class="token parameter punctuation">,</span><span class="token parameter"> </span><span class="token parameter literal-property property">finishedWork</span><span class="token parameter operator">:</span><span class="token parameter"> </span><span class="token parameter maybe-class-name">Fiber</span><span class="token punctuation">)</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword">void</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token comment">// ...省略无关代码, 只保留Hook相关</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword control-flow">switch</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">finishedWork</span><span class="token punctuation">.</span><span class="token property-access">tag</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token keyword">case</span><span class="token plain"> </span><span class="token literal-property property">FunctionComponent</span><span class="token operator">:</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token keyword">case</span><span class="token plain"> </span><span class="token literal-property property">ForwardRef</span><span class="token operator">:</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token keyword">case</span><span class="token plain"> </span><span class="token literal-property property">MemoComponent</span><span class="token operator">:</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token keyword">case</span><span class="token plain"> </span><span class="token literal-property property">SimpleMemoComponent</span><span class="token operator">:</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token keyword">case</span><span class="token plain"> </span><span class="token literal-property property">Block</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token comment">// 在突变阶段调用销毁函数, 保证所有的effect.destroy函数都会在effect.create之前执行</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token function">commitHookEffectListUnmount</span><span class="token punctuation">(</span><span class="token maybe-class-name">HookLayout</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> </span><span class="token maybe-class-name">HookHasEffect</span><span class="token punctuation">,</span><span class="token plain"> finishedWork</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token keyword control-flow">return</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">
</span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token comment">// 依次执行: effect.destroy</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">commitHookEffectListUnmount</span><span class="token punctuation">(</span><span class="token parameter literal-property property">tag</span><span class="token parameter operator">:</span><span class="token parameter"> number</span><span class="token parameter punctuation">,</span><span class="token parameter"> </span><span class="token parameter literal-property property">finishedWork</span><span class="token parameter operator">:</span><span class="token parameter"> </span><span class="token parameter maybe-class-name">Fiber</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> </span><span class="token literal-property property">updateQueue</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">FunctionComponentUpdateQueue</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token punctuation">(</span><span class="token plain">finishedWork</span><span class="token punctuation">.</span><span class="token property-access">updateQueue</span><span class="token operator">:</span><span class="token plain"> any</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> lastEffect </span><span class="token operator">=</span><span class="token plain"> updateQueue </span><span class="token operator">!==</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"> </span><span class="token operator">?</span><span class="token plain"> updateQueue</span><span class="token punctuation">.</span><span class="token property-access">lastEffect</span><span class="token plain"> </span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">lastEffect </span><span class="token operator">!==</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token keyword">const</span><span class="token plain"> firstEffect </span><span class="token operator">=</span><span class="token plain"> lastEffect</span><span class="token punctuation">.</span><span class="token property-access">next</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token keyword">let</span><span class="token plain"> effect </span><span class="token operator">=</span><span class="token plain"> firstEffect</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token keyword control-flow">do</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token plain">effect</span><span class="token punctuation">.</span><span class="token property-access">tag</span><span class="token plain"> </span><span class="token operator">&amp;</span><span class="token plain"> tag</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token operator">===</span><span class="token plain"> tag</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">        </span><span class="token comment">// 根据传入的tag过滤 effect链表.</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">        </span><span class="token keyword">const</span><span class="token plain"> destroy </span><span class="token operator">=</span><span class="token plain"> effect</span><span class="token punctuation">.</span><span class="token property-access">destroy</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">        effect</span><span class="token punctuation">.</span><span class="token property-access">destroy</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword nil">undefined</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">        </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">destroy </span><span class="token operator">!==</span><span class="token plain"> </span><span class="token keyword nil">undefined</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">          </span><span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">        </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      effect </span><span class="token operator">=</span><span class="token plain"> effect</span><span class="token punctuation">.</span><span class="token property-access">next</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword control-flow">while</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">effect </span><span class="token operator">!==</span><span class="token plain"> firstEffect</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token punctuation">}</span></div></div></pre></div><p>调用关系: <!-- --><code>commitMutationEffects-&gt;commitWork-&gt;commitHookEffectListUnmount</code>.<!-- --></p><ul><li>注意在调用<!-- --><code>commitHookEffectListUnmount(HookLayout | HookHasEffect, finishedWork)</code>时, 参数是<!-- --><code>HookLayout | HookHasEffect</code>.<!-- --></li><li>而<!-- --><code>HookLayout | HookHasEffect</code>是通过<!-- --><code>useLayoutEffect</code>创建的<!-- --><code>effect</code>. 所以<!-- --><code>commitHookEffectListUnmount</code>函数只能处理由<!-- --><code>useLayoutEffect()</code>创建的<!-- --><code>effect</code>.<!-- --></li><li>同步调用<!-- --><code>effect.destroy()</code>.<!-- --></li></ul><h3 id="commitlayouteffects"><a aria-hidden="true" tabindex="-1" href="#commitlayouteffects"><span class="icon icon-link"></span></a>commitLayoutEffects<!-- --></h3><p>第三阶段: dom 变更后</p><div class="dumi-default-source-code"><button type="button" class="dumi-default-source-code-copy"><svg viewBox="64 64 896 896"><path d="M832 64H296c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h496v688c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8V96c0-17.7-14.3-32-32-32zM704 192H192c-17.7 0-32 14.3-32 32v530.7c0 8.5 3.4 16.6 9.4 22.6l173.3 173.3c2.2 2.2 4.7 4 7.4 5.5v1.9h4.2c3.5 1.3 7.2 2 11 2H704c17.7 0 32-14.3 32-32V224c0-17.7-14.3-32-32-32zM350 856.2 263.9 770H350v86.2zM664 888H414V746c0-22.1-17.9-40-40-40H232V264h432v624z"></path></svg></button><pre class="prism-code language-js"><div class=""><div class=""><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">commitLayoutEffects</span><span class="token punctuation">(</span><span class="token parameter literal-property property">root</span><span class="token parameter operator">:</span><span class="token parameter"> </span><span class="token parameter maybe-class-name">FiberRoot</span><span class="token parameter punctuation">,</span><span class="token parameter"> </span><span class="token parameter literal-property property">committedLanes</span><span class="token parameter operator">:</span><span class="token parameter"> </span><span class="token parameter maybe-class-name">Lanes</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token comment">// ...省略无关代码, 只保留Hook相关</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword control-flow">while</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">nextEffect </span><span class="token operator">!==</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token keyword">const</span><span class="token plain"> flags </span><span class="token operator">=</span><span class="token plain"> nextEffect</span><span class="token punctuation">.</span><span class="token property-access">flags</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">flags </span><span class="token operator">&amp;</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token maybe-class-name">Update</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> </span><span class="token maybe-class-name">Callback</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token comment">// useEffect,useLayoutEffect都会设置Update标记</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token keyword">const</span><span class="token plain"> current </span><span class="token operator">=</span><span class="token plain"> nextEffect</span><span class="token punctuation">.</span><span class="token property-access">alternate</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token function">commitLayoutEffectOnFiber</span><span class="token punctuation">(</span><span class="token plain">root</span><span class="token punctuation">,</span><span class="token plain"> current</span><span class="token punctuation">,</span><span class="token plain"> nextEffect</span><span class="token punctuation">,</span><span class="token plain"> committedLanes</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    nextEffect </span><span class="token operator">=</span><span class="token plain"> nextEffect</span><span class="token punctuation">.</span><span class="token property-access">nextEffect</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">
</span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">commitLifeCycles</span><span class="token punctuation">(</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token parameter literal-property property">finishedRoot</span><span class="token parameter operator">:</span><span class="token parameter"> </span><span class="token parameter maybe-class-name">FiberRoot</span><span class="token parameter punctuation">,</span><span class="token parameter"></span></div></div><div class=""><div class=""><span class="token parameter">  </span><span class="token parameter literal-property property">current</span><span class="token parameter operator">:</span><span class="token parameter"> </span><span class="token parameter maybe-class-name">Fiber</span><span class="token parameter"> </span><span class="token parameter operator">|</span><span class="token parameter"> </span><span class="token parameter keyword null nil">null</span><span class="token parameter punctuation">,</span><span class="token parameter"></span></div></div><div class=""><div class=""><span class="token parameter">  </span><span class="token parameter literal-property property">finishedWork</span><span class="token parameter operator">:</span><span class="token parameter"> </span><span class="token parameter maybe-class-name">Fiber</span><span class="token parameter punctuation">,</span><span class="token parameter"></span></div></div><div class=""><div class=""><span class="token parameter">  </span><span class="token parameter literal-property property">committedLanes</span><span class="token parameter operator">:</span><span class="token parameter"> </span><span class="token parameter maybe-class-name">Lanes</span><span class="token parameter punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token punctuation">)</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword">void</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token comment">// ...省略无关代码, 只保留Hook相关</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword control-flow">switch</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">finishedWork</span><span class="token punctuation">.</span><span class="token property-access">tag</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token keyword">case</span><span class="token plain"> </span><span class="token literal-property property">FunctionComponent</span><span class="token operator">:</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token keyword">case</span><span class="token plain"> </span><span class="token literal-property property">ForwardRef</span><span class="token operator">:</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token keyword">case</span><span class="token plain"> </span><span class="token literal-property property">SimpleMemoComponent</span><span class="token operator">:</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token keyword">case</span><span class="token plain"> </span><span class="token literal-property property">Block</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token comment">// 在此之前commitMutationEffects函数中, effect.destroy已经被调用, 所以effect.destroy永远不会影响到effect.create</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token function">commitHookEffectListMount</span><span class="token punctuation">(</span><span class="token maybe-class-name">HookLayout</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> </span><span class="token maybe-class-name">HookHasEffect</span><span class="token punctuation">,</span><span class="token plain"> finishedWork</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">
</span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token function">schedulePassiveEffects</span><span class="token punctuation">(</span><span class="token plain">finishedWork</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token keyword control-flow">return</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">
</span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">commitHookEffectListMount</span><span class="token punctuation">(</span><span class="token parameter literal-property property">tag</span><span class="token parameter operator">:</span><span class="token parameter"> number</span><span class="token parameter punctuation">,</span><span class="token parameter"> </span><span class="token parameter literal-property property">finishedWork</span><span class="token parameter operator">:</span><span class="token parameter"> </span><span class="token parameter maybe-class-name">Fiber</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> </span><span class="token literal-property property">updateQueue</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">FunctionComponentUpdateQueue</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token punctuation">(</span><span class="token plain">finishedWork</span><span class="token punctuation">.</span><span class="token property-access">updateQueue</span><span class="token operator">:</span><span class="token plain"> any</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> lastEffect </span><span class="token operator">=</span><span class="token plain"> updateQueue </span><span class="token operator">!==</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"> </span><span class="token operator">?</span><span class="token plain"> updateQueue</span><span class="token punctuation">.</span><span class="token property-access">lastEffect</span><span class="token plain"> </span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">lastEffect </span><span class="token operator">!==</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token keyword">const</span><span class="token plain"> firstEffect </span><span class="token operator">=</span><span class="token plain"> lastEffect</span><span class="token punctuation">.</span><span class="token property-access">next</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token keyword">let</span><span class="token plain"> effect </span><span class="token operator">=</span><span class="token plain"> firstEffect</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token keyword control-flow">do</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token plain">effect</span><span class="token punctuation">.</span><span class="token property-access">tag</span><span class="token plain"> </span><span class="token operator">&amp;</span><span class="token plain"> tag</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token operator">===</span><span class="token plain"> tag</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">        </span><span class="token keyword">const</span><span class="token plain"> create </span><span class="token operator">=</span><span class="token plain"> effect</span><span class="token punctuation">.</span><span class="token property-access">create</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">        effect</span><span class="token punctuation">.</span><span class="token property-access">destroy</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      effect </span><span class="token operator">=</span><span class="token plain"> effect</span><span class="token punctuation">.</span><span class="token property-access">next</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword control-flow">while</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">effect </span><span class="token operator">!==</span><span class="token plain"> firstEffect</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token punctuation">}</span></div></div></pre></div><ol><li><p>调用关系: <!-- --><code>commitLayoutEffects-&gt;commitLayoutEffectOnFiber(commitLifeCycles)-&gt;commitHookEffectListMount</code>.<!-- --></p><ul><li>注意在调用<!-- --><code>commitHookEffectListMount(HookLayout | HookHasEffect, finishedWork)</code>时, 参数是<!-- --><code>HookLayout | HookHasEffect</code>,所以只处理由<!-- --><code>useLayoutEffect()</code>创建的<!-- --><code>effect</code>.<!-- --></li><li>调用<!-- --><code>effect.create()</code>之后, 将返回值赋值到<!-- --><code>effect.destroy</code>.<!-- --></li></ul></li><li><p>为<!-- --><code>flushPassiveEffects</code>做准备<!-- --></p><ul><li><p><code>commitLifeCycles</code>中的<!-- --><code>schedulePassiveEffects(finishedWork)</code>, 其形参<!-- --><code>finishedWork</code>实际上指代当前正在被遍历的<!-- --><code>有副作用的fiber</code></p></li><li><p><code>schedulePassiveEffects</code>比较简单, 就是把带有<!-- --><code>Passive</code>标记的<!-- --><code>effect</code>筛选出来(由<!-- --><code>useEffect</code>创建), 添加到一个全局数组(<!-- --><code>pendingPassiveHookEffectsUnmount</code>和<!-- --><code>pendingPassiveHookEffectsMount</code>).<!-- --></p><div class="dumi-default-source-code"><button type="button" class="dumi-default-source-code-copy"><svg viewBox="64 64 896 896"><path d="M832 64H296c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h496v688c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8V96c0-17.7-14.3-32-32-32zM704 192H192c-17.7 0-32 14.3-32 32v530.7c0 8.5 3.4 16.6 9.4 22.6l173.3 173.3c2.2 2.2 4.7 4 7.4 5.5v1.9h4.2c3.5 1.3 7.2 2 11 2H704c17.7 0 32-14.3 32-32V224c0-17.7-14.3-32-32-32zM350 856.2 263.9 770H350v86.2zM664 888H414V746c0-22.1-17.9-40-40-40H232V264h432v624z"></path></svg></button><pre class="prism-code language-js"><div class=""><div class=""><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">schedulePassiveEffects</span><span class="token punctuation">(</span><span class="token parameter literal-property property">finishedWork</span><span class="token parameter operator">:</span><span class="token parameter"> </span><span class="token parameter maybe-class-name">Fiber</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token comment">// 1. 获取 fiber.updateQueue</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> </span><span class="token literal-property property">updateQueue</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">FunctionComponentUpdateQueue</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token punctuation">(</span><span class="token plain">finishedWork</span><span class="token punctuation">.</span><span class="token property-access">updateQueue</span><span class="token operator">:</span><span class="token plain"> any</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token comment">// 2. 获取 effect环形队列</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> lastEffect </span><span class="token operator">=</span><span class="token plain"> updateQueue </span><span class="token operator">!==</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"> </span><span class="token operator">?</span><span class="token plain"> updateQueue</span><span class="token punctuation">.</span><span class="token property-access">lastEffect</span><span class="token plain"> </span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">lastEffect </span><span class="token operator">!==</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token keyword">const</span><span class="token plain"> firstEffect </span><span class="token operator">=</span><span class="token plain"> lastEffect</span><span class="token punctuation">.</span><span class="token property-access">next</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token keyword">let</span><span class="token plain"> effect </span><span class="token operator">=</span><span class="token plain"> firstEffect</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token keyword control-flow">do</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token keyword">const</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"> next</span><span class="token punctuation">,</span><span class="token plain"> tag </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> effect</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token comment">// 3. 筛选出由useEffect()创建的`effect`</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">        </span><span class="token punctuation">(</span><span class="token plain">tag </span><span class="token operator">&amp;</span><span class="token plain"> </span><span class="token maybe-class-name">HookPassive</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token operator">!==</span><span class="token plain"> </span><span class="token maybe-class-name">NoHookEffect</span><span class="token plain"> </span><span class="token operator">&amp;&amp;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">        </span><span class="token punctuation">(</span><span class="token plain">tag </span><span class="token operator">&amp;</span><span class="token plain"> </span><span class="token maybe-class-name">HookHasEffect</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token operator">!==</span><span class="token plain"> </span><span class="token maybe-class-name">NoHookEffect</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">        </span><span class="token comment">// 把effect添加到全局数组, 等待`flushPassiveEffects`处理</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">        </span><span class="token function">enqueuePendingPassiveHookEffectUnmount</span><span class="token punctuation">(</span><span class="token plain">finishedWork</span><span class="token punctuation">,</span><span class="token plain"> effect</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">        </span><span class="token function">enqueuePendingPassiveHookEffectMount</span><span class="token punctuation">(</span><span class="token plain">finishedWork</span><span class="token punctuation">,</span><span class="token plain"> effect</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      effect </span><span class="token operator">=</span><span class="token plain"> next</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword control-flow">while</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">effect </span><span class="token operator">!==</span><span class="token plain"> firstEffect</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">
</span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token keyword module">export</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">enqueuePendingPassiveHookEffectUnmount</span><span class="token punctuation">(</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token parameter literal-property property">fiber</span><span class="token parameter operator">:</span><span class="token parameter"> </span><span class="token parameter maybe-class-name">Fiber</span><span class="token parameter punctuation">,</span><span class="token parameter"></span></div></div><div class=""><div class=""><span class="token parameter">  </span><span class="token parameter literal-property property">effect</span><span class="token parameter operator">:</span><span class="token parameter"> </span><span class="token parameter maybe-class-name">HookEffect</span><span class="token parameter punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token punctuation">)</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword">void</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token comment">// unmount effects 数组</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  pendingPassiveHookEffectsUnmount</span><span class="token punctuation">.</span><span class="token method function property-access">push</span><span class="token punctuation">(</span><span class="token plain">effect</span><span class="token punctuation">,</span><span class="token plain"> fiber</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">
</span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token keyword module">export</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">enqueuePendingPassiveHookEffectMount</span><span class="token punctuation">(</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token parameter literal-property property">fiber</span><span class="token parameter operator">:</span><span class="token parameter"> </span><span class="token parameter maybe-class-name">Fiber</span><span class="token parameter punctuation">,</span><span class="token parameter"></span></div></div><div class=""><div class=""><span class="token parameter">  </span><span class="token parameter literal-property property">effect</span><span class="token parameter operator">:</span><span class="token parameter"> </span><span class="token parameter maybe-class-name">HookEffect</span><span class="token parameter punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token punctuation">)</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword">void</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token comment">// mount effects 数组</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  pendingPassiveHookEffectsMount</span><span class="token punctuation">.</span><span class="token method function property-access">push</span><span class="token punctuation">(</span><span class="token plain">effect</span><span class="token punctuation">,</span><span class="token plain"> fiber</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token punctuation">}</span></div></div></pre></div></li></ul></li></ol><p>综上<!-- --><code>commitMutationEffects</code>和<!-- --><code>commitLayoutEffects</code>2 个函数, 带有<!-- --><code>Layout</code>标记的<!-- --><code>effect</code>(由<!-- --><code>useLayoutEffect</code>创建), 已经得到了完整的回调处理(<!-- --><code>destroy</code>和<!-- --><code>create</code>已经被调用).<!-- --></p><p>如下图:<!-- --><br/>
其中第一个<!-- --><code>effect</code>拥有<!-- --><code>Layout</code>标记,会执行<!-- --><code>effect.destroy(); effect.destroy = effect.create()</code></p><p><img alt="" src="/static/hook-commit-layout.b47ca81b.png"/></p><h3 id="flushpassiveeffects"><a aria-hidden="true" tabindex="-1" href="#flushpassiveeffects"><span class="icon icon-link"></span></a>flushPassiveEffects<!-- --></h3><p>在上文<!-- --><code>commitBeforeMutationEffects</code>阶段, 异步调用了<!-- --><code>flushPassiveEffects</code>. 在这期间带有<!-- --><code>Passive</code>标记的<!-- --><code>effect</code>已经被添加到<!-- --><code>pendingPassiveHookEffectsUnmount</code>和<!-- --><code>pendingPassiveHookEffectsMount</code>全局数组中.<!-- --></p><p>接下来<!-- --><code>flushPassiveEffects</code>就可以脱离<!-- --><code>fiber节点</code>, 直接访问<!-- --><code>effects</code></p><div class="dumi-default-source-code"><button type="button" class="dumi-default-source-code-copy"><svg viewBox="64 64 896 896"><path d="M832 64H296c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h496v688c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8V96c0-17.7-14.3-32-32-32zM704 192H192c-17.7 0-32 14.3-32 32v530.7c0 8.5 3.4 16.6 9.4 22.6l173.3 173.3c2.2 2.2 4.7 4 7.4 5.5v1.9h4.2c3.5 1.3 7.2 2 11 2H704c17.7 0 32-14.3 32-32V224c0-17.7-14.3-32-32-32zM350 856.2 263.9 770H350v86.2zM664 888H414V746c0-22.1-17.9-40-40-40H232V264h432v624z"></path></svg></button><pre class="prism-code language-js"><div class=""><div class=""><span class="token keyword module">export</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">flushPassiveEffects</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span><span class="token plain"> boolean </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token comment">// Returns whether passive effects were flushed.</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">pendingPassiveEffectsRenderPriority </span><span class="token operator">!==</span><span class="token plain"> </span><span class="token maybe-class-name">NoSchedulerPriority</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token keyword">const</span><span class="token plain"> priorityLevel </span><span class="token operator">=</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      pendingPassiveEffectsRenderPriority </span><span class="token operator">&gt;</span><span class="token plain"> </span><span class="token maybe-class-name">NormalSchedulerPriority</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">        </span><span class="token operator">?</span><span class="token plain"> </span><span class="token maybe-class-name">NormalSchedulerPriority</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">        </span><span class="token operator">:</span><span class="token plain"> pendingPassiveEffectsRenderPriority</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    pendingPassiveEffectsRenderPriority </span><span class="token operator">=</span><span class="token plain"> </span><span class="token maybe-class-name">NoSchedulerPriority</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token comment">// `runWithPriority`设置Schedule中的调度优先级, 如果在flushPassiveEffectsImpl中处理effect时又发起了新的更新, 那么新的update.lane将会受到这个priorityLevel影响.</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token keyword control-flow">return</span><span class="token plain"> </span><span class="token function">runWithPriority</span><span class="token punctuation">(</span><span class="token plain">priorityLevel</span><span class="token punctuation">,</span><span class="token plain"> flushPassiveEffectsImpl</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword control-flow">return</span><span class="token plain"> </span><span class="token boolean">false</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">
</span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token comment">// ...省略无关代码, 只保留Hook相关</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">flushPassiveEffectsImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">rootWithPendingPassiveEffects </span><span class="token operator">===</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token keyword control-flow">return</span><span class="token plain"> </span><span class="token boolean">false</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  rootWithPendingPassiveEffects </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  pendingPassiveEffectsLanes </span><span class="token operator">=</span><span class="token plain"> </span><span class="token maybe-class-name">NoLanes</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">
</span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token comment">// 1. 执行 effect.destroy()</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> unmountEffects </span><span class="token operator">=</span><span class="token plain"> pendingPassiveHookEffectsUnmount</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  pendingPassiveHookEffectsUnmount </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword control-flow">for</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token keyword">let</span><span class="token plain"> i </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">0</span><span class="token punctuation">;</span><span class="token plain"> i </span><span class="token operator">&lt;</span><span class="token plain"> unmountEffects</span><span class="token punctuation">.</span><span class="token property-access">length</span><span class="token punctuation">;</span><span class="token plain"> i </span><span class="token operator">+=</span><span class="token plain"> </span><span class="token number">2</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token keyword">const</span><span class="token plain"> effect </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token plain">unmountEffects</span><span class="token punctuation">[</span><span class="token plain">i</span><span class="token punctuation">]</span><span class="token operator">:</span><span class="token plain"> any</span><span class="token punctuation">)</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">HookEffect</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token keyword">const</span><span class="token plain"> fiber </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token plain">unmountEffects</span><span class="token punctuation">[</span><span class="token plain">i </span><span class="token operator">+</span><span class="token plain"> </span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">:</span><span class="token plain"> any</span><span class="token punctuation">)</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">Fiber</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token keyword">const</span><span class="token plain"> destroy </span><span class="token operator">=</span><span class="token plain"> effect</span><span class="token punctuation">.</span><span class="token property-access">destroy</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    effect</span><span class="token punctuation">.</span><span class="token property-access">destroy</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword nil">undefined</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token plain"> destroy </span><span class="token operator">===</span><span class="token plain"> </span><span class="token string">&#x27;function&#x27;</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">
</span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token comment">// 2. 执行新 effect.create(), 重新赋值到 effect.destroy</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> mountEffects </span><span class="token operator">=</span><span class="token plain"> pendingPassiveHookEffectsMount</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  pendingPassiveHookEffectsMount </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword control-flow">for</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token keyword">let</span><span class="token plain"> i </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">0</span><span class="token punctuation">;</span><span class="token plain"> i </span><span class="token operator">&lt;</span><span class="token plain"> mountEffects</span><span class="token punctuation">.</span><span class="token property-access">length</span><span class="token punctuation">;</span><span class="token plain"> i </span><span class="token operator">+=</span><span class="token plain"> </span><span class="token number">2</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token keyword">const</span><span class="token plain"> effect </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token plain">mountEffects</span><span class="token punctuation">[</span><span class="token plain">i</span><span class="token punctuation">]</span><span class="token operator">:</span><span class="token plain"> any</span><span class="token punctuation">)</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">HookEffect</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token keyword">const</span><span class="token plain"> fiber </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token plain">mountEffects</span><span class="token punctuation">[</span><span class="token plain">i </span><span class="token operator">+</span><span class="token plain"> </span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">:</span><span class="token plain"> any</span><span class="token punctuation">)</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">Fiber</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    effect</span><span class="token punctuation">.</span><span class="token property-access">destroy</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token punctuation">}</span></div></div></pre></div><p>其核心逻辑:</p><ol><li>遍历<!-- --><code>pendingPassiveHookEffectsUnmount</code>中的所有<!-- --><code>effect</code>, 调用<!-- --><code>effect.destroy()</code>.
<!-- --><ul><li>同时清空<!-- --><code>pendingPassiveHookEffectsUnmount</code></li></ul></li><li>遍历<!-- --><code>pendingPassiveHookEffectsMount</code>中的所有<!-- --><code>effect</code>, 调用<!-- --><code>effect.create()</code>, 并更新<!-- --><code>effect.destroy</code>.
<!-- --><ul><li>同时清空<!-- --><code>pendingPassiveHookEffectsMount</code></li></ul></li></ol><p>所以, 带有<!-- --><code>Passive</code>标记的<!-- --><code>effect</code>, 在<!-- --><code>flushPassiveEffects</code>函数中得到了完整的回调处理.<!-- --></p><p>如下图:<!-- --><br/>
其中拥有<!-- --><code>Passive</code>标记的<!-- --><code>effect</code>, 都会执行<!-- --><code>effect.destroy(); effect.destroy = effect.create()</code></p><p><img alt="" src="/static/hook-flushpassive.845a9b59.png"/></p><h2 id="更新-hook"><a aria-hidden="true" tabindex="-1" href="#更新-hook"><span class="icon icon-link"></span></a>更新 Hook<!-- --></h2><p>假设在初次调用之后, 发起更新, 会再次执行<!-- --><code>function</code>, 这时<!-- --><code>function</code>中使用的<!-- --><code>useEffect</code>, <!-- --><code>useLayoutEffect</code>等<!-- --><code>api</code>也会再次执行.<!-- --></p><p>在更新过程中<!-- --><code>useEffect</code>对应源码<!-- --><a href="https://github.com/facebook/react/blob/v17.0.2/packages/react-reconciler/src/ReactFiberHooks.old.js#L1250-L1266">updateEffect</a>, <!-- --><code>useLayoutEffect</code>对应源码<!-- --><a href="https://github.com/facebook/react/blob/v17.0.2/packages/react-reconciler/src/ReactFiberHooks.old.js#L1275-L1280">updateLayoutEffect</a>.它们内部都会调用<!-- --><code>updateEffectImpl</code>, 与初次创建时一样, 只 是参数不同.<!-- --></p><h3 id="更新-effect"><a aria-hidden="true" tabindex="-1" href="#更新-effect"><span class="icon icon-link"></span></a>更新 Effect<!-- --></h3><p><a href="https://github.com/facebook/react/blob/v17.0.2/packages/react-reconciler/src/ReactFiberHooks.old.js#L1205-L1230">updateEffectImpl</a>:<!-- --></p><div class="dumi-default-source-code"><button type="button" class="dumi-default-source-code-copy"><svg viewBox="64 64 896 896"><path d="M832 64H296c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h496v688c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8V96c0-17.7-14.3-32-32-32zM704 192H192c-17.7 0-32 14.3-32 32v530.7c0 8.5 3.4 16.6 9.4 22.6l173.3 173.3c2.2 2.2 4.7 4 7.4 5.5v1.9h4.2c3.5 1.3 7.2 2 11 2H704c17.7 0 32-14.3 32-32V224c0-17.7-14.3-32-32-32zM350 856.2 263.9 770H350v86.2zM664 888H414V746c0-22.1-17.9-40-40-40H232V264h432v624z"></path></svg></button><pre class="prism-code language-js"><div class=""><div class=""><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">updateEffectImpl</span><span class="token punctuation">(</span><span class="token parameter">fiberFlags</span><span class="token parameter punctuation">,</span><span class="token parameter"> hookFlags</span><span class="token parameter punctuation">,</span><span class="token parameter"> create</span><span class="token parameter punctuation">,</span><span class="token parameter"> deps</span><span class="token punctuation">)</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword">void</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token comment">// 1. 获取当前hook</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> hook </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">updateWorkInProgressHook</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> nextDeps </span><span class="token operator">=</span><span class="token plain"> deps </span><span class="token operator">===</span><span class="token plain"> </span><span class="token keyword nil">undefined</span><span class="token plain"> </span><span class="token operator">?</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"> </span><span class="token operator">:</span><span class="token plain"> deps</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword">let</span><span class="token plain"> destroy </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword nil">undefined</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token comment">// 2. 分析依赖</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">currentHook </span><span class="token operator">!==</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token keyword">const</span><span class="token plain"> prevEffect </span><span class="token operator">=</span><span class="token plain"> currentHook</span><span class="token punctuation">.</span><span class="token property-access">memoizedState</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token comment">// 继续使用先前effect.destroy</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    destroy </span><span class="token operator">=</span><span class="token plain"> prevEffect</span><span class="token punctuation">.</span><span class="token property-access">destroy</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">nextDeps </span><span class="token operator">!==</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token keyword">const</span><span class="token plain"> prevDeps </span><span class="token operator">=</span><span class="token plain"> prevEffect</span><span class="token punctuation">.</span><span class="token property-access">deps</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token comment">// 比较依赖是否变化</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token function">areHookInputsEqual</span><span class="token punctuation">(</span><span class="token plain">nextDeps</span><span class="token punctuation">,</span><span class="token plain"> prevDeps</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">        </span><span class="token comment">// 2.1 如果依赖不变, 新建effect(tag不含HookHasEffect)</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">        </span><span class="token function">pushEffect</span><span class="token punctuation">(</span><span class="token plain">hookFlags</span><span class="token punctuation">,</span><span class="token plain"> create</span><span class="token punctuation">,</span><span class="token plain"> destroy</span><span class="token punctuation">,</span><span class="token plain"> nextDeps</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">        </span><span class="token keyword control-flow">return</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token comment">// 2.2 如果依赖改变, 更改fiber.flag, 新建effect</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  currentlyRenderingFiber</span><span class="token punctuation">.</span><span class="token property-access">flags</span><span class="token plain"> </span><span class="token operator">|=</span><span class="token plain"> fiberFlags</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">
</span></div></div><div class=""><div class=""><span class="token plain">  hook</span><span class="token punctuation">.</span><span class="token property-access">memoizedState</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">pushEffect</span><span class="token punctuation">(</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token maybe-class-name">HookHasEffect</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> hookFlags</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    create</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    destroy</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    nextDeps</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token punctuation">}</span></div></div></pre></div><p><a href="https://github.com/facebook/react/blob/v17.0.2/packages/react-reconciler/src/ReactFiberHooks.old.js#L1205-L1230">updateEffectImpl</a>与<!-- --><a href="https://github.com/facebook/react/blob/v17.0.2/packages/react-reconciler/src/ReactFiberHooks.old.js#L1193-L1203">mountEffectImpl</a>逻辑有所不同: - 如果<!-- --><code>useEffect/useLayoutEffect</code>的依赖不变, 新建的<!-- --><code>effect</code>对象不带<!-- --><code>HasEffect</code>标记.<!-- --></p><p>注意: 无论依赖是否变化, 都复用之前的<!-- --><code>effect.destroy</code>. 等待<!-- --><code>commitRoot</code>阶段的调用(上文已经说明).<!-- --></p><p>如下图:</p><ul><li>图中第 1,2 个<!-- --><code>hook</code>其<!-- --><code>deps</code>没变, 故<!-- --><code>effect.tag</code>中不会包含<!-- --><code>HookHasEffect</code>.<!-- --></li><li>图中第 3 个<!-- --><code>hook</code>其<!-- --><code>deps</code>改变, 故<!-- --><code>effect.tag</code>中继续含有<!-- --><code>HookHasEffect</code>.<!-- --></li></ul><p><img alt="" src="/static/renderwithhooks-update.b960ce29.png"/></p><h3 id="处理-effect-回调-1"><a aria-hidden="true" tabindex="-1" href="#处理-effect-回调-1"><span class="icon icon-link"></span></a>处理 Effect 回调<!-- --></h3><p>新的<!-- --><code>hook</code>以及新的<!-- --><code>effect</code>创建完成之后, 余下逻辑与初次渲染完全一致. 处理 Effect 回调时也会根据<!-- --><code>effect.tag</code>进行判断: 只有<!-- --><code>effect.tag</code>包含<!-- --><code>HookHasEffect</code>时才会调用<!-- --><code>effect.destroy</code>和<!-- --><code>effect.create()</code></p><h2 id="组件销毁"><a aria-hidden="true" tabindex="-1" href="#组件销毁"><span class="icon icon-link"></span></a>组件销毁<!-- --></h2><p>当<!-- --><code>function</code>组件被销毁时, <!-- --><code>fiber</code>节点必然会被打上<!-- --><code>Deletion</code>标记, 即<!-- --><code>fiber.flags |= Deletion</code>. 带有<!-- --><code>Deletion</code>标记的<!-- --><code>fiber</code>在<!-- --><a href="https://github.com/facebook/react/blob/v17.0.2/packages/react-reconciler/src/ReactFiberWorkLoop.old.js#L2302-L2383">commitMutationEffects</a>被处理:<!-- --></p><div class="dumi-default-source-code"><button type="button" class="dumi-default-source-code-copy"><svg viewBox="64 64 896 896"><path d="M832 64H296c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h496v688c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8V96c0-17.7-14.3-32-32-32zM704 192H192c-17.7 0-32 14.3-32 32v530.7c0 8.5 3.4 16.6 9.4 22.6l173.3 173.3c2.2 2.2 4.7 4 7.4 5.5v1.9h4.2c3.5 1.3 7.2 2 11 2H704c17.7 0 32-14.3 32-32V224c0-17.7-14.3-32-32-32zM350 856.2 263.9 770H350v86.2zM664 888H414V746c0-22.1-17.9-40-40-40H232V264h432v624z"></path></svg></button><pre class="prism-code language-js"><div class=""><div class=""><span class="token comment">// ...省略无关代码</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">commitMutationEffects</span><span class="token punctuation">(</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token parameter literal-property property">root</span><span class="token parameter operator">:</span><span class="token parameter"> </span><span class="token parameter maybe-class-name">FiberRoot</span><span class="token parameter punctuation">,</span><span class="token parameter"></span></div></div><div class=""><div class=""><span class="token parameter">  </span><span class="token parameter literal-property property">renderPriorityLevel</span><span class="token parameter operator">:</span><span class="token parameter"> </span><span class="token parameter maybe-class-name">ReactPriorityLevel</span><span class="token parameter punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword control-flow">while</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">nextEffect </span><span class="token operator">!==</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token keyword">const</span><span class="token plain"> primaryFlags </span><span class="token operator">=</span><span class="token plain"> flags </span><span class="token operator">&amp;</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token maybe-class-name">Placement</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> </span><span class="token maybe-class-name">Update</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> </span><span class="token maybe-class-name">Deletion</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> </span><span class="token maybe-class-name">Hydrating</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token keyword control-flow">switch</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">primaryFlags</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token keyword">case</span><span class="token plain"> </span><span class="token literal-property property">Deletion</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">        </span><span class="token function">commitDeletion</span><span class="token punctuation">(</span><span class="token plain">root</span><span class="token punctuation">,</span><span class="token plain"> nextEffect</span><span class="token punctuation">,</span><span class="token plain"> renderPriorityLevel</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">        </span><span class="token keyword control-flow">break</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token punctuation">}</span></div></div></pre></div><p>在<!-- --><code>commitDeletion</code>函数之后, 继续调用<!-- --><code>unmountHostComponents-&gt;commitUnmount</code>, 在<!-- --><a href="https://github.com/facebook/react/blob/v17.0.2/packages/react-reconciler/src/ReactFiberCommitWork.old.js#L866-L963">commitUnmount</a>中, 执行<!-- --><code>effect.destroy()</code>, 结束整个闭环.<!-- --></p><h2 id="总结"><a aria-hidden="true" tabindex="-1" href="#总结"><span class="icon icon-link"></span></a>总结<!-- --></h2><p>本节分析了<!-- --><code>副作用Hook</code>从创建到销毁的全部过程, 在<!-- --><code>react</code>内部, 依靠<!-- --><code>fiber.flags</code>和<!-- --><code>effect.tag</code>实现了对<!-- --><code>effect</code>的精准识别. 在<!-- --><code>commitRoot</code>阶段, 对不同类型的<!-- --><code>effect</code>进行处理, 先后调用<!-- --><code>effect.destroy()</code>和<!-- --><code>effect.create()</code>.<!-- --></p></div></div><script>$RC("B:2","S:2")</script>