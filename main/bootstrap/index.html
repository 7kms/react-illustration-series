<!DOCTYPE html><html><head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<meta name="keywords" content="react, react原理, 图解react, react fiber原理, react hook原理, react 合成事件, react 基本包结构">
<meta name="description" content="图解React原理系列, 以react核心包结构和运行机制为主线索进行展开. 包括react 基本包结构, react 工作循环, react 启动模式, react fiber原理, react hook原理, react 合成事件等核心内容">
<link rel="shortcut icon" href="/km@2x.png">
<link rel="stylesheet" href="/umi.eb36fa83.css">
<title data-rh="true">启动过程</title>
<meta data-rh="true" property="og:title" content="启动过程"/><meta data-rh="true" name="description" content="在前文reconciler 运作流程把reconciler的流程归结成 4 个步骤."/><meta data-rh="true" property="og:description" content="在前文reconciler 运作流程把reconciler的流程归结成 4 个步骤."/>
</head>
<body>
<noscript><b>Enable JavaScript to run this app.</b></noscript><div id="root"><!--$?--><template id="B:0"></template><div></div><!--/$--></div><script>window.__UMI_LOADER_DATA__ = {}</script>
<script src="/umi.c14ba5aa.js"></script>

</body></html><div hidden id="S:0"><!--$?--><template id="B:1"></template><div></div><!--/$--></div><script>function $RC(a,b){a=document.getElementById(a);b=document.getElementById(b);b.parentNode.removeChild(b);if(a){a=a.previousSibling;var f=a.parentNode,c=a.nextSibling,e=0;do{if(c&&8===c.nodeType){var d=c.data;if("/$"===d)if(0===e)break;else e--;else"$"!==d&&"$?"!==d&&"$!"!==d||e++}d=c.nextSibling;f.removeChild(c);c=d}while(c);for(;b.firstChild;)f.insertBefore(b.firstChild,c);a.data="$";a._reactRetry&&a._reactRetry()}};$RC("B:0","S:0")</script><div hidden id="S:1"><div class="dumi-default-doc-layout"><div class="dumi-default-header"><div class="dumi-default-header-content"><section class="dumi-default-header-left"><a class="dumi-default-logo" href="/"><img src="/logo.png" alt="图解React"/>图解React<!-- --></a></section><section class="dumi-default-header-right"><ul class="dumi-default-navbar"><li><a class="active" href="/main/macro-structure">原理解析</a></li><li><a href="/algorithm/diff">高频算法</a></li><li><a href="/interview/01-setstate">面试题</a></li></ul><div class="dumi-default-header-right-aside"><div class="dumi-default-search-bar"><svg viewBox="64 64 896 896" class="dumi-default-search-bar-svg"><path d="M909.6 854.5 649.9 594.8C690.2 542.7 712 479 712 412c0-80.2-31.3-155.4-87.9-212.1-56.6-56.7-132-87.9-212.1-87.9s-155.5 31.3-212.1 87.9C143.2 256.5 112 331.8 112 412c0 80.1 31.3 155.5 87.9 212.1C256.5 680.8 331.8 712 412 712c67 0 130.6-21.8 182.7-62l259.7 259.6a8.2 8.2 0 0 0 11.6 0l43.6-43.5a8.2 8.2 0 0 0 0-11.6zM570.4 570.4C528 612.7 471.8 636 412 636s-116-23.3-158.4-65.6C211.3 528 188 471.8 188 412s23.3-116.1 65.6-158.4C296 211.3 352.2 188 412 188s116.1 23.2 158.4 65.6S636 352.2 636 412s-23.3 116.1-65.6 158.4z"></path></svg><input class="dumi-default-search-bar-input" placeholder="输入关键字搜索..."/><span class="dumi-default-search-shortcut">⌘<!-- --> K<!-- --></span></div><span class="dumi-default-color-switch" data-dumi-tooltip="亮色模式" data-dumi-tooltip-bottom="true"><svg viewBox="0 0 16 16"><path d="M8 13a1 1 0 0 1 1 1v1a1 1 0 1 1-2 0v-1a1 1 0 0 1 1-1ZM8 3a1 1 0 0 1-1-1V1a1 1 0 1 1 2 0v1a1 1 0 0 1-1 1Zm7 4a1 1 0 1 1 0 2h-1a1 1 0 1 1 0-2h1ZM3 8a1 1 0 0 1-1 1H1a1 1 0 1 1 0-2h1a1 1 0 0 1 1 1Zm9.95 3.536.707.707a1 1 0 0 1-1.414 1.414l-.707-.707a1 1 0 0 1 1.414-1.414Zm-9.9-7.072-.707-.707a1 1 0 0 1 1.414-1.414l.707.707A1 1 0 0 1 3.05 4.464Zm9.9 0a1 1 0 0 1-1.414-1.414l.707-.707a1 1 0 0 1 1.414 1.414l-.707.707Zm-9.9 7.072a1 1 0 0 1 1.414 1.414l-.707.707a1 1 0 0 1-1.414-1.414l.707-.707ZM8 4a4 4 0 1 0 0 8 4 4 0 0 0 0-8Zm0 6.5a2.5 2.5 0 1 1 0-5 2.5 2.5 0 0 1 0 5Z"></path></svg><select><option value="light" selected="">亮色模式<!-- --></option><option value="dark">暗色模式<!-- --></option><option value="auto">跟随系统<!-- --></option></select></span><a class="dumi-default-icon" data-dumi-tooltip="GitHub" data-dumi-tooltip-bottom="true" target="_blank" href="https://github.com/7kms/react-illustration-series" rel="noreferrer"><svg viewBox="64 64 896 896"><path d="M511.6 76.3C264.3 76.2 64 276.4 64 523.5 64 718.9 189.3 885 363.8 946c23.5 5.9 19.9-10.8 19.9-22.2v-77.5c-135.7 15.9-141.2-73.9-150.3-88.9C215 726 171.5 718 184.5 703c30.9-15.9 62.4 4 98.9 57.9 26.4 39.1 77.9 32.5 104 26 5.7-23.5 17.9-44.5 34.7-60.8-140.6-25.2-199.2-111-199.2-213 0-49.5 16.3-95 48.3-131.7-20.4-60.5 1.9-112.3 4.9-120 58.1-5.2 118.5 41.6 123.2 45.3 33-8.9 70.7-13.6 112.9-13.6 42.4 0 80.2 4.9 113.5 13.9 11.3-8.6 67.3-48.8 121.3-43.9 2.9 7.7 24.7 58.3 5.5 118 32.4 36.8 48.9 82.7 48.9 132.3 0 102.2-59 188.1-200 212.9a127.5 127.5 0 0 1 38.1 91v112.5c.8 9 0 17.9 15 17.9 177.1-59.7 304.6-227 304.6-424.1 0-247.2-200.4-447.3-447.5-447.3z"></path></svg></a></div></section><button type="button" class="dumi-default-header-menu-btn"><svg viewBox="64 64 896 896"><path d="M904 160H120c-4.4 0-8 3.6-8 8v64c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-64c0-4.4-3.6-8-8-8zm0 624H120c-4.4 0-8 3.6-8 8v64c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-64c0-4.4-3.6-8-8-8zm0-312H120c-4.4 0-8 3.6-8 8v64c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-64c0-4.4-3.6-8-8-8z"></path></svg></button></div></div><div class="dumi-default-doc-layout-mobile-bar"><button type="button" class="dumi-default-sidebar-btn"><svg viewBox="64 64 896 896"><path d="M120 230h496c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm0 424h496c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm784 140H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0-424H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8z"></path></svg>侧边菜单<!-- --></button></div><main><div class="dumi-default-sidebar"><dl class="dumi-default-sidebar-group"><dt>基本概念</dt><dd><a title="宏观包结构" class="" href="/main/macro-structure">宏观包结构</a></dd><dd><a title="两大工作循环" class="" href="/main/workloop">两大工作循环</a></dd><dd><a title="高频对象" class="" href="/main/object-structure">高频对象</a></dd></dl><dl class="dumi-default-sidebar-group"><dt>运行核心</dt><dd><a title="启动过程" aria-current="page" class="active" href="/main/bootstrap">启动过程</a></dd><dd><a title="reconciler 运作流程" class="" href="/main/reconciler-workflow">reconciler 运作流程</a></dd><dd><a title="优先级管理" class="" href="/main/priority">优先级管理</a></dd><dd><a title="调度原理" class="" href="/main/scheduler">调度原理</a></dd><dd><a title="fiber 树构造(基础准备)" class="" href="/main/fibertree-prepare">fiber 树构造(基础准备)</a></dd><dd><a title="fiber 树构造(初次创建)" class="" href="/main/fibertree-create">fiber 树构造(初次创建)</a></dd><dd><a title="fiber 树构造(对比更新)" class="" href="/main/fibertree-update">fiber 树构造(对比更新)</a></dd><dd><a title="fiber 树渲染" class="" href="/main/fibertree-commit">fiber 树渲染</a></dd></dl><dl class="dumi-default-sidebar-group"><dt>状态管理</dt><dd><a title="状态与副作用" class="" href="/main/state-effects">状态与副作用</a></dd><dd><a title="Hook 原理(概览)" class="" href="/main/hook-summary">Hook 原理(概览)</a></dd><dd><a title="Hook 原理(状态Hook)" class="" href="/main/hook-state">Hook 原理(状态Hook)</a></dd><dd><a title="Hook 原理(副作用Hook)" class="" href="/main/hook-effect">Hook 原理(副作用Hook)</a></dd><dd><a title="context 原理" class="" href="/main/context">context 原理</a></dd></dl><dl class="dumi-default-sidebar-group"><dt>交互</dt><dd><a title="合成事件" class="" href="/main/synthetic-event">合成事件</a></dd></dl></div><div class="dumi-default-content"><!--$?--><template id="B:2"></template><div></div><!--/$--><div class="dumi-default-footer">Copyright © 2023 | Powered by <a href="https://d.umijs.org" target="_blank" rel="noreferrer">dumi</a></div></div></main></div></div><script>$RC("B:1","S:1")</script><div hidden id="S:2"><div class="markdown"><h1 id="react-应用的启动过程"><a aria-hidden="true" tabindex="-1" href="#react-应用的启动过程"><span class="icon icon-link"></span></a>React 应用的启动过程<!-- --></h1><p>在前文<!-- --><a href="/main/reconciler-workflow"><code>reconciler 运作流程</code></a>把<!-- --><code>reconciler</code>的流程归结成 4 个步骤.<!-- --></p><p>本章节主要讲解<!-- --><code>react</code>应用程序的启动过程, 位于<!-- --><code>react-dom</code>包, 衔接<!-- --><code>reconciler 运作流程</code>中的<!-- --><a href="/main/reconciler-workflow#%E8%BE%93%E5%85%A5"><code>输入</code></a>步骤.<!-- --></p><p>在正式分析源码之前, 先了解一下<!-- --><code>react</code>应用的<!-- --><code>启动模式</code>:<!-- --></p><p>在当前稳定版<!-- --><code>react@17.0.2</code>源码中, 有 3 种启动方式. 先引出官网上对于<!-- --><a href="https://zh-hans.reactjs.org/docs/concurrent-mode-adoption.html#why-so-many-modes">这 3 种模式的介绍</a>, 其基本说明如下:<!-- --></p><ol><li><p><code>legacy</code> 模式: <!-- --><code>ReactDOM.render(&lt;App /&gt;, rootNode)</code>. 这是当前 React app 使用的方式. 这个模式可能不支持<!-- --><a href="https://zh-hans.reactjs.org/docs/concurrent-mode-patterns.html#the-three-steps">这些新功能(concurrent 支持的所有功能)</a>.<!-- --></p><div class="dumi-default-source-code"><button type="button" class="dumi-default-source-code-copy"><svg viewBox="64 64 896 896"><path d="M832 64H296c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h496v688c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8V96c0-17.7-14.3-32-32-32zM704 192H192c-17.7 0-32 14.3-32 32v530.7c0 8.5 3.4 16.6 9.4 22.6l173.3 173.3c2.2 2.2 4.7 4 7.4 5.5v1.9h4.2c3.5 1.3 7.2 2 11 2H704c17.7 0 32-14.3 32-32V224c0-17.7-14.3-32-32-32zM350 856.2 263.9 770H350v86.2zM664 888H414V746c0-22.1-17.9-40-40-40H232V264h432v624z"></path></svg></button><pre class="prism-code language-js"><div class=""><div class=""><span class="token comment">// LegacyRoot</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token maybe-class-name">ReactDOM</span><span class="token punctuation">.</span><span class="token method function property-access">render</span><span class="token punctuation">(</span><span class="token operator">&lt;</span><span class="token maybe-class-name">App</span><span class="token plain"> </span><span class="token operator">/</span><span class="token operator">&gt;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token dom variable">document</span><span class="token punctuation">.</span><span class="token method function property-access">getElementById</span><span class="token punctuation">(</span><span class="token string">&#x27;root&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token parameter">dom</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"> </span><span class="token comment">// 支持callback回调, 参数是一个dom对象</span></div></div></pre></div></li><li><p><a href="https://zh-hans.reactjs.org/docs/concurrent-mode-adoption.html#migration-step-blocking-mode">Blocking 模式</a>: <!-- --><code>ReactDOM.createBlockingRoot(rootNode).render(&lt;App /&gt;)</code>. 目前正在实验中, 它仅提供了 <!-- --><code>concurrent</code> 模式的小部分功能, 作为迁移到 <!-- --><code>concurrent</code> 模式的第一个步骤.<!-- --></p><div class="dumi-default-source-code"><button type="button" class="dumi-default-source-code-copy"><svg viewBox="64 64 896 896"><path d="M832 64H296c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h496v688c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8V96c0-17.7-14.3-32-32-32zM704 192H192c-17.7 0-32 14.3-32 32v530.7c0 8.5 3.4 16.6 9.4 22.6l173.3 173.3c2.2 2.2 4.7 4 7.4 5.5v1.9h4.2c3.5 1.3 7.2 2 11 2H704c17.7 0 32-14.3 32-32V224c0-17.7-14.3-32-32-32zM350 856.2 263.9 770H350v86.2zM664 888H414V746c0-22.1-17.9-40-40-40H232V264h432v624z"></path></svg></button><pre class="prism-code language-js"><div class=""><div class=""><span class="token comment">// BlockingRoot</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token comment">// 1. 创建ReactDOMRoot对象</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> reactDOMBlockingRoot </span><span class="token operator">=</span><span class="token plain"> </span><span class="token maybe-class-name">ReactDOM</span><span class="token punctuation">.</span><span class="token method function property-access">createBlockingRoot</span><span class="token punctuation">(</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token dom variable">document</span><span class="token punctuation">.</span><span class="token method function property-access">getElementById</span><span class="token punctuation">(</span><span class="token string">&#x27;root&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token comment">// 2. 调用render</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">reactDOMBlockingRoot</span><span class="token punctuation">.</span><span class="token method function property-access">render</span><span class="token punctuation">(</span><span class="token operator">&lt;</span><span class="token maybe-class-name">App</span><span class="token plain"> </span><span class="token operator">/</span><span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"> </span><span class="token comment">// 不支持回调</span></div></div></pre></div></li><li><p><a href="https://zh-hans.reactjs.org/docs/concurrent-mode-adoption.html#enabling-concurrent-mode">Concurrent 模式</a>: <!-- --><code>ReactDOM.createRoot(rootNode).render(&lt;App /&gt;)</code>. 目前在实验中, 未来稳定之后，打算作为 React 的默认开发模式. 这个模式开启了所有的新功能.<!-- --></p><div class="dumi-default-source-code"><button type="button" class="dumi-default-source-code-copy"><svg viewBox="64 64 896 896"><path d="M832 64H296c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h496v688c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8V96c0-17.7-14.3-32-32-32zM704 192H192c-17.7 0-32 14.3-32 32v530.7c0 8.5 3.4 16.6 9.4 22.6l173.3 173.3c2.2 2.2 4.7 4 7.4 5.5v1.9h4.2c3.5 1.3 7.2 2 11 2H704c17.7 0 32-14.3 32-32V224c0-17.7-14.3-32-32-32zM350 856.2 263.9 770H350v86.2zM664 888H414V746c0-22.1-17.9-40-40-40H232V264h432v624z"></path></svg></button><pre class="prism-code language-js"><div class=""><div class=""><span class="token comment">// ConcurrentRoot</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token comment">// 1. 创建ReactDOMRoot对象</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> reactDOMRoot </span><span class="token operator">=</span><span class="token plain"> </span><span class="token maybe-class-name">ReactDOM</span><span class="token punctuation">.</span><span class="token method function property-access">createRoot</span><span class="token punctuation">(</span><span class="token dom variable">document</span><span class="token punctuation">.</span><span class="token method function property-access">getElementById</span><span class="token punctuation">(</span><span class="token string">&#x27;root&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token comment">// 2. 调用render</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">reactDOMRoot</span><span class="token punctuation">.</span><span class="token method function property-access">render</span><span class="token punctuation">(</span><span class="token operator">&lt;</span><span class="token maybe-class-name">App</span><span class="token plain"> </span><span class="token operator">/</span><span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"> </span><span class="token comment">// 不支持回调</span></div></div></pre></div></li></ol><p>注意: 虽然<!-- --><code>17.0.2</code>的源码中有<!-- --><a href="https://github.com/facebook/react/blob/v17.0.2/packages/react-dom/src/client/ReactDOM.js#L202"><code>createRoot</code>和<!-- --><code>createBlockingRoot</code>方法<!-- --></a>(如果自行构建, <!-- --><a href="https://github.com/facebook/react/blob/v17.0.2/scripts/rollup/build.js#L30-L35">会默认构建<!-- --><code>experimental</code>版本<!-- --></a>), 但是稳定版的构建入口<!-- --><a href="https://github.com/facebook/react/blob/v17.0.2/packages/react-dom/index.stable.js">排除掉了这两个 api</a>, 所以实际在<!-- --><code>npm i react-dom</code>安装<!-- --><code>17.0.2</code>稳定版后, 不能使用该 api.如果要 想体验非<!-- --><code>legacy</code>模式, 需要<!-- --><a href="https://github.com/reactwg/react-18/discussions/9">显示安装 alpha 版本</a>(或自行构建).<!-- --></p><h2 id="启动流程"><a aria-hidden="true" tabindex="-1" href="#启动流程"><span class="icon icon-link"></span></a>启动流程<!-- --></h2><p>在调用入口函数之前,<!-- --><code>reactElement(&lt;App/&gt;)</code>和 DOM 对象<!-- --><code>div#root</code>之间没有关联, 用图片表示如下:<!-- --></p><p><img alt="" src="data:image/png;base64,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"/></p><h3 id="创建全局对象-create-global-obj"><a aria-hidden="true" tabindex="-1" href="#创建全局对象-create-global-obj"><span class="icon icon-link"></span></a>创建全局对象 {#create-global-obj}<!-- --></h3><p>无论<!-- --><code>Legacy, Concurrent或Blocking</code>模式, react 在初始化时, 都会创建 3 个全局对象<!-- --></p><ol><li><a href="https://github.com/facebook/react/blob/v17.0.2/packages/react-dom/src/client/ReactDOMRoot.js#L62-L72"><code>ReactDOM(Blocking)Root</code>对象<!-- --></a></li></ol><ul><li>属于<!-- --><code>react-dom</code>包, 该对象<!-- --><a href="https://github.com/facebook/react/blob/v17.0.2/packages/react-dom/src/client/ReactDOMRoot.js#L62-L104">暴露有<!-- --><code>render,unmount</code>方法<!-- --></a>, 通过调用该实例的<!-- --><code>render</code>方法, 可以引导 react 应用的启动.<!-- --></li></ul><ol start="2"><li><p><a href="https://github.com/facebook/react/blob/v17.0.2/packages/react-reconciler/src/ReactFiberRoot.old.js#L83-L103"><code>fiberRoot</code>对象<!-- --></a></p><ul><li>属于<!-- --><code>react-reconciler</code>包, 作为<!-- --><code>react-reconciler</code>在运行过程中的全局上下文, 保存 fiber 构建过程中所依赖的全局状态.<!-- --></li><li>其大部分实例变量用来存储<!-- --><code>fiber 构造循环</code>(详见<!-- --><a href="/main/workloop"><code>两大工作循环</code></a>)过程的各种状态.react 应用内部, 可以根据这些实例变量的值, 控制执行逻辑.<!-- --></li></ul></li><li><p><a href="https://github.com/facebook/react/blob/v17.0.2/packages/react-reconciler/src/ReactFiber.old.js#L431-L449"><code>HostRootFiber</code>对象<!-- --></a></p><ul><li>属于<!-- --><code>react-reconciler</code>包, 这是 react 应用中的第一个 Fiber 对象, 是 Fiber 树的根节点, 节点的类型是<!-- --><code>HostRoot</code>.<!-- --></li></ul></li></ol><p>这 3 个对象是 react 体系得以运行的基本保障, 一经创建大多数场景不会再销毁(除非 卸载整个应用<!-- --><code>root.unmount()</code>).<!-- --></p><p>这一过程是从<!-- --><code>react-dom</code>包发起, 内部调用了<!-- --><code>react-reconciler</code>包, 核心流程图如下(其中红色标注了 3 个对象的创建时机).<!-- --></p><p><img alt="" src="/static/function-call.eda9ca96.png"/></p><p>下面逐一解释这 3 个对象的创建过程.</p><h3 id="创建-reactdomblockingroot-对象"><a aria-hidden="true" tabindex="-1" href="#创建-reactdomblockingroot-对象"><span class="icon icon-link"></span></a>创建 ReactDOM(Blocking)Root 对象<!-- --></h3><p>由于 3 种模式启动的 api 有所不同, 所以从源码上追踪, 也对应了 3 种方式. 最终都 new 一个<!-- --><code>ReactDOMRoot</code>或<!-- --><code>ReactDOMBlockingRoot</code>的实例, 需要创建过程中<!-- --><code>RootTag</code>参数, 3 种模式各不相同. 该<!-- --><code>RootTag</code>的类型决定了整个 react 应用是否支持<!-- --><a href="/main/bootstrap#%E5%8F%AF%E4%B8%AD%E6%96%AD%E6%B8%B2%E6%9F%93">可中断渲染(后文有解释)</a>.<!-- --></p><p>下面根据 3 种 mode 下的启动函数逐一分析.</p><h4 id="legacy-模式"><a aria-hidden="true" tabindex="-1" href="#legacy-模式"><span class="icon icon-link"></span></a>legacy 模式<!-- --></h4><p><code>legacy</code>模式表面上是直接调用<!-- --><code>ReactDOM.render</code>, 跟踪<!-- --><code>ReactDOM.render</code>后续调用<!-- --><code>legacyRenderSubtreeIntoContainer</code>(<!-- --><a href="https://github.com/facebook/react/blob/v17.0.2/packages/react-dom/src/client/ReactDOMLegacy.js#L175-L222">源码链接</a>)<!-- --></p><div class="dumi-default-source-code"><button type="button" class="dumi-default-source-code-copy"><svg viewBox="64 64 896 896"><path d="M832 64H296c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h496v688c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8V96c0-17.7-14.3-32-32-32zM704 192H192c-17.7 0-32 14.3-32 32v530.7c0 8.5 3.4 16.6 9.4 22.6l173.3 173.3c2.2 2.2 4.7 4 7.4 5.5v1.9h4.2c3.5 1.3 7.2 2 11 2H704c17.7 0 32-14.3 32-32V224c0-17.7-14.3-32-32-32zM350 856.2 263.9 770H350v86.2zM664 888H414V746c0-22.1-17.9-40-40-40H232V264h432v624z"></path></svg></button><pre class="prism-code language-js"><div class=""><div class=""><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">legacyRenderSubtreeIntoContainer</span><span class="token punctuation">(</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token parameter literal-property property">parentComponent</span><span class="token parameter operator">:</span><span class="token parameter"> </span><span class="token parameter operator">?</span><span class="token parameter maybe-class-name">React$Component</span><span class="token parameter operator">&lt;</span><span class="token parameter">any</span><span class="token parameter punctuation">,</span><span class="token parameter"> any</span><span class="token parameter operator">&gt;</span><span class="token parameter punctuation">,</span><span class="token parameter"></span></div></div><div class=""><div class=""><span class="token parameter">  </span><span class="token parameter literal-property property">children</span><span class="token parameter operator">:</span><span class="token parameter"> </span><span class="token parameter maybe-class-name">ReactNodeList</span><span class="token parameter punctuation">,</span><span class="token parameter"></span></div></div><div class=""><div class=""><span class="token parameter">  </span><span class="token parameter literal-property property">container</span><span class="token parameter operator">:</span><span class="token parameter"> </span><span class="token parameter maybe-class-name">Container</span><span class="token parameter punctuation">,</span><span class="token parameter"></span></div></div><div class=""><div class=""><span class="token parameter">  </span><span class="token parameter literal-property property">forceHydrate</span><span class="token parameter operator">:</span><span class="token parameter"> boolean</span><span class="token parameter punctuation">,</span><span class="token parameter"></span></div></div><div class=""><div class=""><span class="token parameter">  </span><span class="token parameter literal-property property">callback</span><span class="token parameter operator">:</span><span class="token parameter"> </span><span class="token parameter operator">?</span><span class="token parameter known-class-name class-name">Function</span><span class="token parameter punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword">let</span><span class="token plain"> </span><span class="token literal-property property">root</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">RootType</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">container</span><span class="token punctuation">.</span><span class="token property-access">_reactRootContainer</span><span class="token operator">:</span><span class="token plain"> any</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword">let</span><span class="token plain"> fiberRoot</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token plain">root</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token comment">// 初次调用, root还未初始化, 会进入此分支</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token comment">//1. 创建ReactDOMRoot对象, 初始化react应用环境</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    root </span><span class="token operator">=</span><span class="token plain"> container</span><span class="token punctuation">.</span><span class="token property-access">_reactRootContainer</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">legacyCreateRootFromDOMContainer</span><span class="token punctuation">(</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      container</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      forceHydrate</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    fiberRoot </span><span class="token operator">=</span><span class="token plain"> root</span><span class="token punctuation">.</span><span class="token property-access">_internalRoot</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token plain"> callback </span><span class="token operator">===</span><span class="token plain"> </span><span class="token string">&#x27;function&#x27;</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token keyword">const</span><span class="token plain"> originalCallback </span><span class="token operator">=</span><span class="token plain"> callback</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token function-variable function">callback</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">        </span><span class="token comment">// instance最终指向 children(入参: 如&lt;App/&gt;)生成的dom节点</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">        </span><span class="token keyword">const</span><span class="token plain"> instance </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">getPublicRootInstance</span><span class="token punctuation">(</span><span class="token plain">fiberRoot</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">        originalCallback</span><span class="token punctuation">.</span><span class="token method function property-access">call</span><span class="token punctuation">(</span><span class="token plain">instance</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token comment">// 2. 更新容器</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token function">unbatchedUpdates</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token function">updateContainer</span><span class="token punctuation">(</span><span class="token plain">children</span><span class="token punctuation">,</span><span class="token plain"> fiberRoot</span><span class="token punctuation">,</span><span class="token plain"> parentComponent</span><span class="token punctuation">,</span><span class="token plain"> callback</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword control-flow">else</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token comment">// root已经初始化, 二次调用render会进入</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token comment">// 1. 获取FiberRoot对象</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    fiberRoot </span><span class="token operator">=</span><span class="token plain"> root</span><span class="token punctuation">.</span><span class="token property-access">_internalRoot</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token plain"> callback </span><span class="token operator">===</span><span class="token plain"> </span><span class="token string">&#x27;function&#x27;</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token keyword">const</span><span class="token plain"> originalCallback </span><span class="token operator">=</span><span class="token plain"> callback</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token function-variable function">callback</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">        </span><span class="token keyword">const</span><span class="token plain"> instance </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">getPublicRootInstance</span><span class="token punctuation">(</span><span class="token plain">fiberRoot</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">        originalCallback</span><span class="token punctuation">.</span><span class="token method function property-access">call</span><span class="token punctuation">(</span><span class="token plain">instance</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token comment">// 2. 调用更新</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token function">updateContainer</span><span class="token punctuation">(</span><span class="token plain">children</span><span class="token punctuation">,</span><span class="token plain"> fiberRoot</span><span class="token punctuation">,</span><span class="token plain"> parentComponent</span><span class="token punctuation">,</span><span class="token plain"> callback</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword control-flow">return</span><span class="token plain"> </span><span class="token function">getPublicRootInstance</span><span class="token punctuation">(</span><span class="token plain">fiberRoot</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token punctuation">}</span></div></div></pre></div><p>继续跟踪<!-- --><code>legacyCreateRootFromDOMContainer</code>. 最后调用<!-- --><code>new ReactDOMBlockingRoot(container, LegacyRoot, options);</code></p><div class="dumi-default-source-code"><button type="button" class="dumi-default-source-code-copy"><svg viewBox="64 64 896 896"><path d="M832 64H296c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h496v688c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8V96c0-17.7-14.3-32-32-32zM704 192H192c-17.7 0-32 14.3-32 32v530.7c0 8.5 3.4 16.6 9.4 22.6l173.3 173.3c2.2 2.2 4.7 4 7.4 5.5v1.9h4.2c3.5 1.3 7.2 2 11 2H704c17.7 0 32-14.3 32-32V224c0-17.7-14.3-32-32-32zM350 856.2 263.9 770H350v86.2zM664 888H414V746c0-22.1-17.9-40-40-40H232V264h432v624z"></path></svg></button><pre class="prism-code language-js"><div class=""><div class=""><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">legacyCreateRootFromDOMContainer</span><span class="token punctuation">(</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token parameter literal-property property">container</span><span class="token parameter operator">:</span><span class="token parameter"> </span><span class="token parameter maybe-class-name">Container</span><span class="token parameter punctuation">,</span><span class="token parameter"></span></div></div><div class=""><div class=""><span class="token parameter">  </span><span class="token parameter literal-property property">forceHydrate</span><span class="token parameter operator">:</span><span class="token parameter"> boolean</span><span class="token parameter punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token punctuation">)</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">RootType</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> shouldHydrate </span><span class="token operator">=</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    forceHydrate </span><span class="token operator">||</span><span class="token plain"> </span><span class="token function">shouldHydrateDueToLegacyHeuristic</span><span class="token punctuation">(</span><span class="token plain">container</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword control-flow">return</span><span class="token plain"> </span><span class="token function">createLegacyRoot</span><span class="token punctuation">(</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    container</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    shouldHydrate</span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token operator">?</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">          </span><span class="token literal-property property">hydrate</span><span class="token operator">:</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">        </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword nil">undefined</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">
</span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token keyword module">export</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">createLegacyRoot</span><span class="token punctuation">(</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token parameter literal-property property">container</span><span class="token parameter operator">:</span><span class="token parameter"> </span><span class="token parameter maybe-class-name">Container</span><span class="token parameter punctuation">,</span><span class="token parameter"></span></div></div><div class=""><div class=""><span class="token parameter">  options</span><span class="token parameter operator">?</span><span class="token parameter operator">:</span><span class="token parameter"> </span><span class="token parameter maybe-class-name">RootOptions</span><span class="token parameter punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token punctuation">)</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">RootType</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword control-flow">return</span><span class="token plain"> </span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name">ReactDOMBlockingRoot</span><span class="token punctuation">(</span><span class="token plain">container</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token maybe-class-name">LegacyRoot</span><span class="token punctuation">,</span><span class="token plain"> options</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"> </span><span class="token comment">// 注意这里的LegacyRoot是固定的, 并不是外界传入的</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token punctuation">}</span></div></div></pre></div><p>通过以上分析,<!-- --><code>legacy</code>模式下调用<!-- --><code>ReactDOM.render</code>有 2 个核心 步骤:<!-- --></p><ol><li>创建<!-- --><code>ReactDOMBlockingRoot</code>实例(在 Concurrent 模式和 Blocking 模式中详细分析该类), 初始化 react 应用环境.<!-- --></li><li>调用<!-- --><code>updateContainer</code>进行更新.<!-- --></li></ol><h4 id="concurrent-模式和-blocking-模式"><a aria-hidden="true" tabindex="-1" href="#concurrent-模式和-blocking-模式"><span class="icon icon-link"></span></a>Concurrent 模式和 Blocking 模式<!-- --></h4><p><code>Concurrent</code>模式和<!-- --><code>Blocking</code>模式从调用方式上直接可以看出<!-- --></p><ol><li>分别调用<!-- --><code>ReactDOM.createRoot</code>和<!-- --><code>ReactDOM.createBlockingRoot</code>创建<!-- --><code>ReactDOMRoot</code>和<!-- --><code>ReactDOMBlockingRoot</code>实例<!-- --></li><li>调用<!-- --><code>ReactDOMRoot</code>和<!-- --><code>ReactDOMBlockingRoot</code>实例的<!-- --><code>render</code>方法<!-- --></li></ol><div class="dumi-default-source-code"><button type="button" class="dumi-default-source-code-copy"><svg viewBox="64 64 896 896"><path d="M832 64H296c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h496v688c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8V96c0-17.7-14.3-32-32-32zM704 192H192c-17.7 0-32 14.3-32 32v530.7c0 8.5 3.4 16.6 9.4 22.6l173.3 173.3c2.2 2.2 4.7 4 7.4 5.5v1.9h4.2c3.5 1.3 7.2 2 11 2H704c17.7 0 32-14.3 32-32V224c0-17.7-14.3-32-32-32zM350 856.2 263.9 770H350v86.2zM664 888H414V746c0-22.1-17.9-40-40-40H232V264h432v624z"></path></svg></button><pre class="prism-code language-js"><div class=""><div class=""><span class="token keyword module">export</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">createRoot</span><span class="token punctuation">(</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token parameter literal-property property">container</span><span class="token parameter operator">:</span><span class="token parameter"> </span><span class="token parameter maybe-class-name">Container</span><span class="token parameter punctuation">,</span><span class="token parameter"></span></div></div><div class=""><div class=""><span class="token parameter">  options</span><span class="token parameter operator">?</span><span class="token parameter operator">:</span><span class="token parameter"> </span><span class="token parameter maybe-class-name">RootOptions</span><span class="token parameter punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token punctuation">)</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">RootType</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword control-flow">return</span><span class="token plain"> </span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name">ReactDOMRoot</span><span class="token punctuation">(</span><span class="token plain">container</span><span class="token punctuation">,</span><span class="token plain"> options</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">
</span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token keyword module">export</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">createBlockingRoot</span><span class="token punctuation">(</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token parameter literal-property property">container</span><span class="token parameter operator">:</span><span class="token parameter"> </span><span class="token parameter maybe-class-name">Container</span><span class="token parameter punctuation">,</span><span class="token parameter"></span></div></div><div class=""><div class=""><span class="token parameter">  options</span><span class="token parameter operator">?</span><span class="token parameter operator">:</span><span class="token parameter"> </span><span class="token parameter maybe-class-name">RootOptions</span><span class="token parameter punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token punctuation">)</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">RootType</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword control-flow">return</span><span class="token plain"> </span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name">ReactDOMBlockingRoot</span><span class="token punctuation">(</span><span class="token plain">container</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token maybe-class-name">BlockingRoot</span><span class="token punctuation">,</span><span class="token plain"> options</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"> </span><span class="token comment">// 注意第2个参数BlockingRoot是固定写死的</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token punctuation">}</span></div></div></pre></div><p>继续查看<!-- --><code>ReactDOMRoot</code>和<!-- --><code>ReactDOMBlockingRoot</code>对象<!-- --></p><div class="dumi-default-source-code"><button type="button" class="dumi-default-source-code-copy"><svg viewBox="64 64 896 896"><path d="M832 64H296c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h496v688c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8V96c0-17.7-14.3-32-32-32zM704 192H192c-17.7 0-32 14.3-32 32v530.7c0 8.5 3.4 16.6 9.4 22.6l173.3 173.3c2.2 2.2 4.7 4 7.4 5.5v1.9h4.2c3.5 1.3 7.2 2 11 2H704c17.7 0 32-14.3 32-32V224c0-17.7-14.3-32-32-32zM350 856.2 263.9 770H350v86.2zM664 888H414V746c0-22.1-17.9-40-40-40H232V264h432v624z"></path></svg></button><pre class="prism-code language-js"><div class=""><div class=""><span class="token keyword">function</span><span class="token plain"> </span><span class="token function maybe-class-name">ReactDOMRoot</span><span class="token punctuation">(</span><span class="token parameter literal-property property">container</span><span class="token parameter operator">:</span><span class="token parameter"> </span><span class="token parameter maybe-class-name">Container</span><span class="token parameter punctuation">,</span><span class="token parameter"> </span><span class="token parameter literal-property property">options</span><span class="token parameter operator">:</span><span class="token parameter"> </span><span class="token parameter keyword">void</span><span class="token parameter"> </span><span class="token parameter operator">|</span><span class="token parameter"> </span><span class="token parameter maybe-class-name">RootOptions</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token comment">// 创建一个fiberRoot对象, 并将其挂载到this._internalRoot之上</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">_internalRoot</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">createRootImpl</span><span class="token punctuation">(</span><span class="token plain">container</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token maybe-class-name">ConcurrentRoot</span><span class="token punctuation">,</span><span class="token plain"> options</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function maybe-class-name">ReactDOMBlockingRoot</span><span class="token punctuation">(</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token parameter literal-property property">container</span><span class="token parameter operator">:</span><span class="token parameter"> </span><span class="token parameter maybe-class-name">Container</span><span class="token parameter punctuation">,</span><span class="token parameter"></span></div></div><div class=""><div class=""><span class="token parameter">  </span><span class="token parameter literal-property property">tag</span><span class="token parameter operator">:</span><span class="token parameter"> </span><span class="token parameter maybe-class-name">RootTag</span><span class="token parameter punctuation">,</span><span class="token parameter"></span></div></div><div class=""><div class=""><span class="token parameter">  </span><span class="token parameter literal-property property">options</span><span class="token parameter operator">:</span><span class="token parameter"> </span><span class="token parameter keyword">void</span><span class="token parameter"> </span><span class="token parameter operator">|</span><span class="token parameter"> </span><span class="token parameter maybe-class-name">RootOptions</span><span class="token parameter punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token comment">// 创建一个fiberRoot对象, 并将其挂载到this._internalRoot之上</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">_internalRoot</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">createRootImpl</span><span class="token punctuation">(</span><span class="token plain">container</span><span class="token punctuation">,</span><span class="token plain"> tag</span><span class="token punctuation">,</span><span class="token plain"> options</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">
</span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token class-name">ReactDOMRoot</span><span class="token punctuation">.</span><span class="token property-access">prototype</span><span class="token punctuation">.</span><span class="token property-access">render</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token class-name">ReactDOMBlockingRoot</span><span class="token punctuation">.</span><span class="token property-access">prototype</span><span class="token punctuation">.</span><span class="token method-variable function-variable method function property-access">render</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword">function</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token parameter literal-property property">children</span><span class="token parameter operator">:</span><span class="token parameter"> </span><span class="token parameter maybe-class-name">ReactNodeList</span><span class="token punctuation">)</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword">void</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token keyword">const</span><span class="token plain"> root </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">_internalRoot</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token comment">// 执行更新</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token function">updateContainer</span><span class="token punctuation">(</span><span class="token plain">children</span><span class="token punctuation">,</span><span class="token plain"> root</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">
</span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token class-name">ReactDOMRoot</span><span class="token punctuation">.</span><span class="token property-access">prototype</span><span class="token punctuation">.</span><span class="token property-access">unmount</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token class-name">ReactDOMBlockingRoot</span><span class="token punctuation">.</span><span class="token property-access">prototype</span><span class="token punctuation">.</span><span class="token method-variable function-variable method function property-access">unmount</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword">function</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword">void</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token keyword">const</span><span class="token plain"> root </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">_internalRoot</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token keyword">const</span><span class="token plain"> container </span><span class="token operator">=</span><span class="token plain"> root</span><span class="token punctuation">.</span><span class="token property-access">containerInfo</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token comment">// 执行更新</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token function">updateContainer</span><span class="token punctuation">(</span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"> root</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token function">unmarkContainerAsRoot</span><span class="token punctuation">(</span><span class="token plain">container</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">;</span></div></div></pre></div><p><code>ReactDOMRoot</code>和<!-- --><code>ReactDOMBlockingRoot</code>有相同的特性<!-- --></p><ol><li>调用<!-- --><code>createRootImpl</code>创建<!-- --><code>fiberRoot</code>对象, 并将其挂载到<!-- --><code>this._internalRoot</code>上.<!-- --></li><li>原型上有<!-- --><code>render</code>和<!-- --><code>unmount</code>方法, 且内部都会调用<!-- --><code>updateContainer</code>进行更新.<!-- --></li></ol><h3 id="创建-fiberroot-对象-create-root-impl"><a aria-hidden="true" tabindex="-1" href="#创建-fiberroot-对象-create-root-impl"><span class="icon icon-link"></span></a>创建 fiberRoot 对象 {#create-root-impl}<!-- --></h3><p>无论哪种模式下, 在<!-- --><code>ReactDOM(Blocking)Root</code>的创建过程中, 都会调用一个相同的函数<!-- --><code>createRootImpl</code>, 查看后续的函数调用, 最后会创建<!-- --><code>fiberRoot 对象</code>(在这个过程中, 特别注意<!-- --><code>RootTag</code>的传递过程):<!-- --></p><div class="dumi-default-source-code"><button type="button" class="dumi-default-source-code-copy"><svg viewBox="64 64 896 896"><path d="M832 64H296c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h496v688c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8V96c0-17.7-14.3-32-32-32zM704 192H192c-17.7 0-32 14.3-32 32v530.7c0 8.5 3.4 16.6 9.4 22.6l173.3 173.3c2.2 2.2 4.7 4 7.4 5.5v1.9h4.2c3.5 1.3 7.2 2 11 2H704c17.7 0 32-14.3 32-32V224c0-17.7-14.3-32-32-32zM350 856.2 263.9 770H350v86.2zM664 888H414V746c0-22.1-17.9-40-40-40H232V264h432v624z"></path></svg></button><pre class="prism-code language-js"><div class=""><div class=""><span class="token comment">// 注意: 3种模式下的tag是各不相同(分别是ConcurrentRoot,BlockingRoot,LegacyRoot).</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">_internalRoot</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">createRootImpl</span><span class="token punctuation">(</span><span class="token plain">container</span><span class="token punctuation">,</span><span class="token plain"> tag</span><span class="token punctuation">,</span><span class="token plain"> options</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div></div></pre></div><div class="dumi-default-source-code"><button type="button" class="dumi-default-source-code-copy"><svg viewBox="64 64 896 896"><path d="M832 64H296c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h496v688c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8V96c0-17.7-14.3-32-32-32zM704 192H192c-17.7 0-32 14.3-32 32v530.7c0 8.5 3.4 16.6 9.4 22.6l173.3 173.3c2.2 2.2 4.7 4 7.4 5.5v1.9h4.2c3.5 1.3 7.2 2 11 2H704c17.7 0 32-14.3 32-32V224c0-17.7-14.3-32-32-32zM350 856.2 263.9 770H350v86.2zM664 888H414V746c0-22.1-17.9-40-40-40H232V264h432v624z"></path></svg></button><pre class="prism-code language-js"><div class=""><div class=""><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">createRootImpl</span><span class="token punctuation">(</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token parameter literal-property property">container</span><span class="token parameter operator">:</span><span class="token parameter"> </span><span class="token parameter maybe-class-name">Container</span><span class="token parameter punctuation">,</span><span class="token parameter"></span></div></div><div class=""><div class=""><span class="token parameter">  </span><span class="token parameter literal-property property">tag</span><span class="token parameter operator">:</span><span class="token parameter"> </span><span class="token parameter maybe-class-name">RootTag</span><span class="token parameter punctuation">,</span><span class="token parameter"></span></div></div><div class=""><div class=""><span class="token parameter">  </span><span class="token parameter literal-property property">options</span><span class="token parameter operator">:</span><span class="token parameter"> </span><span class="token parameter keyword">void</span><span class="token parameter"> </span><span class="token parameter operator">|</span><span class="token parameter"> </span><span class="token parameter maybe-class-name">RootOptions</span><span class="token parameter punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token comment">// ... 省略部分源码(有关hydrate服务端渲染等, 暂时用不上)</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token comment">// 1. 创建fiberRoot</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> root </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">createContainer</span><span class="token punctuation">(</span><span class="token plain">container</span><span class="token punctuation">,</span><span class="token plain"> tag</span><span class="token punctuation">,</span><span class="token plain"> hydrate</span><span class="token punctuation">,</span><span class="token plain"> hydrationCallbacks</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"> </span><span class="token comment">// 注意RootTag的传递</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token comment">// 2. 标记dom对象, 把dom和fiber对象关联起来</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token function">markContainerAsRoot</span><span class="token punctuation">(</span><span class="token plain">root</span><span class="token punctuation">.</span><span class="token property-access">current</span><span class="token punctuation">,</span><span class="token plain"> container</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token comment">// ...省略部分无关代码</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword control-flow">return</span><span class="token plain"> root</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token punctuation">}</span></div></div></pre></div><div class="dumi-default-source-code"><button type="button" class="dumi-default-source-code-copy"><svg viewBox="64 64 896 896"><path d="M832 64H296c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h496v688c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8V96c0-17.7-14.3-32-32-32zM704 192H192c-17.7 0-32 14.3-32 32v530.7c0 8.5 3.4 16.6 9.4 22.6l173.3 173.3c2.2 2.2 4.7 4 7.4 5.5v1.9h4.2c3.5 1.3 7.2 2 11 2H704c17.7 0 32-14.3 32-32V224c0-17.7-14.3-32-32-32zM350 856.2 263.9 770H350v86.2zM664 888H414V746c0-22.1-17.9-40-40-40H232V264h432v624z"></path></svg></button><pre class="prism-code language-js"><div class=""><div class=""><span class="token keyword module">export</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">createContainer</span><span class="token punctuation">(</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token parameter literal-property property">containerInfo</span><span class="token parameter operator">:</span><span class="token parameter"> </span><span class="token parameter maybe-class-name">Container</span><span class="token parameter punctuation">,</span><span class="token parameter"></span></div></div><div class=""><div class=""><span class="token parameter">  </span><span class="token parameter literal-property property">tag</span><span class="token parameter operator">:</span><span class="token parameter"> </span><span class="token parameter maybe-class-name">RootTag</span><span class="token parameter punctuation">,</span><span class="token parameter"></span></div></div><div class=""><div class=""><span class="token parameter">  </span><span class="token parameter literal-property property">hydrate</span><span class="token parameter operator">:</span><span class="token parameter"> boolean</span><span class="token parameter punctuation">,</span><span class="token parameter"></span></div></div><div class=""><div class=""><span class="token parameter">  </span><span class="token parameter literal-property property">hydrationCallbacks</span><span class="token parameter operator">:</span><span class="token parameter"> </span><span class="token parameter keyword null nil">null</span><span class="token parameter"> </span><span class="token parameter operator">|</span><span class="token parameter"> </span><span class="token parameter maybe-class-name">SuspenseHydrationCallbacks</span><span class="token parameter punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token punctuation">)</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">OpaqueRoot</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token comment">// 创建fiberRoot对象</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword control-flow">return</span><span class="token plain"> </span><span class="token function">createFiberRoot</span><span class="token punctuation">(</span><span class="token plain">containerInfo</span><span class="token punctuation">,</span><span class="token plain"> tag</span><span class="token punctuation">,</span><span class="token plain"> hydrate</span><span class="token punctuation">,</span><span class="token plain"> hydrationCallbacks</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"> </span><span class="token comment">// 注意RootTag的传递</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token punctuation">}</span></div></div></pre></div><h3 id="创建-hostrootfiber-对象"><a aria-hidden="true" tabindex="-1" href="#创建-hostrootfiber-对象"><span class="icon icon-link"></span></a>创建 HostRootFiber 对象<!-- --></h3><p>在<!-- --><code>createFiberRoot</code>中, 创建了<!-- --><code>react</code>应用的首个<!-- --><code>fiber</code>对象, 称为<!-- --><code>HostRootFiber(fiber.tag = HostRoot)</code></p><div class="dumi-default-source-code"><button type="button" class="dumi-default-source-code-copy"><svg viewBox="64 64 896 896"><path d="M832 64H296c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h496v688c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8V96c0-17.7-14.3-32-32-32zM704 192H192c-17.7 0-32 14.3-32 32v530.7c0 8.5 3.4 16.6 9.4 22.6l173.3 173.3c2.2 2.2 4.7 4 7.4 5.5v1.9h4.2c3.5 1.3 7.2 2 11 2H704c17.7 0 32-14.3 32-32V224c0-17.7-14.3-32-32-32zM350 856.2 263.9 770H350v86.2zM664 888H414V746c0-22.1-17.9-40-40-40H232V264h432v624z"></path></svg></button><pre class="prism-code language-js"><div class=""><div class=""><span class="token keyword module">export</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">createFiberRoot</span><span class="token punctuation">(</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token parameter literal-property property">containerInfo</span><span class="token parameter operator">:</span><span class="token parameter"> any</span><span class="token parameter punctuation">,</span><span class="token parameter"></span></div></div><div class=""><div class=""><span class="token parameter">  </span><span class="token parameter literal-property property">tag</span><span class="token parameter operator">:</span><span class="token parameter"> </span><span class="token parameter maybe-class-name">RootTag</span><span class="token parameter punctuation">,</span><span class="token parameter"></span></div></div><div class=""><div class=""><span class="token parameter">  </span><span class="token parameter literal-property property">hydrate</span><span class="token parameter operator">:</span><span class="token parameter"> boolean</span><span class="token parameter punctuation">,</span><span class="token parameter"></span></div></div><div class=""><div class=""><span class="token parameter">  </span><span class="token parameter literal-property property">hydrationCallbacks</span><span class="token parameter operator">:</span><span class="token parameter"> </span><span class="token parameter keyword null nil">null</span><span class="token parameter"> </span><span class="token parameter operator">|</span><span class="token parameter"> </span><span class="token parameter maybe-class-name">SuspenseHydrationCallbacks</span><span class="token parameter punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token punctuation">)</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">FiberRoot</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token comment">// 创建fiberRoot对象, 注意RootTag的传递</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> </span><span class="token literal-property property">root</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">FiberRoot</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name">FiberRootNode</span><span class="token punctuation">(</span><span class="token plain">containerInfo</span><span class="token punctuation">,</span><span class="token plain"> tag</span><span class="token punctuation">,</span><span class="token plain"> hydrate</span><span class="token punctuation">)</span><span class="token operator">:</span><span class="token plain"> any</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">
</span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token comment">// 1. 这里创建了`react`应用的首个`fiber`对象, 称为`HostRootFiber`</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> uninitializedFiber </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">createHostRootFiber</span><span class="token punctuation">(</span><span class="token plain">tag</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  root</span><span class="token punctuation">.</span><span class="token property-access">current</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> uninitializedFiber</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  uninitializedFiber</span><span class="token punctuation">.</span><span class="token property-access">stateNode</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> root</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token comment">// 2. 初始化HostRootFiber的updateQueue</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token function">initializeUpdateQueue</span><span class="token punctuation">(</span><span class="token plain">uninitializedFiber</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">
</span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword control-flow">return</span><span class="token plain"> root</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token punctuation">}</span></div></div></pre></div><p>在创建<!-- --><code>HostRootFiber</code>时, 其中<!-- --><code>fiber.mode</code>属性, 会与 3 种<!-- --><code>RootTag</code>(<!-- --><code>ConcurrentRoot</code>,<!-- --><code>BlockingRoot</code>,<!-- --><code>LegacyRoot</code>)关联起来.<!-- --></p><div class="dumi-default-source-code"><button type="button" class="dumi-default-source-code-copy"><svg viewBox="64 64 896 896"><path d="M832 64H296c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h496v688c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8V96c0-17.7-14.3-32-32-32zM704 192H192c-17.7 0-32 14.3-32 32v530.7c0 8.5 3.4 16.6 9.4 22.6l173.3 173.3c2.2 2.2 4.7 4 7.4 5.5v1.9h4.2c3.5 1.3 7.2 2 11 2H704c17.7 0 32-14.3 32-32V224c0-17.7-14.3-32-32-32zM350 856.2 263.9 770H350v86.2zM664 888H414V746c0-22.1-17.9-40-40-40H232V264h432v624z"></path></svg></button><pre class="prism-code language-js"><div class=""><div class=""><span class="token keyword module">export</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">createHostRootFiber</span><span class="token punctuation">(</span><span class="token parameter literal-property property">tag</span><span class="token parameter operator">:</span><span class="token parameter"> </span><span class="token parameter maybe-class-name">RootTag</span><span class="token punctuation">)</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">Fiber</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword">let</span><span class="token plain"> mode</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">tag </span><span class="token operator">===</span><span class="token plain"> </span><span class="token maybe-class-name">ConcurrentRoot</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    mode </span><span class="token operator">=</span><span class="token plain"> </span><span class="token maybe-class-name">ConcurrentMode</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> </span><span class="token maybe-class-name">BlockingMode</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> </span><span class="token maybe-class-name">StrictMode</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword control-flow">else</span><span class="token plain"> </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">tag </span><span class="token operator">===</span><span class="token plain"> </span><span class="token maybe-class-name">BlockingRoot</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    mode </span><span class="token operator">=</span><span class="token plain"> </span><span class="token maybe-class-name">BlockingMode</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> </span><span class="token maybe-class-name">StrictMode</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword control-flow">else</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    mode </span><span class="token operator">=</span><span class="token plain"> </span><span class="token maybe-class-name">NoMode</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword control-flow">return</span><span class="token plain"> </span><span class="token function">createFiber</span><span class="token punctuation">(</span><span class="token maybe-class-name">HostRoot</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"> mode</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"> </span><span class="token comment">// 注意这里设置的mode属性是由RootTag决定的</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token punctuation">}</span></div></div></pre></div><p>注意:<!-- --><code>fiber</code>树中所有节点的<!-- --><code>mode</code>都会和<!-- --><code>HostRootFiber.mode</code>一致(新建的 fiber 节点, 其 mode 来源于父节点),所以<!-- --><strong>HostRootFiber.mode</strong>非常重要, 它决定了以后整个 fiber 树构建过程.<!-- --></p><p>运行到这里, 3 个  对象创建成功, <!-- --><code>react</code>应用的初始化完毕.<!-- --></p><p>将此刻内存中各个对象的引用情况表示出来:</p><ol><li>legacy</li></ol><p><img alt="" src="/static/process-legacy.99cd6b8d.png"/></p><ol start="2"><li>concurrent</li></ol><p><img alt="" src="/static/process-concurrent.a8d3aaa8.png"/></p><ol start="3"><li>blocking</li></ol><p><img alt="" src="/static/process-blocking.fe6dae67.png"/></p><p>注意:</p><ol><li>3 种模式下,<!-- --><code>HostRootFiber.mode</code>是不一致的<!-- --></li><li>legacy 下, <!-- --><code>div#root</code>和<!-- --><code>ReactDOMBlockingRoot</code>之间通过<!-- --><code>_reactRootContainer</code>关联. 其他模式是没有关联的<!-- --></li><li>此时<!-- --><code>reactElement(&lt;App/&gt;)</code>还是独立在外的, 还没有和目前创建的 3 个全局对象关联起来<!-- --></li></ol><h2 id="调用更新入口"><a aria-hidden="true" tabindex="-1" href="#调用更新入口"><span class="icon icon-link"></span></a>调用更新入口<!-- --></h2><ol><li>legacy<!-- --><br/>
回到<!-- --><code>legacyRenderSubtreeIntoContainer</code>函数中有:<!-- --></li></ol><div class="dumi-default-source-code"><button type="button" class="dumi-default-source-code-copy"><svg viewBox="64 64 896 896"><path d="M832 64H296c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h496v688c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8V96c0-17.7-14.3-32-32-32zM704 192H192c-17.7 0-32 14.3-32 32v530.7c0 8.5 3.4 16.6 9.4 22.6l173.3 173.3c2.2 2.2 4.7 4 7.4 5.5v1.9h4.2c3.5 1.3 7.2 2 11 2H704c17.7 0 32-14.3 32-32V224c0-17.7-14.3-32-32-32zM350 856.2 263.9 770H350v86.2zM664 888H414V746c0-22.1-17.9-40-40-40H232V264h432v624z"></path></svg></button><pre class="prism-code language-js"><div class=""><div class=""><span class="token comment">// 2. 更新容器</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token function">unbatchedUpdates</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token function">updateContainer</span><span class="token punctuation">(</span><span class="token plain">children</span><span class="token punctuation">,</span><span class="token plain"> fiberRoot</span><span class="token punctuation">,</span><span class="token plain"> parentComponent</span><span class="token punctuation">,</span><span class="token plain"> callback</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div></div></pre></div><ol start="2"><li>concurrent 和 blocking<!-- --><br/>
在<!-- --><code>ReactDOM(Blocking)Root</code>原型上有<!-- --><code>render</code>方法<!-- --></li></ol><div class="dumi-default-source-code"><button type="button" class="dumi-default-source-code-copy"><svg viewBox="64 64 896 896"><path d="M832 64H296c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h496v688c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8V96c0-17.7-14.3-32-32-32zM704 192H192c-17.7 0-32 14.3-32 32v530.7c0 8.5 3.4 16.6 9.4 22.6l173.3 173.3c2.2 2.2 4.7 4 7.4 5.5v1.9h4.2c3.5 1.3 7.2 2 11 2H704c17.7 0 32-14.3 32-32V224c0-17.7-14.3-32-32-32zM350 856.2 263.9 770H350v86.2zM664 888H414V746c0-22.1-17.9-40-40-40H232V264h432v624z"></path></svg></button><pre class="prism-code language-js"><div class=""><div class=""><span class="token class-name">ReactDOMRoot</span><span class="token punctuation">.</span><span class="token property-access">prototype</span><span class="token punctuation">.</span><span class="token property-access">render</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token class-name">ReactDOMBlockingRoot</span><span class="token punctuation">.</span><span class="token property-access">prototype</span><span class="token punctuation">.</span><span class="token method-variable function-variable method function property-access">render</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword">function</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token parameter literal-property property">children</span><span class="token parameter operator">:</span><span class="token parameter"> </span><span class="token parameter maybe-class-name">ReactNodeList</span><span class="token punctuation">)</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword">void</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token keyword">const</span><span class="token plain"> root </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">_internalRoot</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token comment">// 执行更新</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token function">updateContainer</span><span class="token punctuation">(</span><span class="token plain">children</span><span class="token punctuation">,</span><span class="token plain"> root</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">;</span></div></div></pre></div><p>相同点:</p><ol><li>3 种模式在调用更新时都会执行<!-- --><code>updateContainer</code>. <!-- --><code>updateContainer</code>函数串联了<!-- --><code>react-dom</code>与<!-- --><code>react-reconciler</code>, 之后的逻辑进入了<!-- --><code>react-reconciler</code>包.<!-- --></li></ol><p>不同点:</p><ol><li><p><code>legacy</code>下的更新会先调用<!-- --><code>unbatchedUpdates</code>, 更改执行上下文为<!-- --><code>LegacyUnbatchedContext</code>, 之后调用<!-- --><code>updateContainer</code>进行更新.<!-- --></p></li><li><p><code>concurrent</code>和<!-- --><code>blocking</code>不会更改执行上下文, 直接调用<!-- --><code>updateContainer</code>进行更新.<!-- --></p></li></ol><p>继续跟踪<!-- --><a href="https://github.com/facebook/react/blob/v17.0.2/packages/react-reconciler/src/ReactFiberReconciler.old.js#L250-L321"><code>updateContainer</code>函数<!-- --></a></p><div class="dumi-default-source-code"><button type="button" class="dumi-default-source-code-copy"><svg viewBox="64 64 896 896"><path d="M832 64H296c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h496v688c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8V96c0-17.7-14.3-32-32-32zM704 192H192c-17.7 0-32 14.3-32 32v530.7c0 8.5 3.4 16.6 9.4 22.6l173.3 173.3c2.2 2.2 4.7 4 7.4 5.5v1.9h4.2c3.5 1.3 7.2 2 11 2H704c17.7 0 32-14.3 32-32V224c0-17.7-14.3-32-32-32zM350 856.2 263.9 770H350v86.2zM664 888H414V746c0-22.1-17.9-40-40-40H232V264h432v624z"></path></svg></button><pre class="prism-code language-js"><div class=""><div class=""><span class="token keyword module">export</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">updateContainer</span><span class="token punctuation">(</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token parameter literal-property property">element</span><span class="token parameter operator">:</span><span class="token parameter"> </span><span class="token parameter maybe-class-name">ReactNodeList</span><span class="token parameter punctuation">,</span><span class="token parameter"></span></div></div><div class=""><div class=""><span class="token parameter">  </span><span class="token parameter literal-property property">container</span><span class="token parameter operator">:</span><span class="token parameter"> </span><span class="token parameter maybe-class-name">OpaqueRoot</span><span class="token parameter punctuation">,</span><span class="token parameter"></span></div></div><div class=""><div class=""><span class="token parameter">  </span><span class="token parameter literal-property property">parentComponent</span><span class="token parameter operator">:</span><span class="token parameter"> </span><span class="token parameter operator">?</span><span class="token parameter maybe-class-name">React$Component</span><span class="token parameter operator">&lt;</span><span class="token parameter">any</span><span class="token parameter punctuation">,</span><span class="token parameter"> any</span><span class="token parameter operator">&gt;</span><span class="token parameter punctuation">,</span><span class="token parameter"></span></div></div><div class=""><div class=""><span class="token parameter">  </span><span class="token parameter literal-property property">callback</span><span class="token parameter operator">:</span><span class="token parameter"> </span><span class="token parameter operator">?</span><span class="token parameter known-class-name class-name">Function</span><span class="token parameter punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token punctuation">)</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">Lane</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> current </span><span class="token operator">=</span><span class="token plain"> container</span><span class="token punctuation">.</span><span class="token property-access">current</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token comment">// 1. 获取当前时间戳, 计算本次更新的优先级</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> eventTime </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">requestEventTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> lane </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">requestUpdateLane</span><span class="token punctuation">(</span><span class="token plain">current</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">
</span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token comment">// 2. 设置fiber.updateQueue</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> update </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">createUpdate</span><span class="token punctuation">(</span><span class="token plain">eventTime</span><span class="token punctuation">,</span><span class="token plain"> lane</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  update</span><span class="token punctuation">.</span><span class="token property-access">payload</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"> element </span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  callback </span><span class="token operator">=</span><span class="token plain"> callback </span><span class="token operator">===</span><span class="token plain"> </span><span class="token keyword nil">undefined</span><span class="token plain"> </span><span class="token operator">?</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"> </span><span class="token operator">:</span><span class="token plain"> callback</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">callback </span><span class="token operator">!==</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    update</span><span class="token punctuation">.</span><span class="token property-access">callback</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> callback</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token function">enqueueUpdate</span><span class="token punctuation">(</span><span class="token plain">current</span><span class="token punctuation">,</span><span class="token plain"> update</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">
</span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token comment">// 3. 进入reconciler运作流程中的`输入`环节</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token function">scheduleUpdateOnFiber</span><span class="token punctuation">(</span><span class="token plain">current</span><span class="token punctuation">,</span><span class="token plain"> lane</span><span class="token punctuation">,</span><span class="token plain"> eventTime</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword control-flow">return</span><span class="token plain"> lane</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token punctuation">}</span></div></div></pre></div><p><code>updateContainer</code>函数位于<!-- --><code>react-reconciler</code>包中, 它串联了<!-- --><code>react-dom</code>与<!-- --><code>react-reconciler</code>. 此处暂时不深入分析<!-- --><code>updateContainer</code>函数的具体功能, 需要关注其最后调用了<!-- --><code>scheduleUpdateOnFiber</code>.<!-- --></p><p>在前文<!-- --><a href="/main/reconciler-workflow"><code>reconciler 运作流程</code></a>中, 重点分析过<!-- --><code>scheduleUpdateOnFiber</code>是<!-- --><code>输入</code>阶段的入口函数.<!-- --></p><p>所以到此为止, 通过调用<!-- --><code>react-dom</code>包的<!-- --><code>api</code>(如: <!-- --><code>ReactDOM.render</code>), <!-- --><code>react</code>内部经过一系列运转, 完成了初始化, 并且进入了<!-- --><code>reconciler 运作流程</code>的第一个阶段.<!-- --></p><h2 id="思考"><a aria-hidden="true" tabindex="-1" href="#思考"><span class="icon icon-link"></span></a>思考<!-- --></h2><h3 id="可中断渲染"><a aria-hidden="true" tabindex="-1" href="#可中断渲染"><span class="icon icon-link"></span></a>可中断渲染<!-- --></h3><p>react 中最广为人知的可中断渲染(render 可以中断, 部分生命周期函数有可能执行多次, <!-- --><code>UNSAFE_componentWillMount</code>,<!-- --><code>UNSAFE_componentWillReceiveProps</code>)只有在<!-- --><code>HostRootFiber.mode === ConcurrentRoot | BlockingRoot</code>才会开启. 如果使用的是<!-- --><code>legacy</code>, 即通过<!-- --><code>ReactDOM.render(&lt;App/&gt;, dom)</code>这种方式启动时<!-- --><code>HostRootFiber.mode = NoMode</code>, 这种情况下无论是首次 render 还是后续 update 都只会进入同步工作循环, <!-- --><code>reconciliation</code>没有机会中断, 所以生命周期函数只会调用一次.<!-- --></p><p>对于<!-- --><code>可中断渲染</code>的宣传最早来自<!-- --><a href="http://conf2017.reactjs.org/speakers/lin">2017 年 Lin Clark 的演讲</a>. 演讲中阐述了未来 react 会应用 fiber 架构, <!-- --><code>reconciliation可中断</code>等(13:15 秒). 在<!-- --><a href="https://github.com/facebook/react/blob/master/CHANGELOG.md#1610-november-9-2017"><code>v16.1.0</code></a>中应用了 fiber.<!-- --></p><p>在最新稳定版<!-- --><a href="https://github.com/facebook/react/blob/main/CHANGELOG.md#1702-march-22-2021"><code>v17.0.2</code></a>中, <!-- --><code>可中断渲染</code>虽然实现, 但是并没有在稳定版暴露出 api. 只能<!-- --><a href="https://github.com/reactwg/react-18/discussions/9">安装 alpha 版本</a>才能体验该特性.<!-- --></p><p>但是不少开发人员认为稳定版本的<!-- --><code>react</code>已经是可中断渲染(其实是有误区的), 大概率也是受到了各类宣传文章的影响. 前端大环境还是比较浮躁的, 在当下, 更需要静下心来学习.<!-- --></p><h2 id="总结"><a aria-hidden="true" tabindex="-1" href="#总结"><span class="icon icon-link"></span></a>总结<!-- --></h2><p>本章节介绍了<!-- --><code>react</code>应用的 3 种启动方式. 分析了启动后创建了 3 个关键对象, 并绘制了对象在内存中的引用关系. 启动过程最后调用<!-- --><code>updateContainer</code>进入<!-- --><code>react-reconciler</code>包,进而调用<!-- --><code>schedulerUpdateOnFiber</code>函数, 与<!-- --><code>reconciler运作流程</code>中的<!-- --><code>输入</code>阶段相衔接.<!-- --></p></div></div><script>$RC("B:2","S:2")</script>