<!DOCTYPE html><html><head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<meta name="keywords" content="react, react原理, 图解react, react fiber原理, react hook原理, react 合成事件, react 基本包结构">
<meta name="description" content="图解React原理系列, 以react核心包结构和运行机制为主线索进行展开. 包括react 基本包结构, react 工作循环, react 启动模式, react fiber原理, react hook原理, react 合成事件等核心内容">
<link rel="shortcut icon" href="/km@2x.png">
<link rel="stylesheet" href="/umi.eb36fa83.css">
<title data-rh="true">Hook 原理(概览)</title>
<meta data-rh="true" property="og:title" content="Hook 原理(概览)"/><meta data-rh="true" name="description" content="在前文状态与副作用中, 总结了class组件, function组件中通过api去改变fiber节点的状态和副作用. 其中对于function组件来讲, 其内部则需要依靠Hook来实现."/><meta data-rh="true" property="og:description" content="在前文状态与副作用中, 总结了class组件, function组件中通过api去改变fiber节点的状态和副作用. 其中对于function组件来讲, 其内部则需要依靠Hook来实现."/>
</head>
<body>
<noscript><b>Enable JavaScript to run this app.</b></noscript><div id="root"><!--$?--><template id="B:0"></template><div></div><!--/$--></div><script>window.__UMI_LOADER_DATA__ = {}</script>
<script src="/umi.c14ba5aa.js"></script>

</body></html><div hidden id="S:0"><!--$?--><template id="B:1"></template><div></div><!--/$--></div><script>function $RC(a,b){a=document.getElementById(a);b=document.getElementById(b);b.parentNode.removeChild(b);if(a){a=a.previousSibling;var f=a.parentNode,c=a.nextSibling,e=0;do{if(c&&8===c.nodeType){var d=c.data;if("/$"===d)if(0===e)break;else e--;else"$"!==d&&"$?"!==d&&"$!"!==d||e++}d=c.nextSibling;f.removeChild(c);c=d}while(c);for(;b.firstChild;)f.insertBefore(b.firstChild,c);a.data="$";a._reactRetry&&a._reactRetry()}};$RC("B:0","S:0")</script><div hidden id="S:1"><div class="dumi-default-doc-layout"><div class="dumi-default-header"><div class="dumi-default-header-content"><section class="dumi-default-header-left"><a class="dumi-default-logo" href="/"><img src="/logo.png" alt="图解React"/>图解React<!-- --></a></section><section class="dumi-default-header-right"><ul class="dumi-default-navbar"><li><a class="active" href="/main/macro-structure">原理解析</a></li><li><a href="/algorithm/diff">高频算法</a></li><li><a href="/interview/01-setstate">面试题</a></li></ul><div class="dumi-default-header-right-aside"><div class="dumi-default-search-bar"><svg viewBox="64 64 896 896" class="dumi-default-search-bar-svg"><path d="M909.6 854.5 649.9 594.8C690.2 542.7 712 479 712 412c0-80.2-31.3-155.4-87.9-212.1-56.6-56.7-132-87.9-212.1-87.9s-155.5 31.3-212.1 87.9C143.2 256.5 112 331.8 112 412c0 80.1 31.3 155.5 87.9 212.1C256.5 680.8 331.8 712 412 712c67 0 130.6-21.8 182.7-62l259.7 259.6a8.2 8.2 0 0 0 11.6 0l43.6-43.5a8.2 8.2 0 0 0 0-11.6zM570.4 570.4C528 612.7 471.8 636 412 636s-116-23.3-158.4-65.6C211.3 528 188 471.8 188 412s23.3-116.1 65.6-158.4C296 211.3 352.2 188 412 188s116.1 23.2 158.4 65.6S636 352.2 636 412s-23.3 116.1-65.6 158.4z"></path></svg><input class="dumi-default-search-bar-input" placeholder="输入关键字搜索..."/><span class="dumi-default-search-shortcut">⌘<!-- --> K<!-- --></span></div><span class="dumi-default-color-switch" data-dumi-tooltip="亮色模式" data-dumi-tooltip-bottom="true"><svg viewBox="0 0 16 16"><path d="M8 13a1 1 0 0 1 1 1v1a1 1 0 1 1-2 0v-1a1 1 0 0 1 1-1ZM8 3a1 1 0 0 1-1-1V1a1 1 0 1 1 2 0v1a1 1 0 0 1-1 1Zm7 4a1 1 0 1 1 0 2h-1a1 1 0 1 1 0-2h1ZM3 8a1 1 0 0 1-1 1H1a1 1 0 1 1 0-2h1a1 1 0 0 1 1 1Zm9.95 3.536.707.707a1 1 0 0 1-1.414 1.414l-.707-.707a1 1 0 0 1 1.414-1.414Zm-9.9-7.072-.707-.707a1 1 0 0 1 1.414-1.414l.707.707A1 1 0 0 1 3.05 4.464Zm9.9 0a1 1 0 0 1-1.414-1.414l.707-.707a1 1 0 0 1 1.414 1.414l-.707.707Zm-9.9 7.072a1 1 0 0 1 1.414 1.414l-.707.707a1 1 0 0 1-1.414-1.414l.707-.707ZM8 4a4 4 0 1 0 0 8 4 4 0 0 0 0-8Zm0 6.5a2.5 2.5 0 1 1 0-5 2.5 2.5 0 0 1 0 5Z"></path></svg><select><option value="light" selected="">亮色模式<!-- --></option><option value="dark">暗色模式<!-- --></option><option value="auto">跟随系统<!-- --></option></select></span><a class="dumi-default-icon" data-dumi-tooltip="GitHub" data-dumi-tooltip-bottom="true" target="_blank" href="https://github.com/7kms/react-illustration-series" rel="noreferrer"><svg viewBox="64 64 896 896"><path d="M511.6 76.3C264.3 76.2 64 276.4 64 523.5 64 718.9 189.3 885 363.8 946c23.5 5.9 19.9-10.8 19.9-22.2v-77.5c-135.7 15.9-141.2-73.9-150.3-88.9C215 726 171.5 718 184.5 703c30.9-15.9 62.4 4 98.9 57.9 26.4 39.1 77.9 32.5 104 26 5.7-23.5 17.9-44.5 34.7-60.8-140.6-25.2-199.2-111-199.2-213 0-49.5 16.3-95 48.3-131.7-20.4-60.5 1.9-112.3 4.9-120 58.1-5.2 118.5 41.6 123.2 45.3 33-8.9 70.7-13.6 112.9-13.6 42.4 0 80.2 4.9 113.5 13.9 11.3-8.6 67.3-48.8 121.3-43.9 2.9 7.7 24.7 58.3 5.5 118 32.4 36.8 48.9 82.7 48.9 132.3 0 102.2-59 188.1-200 212.9a127.5 127.5 0 0 1 38.1 91v112.5c.8 9 0 17.9 15 17.9 177.1-59.7 304.6-227 304.6-424.1 0-247.2-200.4-447.3-447.5-447.3z"></path></svg></a></div></section><button type="button" class="dumi-default-header-menu-btn"><svg viewBox="64 64 896 896"><path d="M904 160H120c-4.4 0-8 3.6-8 8v64c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-64c0-4.4-3.6-8-8-8zm0 624H120c-4.4 0-8 3.6-8 8v64c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-64c0-4.4-3.6-8-8-8zm0-312H120c-4.4 0-8 3.6-8 8v64c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-64c0-4.4-3.6-8-8-8z"></path></svg></button></div></div><div class="dumi-default-doc-layout-mobile-bar"><button type="button" class="dumi-default-sidebar-btn"><svg viewBox="64 64 896 896"><path d="M120 230h496c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm0 424h496c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm784 140H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0-424H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8z"></path></svg>侧边菜单<!-- --></button></div><main><div class="dumi-default-sidebar"><dl class="dumi-default-sidebar-group"><dt>基本概念</dt><dd><a title="宏观包结构" class="" href="/main/macro-structure">宏观包结构</a></dd><dd><a title="两大工作循环" class="" href="/main/workloop">两大工作循环</a></dd><dd><a title="高频对象" class="" href="/main/object-structure">高频对象</a></dd></dl><dl class="dumi-default-sidebar-group"><dt>运行核心</dt><dd><a title="启动过程" class="" href="/main/bootstrap">启动过程</a></dd><dd><a title="reconciler 运作流程" class="" href="/main/reconciler-workflow">reconciler 运作流程</a></dd><dd><a title="优先级管理" class="" href="/main/priority">优先级管理</a></dd><dd><a title="调度原理" class="" href="/main/scheduler">调度原理</a></dd><dd><a title="fiber 树构造(基础准备)" class="" href="/main/fibertree-prepare">fiber 树构造(基础准备)</a></dd><dd><a title="fiber 树构造(初次创建)" class="" href="/main/fibertree-create">fiber 树构造(初次创建)</a></dd><dd><a title="fiber 树构造(对比更新)" class="" href="/main/fibertree-update">fiber 树构造(对比更新)</a></dd><dd><a title="fiber 树渲染" class="" href="/main/fibertree-commit">fiber 树渲染</a></dd></dl><dl class="dumi-default-sidebar-group"><dt>状态管理</dt><dd><a title="状态与副作用" class="" href="/main/state-effects">状态与副作用</a></dd><dd><a title="Hook 原理(概览)" aria-current="page" class="active" href="/main/hook-summary">Hook 原理(概览)</a></dd><dd><a title="Hook 原理(状态Hook)" class="" href="/main/hook-state">Hook 原理(状态Hook)</a></dd><dd><a title="Hook 原理(副作用Hook)" class="" href="/main/hook-effect">Hook 原理(副作用Hook)</a></dd><dd><a title="context 原理" class="" href="/main/context">context 原理</a></dd></dl><dl class="dumi-default-sidebar-group"><dt>交互</dt><dd><a title="合成事件" class="" href="/main/synthetic-event">合成事件</a></dd></dl></div><div class="dumi-default-content"><!--$?--><template id="B:2"></template><div></div><!--/$--><div class="dumi-default-footer">Copyright © 2023 | Powered by <a href="https://d.umijs.org" target="_blank" rel="noreferrer">dumi</a></div></div></main></div></div><script>$RC("B:1","S:1")</script><div hidden id="S:2"><div class="markdown"><h1 id="hook-原理概览"><a aria-hidden="true" tabindex="-1" href="#hook-原理概览"><span class="icon icon-link"></span></a>Hook 原理(概览)<!-- --></h1><p>在前文<!-- --><a href="/main/state-effects">状态与副作用</a>中, 总结了<!-- --><code>class组件, function组件</code>中通过<!-- --><code>api</code>去改变<!-- --><code>fiber节点</code>的<!-- --><code>状态</code>和<!-- --><code>副作用</code>. 其中对于<!-- --><code>function组件</code>来讲, 其内部则需要依靠<!-- --><code>Hook</code>来实现.<!-- --></p><p>官方文档上专门用了一个版块来介绍<!-- --><a href="https://zh-hans.reactjs.org/docs/hooks-intro.html">Hook</a>, 这里摘抄了几个比较关心的问题(其他<!-- --><code>FAQ</code>请移步官网):<!-- --></p><ol><li><p><a href="https://zh-hans.reactjs.org/docs/hooks-intro.html#motivation">引入<!-- --><code>Hook</code>的动机?<!-- --></a></p><ul><li>在组件之间复用状态逻辑很难; 复杂组件变得难以理解; 难以理解的 class. 为了解决这些实际开发痛点, 引入了<!-- --><code>Hook</code>.<!-- --></li></ul></li><li><p><a href="https://zh-hans.reactjs.org/docs/hooks-state.html#whats-a-hook"><code>Hook</code> 是什么? 什么时候会用 <!-- --><code>Hook</code>?<!-- --></a></p><ul><li><code>Hook</code> 是一个特殊的函数, 它可以让你“钩入” <!-- --><code>React</code> 的特性. 如, <!-- --><code>useState</code> 是允许你在 <!-- --><code>React</code> 函数组件中添加 <!-- --><code>state</code> 的 <!-- --><code>Hook</code>.<!-- --></li><li>如果你在编写函数组件并意识到需要向其添加一些 <!-- --><code>state</code>, 以前的做法是必须将其转化为 <!-- --><code>class</code>. 现在你可以在现有的函数组件中使用 <!-- --><code>Hook</code>.<!-- --></li></ul></li><li><p><a href="https://zh-hans.reactjs.org/docs/hooks-faq.html#are-hooks-slow-because-of-creating-functions-in-render"><code>Hook</code> 会因为在  渲染时创建函数而变慢吗?<!-- --></a></p><ul><li>不会. 在现代浏览器中,闭包和类的原始性能只有在极端场景下才会有明显的差别. 除此之外,可以认为 <!-- --><code>Hook</code> 的设计在某些方面更加高效:
<!-- --><ul><li><code>Hook</code> 避免了 <!-- --><code>class</code> 需要的额外开支,像是创建类实例和在构造函数中绑定事件处理器的成本.<!-- --></li><li>符合语言习惯的代码在使用 <!-- --><code>Hook</code> 时不需要很深的组件树嵌套. 这个现象在使用<!-- --><code>高阶组件</code>、<!-- --><code>render props</code>、和 <!-- --><code>context</code> 的代码库中非常普遍. 组件树小了, <!-- --><code>React</code> 的工作量也随之减少.<!-- --></li></ul></li></ul></li></ol><p>所以<!-- --><code>Hook</code>是<!-- --><code>React</code>团队在大量实践后的产物, 更优雅的代替<!-- --><code>class</code>, 且性能更高. 故从开发使用者的角度来讲, 应该拥抱<!-- --><code>Hook</code>所带来的便利.<!-- --></p><h2 id="hook-与-fiber"><a aria-hidden="true" tabindex="-1" href="#hook-与-fiber"><span class="icon icon-link"></span></a>Hook 与 Fiber<!-- --></h2><p>通过官网文档的讲解, 能快速掌握<!-- --><code>Hook</code>的使用. 再结合前文<!-- --><a href="/main/state-effects">状态与副作用</a>的介绍, 我们知道使用<!-- --><code>Hook</code>最终也是为了控制<!-- --><code>fiber节点</code>的<!-- --><code>状态</code>和<!-- --><code>副作用</code>. 从<!-- --><code>fiber</code>视角, 状态和副作用相关的属性如下(这里不再解释单个属性的意义, 可以回顾<!-- --><a href="/main/state-effects">状态与副作用</a>):<!-- --></p><div class="dumi-default-source-code"><button type="button" class="dumi-default-source-code-copy"><svg viewBox="64 64 896 896"><path d="M832 64H296c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h496v688c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8V96c0-17.7-14.3-32-32-32zM704 192H192c-17.7 0-32 14.3-32 32v530.7c0 8.5 3.4 16.6 9.4 22.6l173.3 173.3c2.2 2.2 4.7 4 7.4 5.5v1.9h4.2c3.5 1.3 7.2 2 11 2H704c17.7 0 32-14.3 32-32V224c0-17.7-14.3-32-32-32zM350 856.2 263.9 770H350v86.2zM664 888H414V746c0-22.1-17.9-40-40-40H232V264h432v624z"></path></svg></button><pre class="prism-code language-js"><div class=""><div class=""><span class="token keyword module">export</span><span class="token plain"> type </span><span class="token maybe-class-name">Fiber</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token operator">|</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token comment">// 1. fiber节点自身状态相关</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token literal-property property">pendingProps</span><span class="token operator">:</span><span class="token plain"> any</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token literal-property property">memoizedProps</span><span class="token operator">:</span><span class="token plain"> any</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token literal-property property">updateQueue</span><span class="token operator">:</span><span class="token plain"> mixed</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token literal-property property">memoizedState</span><span class="token operator">:</span><span class="token plain"> any</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">
</span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token comment">// 2. fiber节点副作用(Effect)相关</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token literal-property property">flags</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">Flags</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token literal-property property">nextEffect</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">Fiber</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token literal-property property">firstEffect</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">Fiber</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token literal-property property">lastEffect</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">Fiber</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token operator">|</span><span class="token punctuation">}</span><span class="token punctuation">;</span></div></div></pre></div><p>使用<!-- --><code>Hook</code>的任意一个<!-- --><code>api</code>, 最后都是为了控制上述这几个<!-- --><code>fiber属性</code>.<!-- --></p><h2 id="hook-数据结构"><a aria-hidden="true" tabindex="-1" href="#hook-数据结构"><span class="icon icon-link"></span></a>Hook 数据结构<!-- --></h2><p>在<!-- --><a href="https://github.com/facebook/react/blob/v17.0.2/packages/react-reconciler/src/ReactFiberHooks.old.js#L95-L140">ReactFiberHooks</a>中, 定义了<!-- --><code>Hook</code>的数据结构:<!-- --></p><div class="dumi-default-source-code"><button type="button" class="dumi-default-source-code-copy"><svg viewBox="64 64 896 896"><path d="M832 64H296c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h496v688c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8V96c0-17.7-14.3-32-32-32zM704 192H192c-17.7 0-32 14.3-32 32v530.7c0 8.5 3.4 16.6 9.4 22.6l173.3 173.3c2.2 2.2 4.7 4 7.4 5.5v1.9h4.2c3.5 1.3 7.2 2 11 2H704c17.7 0 32-14.3 32-32V224c0-17.7-14.3-32-32-32zM350 856.2 263.9 770H350v86.2zM664 888H414V746c0-22.1-17.9-40-40-40H232V264h432v624z"></path></svg></button><pre class="prism-code language-js"><div class=""><div class=""><span class="token plain">type </span><span class="token maybe-class-name">Update</span><span class="token operator">&lt;</span><span class="token constant">S</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token constant">A</span><span class="token operator">&gt;</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token operator">|</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token literal-property property">lane</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">Lane</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token literal-property property">action</span><span class="token operator">:</span><span class="token plain"> </span><span class="token constant">A</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token literal-property property">eagerReducer</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter constant">S</span><span class="token parameter punctuation">,</span><span class="token parameter"> </span><span class="token parameter constant">A</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token constant">S</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token literal-property property">eagerState</span><span class="token operator">:</span><span class="token plain"> </span><span class="token constant">S</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token literal-property property">next</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">Update</span><span class="token operator">&lt;</span><span class="token constant">S</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token constant">A</span><span class="token operator">&gt;</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  priority</span><span class="token operator">?</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">ReactPriorityLevel</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token operator">|</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">
</span></div></div><div class=""><div class=""><span class="token plain">type </span><span class="token maybe-class-name">UpdateQueue</span><span class="token operator">&lt;</span><span class="token constant">S</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token constant">A</span><span class="token operator">&gt;</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token operator">|</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token literal-property property">pending</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">Update</span><span class="token operator">&lt;</span><span class="token constant">S</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token constant">A</span><span class="token operator">&gt;</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token literal-property property">dispatch</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter constant">A</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> mixed</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token literal-property property">lastRenderedReducer</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter constant">S</span><span class="token parameter punctuation">,</span><span class="token parameter"> </span><span class="token parameter constant">A</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token constant">S</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token literal-property property">lastRenderedState</span><span class="token operator">:</span><span class="token plain"> </span><span class="token constant">S</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token operator">|</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">
</span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token keyword module">export</span><span class="token plain"> type </span><span class="token maybe-class-name">Hook</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token operator">|</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token literal-property property">memoizedState</span><span class="token operator">:</span><span class="token plain"> any</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token comment">// 当前状态</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token literal-property property">baseState</span><span class="token operator">:</span><span class="token plain"> any</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token comment">// 基状态</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token literal-property property">baseQueue</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">Update</span><span class="token operator">&lt;</span><span class="token plain">any</span><span class="token punctuation">,</span><span class="token plain"> any</span><span class="token operator">&gt;</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token comment">// 基队列</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token literal-property property">queue</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">UpdateQueue</span><span class="token operator">&lt;</span><span class="token plain">any</span><span class="token punctuation">,</span><span class="token plain"> any</span><span class="token operator">&gt;</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token comment">// 更新队列</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token literal-property property">next</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">Hook</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token comment">// next指针</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token operator">|</span><span class="token punctuation">}</span><span class="token punctuation">;</span></div></div></pre></div><p>从定义来看, <!-- --><code>Hook</code> 对象共有 5 个属性(有关这些属性的应用, 将在<!-- --><code>Hook 原理(状态)</code>章节中具体分析.):<!-- --></p><ol><li><code>hook.memoizedState</code>: 保持在内存中的局部状态.<!-- --></li><li><code>hook.baseState</code>: <!-- --><code>hook.baseQueue</code>中所有<!-- --><code>update</code>对象合并之后的状态.<!-- --></li><li><code>hook.baseQueue</code>: 存储<!-- --><code>update对象</code>的环形链表, 只包括高于本次渲染优先级的<!-- --><code>update对象</code>.<!-- --></li><li><code>hook.queue</code>: 存储<!-- --><code>update对象</code>的环形链表, 包括所有优先级的<!-- --><code>update对象</code>.<!-- --></li><li><code>hook.next</code>: <!-- --><code>next</code>指针, 指向链表中的下一个<!-- --><code>hook</code>.<!-- --></li></ol><p>所以<!-- --><code>Hook</code>是一个链表, 单个<!-- --><code>Hook</code>拥有自己的状态<!-- --><code>hook.memoizedState</code>和自己的更新队列<!-- --><code>hook.queue</code>(有关 Hook 状态的分析, 在<!-- --><code>Hook原理(状态)</code>章节中解读).<!-- --></p><p><img alt="" src="/static/hook-linkedlist.d52c2c25.png"/></p><p>注意: 其中<!-- --><code>hook.queue</code>与<!-- --><code>fiber.updateQueue</code>虽然都是<!-- --><code>update环形链表</code>, 尽管<!-- --><code>update对象</code>的数据结构与处理方式都高度相似, 但是这 2 个队列中的<!-- --><code>update对象</code>是完全独立的. <!-- --><code>hook.queue</code>只作用于<!-- --><code>hook对象</code>的状态维护, 切勿与<!-- --><code>fiber.updateQueue</code>混淆.<!-- --></p><h2 id="hook-分类"><a aria-hidden="true" tabindex="-1" href="#hook-分类"><span class="icon icon-link"></span></a>Hook 分类<!-- --></h2><p>在<!-- --><code>v17.0.2</code>中, 共定义了<!-- --><a href="https://github.com/facebook/react/blob/v17.0.2/packages/react-reconciler/src/ReactFiberHooks.old.js#L111-L125">14 种 Hook</a></p><div class="dumi-default-source-code"><button type="button" class="dumi-default-source-code-copy"><svg viewBox="64 64 896 896"><path d="M832 64H296c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h496v688c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8V96c0-17.7-14.3-32-32-32zM704 192H192c-17.7 0-32 14.3-32 32v530.7c0 8.5 3.4 16.6 9.4 22.6l173.3 173.3c2.2 2.2 4.7 4 7.4 5.5v1.9h4.2c3.5 1.3 7.2 2 11 2H704c17.7 0 32-14.3 32-32V224c0-17.7-14.3-32-32-32zM350 856.2 263.9 770H350v86.2zM664 888H414V746c0-22.1-17.9-40-40-40H232V264h432v624z"></path></svg></button><pre class="prism-code language-js"><div class=""><div class=""><span class="token keyword module">export</span><span class="token plain"> type </span><span class="token maybe-class-name">HookType</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token operator">|</span><span class="token plain"> </span><span class="token string">&#x27;useState&#x27;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token operator">|</span><span class="token plain"> </span><span class="token string">&#x27;useReducer&#x27;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token operator">|</span><span class="token plain"> </span><span class="token string">&#x27;useContext&#x27;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token operator">|</span><span class="token plain"> </span><span class="token string">&#x27;useRef&#x27;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token operator">|</span><span class="token plain"> </span><span class="token string">&#x27;useEffect&#x27;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token operator">|</span><span class="token plain"> </span><span class="token string">&#x27;useLayoutEffect&#x27;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token operator">|</span><span class="token plain"> </span><span class="token string">&#x27;useCallback&#x27;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token operator">|</span><span class="token plain"> </span><span class="token string">&#x27;useMemo&#x27;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token operator">|</span><span class="token plain"> </span><span class="token string">&#x27;useImperativeHandle&#x27;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token operator">|</span><span class="token plain"> </span><span class="token string">&#x27;useDebugValue&#x27;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token operator">|</span><span class="token plain"> </span><span class="token string">&#x27;useDeferredValue&#x27;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token operator">|</span><span class="token plain"> </span><span class="token string">&#x27;useTransition&#x27;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token operator">|</span><span class="token plain"> </span><span class="token string">&#x27;useMutableSource&#x27;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token operator">|</span><span class="token plain"> </span><span class="token string">&#x27;useOpaqueIdentifier&#x27;</span><span class="token punctuation">;</span></div></div></pre></div><p>官网上已经将其分为了 2 个类别, 状态<!-- --><code>Hook</code>(<!-- --><code>State Hook</code>), 和副作用<!-- --><code>Hook</code>(<!-- --><code>Effect Hook</code>).<!-- --></p><p>这里我们可以结合前文<!-- --><a href="/main/state-effects">状态与副作用</a>, 从<!-- --><code>fiber</code>的视角去理解<!-- --><code>状态Hook</code>与<!-- --><code>副作用Hook</code>的区别.<!-- --></p><h3 id="状态-hook"><a aria-hidden="true" tabindex="-1" href="#状态-hook"><span class="icon icon-link"></span></a>状态 Hook<!-- --></h3><p>狭义上讲, <!-- --><code>useState, useReducer</code>可以在<!-- --><code>function组件</code>添加内部的<!-- --><code>state</code>, 且<!-- --><code>useState</code>实际上是<!-- --><code>useReducer</code>的简易封装, 是一个最特殊(简单)的<!-- --><code>useReducer</code>. 所以将<!-- --><code>useState, useReducer</code>称为<!-- --><code>状态Hook</code>.<!-- --></p><p>广义上讲, 只要能实现数据持久化<!-- --><code>且没有副作用</code>的<!-- --><code>Hook</code>, 均可以视为<!-- --><code>状态Hook</code>, 所以还包括<!-- --><code>useContext, useRef, useCallback, useMemo</code>等. 这类<!-- --><code>Hook</code>内部没有使用<!-- --><code>useState/useReducer</code>, 但是它们也能实现多次<!-- --><code>render</code>时, 保持其初始值不变(即数据持久化)且没有任何<!-- --><code>副作用</code>.<!-- --></p><p>得益于<!-- --><a href="/main/fibertree-prepare#%E5%8F%8C%E7%BC%93%E5%86%B2%E6%8A%80%E6%9C%AF">双缓冲技术(double buffering)</a>, 在多次<!-- --><code>render</code>时, 以<!-- --><code>fiber</code>为载体, 保证复用同一个<!-- --><code>Hook</code>对象, 进而实现数据持久化. 具体实现细节, 在<!-- --><code>Hook原理(状态)</code>章节中讨论.<!-- --></p><h3 id="副作用-hook"><a aria-hidden="true" tabindex="-1" href="#副作用-hook"><span class="icon icon-link"></span></a>副作用 Hook<!-- --></h3><p>回到<!-- --><code>fiber</code>视角, <!-- --><code>状态Hook</code>实现了状态持久化(等同于<!-- --><code>class组件</code>维护<!-- --><code>fiber.memoizedState</code>), 那么<!-- --><code>副作用Hook</code>则会修改<!-- --><code>fiber.flags</code>. (通过前文<!-- --><code>fiber树构造</code>系列的解读, 我们知道在<!-- --><code>performUnitOfWork-&gt;completeWork</code>阶段, 所有存在副作用的<!-- --><code>fiber</code>节点, 都会被添加到父节点的<!-- --><code>副作用队列</code>后, 最后在<!-- --><code>commitRoot</code>阶段处理这些<!-- --><code>副作用节点</code>.)<!-- --></p><p>另外, <!-- --><code>副作用Hook</code>还提供了<!-- --><code>副作用回调</code>(类似于<!-- --><code>class组件</code>的生命周期回调), 比如:<!-- --></p><div class="dumi-default-source-code"><button type="button" class="dumi-default-source-code-copy"><svg viewBox="64 64 896 896"><path d="M832 64H296c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h496v688c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8V96c0-17.7-14.3-32-32-32zM704 192H192c-17.7 0-32 14.3-32 32v530.7c0 8.5 3.4 16.6 9.4 22.6l173.3 173.3c2.2 2.2 4.7 4 7.4 5.5v1.9h4.2c3.5 1.3 7.2 2 11 2H704c17.7 0 32-14.3 32-32V224c0-17.7-14.3-32-32-32zM350 856.2 263.9 770H350v86.2zM664 888H414V746c0-22.1-17.9-40-40-40H232V264h432v624z"></path></svg></button><pre class="prism-code language-js"><div class=""><div class=""><span class="token comment">// 使用useEffect时, 需要传入一个副作用回调函数.</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token comment">// 在fiber树构造完成之后, commitRoot阶段会处理这些副作用回调</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">&#x27;这是一个副作用回调函数&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div></div></pre></div><p>在<!-- --><code>react</code>内部, <!-- --><code>useEffect</code>就是最标准的<!-- --><code>副作用Hook</code>. 其他比如<!-- --><code>useLayoutEffect</code>以及<!-- --><code>自定义Hook</code>, 如果要实现<!-- --><code>副作用</code>, 必须直接或间接的调用<!-- --><code>useEffect</code>.<!-- --></p><p>有关<!-- --><code>useEffect</code>具体实现细节, 在<!-- --><code>Hook原理(副作用)</code>章节中讨论.<!-- --></p><h3 id="组合-hook"><a aria-hidden="true" tabindex="-1" href="#组合-hook"><span class="icon icon-link"></span></a>组合 Hook<!-- --></h3><p>虽然官网并无<!-- --><code>组合Hook</code>的说法, 但事实上大多数<!-- --><code>Hook</code>(包括自定义<!-- --><code>Hook</code>)都是由上述 2 种 <!-- --><code>Hook</code>组合而成, 同时拥有这 2 种 Hook 的特性.<!-- --></p><ul><li>在<!-- --><code>react</code>内部有<!-- --><code>useDeferredValue, useTransition, useMutableSource, useOpaqueIdentifier</code>等.<!-- --></li><li>平时开发中, <!-- --><code>自定义Hook</code>大部分都是组合 Hook.<!-- --></li></ul><p>比如官网上的<!-- --><a href="https://zh-hans.reactjs.org/docs/hooks-custom.html#extracting-a-custom-hook">自定义 Hook</a>例子:<!-- --></p><div class="dumi-default-source-code"><button type="button" class="dumi-default-source-code-copy"><svg viewBox="64 64 896 896"><path d="M832 64H296c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h496v688c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8V96c0-17.7-14.3-32-32-32zM704 192H192c-17.7 0-32 14.3-32 32v530.7c0 8.5 3.4 16.6 9.4 22.6l173.3 173.3c2.2 2.2 4.7 4 7.4 5.5v1.9h4.2c3.5 1.3 7.2 2 11 2H704c17.7 0 32-14.3 32-32V224c0-17.7-14.3-32-32-32zM350 856.2 263.9 770H350v86.2zM664 888H414V746c0-22.1-17.9-40-40-40H232V264h432v624z"></path></svg></button><pre class="prism-code language-js"><div class=""><div class=""><span class="token keyword module">import</span><span class="token plain"> </span><span class="token imports punctuation">{</span><span class="token imports"> useState</span><span class="token imports punctuation">,</span><span class="token imports"> useEffect </span><span class="token imports punctuation">}</span><span class="token plain"> </span><span class="token keyword module">from</span><span class="token plain"> </span><span class="token string">&#x27;react&#x27;</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">
</span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">useFriendStatus</span><span class="token punctuation">(</span><span class="token parameter">friendID</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token comment">// 1. 调用useState, 创建一个状态Hook</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token plain">isOnline</span><span class="token punctuation">,</span><span class="token plain"> setIsOnline</span><span class="token punctuation">]</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">useState</span><span class="token punctuation">(</span><span class="token keyword null nil">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">
</span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token comment">// 2. 调用useEffect, 创建一个副作用Hook</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">handleStatusChange</span><span class="token punctuation">(</span><span class="token parameter">status</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token function">setIsOnline</span><span class="token punctuation">(</span><span class="token plain">status</span><span class="token punctuation">.</span><span class="token property-access">isOnline</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token maybe-class-name">ChatAPI</span><span class="token punctuation">.</span><span class="token method function property-access">subscribeToFriendStatus</span><span class="token punctuation">(</span><span class="token plain">friendID</span><span class="token punctuation">,</span><span class="token plain"> handleStatusChange</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token keyword control-flow">return</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token maybe-class-name">ChatAPI</span><span class="token punctuation">.</span><span class="token method function property-access">unsubscribeFromFriendStatus</span><span class="token punctuation">(</span><span class="token plain">friendID</span><span class="token punctuation">,</span><span class="token plain"> handleStatusChange</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword control-flow">return</span><span class="token plain"> isOnline</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token punctuation">}</span></div></div></pre></div><h2 id="调用-function-前"><a aria-hidden="true" tabindex="-1" href="#调用-function-前"><span class="icon icon-link"></span></a>调用 function 前<!-- --></h2><p>在调用<!-- --><code>function</code>之前, <!-- --><code>react</code>内部还需要提前做一些准备工作.<!-- --></p><h3 id="处理函数"><a aria-hidden="true" tabindex="-1" href="#处理函数"><span class="icon icon-link"></span></a>处理函数<!-- --></h3><p>从<!-- --><code>fiber树构造</code>的视角来看, 不同的<!-- --><code>fiber</code>类型, 只需要调用不同的<!-- --><code>处理函数</code>返回<!-- --><code>fiber子节点</code>. 所以在<!-- --><a href="https://github.com/facebook/react/blob/v17.0.2/packages/react-reconciler/src/ReactFiberBeginWork.old.js#L3340-L3354">performUnitOfWork-&gt;beginWork</a>函数中, 调用了多种<!-- --><code>处理函数</code>. 从调用方来讲, 无需关心<!-- --><code>处理函数</code>的内部实现(比如<!-- --><code>updateFunctionComponent</code>内部使用了<!-- --><code>Hook对象</code>, <!-- --><code>updateClassComponent</code>内部使用了<!-- --><code>class实例</code>).<!-- --></p><p>本节讨论<!-- --><code>Hook</code>, 所以列出其中的<!-- --><a href="https://github.com/facebook/react/blob/v17.0.2/packages/react-reconciler/src/ReactFiberBeginWork.old.js#L702-L783">updateFunctionComponent</a>函数:<!-- --></p><div class="dumi-default-source-code"><button type="button" class="dumi-default-source-code-copy"><svg viewBox="64 64 896 896"><path d="M832 64H296c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h496v688c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8V96c0-17.7-14.3-32-32-32zM704 192H192c-17.7 0-32 14.3-32 32v530.7c0 8.5 3.4 16.6 9.4 22.6l173.3 173.3c2.2 2.2 4.7 4 7.4 5.5v1.9h4.2c3.5 1.3 7.2 2 11 2H704c17.7 0 32-14.3 32-32V224c0-17.7-14.3-32-32-32zM350 856.2 263.9 770H350v86.2zM664 888H414V746c0-22.1-17.9-40-40-40H232V264h432v624z"></path></svg></button><pre class="prism-code language-js"><div class=""><div class=""><span class="token comment">// 只保留FunctionComponent相关:</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">beginWork</span><span class="token punctuation">(</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token parameter literal-property property">current</span><span class="token parameter operator">:</span><span class="token parameter"> </span><span class="token parameter maybe-class-name">Fiber</span><span class="token parameter"> </span><span class="token parameter operator">|</span><span class="token parameter"> </span><span class="token parameter keyword null nil">null</span><span class="token parameter punctuation">,</span><span class="token parameter"></span></div></div><div class=""><div class=""><span class="token parameter">  </span><span class="token parameter literal-property property">workInProgress</span><span class="token parameter operator">:</span><span class="token parameter"> </span><span class="token parameter maybe-class-name">Fiber</span><span class="token parameter punctuation">,</span><span class="token parameter"></span></div></div><div class=""><div class=""><span class="token parameter">  </span><span class="token parameter literal-property property">renderLanes</span><span class="token parameter operator">:</span><span class="token parameter"> </span><span class="token parameter maybe-class-name">Lanes</span><span class="token parameter punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token punctuation">)</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">Fiber</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> updateLanes </span><span class="token operator">=</span><span class="token plain"> workInProgress</span><span class="token punctuation">.</span><span class="token property-access">lanes</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword control-flow">switch</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">workInProgress</span><span class="token punctuation">.</span><span class="token property-access">tag</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token keyword">case</span><span class="token plain"> </span><span class="token literal-property property">FunctionComponent</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token keyword">const</span><span class="token plain"> </span><span class="token maybe-class-name">Component</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> workInProgress</span><span class="token punctuation">.</span><span class="token property-access">type</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token keyword">const</span><span class="token plain"> unresolvedProps </span><span class="token operator">=</span><span class="token plain"> workInProgress</span><span class="token punctuation">.</span><span class="token property-access">pendingProps</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token keyword">const</span><span class="token plain"> resolvedProps </span><span class="token operator">=</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">        workInProgress</span><span class="token punctuation">.</span><span class="token property-access">elementType</span><span class="token plain"> </span><span class="token operator">===</span><span class="token plain"> </span><span class="token maybe-class-name">Component</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">          </span><span class="token operator">?</span><span class="token plain"> unresolvedProps</span></div></div><div class=""><div class=""><span class="token plain">          </span><span class="token operator">:</span><span class="token plain"> </span><span class="token function">resolveDefaultProps</span><span class="token punctuation">(</span><span class="token maybe-class-name">Component</span><span class="token punctuation">,</span><span class="token plain"> unresolvedProps</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token keyword control-flow">return</span><span class="token plain"> </span><span class="token function">updateFunctionComponent</span><span class="token punctuation">(</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">        current</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">        workInProgress</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">        </span><span class="token maybe-class-name">Component</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">        resolvedProps</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">        renderLanes</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">
</span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">updateFunctionComponent</span><span class="token punctuation">(</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token parameter">current</span><span class="token parameter punctuation">,</span><span class="token parameter"></span></div></div><div class=""><div class=""><span class="token parameter">  workInProgress</span><span class="token parameter punctuation">,</span><span class="token parameter"></span></div></div><div class=""><div class=""><span class="token parameter">  </span><span class="token parameter maybe-class-name">Component</span><span class="token parameter punctuation">,</span><span class="token parameter"></span></div></div><div class=""><div class=""><span class="token parameter">  </span><span class="token parameter literal-property property">nextProps</span><span class="token parameter operator">:</span><span class="token parameter"> any</span><span class="token parameter punctuation">,</span><span class="token parameter"></span></div></div><div class=""><div class=""><span class="token parameter">  renderLanes</span><span class="token parameter punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token comment">// ...省略无关代码</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword">let</span><span class="token plain"> context</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword">let</span><span class="token plain"> nextChildren</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token function">prepareToReadContext</span><span class="token punctuation">(</span><span class="token plain">workInProgress</span><span class="token punctuation">,</span><span class="token plain"> renderLanes</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">
</span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token comment">// 进入Hooks相关逻辑, 最后返回下级ReactElement对象</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  nextChildren </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">renderWithHooks</span><span class="token punctuation">(</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    current</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    workInProgress</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token maybe-class-name">Component</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    nextProps</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    context</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    renderLanes</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token comment">// 进入reconcile函数, 生成下级fiber节点</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token function">reconcileChildren</span><span class="token punctuation">(</span><span class="token plain">current</span><span class="token punctuation">,</span><span class="token plain"> workInProgress</span><span class="token punctuation">,</span><span class="token plain"> nextChildren</span><span class="token punctuation">,</span><span class="token plain"> renderLanes</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token comment">// 返回下级fiber节点</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword control-flow">return</span><span class="token plain"> workInProgress</span><span class="token punctuation">.</span><span class="token property-access">child</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token punctuation">}</span></div></div></pre></div><p>在<!-- --><code>updateFunctionComponent</code>函数中调用了<!-- --><a href="https://github.com/facebook/react/blob/v17.0.2/packages/react-reconciler/src/ReactFiberHooks.old.js#L342-L476">renderWithHooks</a>(位于<!-- --><a href="https://github.com/facebook/react/blob/v17.0.2/packages/react-reconciler/src/ReactFiberHooks.old.js">ReactFiberHooks</a>) , 至此<!-- --><code>Fiber</code>  与<!-- --><code>Hook</code>产生了关联.<!-- --></p><h3 id="全局变量"><a aria-hidden="true" tabindex="-1" href="#全局变量"><span class="icon icon-link"></span></a>全局变量<!-- --></h3><p>在分析<!-- --><code>renderWithHooks</code>函数前, 有必要理解<!-- --><a href="https://github.com/facebook/react/blob/v17.0.2/packages/react-reconciler/src/ReactFiberHooks.old.js">ReactFiberHooks</a>头部定义的全局变量(源码中均有英文注释):<!-- --></p><div class="dumi-default-source-code"><button type="button" class="dumi-default-source-code-copy"><svg viewBox="64 64 896 896"><path d="M832 64H296c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h496v688c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8V96c0-17.7-14.3-32-32-32zM704 192H192c-17.7 0-32 14.3-32 32v530.7c0 8.5 3.4 16.6 9.4 22.6l173.3 173.3c2.2 2.2 4.7 4 7.4 5.5v1.9h4.2c3.5 1.3 7.2 2 11 2H704c17.7 0 32-14.3 32-32V224c0-17.7-14.3-32-32-32zM350 856.2 263.9 770H350v86.2zM664 888H414V746c0-22.1-17.9-40-40-40H232V264h432v624z"></path></svg></button><pre class="prism-code language-js"><div class=""><div class=""><span class="token comment">// 渲染优先级</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token keyword">let</span><span class="token plain"> </span><span class="token literal-property property">renderLanes</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">Lanes</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token maybe-class-name">NoLanes</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">
</span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token comment">// 当前正在构造的fiber, 等同于 workInProgress, 为了和当前hook区分, 所以将其改名</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token keyword">let</span><span class="token plain"> </span><span class="token literal-property property">currentlyRenderingFiber</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">Fiber</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token keyword null nil">null</span><span class="token operator">:</span><span class="token plain"> any</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">
</span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token comment">// Hooks被存储在fiber.memoizedState 链表上</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token keyword">let</span><span class="token plain"> </span><span class="token literal-property property">currentHook</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">Hook</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">;</span><span class="token plain"> </span><span class="token comment">// currentHook = fiber(current).memoizedState</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">
</span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token keyword">let</span><span class="token plain"> </span><span class="token literal-property property">workInProgressHook</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">Hook</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">;</span><span class="token plain"> </span><span class="token comment">// workInProgressHook = fiber(workInProgress).memoizedState</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">
</span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token comment">// 在function的执行过程中, 是否再次发起了更新. 只有function被完全执行之后才会重置.</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token comment">// 当render异常时, 通过该变量可以决定是否清除render过程中的更新.</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token keyword">let</span><span class="token plain"> </span><span class="token literal-property property">didScheduleRenderPhaseUpdate</span><span class="token operator">:</span><span class="token plain"> boolean </span><span class="token operator">=</span><span class="token plain"> </span><span class="token boolean">false</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">
</span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token comment">// 在本次function的执行过程中, 是否再次发起了更新. 每一次调用function都会被重置</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token keyword">let</span><span class="token plain"> </span><span class="token literal-property property">didScheduleRenderPhaseUpdateDuringThisPass</span><span class="token operator">:</span><span class="token plain"> boolean </span><span class="token operator">=</span><span class="token plain"> </span><span class="token boolean">false</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">
</span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token comment">// 在本次function的执行过程中, 重新发起更新的最大次数</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> </span><span class="token constant">RE_RENDER_LIMIT</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">25</span><span class="token punctuation">;</span></div></div></pre></div><p>每个变量的解释, 可以对照源码中的英文注释, 其中最重要的有:</p><ol><li><code>currentlyRenderingFiber</code>: 当前正在构造的 fiber, 等同于 workInProgress<!-- --></li><li><code>currentHook 与 workInProgressHook</code>: 分别指向<!-- --><code>current.memoizedState</code>和<!-- --><code>workInProgress.memoizedState</code></li></ol><p>注: 有关<!-- --><code>current</code>和<!-- --><code>workInProgress</code>的区别, 请回顾<!-- --><a href="/main/fibertree-prepare#%E5%8F%8C%E7%BC%93%E5%86%B2%E6%8A%80%E6%9C%AF">双缓冲技术(double buffering)</a></p><h3 id="renderwithhooks-函数"><a aria-hidden="true" tabindex="-1" href="#renderwithhooks-函数"><span class="icon icon-link"></span></a>renderWithHooks 函数<!-- --></h3><p><a href="https://github.com/facebook/react/blob/v17.0.2/packages/react-reconciler/src/ReactFiberHooks.old.js#L342-L476">renderWithHooks</a>源码看似较长, 但是去除 dev 后保留主干, 逻辑十分清晰. 以调用<!-- --><code>function</code>为分界点, 逻辑被分为 3 个部分:<!-- --></p><div class="dumi-default-source-code"><button type="button" class="dumi-default-source-code-copy"><svg viewBox="64 64 896 896"><path d="M832 64H296c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h496v688c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8V96c0-17.7-14.3-32-32-32zM704 192H192c-17.7 0-32 14.3-32 32v530.7c0 8.5 3.4 16.6 9.4 22.6l173.3 173.3c2.2 2.2 4.7 4 7.4 5.5v1.9h4.2c3.5 1.3 7.2 2 11 2H704c17.7 0 32-14.3 32-32V224c0-17.7-14.3-32-32-32zM350 856.2 263.9 770H350v86.2zM664 888H414V746c0-22.1-17.9-40-40-40H232V264h432v624z"></path></svg></button><pre class="prism-code language-js"><div class=""><div class=""><span class="token comment">// ...省略无关代码</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token keyword module">export</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token plain"> renderWithHooks</span><span class="token operator">&lt;</span><span class="token maybe-class-name">Props</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token maybe-class-name">SecondArg</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token literal-property property">current</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">Fiber</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token literal-property property">workInProgress</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">Fiber</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token function-variable function maybe-class-name">Component</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token parameter literal-property property">p</span><span class="token parameter operator">:</span><span class="token parameter"> </span><span class="token parameter maybe-class-name">Props</span><span class="token parameter punctuation">,</span><span class="token parameter"> </span><span class="token parameter literal-property property">arg</span><span class="token parameter operator">:</span><span class="token parameter"> </span><span class="token parameter maybe-class-name">SecondArg</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> any</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token literal-property property">props</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">Props</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token literal-property property">secondArg</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">SecondArg</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token literal-property property">nextRenderLanes</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">Lanes</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token punctuation">)</span><span class="token operator">:</span><span class="token plain"> any </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token comment">// --------------- 1. 设置全局变量 -------------------</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  renderLanes </span><span class="token operator">=</span><span class="token plain"> nextRenderLanes</span><span class="token punctuation">;</span><span class="token plain"> </span><span class="token comment">// 当前渲染优先级</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  currentlyRenderingFiber </span><span class="token operator">=</span><span class="token plain"> workInProgress</span><span class="token punctuation">;</span><span class="token plain"> </span><span class="token comment">// 当前fiber节点, 也就是function组件对应的fiber节点</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">
</span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token comment">// 清除当前fiber的遗留状态</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  workInProgress</span><span class="token punctuation">.</span><span class="token property-access">memoizedState</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  workInProgress</span><span class="token punctuation">.</span><span class="token property-access">updateQueue</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  workInProgress</span><span class="token punctuation">.</span><span class="token property-access">lanes</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token maybe-class-name">NoLanes</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">
</span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token comment">// --------------- 2. 调用function,生成子级ReactElement对象 -------------------</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token comment">// 指定dispatcher, 区分mount和update</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token maybe-class-name">ReactCurrentDispatcher</span><span class="token punctuation">.</span><span class="token property-access">current</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    current </span><span class="token operator">===</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"> </span><span class="token operator">||</span><span class="token plain"> current</span><span class="token punctuation">.</span><span class="token property-access">memoizedState</span><span class="token plain"> </span><span class="token operator">===</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token operator">?</span><span class="token plain"> </span><span class="token maybe-class-name">HooksDispatcherOnMount</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">HooksDispatcherOnUpdate</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token comment">// 执行function函数, 其中进行分析Hooks的使用</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword">let</span><span class="token plain"> children </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function maybe-class-name">Component</span><span class="token punctuation">(</span><span class="token plain">props</span><span class="token punctuation">,</span><span class="token plain"> secondArg</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">
</span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token comment">// --------------- 3. 重置全局变量,并返回 -------------------</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token comment">// 执行function之后, 还原被修改的全局变量, 不影响下一次调用</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  renderLanes </span><span class="token operator">=</span><span class="token plain"> </span><span class="token maybe-class-name">NoLanes</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  currentlyRenderingFiber </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token keyword null nil">null</span><span class="token operator">:</span><span class="token plain"> any</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">
</span></div></div><div class=""><div class=""><span class="token plain">  currentHook </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  workInProgressHook </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  didScheduleRenderPhaseUpdate </span><span class="token operator">=</span><span class="token plain"> </span><span class="token boolean">false</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">
</span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword control-flow">return</span><span class="token plain"> children</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token punctuation">}</span></div></div></pre></div><ol><li>调用<!-- --><code>function</code>前: 设置全局变量, 标记<!-- --><code>渲染优先级</code>和当前<!-- --><code>fiber</code>, 清除当前<!-- --><code>fiber</code>的遗留状态.<!-- --></li><li>调用<!-- --><code>function</code>: 构造出<!-- --><code>Hooks</code>链表, 最后生成子级<!-- --><code>ReactElement</code>对象(<!-- --><code>children</code>).<!-- --></li><li>调用<!-- --><code>function</code>后: 重置全局变量, 返回<!-- --><code>children</code>.
<!-- --><ul><li>为了保证不同的<!-- --><code>function</code>节点在调用时<!-- --><code>renderWithHooks</code>互不影响, 所以退出时重置全局变量.<!-- --></li></ul></li></ol><h2 id="调用-function"><a aria-hidden="true" tabindex="-1" href="#调用-function"><span class="icon icon-link"></span></a>调用 function<!-- --></h2><h3 id="hooks-构造"><a aria-hidden="true" tabindex="-1" href="#hooks-构造"><span class="icon icon-link"></span></a>Hooks 构造<!-- --></h3><p>在<!-- --><code>function</code>中, 如果使用了<!-- --><code>Hook api</code>(如: <!-- --><code>useEffect</code>, <!-- --><code>useState</code>), 就会创建一个与之对应的<!-- --><code>Hook</code>对象, 接下来重点分析这个创建过程.<!-- --></p><p>有如下 demo:<!-- --><br/><a href="https://codesandbox.io/s/hook-summary-wb7zz?fontsize=14&amp;hidenavigation=1&amp;theme=dark"><img src="https://codesandbox.io/static/img/play-codesandbox.svg" alt="Edit hook-summary"/></a></p></div><div id="docs-main-hook-summary-demo-0" class="dumi-default-previewer"><div class="dumi-default-previewer-demo"><template id="P:3"></template></div><div class="dumi-default-previewer-meta"><div class="dumi-default-previewer-actions"><button class="dumi-default-previewer-action-btn" type="button" data-dumi-tooltip="在 CodeSandbox 中打开"><svg viewBox="64 64 896 896"><path d="m709.6 210 .4-.2h.2L512 96 313.9 209.8h-.2l.7.3L151.5 304v416L512 928l360.5-208V304l-162.9-94zM482.7 843.6 339.6 761V621.4L210 547.8V372.9l272.7 157.3v313.4zM238.2 321.5l134.7-77.8 138.9 79.7 139.1-79.9 135.2 78-273.9 158-274-158zM814 548.3l-128.8 73.1v139.1l-143.9 83V530.4L814 373.1v175.2z"></path></svg></button><button class="dumi-default-previewer-action-btn" type="button" data-dumi-tooltip="在 StackBlitz 中打开"><svg viewBox="64 64 896 896"><path d="M848 359.3H627.7L825.8 109c4.1-5.3.4-13-6.3-13H436c-2.8 0-5.5 1.5-6.9 4L170 547.5c-3.1 5.3.7 12 6.9 12h174.4l-89.4 357.6c-1.9 7.8 7.5 13.3 13.3 7.7L853.5 373c5.2-4.9 1.7-13.7-5.5-13.7zM378.2 732.5l60.3-241H281.1l189.6-327.4h224.6L487 427.4h211L378.2 732.5z"></path></svg></button><a target="_blank" rel="noreferrer" href="/~demos/docs-main-hook-summary-demo-0" class="dumi-default-previewer-action-btn" data-dumi-tooltip="在独立页面中打开"><svg viewBox="0 0 1024 1024"><path d="M853.333 469.333A42.667 42.667 0 0 0 810.667 512v256A42.667 42.667 0 0 1 768 810.667H256A42.667 42.667 0 0 1 213.333 768V256A42.667 42.667 0 0 1 256 213.333h256A42.667 42.667 0 0 0 512 128H256a128 128 0 0 0-128 128v512a128 128 0 0 0 128 128h512a128 128 0 0 0 128-128V512a42.667 42.667 0 0 0-42.667-42.667z"></path><path d="M682.667 213.333h67.413L481.707 481.28a42.667 42.667 0 0 0 0 60.587 42.667 42.667 0 0 0 60.586 0L810.667 273.92v67.413A42.667 42.667 0 0 0 853.333 384 42.667 42.667 0 0 0 896 341.333V170.667A42.667 42.667 0 0 0 853.333 128H682.667a42.667 42.667 0 0 0 0 85.333z"></path></svg></a><button class="dumi-default-previewer-action-btn" type="button" data-dumi-tooltip="展开代码"><svg viewBox="0 0 200 117"><path d="M59.688 2.578c-3.438-3.437-8.438-3.437-11.563 0L3.75 48.516c-5 5.937-5 14.062 0 19.062l44.063 45.938c1.562 1.562 4.062 2.5 5.937 2.5s4.063-.938 5.938-2.5c3.437-3.438 3.437-8.438 0-11.563l-42.5-43.437 42.5-44.063c3.437-3.437 3.437-8.437 0-11.875Zm135.937 45.938L151.25 2.578c-3.438-3.437-8.438-3.437-11.563 0-3.125 3.438-3.437 8.438 0 11.563l42.5 44.375-42.5 44.062c-3.437 3.438-3.437 8.438 0 11.563 1.563 1.562 3.438 2.5 5.938 2.5 2.5 0 4.063-.938 5.938-2.5l44.062-45.938c5.625-5.625 5.625-13.75 0-19.687Zm-75.938-45c-4.062-1.563-9.062.937-10.937 5l-34.063 95c-1.562 4.062.938 9.062 5 10.937.938 0 1.563.938 2.5.938 3.438 0 6.563-2.5 7.5-5.938l35-95.937c1.563-4.063-.937-9.063-5-10Z"></path></svg></button></div></div></div><div class="markdown"><p>在<!-- --><code>function</code>组件中, 同时使用了<!-- --><code>状态Hook</code>和<!-- --><code>副作用Hook</code>.<!-- --></p><p>初次渲染时, 逻辑执行到<!-- --><code>performUnitOfWork-&gt;beginWork-&gt;updateFunctionComponent-&gt;renderWithHooks</code>前, 内存结构如下(本节重点是<!-- --><code>Hook</code>, 有关<!-- --><code>fiber树构造</code>过程可回顾前文):<!-- --></p><p><img alt="" src="/static/mount-before-renderwithhooks.8aa55c5e.png"/></p><p>当执行<!-- --><code>renderWithHooks</code>时, 开始调用<!-- --><code>function</code>. 本例中, 在<!-- --><code>function</code>内部, 共使用了 4 次<!-- --><code>Hook api</code>, 依次调用<!-- --><code>useState, useEffect, useState, useEffect</code>.<!-- --></p><p>而<!-- --><code>useState, useEffect</code>在<!-- --><code>fiber</code>初次构造时分别对应<!-- --><a href="https://github.com/facebook/react/blob/v17.0.2/packages/react-reconciler/src/ReactFiberHooks.old.js#L1113-L1136">mountState</a>和<!-- --><a href="https://github.com/facebook/react/blob/v17.0.2/packages/react-reconciler/src/ReactFiberHooks.old.js#L1193-L1248">mountEffect-&gt;mountEffectImpl</a></p><div class="dumi-default-source-code"><button type="button" class="dumi-default-source-code-copy"><svg viewBox="64 64 896 896"><path d="M832 64H296c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h496v688c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8V96c0-17.7-14.3-32-32-32zM704 192H192c-17.7 0-32 14.3-32 32v530.7c0 8.5 3.4 16.6 9.4 22.6l173.3 173.3c2.2 2.2 4.7 4 7.4 5.5v1.9h4.2c3.5 1.3 7.2 2 11 2H704c17.7 0 32-14.3 32-32V224c0-17.7-14.3-32-32-32zM350 856.2 263.9 770H350v86.2zM664 888H414V746c0-22.1-17.9-40-40-40H232V264h432v624z"></path></svg></button><pre class="prism-code language-js"><div class=""><div class=""><span class="token keyword">function</span><span class="token plain"> mountState</span><span class="token operator">&lt;</span><span class="token constant">S</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token literal-property property">initialState</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token constant">S</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> </span><span class="token constant">S</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token punctuation">)</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token constant">S</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token maybe-class-name">Dispatch</span><span class="token operator">&lt;</span><span class="token maybe-class-name">BasicStateAction</span><span class="token operator">&lt;</span><span class="token constant">S</span><span class="token operator">&gt;&gt;</span><span class="token punctuation">]</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> hook </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">mountWorkInProgressHook</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token comment">// ...省略部分本节不讨论</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword control-flow">return</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token plain">hook</span><span class="token punctuation">.</span><span class="token property-access">memoizedState</span><span class="token punctuation">,</span><span class="token plain"> dispatch</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">
</span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">mountEffectImpl</span><span class="token punctuation">(</span><span class="token parameter">fiberFlags</span><span class="token parameter punctuation">,</span><span class="token parameter"> hookFlags</span><span class="token parameter punctuation">,</span><span class="token parameter"> create</span><span class="token parameter punctuation">,</span><span class="token parameter"> deps</span><span class="token punctuation">)</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword">void</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> hook </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">mountWorkInProgressHook</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token comment">// ...省略部分本节不讨论</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token punctuation">}</span></div></div></pre></div><p>无论<!-- --><code>useState, useEffect</code>, 内部都通过<!-- --><code>mountWorkInProgressHook</code>创建一个 hook.<!-- --></p><h3 id="链表存储"><a aria-hidden="true" tabindex="-1" href="#链表存储"><span class="icon icon-link"></span></a>链表存储<!-- --></h3><p>而<!-- --><a href="https://github.com/facebook/react/blob/v17.0.2/packages/react-reconciler/src/ReactFiberHooks.old.js#L531-L550">mountWorkInProgressHook</a>非常简单:<!-- --></p><div class="dumi-default-source-code"><button type="button" class="dumi-default-source-code-copy"><svg viewBox="64 64 896 896"><path d="M832 64H296c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h496v688c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8V96c0-17.7-14.3-32-32-32zM704 192H192c-17.7 0-32 14.3-32 32v530.7c0 8.5 3.4 16.6 9.4 22.6l173.3 173.3c2.2 2.2 4.7 4 7.4 5.5v1.9h4.2c3.5 1.3 7.2 2 11 2H704c17.7 0 32-14.3 32-32V224c0-17.7-14.3-32-32-32zM350 856.2 263.9 770H350v86.2zM664 888H414V746c0-22.1-17.9-40-40-40H232V264h432v624z"></path></svg></button><pre class="prism-code language-js"><div class=""><div class=""><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">mountWorkInProgressHook</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">Hook</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> </span><span class="token literal-property property">hook</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">Hook</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token literal-property property">memoizedState</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">
</span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token literal-property property">baseState</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token literal-property property">baseQueue</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token literal-property property">queue</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">
</span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token literal-property property">next</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">
</span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">workInProgressHook </span><span class="token operator">===</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token comment">// 链表中首个hook</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    currentlyRenderingFiber</span><span class="token punctuation">.</span><span class="token property-access">memoizedState</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> workInProgressHook </span><span class="token operator">=</span><span class="token plain"> hook</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword control-flow">else</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token comment">// 将hook添加到链表末尾</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    workInProgressHook </span><span class="token operator">=</span><span class="token plain"> workInProgressHook</span><span class="token punctuation">.</span><span class="token property-access">next</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> hook</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword control-flow">return</span><span class="token plain"> workInProgressHook</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token punctuation">}</span></div></div></pre></div><p>逻辑是创建<!-- --><code>Hook</code>并挂载到<!-- --><code>fiber.memoizedState</code>上, 多个<!-- --><code>Hook</code>以链表结构保存.<!-- --></p><p>本示例中, <!-- --><code>function</code>调用之后则会创建 4 个<!-- --><code>hook</code>, 这时的内存结构如下:<!-- --></p><p><img alt="" src="/static/mount-after-renderwithhooks.fb7b72a5.png"/></p><p>可以看到: 无论<!-- --><code>状态Hook</code>或<!-- --><code>副作用Hook</code>都按照调用顺序存储在<!-- --><code>fiber.memoizedState</code>链表中.<!-- --></p><p><img alt="" src="/static/mount-fiber-memoizedstate.60fd49d4.png"/></p><h3 id="顺序克隆"><a aria-hidden="true" tabindex="-1" href="#顺序克隆"><span class="icon icon-link"></span></a>顺序克隆<!-- --></h3><p><code>fiber树构造(对比更新)</code>阶段, 执行<!-- --><code>updateFunctionComponent-&gt;renderWithHooks</code>时再次调用<!-- --><code>function</code>, <!-- --><code>调用function前</code>的内存结构如下:<!-- --></p><p><img alt="" src="/static/update-before-renderwithhooks.4cb2417e.png"/></p><p>注意: 在<!-- --><code>renderWithHooks</code>函数中已经设置了<!-- --><code>workInProgress.memoizedState = null</code>, 等待调用<!-- --><code>function</code>时重新设置.<!-- --></p><p>接下来调用<!-- --><code>function</code>, 同样依次调用<!-- --><code>useState, useEffect, useState, useEffect</code>. 而<!-- --><code>useState, useEffect</code>在<!-- --><code>fiber</code>对比更新时分别对应<!-- --><a href="https://github.com/facebook/react/blob/v17.0.2/packages/react-reconciler/src/ReactFiberHooks.old.js#L1138-L1142">updateState-&gt;updateReducer</a>和<!-- --><a href="https://github.com/facebook/react/blob/v17.0.2/packages/react-reconciler/src/ReactFiberHooks.old.js#L1205-L1266">updateEffect-&gt;updateEffectImpl</a></p><div class="dumi-default-source-code"><button type="button" class="dumi-default-source-code-copy"><svg viewBox="64 64 896 896"><path d="M832 64H296c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h496v688c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8V96c0-17.7-14.3-32-32-32zM704 192H192c-17.7 0-32 14.3-32 32v530.7c0 8.5 3.4 16.6 9.4 22.6l173.3 173.3c2.2 2.2 4.7 4 7.4 5.5v1.9h4.2c3.5 1.3 7.2 2 11 2H704c17.7 0 32-14.3 32-32V224c0-17.7-14.3-32-32-32zM350 856.2 263.9 770H350v86.2zM664 888H414V746c0-22.1-17.9-40-40-40H232V264h432v624z"></path></svg></button><pre class="prism-code language-js"><div class=""><div class=""><span class="token comment">// ----- 状态Hook --------</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token keyword">function</span><span class="token plain"> updateReducer</span><span class="token operator">&lt;</span><span class="token constant">S</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token constant">I</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token constant">A</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token function-variable function">reducer</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token parameter constant">S</span><span class="token parameter punctuation">,</span><span class="token parameter"> </span><span class="token parameter constant">A</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token constant">S</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token literal-property property">initialArg</span><span class="token operator">:</span><span class="token plain"> </span><span class="token constant">I</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  init</span><span class="token operator">?</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token parameter constant">I</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token constant">S</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token punctuation">)</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token constant">S</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token maybe-class-name">Dispatch</span><span class="token operator">&lt;</span><span class="token constant">A</span><span class="token operator">&gt;</span><span class="token punctuation">]</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> hook </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">updateWorkInProgressHook</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token comment">// ...省略部分本节不讨论</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">
</span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token comment">// ----- 副作用Hook --------</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">updateEffectImpl</span><span class="token punctuation">(</span><span class="token parameter">fiberFlags</span><span class="token parameter punctuation">,</span><span class="token parameter"> hookFlags</span><span class="token parameter punctuation">,</span><span class="token parameter"> create</span><span class="token parameter punctuation">,</span><span class="token parameter"> deps</span><span class="token punctuation">)</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword">void</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> hook </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">updateWorkInProgressHook</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token comment">// ...省略部分本节不讨论</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token punctuation">}</span></div></div></pre></div><p>无论<!-- --><code>useState, useEffect</code>, 内部调用<!-- --><code>updateWorkInProgressHook</code>获取一个 hook.<!-- --></p><div class="dumi-default-source-code"><button type="button" class="dumi-default-source-code-copy"><svg viewBox="64 64 896 896"><path d="M832 64H296c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h496v688c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8V96c0-17.7-14.3-32-32-32zM704 192H192c-17.7 0-32 14.3-32 32v530.7c0 8.5 3.4 16.6 9.4 22.6l173.3 173.3c2.2 2.2 4.7 4 7.4 5.5v1.9h4.2c3.5 1.3 7.2 2 11 2H704c17.7 0 32-14.3 32-32V224c0-17.7-14.3-32-32-32zM350 856.2 263.9 770H350v86.2zM664 888H414V746c0-22.1-17.9-40-40-40H232V264h432v624z"></path></svg></button><pre class="prism-code language-js"><div class=""><div class=""><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">updateWorkInProgressHook</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">Hook</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token comment">// 1. 移动currentHook指针</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword">let</span><span class="token plain"> </span><span class="token literal-property property">nextCurrentHook</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> </span><span class="token maybe-class-name">Hook</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">currentHook </span><span class="token operator">===</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token keyword">const</span><span class="token plain"> current </span><span class="token operator">=</span><span class="token plain"> currentlyRenderingFiber</span><span class="token punctuation">.</span><span class="token property-access">alternate</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">current </span><span class="token operator">!==</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      nextCurrentHook </span><span class="token operator">=</span><span class="token plain"> current</span><span class="token punctuation">.</span><span class="token property-access">memoizedState</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword control-flow">else</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      nextCurrentHook </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword control-flow">else</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    nextCurrentHook </span><span class="token operator">=</span><span class="token plain"> currentHook</span><span class="token punctuation">.</span><span class="token property-access">next</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">
</span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token comment">// 2. 移动workInProgressHook指针</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword">let</span><span class="token plain"> </span><span class="token literal-property property">nextWorkInProgressHook</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> </span><span class="token maybe-class-name">Hook</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">workInProgressHook </span><span class="token operator">===</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    nextWorkInProgressHook </span><span class="token operator">=</span><span class="token plain"> currentlyRenderingFiber</span><span class="token punctuation">.</span><span class="token property-access">memoizedState</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword control-flow">else</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    nextWorkInProgressHook </span><span class="token operator">=</span><span class="token plain"> workInProgressHook</span><span class="token punctuation">.</span><span class="token property-access">next</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">
</span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">nextWorkInProgressHook </span><span class="token operator">!==</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token comment">// 渲染时更新: 本节不讨论</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword control-flow">else</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    currentHook </span><span class="token operator">=</span><span class="token plain"> nextCurrentHook</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token comment">// 3. 克隆currentHook作为新的workInProgressHook.</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token comment">// 随后逻辑与mountWorkInProgressHook一致</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token keyword">const</span><span class="token plain"> </span><span class="token literal-property property">newHook</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">Hook</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token literal-property property">memoizedState</span><span class="token operator">:</span><span class="token plain"> currentHook</span><span class="token punctuation">.</span><span class="token property-access">memoizedState</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">
</span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token literal-property property">baseState</span><span class="token operator">:</span><span class="token plain"> currentHook</span><span class="token punctuation">.</span><span class="token property-access">baseState</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token literal-property property">baseQueue</span><span class="token operator">:</span><span class="token plain"> currentHook</span><span class="token punctuation">.</span><span class="token property-access">baseQueue</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token literal-property property">queue</span><span class="token operator">:</span><span class="token plain"> currentHook</span><span class="token punctuation">.</span><span class="token property-access">queue</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">
</span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token literal-property property">next</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token comment">// 注意next指针是null</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">workInProgressHook </span><span class="token operator">===</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      currentlyRenderingFiber</span><span class="token punctuation">.</span><span class="token property-access">memoizedState</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> workInProgressHook </span><span class="token operator">=</span><span class="token plain"> newHook</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword control-flow">else</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      workInProgressHook </span><span class="token operator">=</span><span class="token plain"> workInProgressHook</span><span class="token punctuation">.</span><span class="token property-access">next</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> newHook</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword control-flow">return</span><span class="token plain"> workInProgressHook</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token punctuation">}</span></div></div></pre></div><p><code>updateWorkInProgressHook</code>函数逻辑简单: 目的是为了让<!-- --><code>currentHook</code>和<!-- --><code>workInProgressHook</code>两个指针同时向后移动.<!-- --></p><ol><li>由于<!-- --><code>renderWithHooks函数</code>设置了<!-- --><code>workInProgress.memoizedState=null</code>, 所以<!-- --><code>workInProgressHook</code>初始值必然为<!-- --><code>null</code>, 只能从<!-- --><code>currentHook</code>克隆.<!-- --></li><li>而从<!-- --><code>currentHook</code>克隆而来的<!-- --><code>newHook.next=null</code>, 进而导致<!-- --><code>workInProgressHook</code>链表需要完全重建.<!-- --></li></ol><p>所以<!-- --><code>function</code>执行完成之后, 有关<!-- --><code>Hook</code>的内存结构如下:<!-- --></p><p><img alt="" src="/static/update-after-renderwithhooks.e3518dec.png"/></p><p>可以看到:</p><ol><li>以双缓冲技术为基础, 将<!-- --><code>current.memoizedState</code>按照顺序克隆到了<!-- --><code>workInProgress.memoizedState</code>中.<!-- --></li><li><code>Hook</code>经过了一次克隆, 内部的属性(<!-- --><code>hook.memoizedState</code>等)都没有变动, 所以其状态并不会丢失.<!-- --></li></ol><p><img alt="" src="/static/update-fiber-memoizedstate.f5000c8b.png"/></p><h2 id="总结"><a aria-hidden="true" tabindex="-1" href="#总结"><span class="icon icon-link"></span></a>总结<!-- --></h2><p>本节首先引入了官方文档上对于<!-- --><code>Hook</code>的解释, 了解<!-- --><code>Hook</code>的由来, 以及<!-- --><code>Hook</code>相较于<!-- --><code>class</code>的优势. 然后从<!-- --><code>fiber</code>视角分析了<!-- --><code>fiber</code>与<!-- --><code>hook</code>的内在关系, 通过<!-- --><code>renderWithHooks</code>函数, 把<!-- --><code>Hook</code>链表挂载到了<!-- --><code>fiber.memoizedState</code>之上. 利用<!-- --><code>fiber树</code>内部的双缓冲技术, 实现了<!-- --><code>Hook</code>从<!-- --><code>current</code>到<!-- --><code>workInProgress</code>转移, 进而实现了<!-- --><code>Hook</code>状态的持久化.<!-- --></p></div></div><div hidden id="S:3"><button>1<!-- --></button><button>2<!-- --></button></div><script>function $RS(a,b){a=document.getElementById(a);b=document.getElementById(b);for(a.parentNode.removeChild(a);a.firstChild;)b.parentNode.insertBefore(a.firstChild,b);b.parentNode.removeChild(b)};$RS("S:3","P:3")</script><script>$RC("B:2","S:2")</script>