<!DOCTYPE html><html><head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<meta name="keywords" content="react, react原理, 图解react, react fiber原理, react hook原理, react 合成事件, react 基本包结构">
<meta name="description" content="图解React原理系列, 以react核心包结构和运行机制为主线索进行展开. 包括react 基本包结构, react 工作循环, react 启动模式, react fiber原理, react hook原理, react 合成事件等核心内容">
<link rel="shortcut icon" href="/km@2x.png">
<link rel="stylesheet" href="/umi.eb36fa83.css">
<title data-rh="true">fiber 树构造(初次创建)</title>
<meta data-rh="true" property="og:title" content="fiber 树构造(初次创建)"/><meta data-rh="true" name="description" content="本节的内容完全建立在前文fiber 树构造(基础准备)中介绍的基础知识之上, 其中总结了fiber 树构造的 2 种情况:"/><meta data-rh="true" property="og:description" content="本节的内容完全建立在前文fiber 树构造(基础准备)中介绍的基础知识之上, 其中总结了fiber 树构造的 2 种情况:"/>
</head>
<body>
<noscript><b>Enable JavaScript to run this app.</b></noscript><div id="root"><!--$?--><template id="B:0"></template><div></div><!--/$--></div><script>window.__UMI_LOADER_DATA__ = {}</script>
<script src="/umi.c14ba5aa.js"></script>

</body></html><div hidden id="S:0"><!--$?--><template id="B:1"></template><div></div><!--/$--></div><script>function $RC(a,b){a=document.getElementById(a);b=document.getElementById(b);b.parentNode.removeChild(b);if(a){a=a.previousSibling;var f=a.parentNode,c=a.nextSibling,e=0;do{if(c&&8===c.nodeType){var d=c.data;if("/$"===d)if(0===e)break;else e--;else"$"!==d&&"$?"!==d&&"$!"!==d||e++}d=c.nextSibling;f.removeChild(c);c=d}while(c);for(;b.firstChild;)f.insertBefore(b.firstChild,c);a.data="$";a._reactRetry&&a._reactRetry()}};$RC("B:0","S:0")</script><div hidden id="S:1"><div class="dumi-default-doc-layout"><div class="dumi-default-header"><div class="dumi-default-header-content"><section class="dumi-default-header-left"><a class="dumi-default-logo" href="/"><img src="/logo.png" alt="图解React"/>图解React<!-- --></a></section><section class="dumi-default-header-right"><ul class="dumi-default-navbar"><li><a class="active" href="/main/macro-structure">原理解析</a></li><li><a href="/algorithm/diff">高频算法</a></li><li><a href="/interview/01-setstate">面试题</a></li></ul><div class="dumi-default-header-right-aside"><div class="dumi-default-search-bar"><svg viewBox="64 64 896 896" class="dumi-default-search-bar-svg"><path d="M909.6 854.5 649.9 594.8C690.2 542.7 712 479 712 412c0-80.2-31.3-155.4-87.9-212.1-56.6-56.7-132-87.9-212.1-87.9s-155.5 31.3-212.1 87.9C143.2 256.5 112 331.8 112 412c0 80.1 31.3 155.5 87.9 212.1C256.5 680.8 331.8 712 412 712c67 0 130.6-21.8 182.7-62l259.7 259.6a8.2 8.2 0 0 0 11.6 0l43.6-43.5a8.2 8.2 0 0 0 0-11.6zM570.4 570.4C528 612.7 471.8 636 412 636s-116-23.3-158.4-65.6C211.3 528 188 471.8 188 412s23.3-116.1 65.6-158.4C296 211.3 352.2 188 412 188s116.1 23.2 158.4 65.6S636 352.2 636 412s-23.3 116.1-65.6 158.4z"></path></svg><input class="dumi-default-search-bar-input" placeholder="输入关键字搜索..."/><span class="dumi-default-search-shortcut">⌘<!-- --> K<!-- --></span></div><span class="dumi-default-color-switch" data-dumi-tooltip="亮色模式" data-dumi-tooltip-bottom="true"><svg viewBox="0 0 16 16"><path d="M8 13a1 1 0 0 1 1 1v1a1 1 0 1 1-2 0v-1a1 1 0 0 1 1-1ZM8 3a1 1 0 0 1-1-1V1a1 1 0 1 1 2 0v1a1 1 0 0 1-1 1Zm7 4a1 1 0 1 1 0 2h-1a1 1 0 1 1 0-2h1ZM3 8a1 1 0 0 1-1 1H1a1 1 0 1 1 0-2h1a1 1 0 0 1 1 1Zm9.95 3.536.707.707a1 1 0 0 1-1.414 1.414l-.707-.707a1 1 0 0 1 1.414-1.414Zm-9.9-7.072-.707-.707a1 1 0 0 1 1.414-1.414l.707.707A1 1 0 0 1 3.05 4.464Zm9.9 0a1 1 0 0 1-1.414-1.414l.707-.707a1 1 0 0 1 1.414 1.414l-.707.707Zm-9.9 7.072a1 1 0 0 1 1.414 1.414l-.707.707a1 1 0 0 1-1.414-1.414l.707-.707ZM8 4a4 4 0 1 0 0 8 4 4 0 0 0 0-8Zm0 6.5a2.5 2.5 0 1 1 0-5 2.5 2.5 0 0 1 0 5Z"></path></svg><select><option value="light" selected="">亮色模式<!-- --></option><option value="dark">暗色模式<!-- --></option><option value="auto">跟随系统<!-- --></option></select></span><a class="dumi-default-icon" data-dumi-tooltip="GitHub" data-dumi-tooltip-bottom="true" target="_blank" href="https://github.com/7kms/react-illustration-series" rel="noreferrer"><svg viewBox="64 64 896 896"><path d="M511.6 76.3C264.3 76.2 64 276.4 64 523.5 64 718.9 189.3 885 363.8 946c23.5 5.9 19.9-10.8 19.9-22.2v-77.5c-135.7 15.9-141.2-73.9-150.3-88.9C215 726 171.5 718 184.5 703c30.9-15.9 62.4 4 98.9 57.9 26.4 39.1 77.9 32.5 104 26 5.7-23.5 17.9-44.5 34.7-60.8-140.6-25.2-199.2-111-199.2-213 0-49.5 16.3-95 48.3-131.7-20.4-60.5 1.9-112.3 4.9-120 58.1-5.2 118.5 41.6 123.2 45.3 33-8.9 70.7-13.6 112.9-13.6 42.4 0 80.2 4.9 113.5 13.9 11.3-8.6 67.3-48.8 121.3-43.9 2.9 7.7 24.7 58.3 5.5 118 32.4 36.8 48.9 82.7 48.9 132.3 0 102.2-59 188.1-200 212.9a127.5 127.5 0 0 1 38.1 91v112.5c.8 9 0 17.9 15 17.9 177.1-59.7 304.6-227 304.6-424.1 0-247.2-200.4-447.3-447.5-447.3z"></path></svg></a></div></section><button type="button" class="dumi-default-header-menu-btn"><svg viewBox="64 64 896 896"><path d="M904 160H120c-4.4 0-8 3.6-8 8v64c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-64c0-4.4-3.6-8-8-8zm0 624H120c-4.4 0-8 3.6-8 8v64c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-64c0-4.4-3.6-8-8-8zm0-312H120c-4.4 0-8 3.6-8 8v64c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-64c0-4.4-3.6-8-8-8z"></path></svg></button></div></div><div class="dumi-default-doc-layout-mobile-bar"><button type="button" class="dumi-default-sidebar-btn"><svg viewBox="64 64 896 896"><path d="M120 230h496c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm0 424h496c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm784 140H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0-424H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8z"></path></svg>侧边菜单<!-- --></button></div><main><div class="dumi-default-sidebar"><dl class="dumi-default-sidebar-group"><dt>基本概念</dt><dd><a title="宏观包结构" class="" href="/main/macro-structure">宏观包结构</a></dd><dd><a title="两大工作循环" class="" href="/main/workloop">两大工作循环</a></dd><dd><a title="高频对象" class="" href="/main/object-structure">高频对象</a></dd></dl><dl class="dumi-default-sidebar-group"><dt>运行核心</dt><dd><a title="启动过程" class="" href="/main/bootstrap">启动过程</a></dd><dd><a title="reconciler 运作流程" class="" href="/main/reconciler-workflow">reconciler 运作流程</a></dd><dd><a title="优先级管理" class="" href="/main/priority">优先级管理</a></dd><dd><a title="调度原理" class="" href="/main/scheduler">调度原理</a></dd><dd><a title="fiber 树构造(基础准备)" class="" href="/main/fibertree-prepare">fiber 树构造(基础准备)</a></dd><dd><a title="fiber 树构造(初次创建)" aria-current="page" class="active" href="/main/fibertree-create">fiber 树构造(初次创建)</a></dd><dd><a title="fiber 树构造(对比更新)" class="" href="/main/fibertree-update">fiber 树构造(对比更新)</a></dd><dd><a title="fiber 树渲染" class="" href="/main/fibertree-commit">fiber 树渲染</a></dd></dl><dl class="dumi-default-sidebar-group"><dt>状态管理</dt><dd><a title="状态与副作用" class="" href="/main/state-effects">状态与副作用</a></dd><dd><a title="Hook 原理(概览)" class="" href="/main/hook-summary">Hook 原理(概览)</a></dd><dd><a title="Hook 原理(状态Hook)" class="" href="/main/hook-state">Hook 原理(状态Hook)</a></dd><dd><a title="Hook 原理(副作用Hook)" class="" href="/main/hook-effect">Hook 原理(副作用Hook)</a></dd><dd><a title="context 原理" class="" href="/main/context">context 原理</a></dd></dl><dl class="dumi-default-sidebar-group"><dt>交互</dt><dd><a title="合成事件" class="" href="/main/synthetic-event">合成事件</a></dd></dl></div><div class="dumi-default-content"><!--$?--><template id="B:2"></template><div></div><!--/$--><div class="dumi-default-footer">Copyright © 2023 | Powered by <a href="https://d.umijs.org" target="_blank" rel="noreferrer">dumi</a></div></div></main></div></div><script>$RC("B:1","S:1")</script><div hidden id="S:2"><div class="markdown"><h1 id="fiber-树构造初次创建"><a aria-hidden="true" tabindex="-1" href="#fiber-树构造初次创建"><span class="icon icon-link"></span></a>fiber 树构造(初次创建)<!-- --></h1><p>本节的内容完全建立在前文<!-- --><a href="/main/fibertree-prepare">fiber 树构造(基础准备)</a>中介绍的基础知识之上, 其中总结了<!-- --><code>fiber 树构造</code>的 2 种情况:<!-- --></p><ol><li>初次创建: 在<!-- --><code>React</code>应用首次启动时, 界面还没有渲染, 此时并不会进入对比过程, 相当于直接构造一棵全新的树.<!-- --></li><li>对比更新: <!-- --><code>React</code>应用启动后, 界面已经渲染. 如果再次发生更新, 创建<!-- --><code>新fiber</code>之前需要和<!-- --><code>旧fiber</code>进行对比. 最后构造的 fiber 树有可能是全新的, 也可能是部分更新的.<!-- --></li></ol><p>本节只讨论<!-- --><code>初次创建</code>这种情况, 为了控制篇幅(本节直击核心源码, 不再介绍基础知识, 可参照<!-- --><a href="/main/fibertree-prepare">fiber 树构造(基础准备)</a>)并突出<!-- --><code>fiber 树构造</code>过程, 后文会在<!-- --><code>Legacy</code>模式下进行分析(因为只讨论<!-- --><code>fiber树构造</code>原理, <!-- --><code>Concurrent</code>模式与<!-- --><code>Legacy</code>没有区别).<!-- --></p><p>本节示例代码如下(<!-- --><a href="https://codesandbox.io/s/busy-jang-b26hy?file=/src/App.js">codesandbox 地址</a>):<!-- --></p><div class="dumi-default-source-code"><button type="button" class="dumi-default-source-code-copy"><svg viewBox="64 64 896 896"><path d="M832 64H296c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h496v688c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8V96c0-17.7-14.3-32-32-32zM704 192H192c-17.7 0-32 14.3-32 32v530.7c0 8.5 3.4 16.6 9.4 22.6l173.3 173.3c2.2 2.2 4.7 4 7.4 5.5v1.9h4.2c3.5 1.3 7.2 2 11 2H704c17.7 0 32-14.3 32-32V224c0-17.7-14.3-32-32-32zM350 856.2 263.9 770H350v86.2zM664 888H414V746c0-22.1-17.9-40-40-40H232V264h432v624z"></path></svg></button><pre class="prism-code language-js"><div class=""><div class=""><span class="token keyword">class</span><span class="token plain"> </span><span class="token class-name">App</span><span class="token plain"> </span><span class="token keyword">extends</span><span class="token plain"> </span><span class="token class-name">React</span><span class="token class-name punctuation">.</span><span class="token class-name">Component</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token function">componentDidMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token template-string template-punctuation string">`</span><span class="token template-string string">App Mount</span><span class="token template-string template-punctuation string">`</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token template-string template-punctuation string">`</span><span class="token template-string string">App 组件对应的fiber节点: </span><span class="token template-string template-punctuation string">`</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">_reactInternals</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token keyword control-flow">return</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token operator">&lt;</span><span class="token plain">div className</span><span class="token operator">=</span><span class="token string">&quot;app&quot;</span><span class="token operator">&gt;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">        </span><span class="token operator">&lt;</span><span class="token plain">header</span><span class="token operator">&gt;</span><span class="token plain">header</span><span class="token operator">&lt;</span><span class="token operator">/</span><span class="token plain">header</span><span class="token operator">&gt;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">        </span><span class="token operator">&lt;</span><span class="token maybe-class-name">Content</span><span class="token plain"> </span><span class="token operator">/</span><span class="token operator">&gt;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token operator">&lt;</span><span class="token operator">/</span><span class="token plain">div</span><span class="token operator">&gt;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">
</span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token keyword">class</span><span class="token plain"> </span><span class="token class-name">Content</span><span class="token plain"> </span><span class="token keyword">extends</span><span class="token plain"> </span><span class="token class-name">React</span><span class="token class-name punctuation">.</span><span class="token class-name">Component</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token function">componentDidMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token template-string template-punctuation string">`</span><span class="token template-string string">Content Mount</span><span class="token template-string template-punctuation string">`</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token template-string template-punctuation string">`</span><span class="token template-string string">Content 组件对应的fiber节点: </span><span class="token template-string template-punctuation string">`</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">_reactInternals</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token keyword control-flow">return</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token operator">&lt;</span><span class="token maybe-class-name">React</span><span class="token punctuation">.</span><span class="token property-access maybe-class-name">Fragment</span><span class="token operator">&gt;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">        </span><span class="token operator">&lt;</span><span class="token plain">p</span><span class="token operator">&gt;</span><span class="token number">1</span><span class="token operator">&lt;</span><span class="token operator">/</span><span class="token plain">p</span><span class="token operator">&gt;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">        </span><span class="token operator">&lt;</span><span class="token plain">p</span><span class="token operator">&gt;</span><span class="token number">2</span><span class="token operator">&lt;</span><span class="token operator">/</span><span class="token plain">p</span><span class="token operator">&gt;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token operator">&lt;</span><span class="token operator">/</span><span class="token maybe-class-name">React</span><span class="token punctuation">.</span><span class="token property-access maybe-class-name">Fragment</span><span class="token operator">&gt;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token keyword module">export</span><span class="token plain"> </span><span class="token keyword module">default</span><span class="token plain"> </span><span class="token maybe-class-name">App</span><span class="token punctuation">;</span></div></div></pre></div><h2 id="启动阶段"><a aria-hidden="true" tabindex="-1" href="#启动阶段"><span class="icon icon-link"></span></a>启动阶段<!-- --></h2><p>在前文<!-- --><a href="/main/bootstrap">React 应用的启动过程</a>中分析了 3 种启动模式的差异, 在进入<!-- --><code>react-reconciler</code>包之前(调用<!-- --><code>updateContainer</code>之前), 内存状态图如下:<!-- --></p><p><img alt="" src="/static/process-legacy.99cd6b8d.png"/></p><p>根据这个结构, 可以在控制台中打出当前页面对应的<!-- --><code>fiber</code>树(用于观察其结构):<!-- --></p><div class="dumi-default-source-code"><button type="button" class="dumi-default-source-code-copy"><svg viewBox="64 64 896 896"><path d="M832 64H296c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h496v688c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8V96c0-17.7-14.3-32-32-32zM704 192H192c-17.7 0-32 14.3-32 32v530.7c0 8.5 3.4 16.6 9.4 22.6l173.3 173.3c2.2 2.2 4.7 4 7.4 5.5v1.9h4.2c3.5 1.3 7.2 2 11 2H704c17.7 0 32-14.3 32-32V224c0-17.7-14.3-32-32-32zM350 856.2 263.9 770H350v86.2zM664 888H414V746c0-22.1-17.9-40-40-40H232V264h432v624z"></path></svg></button><pre class="prism-code language-js"><div class=""><div class=""><span class="token dom variable">document</span><span class="token punctuation">.</span><span class="token method function property-access">getElementById</span><span class="token punctuation">(</span><span class="token string">&#x27;root&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token property-access">_reactRootContainer</span><span class="token punctuation">.</span><span class="token property-access">_internalRoot</span><span class="token punctuation">.</span><span class="token property-access">current</span><span class="token punctuation">;</span></div></div></pre></div><p>然后进入<!-- --><code>react-reconciler</code>包调用<!-- --><a href="https://github.com/facebook/react/blob/v17.0.2/packages/react-reconciler/src/ReactFiberReconciler.old.js#L250-L321">updateContainer 函数</a>:<!-- --></p><div class="dumi-default-source-code"><button type="button" class="dumi-default-source-code-copy"><svg viewBox="64 64 896 896"><path d="M832 64H296c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h496v688c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8V96c0-17.7-14.3-32-32-32zM704 192H192c-17.7 0-32 14.3-32 32v530.7c0 8.5 3.4 16.6 9.4 22.6l173.3 173.3c2.2 2.2 4.7 4 7.4 5.5v1.9h4.2c3.5 1.3 7.2 2 11 2H704c17.7 0 32-14.3 32-32V224c0-17.7-14.3-32-32-32zM350 856.2 263.9 770H350v86.2zM664 888H414V746c0-22.1-17.9-40-40-40H232V264h432v624z"></path></svg></button><pre class="prism-code language-js"><div class=""><div class=""><span class="token comment">// ... 省略了部分代码</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token keyword module">export</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">updateContainer</span><span class="token punctuation">(</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token parameter literal-property property">element</span><span class="token parameter operator">:</span><span class="token parameter"> </span><span class="token parameter maybe-class-name">ReactNodeList</span><span class="token parameter punctuation">,</span><span class="token parameter"></span></div></div><div class=""><div class=""><span class="token parameter">  </span><span class="token parameter literal-property property">container</span><span class="token parameter operator">:</span><span class="token parameter"> </span><span class="token parameter maybe-class-name">OpaqueRoot</span><span class="token parameter punctuation">,</span><span class="token parameter"></span></div></div><div class=""><div class=""><span class="token parameter">  </span><span class="token parameter literal-property property">parentComponent</span><span class="token parameter operator">:</span><span class="token parameter"> </span><span class="token parameter operator">?</span><span class="token parameter maybe-class-name">React$Component</span><span class="token parameter operator">&lt;</span><span class="token parameter">any</span><span class="token parameter punctuation">,</span><span class="token parameter"> any</span><span class="token parameter operator">&gt;</span><span class="token parameter punctuation">,</span><span class="token parameter"></span></div></div><div class=""><div class=""><span class="token parameter">  </span><span class="token parameter literal-property property">callback</span><span class="token parameter operator">:</span><span class="token parameter"> </span><span class="token parameter operator">?</span><span class="token parameter known-class-name class-name">Function</span><span class="token parameter punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token punctuation">)</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">Lane</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token comment">// 获取当前时间戳</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> current </span><span class="token operator">=</span><span class="token plain"> container</span><span class="token punctuation">.</span><span class="token property-access">current</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> eventTime </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">requestEventTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token comment">// 1. 创建一个优先级变量(车道模型)</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> lane </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">requestUpdateLane</span><span class="token punctuation">(</span><span class="token plain">current</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">
</span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token comment">// 2. 根据车道优先级, 创建update对象, 并加入fiber.updateQueue.pending队列</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> update </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">createUpdate</span><span class="token punctuation">(</span><span class="token plain">eventTime</span><span class="token punctuation">,</span><span class="token plain"> lane</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  update</span><span class="token punctuation">.</span><span class="token property-access">payload</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"> element </span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  callback </span><span class="token operator">=</span><span class="token plain"> callback </span><span class="token operator">===</span><span class="token plain"> </span><span class="token keyword nil">undefined</span><span class="token plain"> </span><span class="token operator">?</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"> </span><span class="token operator">:</span><span class="token plain"> callback</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">callback </span><span class="token operator">!==</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    update</span><span class="token punctuation">.</span><span class="token property-access">callback</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> callback</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token function">enqueueUpdate</span><span class="token punctuation">(</span><span class="token plain">current</span><span class="token punctuation">,</span><span class="token plain"> update</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">
</span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token comment">// 3. 进入reconciler运作流程中的`输入`环节</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token function">scheduleUpdateOnFiber</span><span class="token punctuation">(</span><span class="token plain">current</span><span class="token punctuation">,</span><span class="token plain"> lane</span><span class="token punctuation">,</span><span class="token plain"> eventTime</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword control-flow">return</span><span class="token plain"> lane</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token punctuation">}</span></div></div></pre></div><p>由于<!-- --><code>update</code>对象的创建, 此时的内存结构如下:<!-- --></p><p><img alt="" src="/static/update-container.a5c20447.png"/></p><p>注意: 最初的<!-- --><code>ReactElement</code>对象<!-- --><code>&lt;App/&gt;</code>被挂载到<!-- --><code>HostRootFiber.updateQueue.shared.pending.payload.element</code>中, 后文<!-- --><code>fiber树构造</code>过程中会再次变动.<!-- --></p><h2 id="构造阶段"><a aria-hidden="true" tabindex="-1" href="#构造阶段"><span class="icon icon-link"></span></a>构造阶段<!-- --></h2><p>为了突出构造过程,排除干扰,先把内存状态图中的<!-- --><code>FiberRoot</code>和<!-- --><code>HostRootFiber</code>单独提出来(后文在此基础上添加):<!-- --></p><p><img alt="" src="/static/initial-status.35133c81.png"/></p><p>在<!-- --><a href="https://github.com/facebook/react/blob/v17.0.2/packages/react-reconciler/src/ReactFiberWorkLoop.old.js#L517-L619">scheduleUpdateOnFiber 函数</a>中:<!-- --></p><div class="dumi-default-source-code"><button type="button" class="dumi-default-source-code-copy"><svg viewBox="64 64 896 896"><path d="M832 64H296c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h496v688c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8V96c0-17.7-14.3-32-32-32zM704 192H192c-17.7 0-32 14.3-32 32v530.7c0 8.5 3.4 16.6 9.4 22.6l173.3 173.3c2.2 2.2 4.7 4 7.4 5.5v1.9h4.2c3.5 1.3 7.2 2 11 2H704c17.7 0 32-14.3 32-32V224c0-17.7-14.3-32-32-32zM350 856.2 263.9 770H350v86.2zM664 888H414V746c0-22.1-17.9-40-40-40H232V264h432v624z"></path></svg></button><pre class="prism-code language-js"><div class=""><div class=""><span class="token comment">// ...省略部分代码</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token keyword module">export</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">scheduleUpdateOnFiber</span><span class="token punctuation">(</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token parameter literal-property property">fiber</span><span class="token parameter operator">:</span><span class="token parameter"> </span><span class="token parameter maybe-class-name">Fiber</span><span class="token parameter punctuation">,</span><span class="token parameter"></span></div></div><div class=""><div class=""><span class="token parameter">  </span><span class="token parameter literal-property property">lane</span><span class="token parameter operator">:</span><span class="token parameter"> </span><span class="token parameter maybe-class-name">Lane</span><span class="token parameter punctuation">,</span><span class="token parameter"></span></div></div><div class=""><div class=""><span class="token parameter">  </span><span class="token parameter literal-property property">eventTime</span><span class="token parameter operator">:</span><span class="token parameter"> number</span><span class="token parameter punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token comment">// 标记优先级</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> root </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">markUpdateLaneFromFiberToRoot</span><span class="token punctuation">(</span><span class="token plain">fiber</span><span class="token punctuation">,</span><span class="token plain"> lane</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">lane </span><span class="token operator">===</span><span class="token plain"> </span><span class="token maybe-class-name">SyncLane</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token punctuation">(</span><span class="token plain">executionContext </span><span class="token operator">&amp;</span><span class="token plain"> </span><span class="token maybe-class-name">LegacyUnbatchedContext</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token operator">!==</span><span class="token plain"> </span><span class="token maybe-class-name">NoContext</span><span class="token plain"> </span><span class="token operator">&amp;&amp;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token punctuation">(</span><span class="token plain">executionContext </span><span class="token operator">&amp;</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token maybe-class-name">RenderContext</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> </span><span class="token maybe-class-name">CommitContext</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token operator">===</span><span class="token plain"> </span><span class="token maybe-class-name">NoContext</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token comment">// 首次渲染, 直接进行`fiber构造`</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token function">performSyncWorkOnRoot</span><span class="token punctuation">(</span><span class="token plain">root</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token comment">// ...</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token punctuation">}</span></div></div></pre></div><p>可以看到, 在<!-- --><code>Legacy</code>模式下且首次渲染时, 有 2 个函数<!-- --><a href="https://github.com/facebook/react/blob/v17.0.2/packages/react-reconciler/src/ReactFiberWorkLoop.old.js#L625-L667">markUpdateLaneFromFiberToRoot</a>和<!-- --><a href="https://github.com/facebook/react/blob/v17.0.2/packages/react-reconciler/src/ReactFiberWorkLoop.old.js#L965-L1045">performSyncWorkOnRoot</a>.<!-- --></p><p>其中<!-- --><code>markUpdateLaneFromFiberToRoot(fiber, lane)</code>函数在<!-- --><code>fiber树构造(对比更新)</code>中才会发挥作用, 因为在<!-- --><code>初次创建</code>时并没有与当前页面所对应的<!-- --><code>fiber树</code>, 所以核心代码并没有执行, 最后直接返回了<!-- --><code>FiberRoot</code>对象.<!-- --></p><p><code>performSyncWorkOnRoot</code>看起来源码很多, <!-- --><code>初次创建</code>中真正用到的就 2 个函数:<!-- --></p><div class="dumi-default-source-code"><button type="button" class="dumi-default-source-code-copy"><svg viewBox="64 64 896 896"><path d="M832 64H296c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h496v688c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8V96c0-17.7-14.3-32-32-32zM704 192H192c-17.7 0-32 14.3-32 32v530.7c0 8.5 3.4 16.6 9.4 22.6l173.3 173.3c2.2 2.2 4.7 4 7.4 5.5v1.9h4.2c3.5 1.3 7.2 2 11 2H704c17.7 0 32-14.3 32-32V224c0-17.7-14.3-32-32-32zM350 856.2 263.9 770H350v86.2zM664 888H414V746c0-22.1-17.9-40-40-40H232V264h432v624z"></path></svg></button><pre class="prism-code language-js"><div class=""><div class=""><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">performSyncWorkOnRoot</span><span class="token punctuation">(</span><span class="token parameter">root</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword">let</span><span class="token plain"> lanes</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword">let</span><span class="token plain"> exitStatus</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    root </span><span class="token operator">===</span><span class="token plain"> workInProgressRoot </span><span class="token operator">&amp;&amp;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token function">includesSomeLane</span><span class="token punctuation">(</span><span class="token plain">root</span><span class="token punctuation">.</span><span class="token property-access">expiredLanes</span><span class="token punctuation">,</span><span class="token plain"> workInProgressRootRenderLanes</span><span class="token punctuation">)</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token comment">// 初次构造时(因为root=fiberRoot, workInProgressRoot=null), 所以不会进入</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword control-flow">else</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token comment">// 1. 获取本次render的优先级, 初次构造返回 NoLanes</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    lanes </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">getNextLanes</span><span class="token punctuation">(</span><span class="token plain">root</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token maybe-class-name">NoLanes</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token comment">// 2. 从root节点开始, 至上而下更新</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    exitStatus </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">renderRootSync</span><span class="token punctuation">(</span><span class="token plain">root</span><span class="token punctuation">,</span><span class="token plain"> lanes</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">
</span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token comment">// 将最新的fiber树挂载到root.finishedWork节点上</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> </span><span class="token literal-property property">finishedWork</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">Fiber</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">root</span><span class="token punctuation">.</span><span class="token property-access">current</span><span class="token punctuation">.</span><span class="token property-access">alternate</span><span class="token operator">:</span><span class="token plain"> any</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  root</span><span class="token punctuation">.</span><span class="token property-access">finishedWork</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> finishedWork</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  root</span><span class="token punctuation">.</span><span class="token property-access">finishedLanes</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> lanes</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token comment">// 进入commit阶段</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token function">commitRoot</span><span class="token punctuation">(</span><span class="token plain">root</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">
</span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token comment">// ...后面的内容本节不讨论</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token punctuation">}</span></div></div></pre></div><p>其中<!-- --><code>getNextLanes</code>返回本次 render 的渲染优先级(详见<!-- --><a href="/main/fibertree-prepare#%E4%BC%98%E5%85%88%E7%BA%A7">fiber 树构造(基础准备)</a>中<!-- --><code>优先级</code>相关小节)<!-- --></p><p><a href="https://github.com/facebook/react/blob/v17.0.2/packages/react-reconciler/src/ReactFiberWorkLoop.old.js#L1490-L1553">renderRootSync</a></p><div class="dumi-default-source-code"><button type="button" class="dumi-default-source-code-copy"><svg viewBox="64 64 896 896"><path d="M832 64H296c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h496v688c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8V96c0-17.7-14.3-32-32-32zM704 192H192c-17.7 0-32 14.3-32 32v530.7c0 8.5 3.4 16.6 9.4 22.6l173.3 173.3c2.2 2.2 4.7 4 7.4 5.5v1.9h4.2c3.5 1.3 7.2 2 11 2H704c17.7 0 32-14.3 32-32V224c0-17.7-14.3-32-32-32zM350 856.2 263.9 770H350v86.2zM664 888H414V746c0-22.1-17.9-40-40-40H232V264h432v624z"></path></svg></button><pre class="prism-code language-js"><div class=""><div class=""><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">renderRootSync</span><span class="token punctuation">(</span><span class="token parameter literal-property property">root</span><span class="token parameter operator">:</span><span class="token parameter"> </span><span class="token parameter maybe-class-name">FiberRoot</span><span class="token parameter punctuation">,</span><span class="token parameter"> </span><span class="token parameter literal-property property">lanes</span><span class="token parameter operator">:</span><span class="token parameter"> </span><span class="token parameter maybe-class-name">Lanes</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> prevExecutionContext </span><span class="token operator">=</span><span class="token plain"> executionContext</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  executionContext </span><span class="token operator">|=</span><span class="token plain"> </span><span class="token maybe-class-name">RenderContext</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token comment">// 如果fiberRoot变动, 或者update.lane变动, 都会刷新栈帧, 丢弃上一次渲染进度</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">workInProgressRoot </span><span class="token operator">!==</span><span class="token plain"> root </span><span class="token operator">||</span><span class="token plain"> workInProgressRootRenderLanes </span><span class="token operator">!==</span><span class="token plain"> lanes</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token comment">// 刷新栈帧, legacy模式下都会进入</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token function">prepareFreshStack</span><span class="token punctuation">(</span><span class="token plain">root</span><span class="token punctuation">,</span><span class="token plain"> lanes</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword control-flow">do</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token keyword control-flow">try</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token function">workLoopSync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token keyword control-flow">break</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword control-flow">catch</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">thrownValue</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token function">handleError</span><span class="token punctuation">(</span><span class="token plain">root</span><span class="token punctuation">,</span><span class="token plain"> thrownValue</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword control-flow">while</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  executionContext </span><span class="token operator">=</span><span class="token plain"> prevExecutionContext</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token comment">// 重置全局变量, 表明render结束</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  workInProgressRoot </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  workInProgressRootRenderLanes </span><span class="token operator">=</span><span class="token plain"> </span><span class="token maybe-class-name">NoLanes</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword control-flow">return</span><span class="token plain"> workInProgressRootExitStatus</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token punctuation">}</span></div></div></pre></div><p>在<!-- --><code>renderRootSync</code>中, 在执行<!-- --><code>fiber树构造</code>前(<!-- --><code>workLoopSync</code>)会先刷新栈帧<!-- --><code>prepareFreshStack</code>(参考<!-- --><a href="/main/fibertree-prepare#%E6%A0%88%E5%B8%A7%E7%AE%A1%E7%90%86">fiber 树构造(基础准备)</a>).在这里创建了<!-- --><code>HostRootFiber.alternate</code>, 重置全局变量<!-- --><code>workInProgress</code>和<!-- --><code>workInProgressRoot</code>等.<!-- --></p><p><img alt="" src="/static/status-freshstack.01a7f38b.png"/></p><h3 id="循环构造"><a aria-hidden="true" tabindex="-1" href="#循环构造"><span class="icon icon-link"></span></a>循环构造<!-- --></h3><p>逻辑来到<!-- --><code>workLoopSync</code>, 虽然本节在<!-- --><code>Legacy</code>模式下进行讨论, 此处还是对比一下<!-- --><code>workLoopConcurrent</code></p><div class="dumi-default-source-code"><button type="button" class="dumi-default-source-code-copy"><svg viewBox="64 64 896 896"><path d="M832 64H296c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h496v688c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8V96c0-17.7-14.3-32-32-32zM704 192H192c-17.7 0-32 14.3-32 32v530.7c0 8.5 3.4 16.6 9.4 22.6l173.3 173.3c2.2 2.2 4.7 4 7.4 5.5v1.9h4.2c3.5 1.3 7.2 2 11 2H704c17.7 0 32-14.3 32-32V224c0-17.7-14.3-32-32-32zM350 856.2 263.9 770H350v86.2zM664 888H414V746c0-22.1-17.9-40-40-40H232V264h432v624z"></path></svg></button><pre class="prism-code language-js"><div class=""><div class=""><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">workLoopSync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword control-flow">while</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">workInProgress </span><span class="token operator">!==</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token function">performUnitOfWork</span><span class="token punctuation">(</span><span class="token plain">workInProgress</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">
</span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">workLoopConcurrent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token comment">// Perform work until Scheduler asks us to yield</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword control-flow">while</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">workInProgress </span><span class="token operator">!==</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"> </span><span class="token operator">&amp;&amp;</span><span class="token plain"> </span><span class="token operator">!</span><span class="token function">shouldYield</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token function">performUnitOfWork</span><span class="token punctuation">(</span><span class="token plain">workInProgress</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token punctuation">}</span></div></div></pre></div><p>可以看到<!-- --><code>workLoopConcurrent</code>相比于<!-- --><code>Sync</code>, 会多一个停顿机制, 这个机制实现了<!-- --><code>时间切片</code>和<!-- --><code>可中断渲染</code>(参考<!-- --><a href="/main/scheduler#%E6%97%B6%E9%97%B4%E5%88%87%E7%89%87%E5%8E%9F%E7%90%86">React 调度原理</a>)<!-- --></p><p>结合<!-- --><code>performUnitOfWork函数</code>(<!-- --><a href="https://github.com/facebook/react/blob/v17.0.2/packages/react-reconciler/src/ReactFiberWorkLoop.old.js#L1642-L1668">源码地址</a>)<!-- --></p><div class="dumi-default-source-code"><button type="button" class="dumi-default-source-code-copy"><svg viewBox="64 64 896 896"><path d="M832 64H296c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h496v688c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8V96c0-17.7-14.3-32-32-32zM704 192H192c-17.7 0-32 14.3-32 32v530.7c0 8.5 3.4 16.6 9.4 22.6l173.3 173.3c2.2 2.2 4.7 4 7.4 5.5v1.9h4.2c3.5 1.3 7.2 2 11 2H704c17.7 0 32-14.3 32-32V224c0-17.7-14.3-32-32-32zM350 856.2 263.9 770H350v86.2zM664 888H414V746c0-22.1-17.9-40-40-40H232V264h432v624z"></path></svg></button><pre class="prism-code language-js"><div class=""><div class=""><span class="token comment">// ... 省略部分无关代码</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">performUnitOfWork</span><span class="token punctuation">(</span><span class="token parameter literal-property property">unitOfWork</span><span class="token parameter operator">:</span><span class="token parameter"> </span><span class="token parameter maybe-class-name">Fiber</span><span class="token punctuation">)</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword">void</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token comment">// unitOfWork就是被传入的workInProgress</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> current </span><span class="token operator">=</span><span class="token plain"> unitOfWork</span><span class="token punctuation">.</span><span class="token property-access">alternate</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword">let</span><span class="token plain"> next</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  next </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">beginWork</span><span class="token punctuation">(</span><span class="token plain">current</span><span class="token punctuation">,</span><span class="token plain"> unitOfWork</span><span class="token punctuation">,</span><span class="token plain"> subtreeRenderLanes</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  unitOfWork</span><span class="token punctuation">.</span><span class="token property-access">memoizedProps</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> unitOfWork</span><span class="token punctuation">.</span><span class="token property-access">pendingProps</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">next </span><span class="token operator">===</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token comment">// 如果没有派生出新的节点, 则进入completeWork阶段, 传入的是当前unitOfWork</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token function">completeUnitOfWork</span><span class="token punctuation">(</span><span class="token plain">unitOfWork</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword control-flow">else</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    workInProgress </span><span class="token operator">=</span><span class="token plain"> next</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token punctuation">}</span></div></div></pre></div><p>可以明显的看出, 整个<!-- --><code>fiber树构造</code>是一个深度优先遍历(可参考<!-- --><a href="/algorithm/dfs">React 算法之深度优先遍历</a>), 其中有 2 个重要的变量<!-- --><code>workInProgress</code>和<!-- --><code>current</code>(可参考前文<!-- --><a href="/main/fibertree-prepare#%E5%8F%8C%E7%BC%93%E5%86%B2%E6%8A%80%E6%9C%AF">fiber 树构造(基础准备)</a>中介绍的<!-- --><code>双缓冲技术</code>):<!-- --></p><ul><li><code>workInProgress</code>和<!-- --><code>current</code>都视为指针<!-- --></li><li><code>workInProgress</code>指向当前正在构造的<!-- --><code>fiber</code>节点<!-- --></li><li><code>current = workInProgress.alternate</code>(即<!-- --><code>fiber.alternate</code>), 指向当前页面正在使用的<!-- --><code>fiber</code>节点. 初次构造时, 页面还未渲染, 此时<!-- --><code>current = null</code>.<!-- --></li></ul><p>在深度优先遍历中, 每个<!-- --><code>fiber</code>节点都会经历 2 个阶段:<!-- --></p><ol><li>探寻 阶段 <!-- --><code>beginWork</code></li><li>回溯阶段 <!-- --><code>completeWork</code></li></ol><p>这 2 个阶段共同完成了每一个<!-- --><code>fiber</code>节点的创建, 所有<!-- --><code>fiber</code>节点则构成了<!-- --><code>fiber树</code>.<!-- --></p><h3 id="探寻阶段-beginwork"><a aria-hidden="true" tabindex="-1" href="#探寻阶段-beginwork"><span class="icon icon-link"></span></a>探寻阶段 beginWork<!-- --></h3><p><code>beginWork(current, unitOfWork, subtreeRenderLanes)</code>(<!-- --><a href="https://github.com/facebook/react/blob/v17.0.2/packages/react-reconciler/src/ReactFiberBeginWork.old.js#L3083-L3494">源码地址</a>)针对所有的 Fiber 类型, 其中的每一个 case 处理一种 Fiber 类型. <!-- --><code>updateXXX</code>函数(如: <!-- --><code>updateHostRoot</code>, <!-- --><code>updateClassComponent</code> 等)的主要逻辑:<!-- --></p><ol><li>根据 <!-- --><code>ReactElement</code>对象创建所有的<!-- --><code>fiber</code>节点, 最终构造出<!-- --><code>fiber树形结构</code>(设置<!-- --><code>return</code>和<!-- --><code>sibling</code>指针)<!-- --></li><li>设置<!-- --><code>fiber.flags</code>(二进制形式变量, 用来标记 <!-- --><code>fiber</code>节点 的<!-- --><code>增,删,改</code>状态, 等待<!-- --><code>completeWork阶段处理</code>)<!-- --></li><li>设置<!-- --><code>fiber.stateNode</code>局部状态(如<!-- --><code>Class类型</code>节点: <!-- --><code>fiber.stateNode=new Class()</code>)<!-- --></li></ol><div class="dumi-default-source-code"><button type="button" class="dumi-default-source-code-copy"><svg viewBox="64 64 896 896"><path d="M832 64H296c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h496v688c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8V96c0-17.7-14.3-32-32-32zM704 192H192c-17.7 0-32 14.3-32 32v530.7c0 8.5 3.4 16.6 9.4 22.6l173.3 173.3c2.2 2.2 4.7 4 7.4 5.5v1.9h4.2c3.5 1.3 7.2 2 11 2H704c17.7 0 32-14.3 32-32V224c0-17.7-14.3-32-32-32zM350 856.2 263.9 770H350v86.2zM664 888H414V746c0-22.1-17.9-40-40-40H232V264h432v624z"></path></svg></button><pre class="prism-code language-js"><div class=""><div class=""><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">beginWork</span><span class="token punctuation">(</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token parameter literal-property property">current</span><span class="token parameter operator">:</span><span class="token parameter"> </span><span class="token parameter maybe-class-name">Fiber</span><span class="token parameter"> </span><span class="token parameter operator">|</span><span class="token parameter"> </span><span class="token parameter keyword null nil">null</span><span class="token parameter punctuation">,</span><span class="token parameter"></span></div></div><div class=""><div class=""><span class="token parameter">  </span><span class="token parameter literal-property property">workInProgress</span><span class="token parameter operator">:</span><span class="token parameter"> </span><span class="token parameter maybe-class-name">Fiber</span><span class="token parameter punctuation">,</span><span class="token parameter"></span></div></div><div class=""><div class=""><span class="token parameter">  </span><span class="token parameter literal-property property">renderLanes</span><span class="token parameter operator">:</span><span class="token parameter"> </span><span class="token parameter maybe-class-name">Lanes</span><span class="token parameter punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token punctuation">)</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">Fiber</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> updateLanes </span><span class="token operator">=</span><span class="token plain"> workInProgress</span><span class="token punctuation">.</span><span class="token property-access">lanes</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">current </span><span class="token operator">!==</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token comment">// update逻辑, 首次render不会进入</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword control-flow">else</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    didReceiveUpdate </span><span class="token operator">=</span><span class="token plain"> </span><span class="token boolean">false</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token comment">// 1. 设置workInProgress优先级为NoLanes(最高优先  级)</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  workInProgress</span><span class="token punctuation">.</span><span class="token property-access">lanes</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token maybe-class-name">NoLanes</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token comment">// 2. 根据workInProgress节点的类型, 用不同的方法派生出子节点</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword control-flow">switch</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    workInProgress</span><span class="token punctuation">.</span><span class="token property-access">tag</span><span class="token plain"> </span><span class="token comment">// 只保留了本例使用到的case</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token keyword">case</span><span class="token plain"> </span><span class="token literal-property property">ClassComponent</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token keyword">const</span><span class="token plain"> </span><span class="token maybe-class-name">Component</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> workInProgress</span><span class="token punctuation">.</span><span class="token property-access">type</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token keyword">const</span><span class="token plain"> unresolvedProps </span><span class="token operator">=</span><span class="token plain"> workInProgress</span><span class="token punctuation">.</span><span class="token property-access">pendingProps</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token keyword">const</span><span class="token plain"> resolvedProps </span><span class="token operator">=</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">        workInProgress</span><span class="token punctuation">.</span><span class="token property-access">elementType</span><span class="token plain"> </span><span class="token operator">===</span><span class="token plain"> </span><span class="token maybe-class-name">Component</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">          </span><span class="token operator">?</span><span class="token plain"> unresolvedProps</span></div></div><div class=""><div class=""><span class="token plain">          </span><span class="token operator">:</span><span class="token plain"> </span><span class="token function">resolveDefaultProps</span><span class="token punctuation">(</span><span class="token maybe-class-name">Component</span><span class="token punctuation">,</span><span class="token plain"> unresolvedProps</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token keyword control-flow">return</span><span class="token plain"> </span><span class="token function">updateClassComponent</span><span class="token punctuation">(</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">        current</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">        workInProgress</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">        </span><span class="token maybe-class-name">Component</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">        resolvedProps</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">        renderLanes</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token keyword">case</span><span class="token plain"> </span><span class="token literal-property property">HostRoot</span><span class="token operator">:</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token keyword control-flow">return</span><span class="token plain"> </span><span class="token function">updateHostRoot</span><span class="token punctuation">(</span><span class="token plain">current</span><span class="token punctuation">,</span><span class="token plain"> workInProgress</span><span class="token punctuation">,</span><span class="token plain"> renderLanes</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token keyword">case</span><span class="token plain"> </span><span class="token literal-property property">HostComponent</span><span class="token operator">:</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token keyword control-flow">return</span><span class="token plain"> </span><span class="token function">updateHostComponent</span><span class="token punctuation">(</span><span class="token plain">current</span><span class="token punctuation">,</span><span class="token plain"> workInProgress</span><span class="token punctuation">,</span><span class="token plain"> renderLanes</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token keyword">case</span><span class="token plain"> </span><span class="token literal-property property">HostText</span><span class="token operator">:</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token keyword control-flow">return</span><span class="token plain"> </span><span class="token function">updateHostText</span><span class="token punctuation">(</span><span class="token plain">current</span><span class="token punctuation">,</span><span class="token plain"> workInProgress</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token keyword">case</span><span class="token plain"> </span><span class="token literal-property property">Fragment</span><span class="token operator">:</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token keyword control-flow">return</span><span class="token plain"> </span><span class="token function">updateFragment</span><span class="token punctuation">(</span><span class="token plain">current</span><span class="token punctuation">,</span><span class="token plain"> workInProgress</span><span class="token punctuation">,</span><span class="token plain"> renderLanes</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token punctuation">}</span></div></div></pre></div><p><code>updateXXX</code>函数(如: updateHostRoot, updateClassComponent 等)虽然 case 较多, 但是主要逻辑可以概括为 3 个步骤:<!-- --></p><ol><li>根据<!-- --><code>fiber.pendingProps, fiber.updateQueue</code>等<!-- --><code>输入数据</code>状态, 计算<!-- --><code>fiber.memoizedState</code>作为<!-- --><code>输出状态</code></li><li>获取下级<!-- --><code>ReactElement</code>对象
<!-- --><ol><li>class 类型的 <!-- --><code>fiber</code> 节点
<!-- --><ul><li>构建<!-- --><code>React.Component</code>实例<!-- --></li><li>把新实例挂载到<!-- --><code>fiber.stateNode</code>上<!-- --></li><li>执行<!-- --><code>render</code>之前的生命周期函数<!-- --></li><li>执行<!-- --><code>render</code>方法, 获取下级<!-- --><code>reactElement</code></li><li>根据实际情况, 设置<!-- --><code>fiber.flags</code></li></ul></li><li>function 类型的 <!-- --><code>fiber</code> 节点
<!-- --><ul><li>执行 function, 获取下级<!-- --><code>reactElement</code></li><li>根据实际情况, 设置<!-- --><code>fiber.flags</code></li></ul></li><li>HostComponent 类型(如: <!-- --><code>div, span, button</code> 等)的 <!-- --><code>fiber</code> 节点
<!-- --><ul><li><code>pendingProps.children</code>作为下级<!-- --><code>reactElement</code></li><li>如果下级节点是文本节点,则设置下级节点为 null. 准备进入<!-- --><code>completeUnitOfWork</code>阶段<!-- --></li><li>根据实际情况, 设置<!-- --><code>fiber.flags</code></li></ul></li><li>其他类型...</li></ol></li><li>根据<!-- --><code>ReactElement</code>对象, 调用<!-- --><code>reconcileChildren</code>生成<!-- --><code>Fiber</code>子节点(只生成<!-- --><code>次级子节点</code>)
<!-- --><ul><li>根据实际情况, 设置<!-- --><code>fiber.flags</code></li></ul></li></ol><p>不同的<!-- --><code>updateXXX</code>函数处理的<!-- --><code>fiber</code>节点类型不同, 总的目的是为了向下生成子节点. 在这个过程中把一些需要持久化的数据挂载到<!-- --><code>fiber</code>节点上(如<!-- --><code>fiber.stateNode</code>,<!-- --><code>fiber.memoizedState</code>等); 把<!-- --><code>fiber</code>节点的特殊操作设置到<!-- --><code>fiber.flags</code>(如:<!-- --><code>节点ref</code>,<!-- --><code>class组件的生命周期</code>,<!-- --><code>function组件的hook</code>,<!-- --><code>节点删除</code>等).<!-- --></p><p>这里列出<!-- --><code>updateHostRoot</code>, <!-- --><code>updateHostComponent</code>的代码, 对于其他常用 case 的分析(如<!-- --><code>class</code>类型, <!-- --><code>function</code>类型), 在<!-- --><code>状态组件</code>章节中进行探讨.<!-- --></p><p><code>fiber树</code>的根节点是<!-- --><code>HostRootFiber</code>节点, 所以第一次进入<!-- --><code>beginWork</code>会调用<!-- --><a href="https://github.com/facebook/react/blob/v17.0.2/packages/react-reconciler/src/ReactFiberBeginWork.old.js#L1053-L1122">updateHostRoot(current, workInProgress, renderLanes)</a></p><div class="dumi-default-source-code"><button type="button" class="dumi-default-source-code-copy"><svg viewBox="64 64 896 896"><path d="M832 64H296c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h496v688c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8V96c0-17.7-14.3-32-32-32zM704 192H192c-17.7 0-32 14.3-32 32v530.7c0 8.5 3.4 16.6 9.4 22.6l173.3 173.3c2.2 2.2 4.7 4 7.4 5.5v1.9h4.2c3.5 1.3 7.2 2 11 2H704c17.7 0 32-14.3 32-32V224c0-17.7-14.3-32-32-32zM350 856.2 263.9 770H350v86.2zM664 888H414V746c0-22.1-17.9-40-40-40H232V264h432v624z"></path></svg></button><pre class="prism-code language-js"><div class=""><div class=""><span class="token comment">// 省略与本节无关代码</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">updateHostRoot</span><span class="token punctuation">(</span><span class="token parameter">current</span><span class="token parameter punctuation">,</span><span class="token parameter"> workInProgress</span><span class="token parameter punctuation">,</span><span class="token parameter"> renderLanes</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token comment">// 1. 状态计算, 更新整合到 workInProgress.memoizedState中来</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> updateQueue </span><span class="token operator">=</span><span class="token plain"> workInProgress</span><span class="token punctuation">.</span><span class="token property-access">updateQueue</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> nextProps </span><span class="token operator">=</span><span class="token plain"> workInProgress</span><span class="token punctuation">.</span><span class="token property-access">pendingProps</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> prevState </span><span class="token operator">=</span><span class="token plain"> workInProgress</span><span class="token punctuation">.</span><span class="token property-access">memoizedState</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> prevChildren </span><span class="token operator">=</span><span class="token plain"> prevState </span><span class="token operator">!==</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"> </span><span class="token operator">?</span><span class="token plain"> prevState</span><span class="token punctuation">.</span><span class="token property-access">element</span><span class="token plain"> </span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token function">cloneUpdateQueue</span><span class="token punctuation">(</span><span class="token plain">current</span><span class="token punctuation">,</span><span class="token plain"> workInProgress</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token comment">// 遍历updateQueue.shared.pending, 提取有足够优先级的update对象, 计算出最终的状态 workInProgress.memoizedState</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token function">processUpdateQueue</span><span class="token punctuation">(</span><span class="token plain">workInProgress</span><span class="token punctuation">,</span><span class="token plain"> nextProps</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"> renderLanes</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> nextState </span><span class="token operator">=</span><span class="token plain"> workInProgress</span><span class="token punctuation">.</span><span class="token property-access">memoizedState</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token comment">// 2. 获取下级`ReactElement`对象</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> nextChildren </span><span class="token operator">=</span><span class="token plain"> nextState</span><span class="token punctuation">.</span><span class="token property-access">element</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> </span><span class="token literal-property property">root</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">FiberRoot</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> workInProgress</span><span class="token punctuation">.</span><span class="token property-access">stateNode</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">root</span><span class="token punctuation">.</span><span class="token property-access">hydrate</span><span class="token plain"> </span><span class="token operator">&amp;&amp;</span><span class="token plain"> </span><span class="token function">enterHydrationState</span><span class="token punctuation">(</span><span class="token plain">workInProgress</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token comment">// ...服务端渲染相关, 此处省略</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword control-flow">else</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token comment">// 3. 根据`ReactElement`对象, 调用`reconcileChildren`生成`Fiber`子节点(只生成`次级子节点`)</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token function">reconcileChildren</span><span class="token punctuation">(</span><span class="token plain">current</span><span class="token punctuation">,</span><span class="token plain"> workInProgress</span><span class="token punctuation">,</span><span class="token plain"> nextChildren</span><span class="token punctuation">,</span><span class="token plain"> renderLanes</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword control-flow">return</span><span class="token plain"> workInProgress</span><span class="token punctuation">.</span><span class="token property-access">child</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token punctuation">}</span></div></div></pre></div><p>普通 DOM 标签类型的节点(如<!-- --><code>div</code>,<!-- --><code>span</code>,<!-- --><code>p</code>),会进入<!-- --><a href="https://github.com/facebook/react/blob/v17.0.2/packages/react-reconciler/src/ReactFiberBeginWork.old.js#L1124-L1157">updateHostComponent</a>:<!-- --></p><div class="dumi-default-source-code"><button type="button" class="dumi-default-source-code-copy"><svg viewBox="64 64 896 896"><path d="M832 64H296c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h496v688c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8V96c0-17.7-14.3-32-32-32zM704 192H192c-17.7 0-32 14.3-32 32v530.7c0 8.5 3.4 16.6 9.4 22.6l173.3 173.3c2.2 2.2 4.7 4 7.4 5.5v1.9h4.2c3.5 1.3 7.2 2 11 2H704c17.7 0 32-14.3 32-32V224c0-17.7-14.3-32-32-32zM350 856.2 263.9 770H350v86.2zM664 888H414V746c0-22.1-17.9-40-40-40H232V264h432v624z"></path></svg></button><pre class="prism-code language-js"><div class=""><div class=""><span class="token comment">// ...省略部分无关代码</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">updateHostComponent</span><span class="token punctuation">(</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token parameter literal-property property">current</span><span class="token parameter operator">:</span><span class="token parameter"> </span><span class="token parameter maybe-class-name">Fiber</span><span class="token parameter"> </span><span class="token parameter operator">|</span><span class="token parameter"> </span><span class="token parameter keyword null nil">null</span><span class="token parameter punctuation">,</span><span class="token parameter"></span></div></div><div class=""><div class=""><span class="token parameter">  </span><span class="token parameter literal-property property">workInProgress</span><span class="token parameter operator">:</span><span class="token parameter"> </span><span class="token parameter maybe-class-name">Fiber</span><span class="token parameter punctuation">,</span><span class="token parameter"></span></div></div><div class=""><div class=""><span class="token parameter">  </span><span class="token parameter literal-property property">renderLanes</span><span class="token parameter operator">:</span><span class="token parameter"> </span><span class="token parameter maybe-class-name">Lanes</span><span class="token parameter punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token comment">// 1. 状态计算, 由于HostComponent是无状态组件, 所以只需要收集 nextProps即可, 它没有 memoizedState</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> type </span><span class="token operator">=</span><span class="token plain"> workInProgress</span><span class="token punctuation">.</span><span class="token property-access">type</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> nextProps </span><span class="token operator">=</span><span class="token plain"> workInProgress</span><span class="token punctuation">.</span><span class="token property-access">pendingProps</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> prevProps </span><span class="token operator">=</span><span class="token plain"> current </span><span class="token operator">!==</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"> </span><span class="token operator">?</span><span class="token plain"> current</span><span class="token punctuation">.</span><span class="token property-access">memoizedProps</span><span class="token plain"> </span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token comment">// 2. 获取下级`ReactElement`对象</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword">let</span><span class="token plain"> nextChildren </span><span class="token operator">=</span><span class="token plain"> nextProps</span><span class="token punctuation">.</span><span class="token property-access">children</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> isDirectTextChild </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">shouldSetTextContent</span><span class="token punctuation">(</span><span class="token plain">type</span><span class="token punctuation">,</span><span class="token plain"> nextProps</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">
</span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">isDirectTextChild</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token comment">// 如果子节点只有一个文本节点, 不用再创建一个HostText类型的fiber</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    nextChildren </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword control-flow">else</span><span class="token plain"> </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">prevProps </span><span class="token operator">!==</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"> </span><span class="token operator">&amp;&amp;</span><span class="token plain"> </span><span class="token function">shouldSetTextContent</span><span class="token punctuation">(</span><span class="token plain">type</span><span class="token punctuation">,</span><span class="token plain"> prevProps</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token comment">// 特殊操作需要设置fiber.flags</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    workInProgress</span><span class="token punctuation">.</span><span class="token property-access">flags</span><span class="token plain"> </span><span class="token operator">|=</span><span class="token plain"> </span><span class="token maybe-class-name">ContentReset</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token comment">// 特殊操作需要设置fiber.flags</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token function">markRef</span><span class="token punctuation">(</span><span class="token plain">current</span><span class="token punctuation">,</span><span class="token plain"> workInProgress</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token comment">// 3. 根据`ReactElement`对象, 调用`reconcileChildren`生成`Fiber`子节点(只生成`次级子节点`)</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token function">reconcileChildren</span><span class="token punctuation">(</span><span class="token plain">current</span><span class="token punctuation">,</span><span class="token plain"> workInProgress</span><span class="token punctuation">,</span><span class="token plain"> nextChildren</span><span class="token punctuation">,</span><span class="token plain"> renderLanes</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword control-flow">return</span><span class="token plain"> workInProgress</span><span class="token punctuation">.</span><span class="token property-access">child</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token punctuation">}</span></div></div></pre></div><h3 id="回溯阶段-completework"><a aria-hidden="true" tabindex="-1" href="#回溯阶段-completework"><span class="icon icon-link"></span></a>回溯阶段 completeWork<!-- --></h3><p><code>completeUnitOfWork(unitOfWork)</code>(<!-- --><a href="https://github.com/facebook/react/blob/v17.0.2/packages/react-reconciler/src/ReactFiberWorkLoop.old.js#L1670-L1802">源码地址</a>), 处理 <!-- --><code>beginWork</code> 阶段已经创建出来的 <!-- --><code>fiber</code> 节点, 核心逻辑:<!-- --></p><ol><li>调用<!-- --><code>completeWork</code><ul><li>给<!-- --><code>fiber</code>节点(tag=HostComponent, HostText)创建 DOM 实例, 设置<!-- --><code>fiber.stateNode</code>局部状态(如<!-- --><code>tag=HostComponent, HostText</code>节点: fiber.stateNode 指向这个 DOM 实例).<!-- --></li><li>为 DOM 节点设置属性, 绑定事件(这里先说明有这个步骤, 详细的事件处理流程, 在<!-- --><code>合成事件原理</code>中详细说明).<!-- --></li><li>设置<!-- --><code>fiber.flags</code>标记<!-- --></li></ul></li><li>把当前 <!-- --><code>fiber</code> 对象的副作用队列(<!-- --><code>firstEffect</code>和<!-- --><code>lastEffect</code>)添加到父节点的副作用队列之后, 更新父节点的<!-- --><code>firstEffect</code>和<!-- --><code>lastEffect</code>指针.<!-- --></li><li>识别<!-- --><code>beginWork</code>阶段设置的<!-- --><code>fiber.flags</code>, 判断当前 <!-- --><code>fiber</code> 是否有副作用(增,删,改), 如果有, 需要将当前 <!-- --><code>fiber</code> 加入到父节点的<!-- --><code>effects</code>队列, 等待<!-- --><code>commit</code>阶段处理.<!-- --></li></ol><div class="dumi-default-source-code"><button type="button" class="dumi-default-source-code-copy"><svg viewBox="64 64 896 896"><path d="M832 64H296c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h496v688c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8V96c0-17.7-14.3-32-32-32zM704 192H192c-17.7 0-32 14.3-32 32v530.7c0 8.5 3.4 16.6 9.4 22.6l173.3 173.3c2.2 2.2 4.7 4 7.4 5.5v1.9h4.2c3.5 1.3 7.2 2 11 2H704c17.7 0 32-14.3 32-32V224c0-17.7-14.3-32-32-32zM350 856.2 263.9 770H350v86.2zM664 888H414V746c0-22.1-17.9-40-40-40H232V264h432v624z"></path></svg></button><pre class="prism-code language-js"><div class=""><div class=""><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">completeUnitOfWork</span><span class="token punctuation">(</span><span class="token parameter literal-property property">unitOfWork</span><span class="token parameter operator">:</span><span class="token parameter"> </span><span class="token parameter maybe-class-name">Fiber</span><span class="token punctuation">)</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword">void</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword">let</span><span class="token plain"> completedWork </span><span class="token operator">=</span><span class="token plain"> unitOfWork</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token comment">// 外层循环控制并移动指针(`workInProgress`,`completedWork`等)</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword control-flow">do</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token keyword">const</span><span class="token plain"> current </span><span class="token operator">=</span><span class="token plain"> completedWork</span><span class="token punctuation">.</span><span class="token property-access">alternate</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token keyword">const</span><span class="token plain"> returnFiber </span><span class="token operator">=</span><span class="token plain"> completedWork</span><span class="token punctuation">.</span><span class="token keyword control-flow">return</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token plain">completedWork</span><span class="token punctuation">.</span><span class="token property-access">flags</span><span class="token plain"> </span><span class="token operator">&amp;</span><span class="token plain"> </span><span class="token maybe-class-name">Incomplete</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token operator">===</span><span class="token plain"> </span><span class="token maybe-class-name">NoFlags</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token keyword">let</span><span class="token plain"> next</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token comment">// 1. 处理Fiber节点, 会调用渲染器(调用react-dom包, 关联Fiber节点和dom对象, 绑定事件等)</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      next </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">completeWork</span><span class="token punctuation">(</span><span class="token plain">current</span><span class="token punctuation">,</span><span class="token plain"> completedWork</span><span class="token punctuation">,</span><span class="token plain"> subtreeRenderLanes</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"> </span><span class="token comment">// 处理单个节点</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">next </span><span class="token operator">!==</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">        </span><span class="token comment">// 如果派生出其他的子节点, 则回到`beginWork`阶段进行处理</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">        workInProgress </span><span class="token operator">=</span><span class="token plain"> next</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">        </span><span class="token keyword control-flow">return</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token comment">// 重置子节点的优先级</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token function">resetChildLanes</span><span class="token punctuation">(</span><span class="token plain">completedWork</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">        returnFiber </span><span class="token operator">!==</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"> </span><span class="token operator">&amp;&amp;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">        </span><span class="token punctuation">(</span><span class="token plain">returnFiber</span><span class="token punctuation">.</span><span class="token property-access">flags</span><span class="token plain"> </span><span class="token operator">&amp;</span><span class="token plain"> </span><span class="token maybe-class-name">Incomplete</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token operator">===</span><span class="token plain"> </span><span class="token maybe-class-name">NoFlags</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">        </span><span class="token comment">// 2. 收集当前Fiber节点以及其子树的副作用effects</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">        </span><span class="token comment">// 2.1 把子节点的副作用队列添加到父节点上</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">        </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">returnFiber</span><span class="token punctuation">.</span><span class="token property-access">firstEffect</span><span class="token plain"> </span><span class="token operator">===</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">          returnFiber</span><span class="token punctuation">.</span><span class="token property-access">firstEffect</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> completedWork</span><span class="token punctuation">.</span><span class="token property-access">firstEffect</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">        </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">        </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">completedWork</span><span class="token punctuation">.</span><span class="token property-access">lastEffect</span><span class="token plain"> </span><span class="token operator">!==</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">          </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">returnFiber</span><span class="token punctuation">.</span><span class="token property-access">lastEffect</span><span class="token plain"> </span><span class="token operator">!==</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">            returnFiber</span><span class="token punctuation">.</span><span class="token property-access">lastEffect</span><span class="token punctuation">.</span><span class="token property-access">nextEffect</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> completedWork</span><span class="token punctuation">.</span><span class="token property-access">firstEffect</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">          </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">          returnFiber</span><span class="token punctuation">.</span><span class="token property-access">lastEffect</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> completedWork</span><span class="token punctuation">.</span><span class="token property-access">lastEffect</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">        </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">        </span><span class="token comment">// 2.2 如果当前fiber节点有副作用, 将其添加到子节点的副作用队列之后.</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">        </span><span class="token keyword">const</span><span class="token plain"> flags </span><span class="token operator">=</span><span class="token plain"> completedWork</span><span class="token punctuation">.</span><span class="token property-access">flags</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">        </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">flags </span><span class="token operator">&gt;</span><span class="token plain"> </span><span class="token maybe-class-name">PerformedWork</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">          </span><span class="token comment">// PerformedWork是提供给 React DevTools读取的, 所以略过PerformedWork</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">          </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">returnFiber</span><span class="token punctuation">.</span><span class="token property-access">lastEffect</span><span class="token plain"> </span><span class="token operator">!==</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">            returnFiber</span><span class="token punctuation">.</span><span class="token property-access">lastEffect</span><span class="token punctuation">.</span><span class="token property-access">nextEffect</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> completedWork</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">          </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword control-flow">else</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">            returnFiber</span><span class="token punctuation">.</span><span class="token property-access">firstEffect</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> completedWork</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">          </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">          returnFiber</span><span class="token punctuation">.</span><span class="token property-access">lastEffect</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> completedWork</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">        </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword control-flow">else</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token comment">// 异常处理, 本节不讨论</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">
</span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token keyword">const</span><span class="token plain"> siblingFiber </span><span class="token operator">=</span><span class="token plain"> completedWork</span><span class="token punctuation">.</span><span class="token property-access">sibling</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">siblingFiber </span><span class="token operator">!==</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token comment">// 如果有兄弟节点, 返回之后再次进入`beginWork`阶段</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      workInProgress </span><span class="token operator">=</span><span class="token plain"> siblingFiber</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token keyword control-flow">return</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token comment">// 移动指针, 指向下一个节点</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    completedWork </span><span class="token operator">=</span><span class="token plain"> returnFiber</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    workInProgress </span><span class="token operator">=</span><span class="token plain"> completedWork</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword control-flow">while</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">completedWork </span><span class="token operator">!==</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token comment">// 已回溯到根节点, 设置workInProgressRootExitStatus = RootCompleted</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">workInProgressRootExitStatus </span><span class="token operator">===</span><span class="token plain"> </span><span class="token maybe-class-name">RootIncomplete</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    workInProgressRootExitStatus </span><span class="token operator">=</span><span class="token plain"> </span><span class="token maybe-class-name">RootCompleted</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token punctuation">}</span></div></div></pre></div><p>接下来分析<!-- --><code>fiber</code>处理函数<!-- --><a href="https://github.com/facebook/react/blob/v17.0.2/packages/react-reconciler/src/ReactFiberCompleteWork.old.js#L645-L1289">completeWork</a></p><div class="dumi-default-source-code"><button type="button" class="dumi-default-source-code-copy"><svg viewBox="64 64 896 896"><path d="M832 64H296c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h496v688c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8V96c0-17.7-14.3-32-32-32zM704 192H192c-17.7 0-32 14.3-32 32v530.7c0 8.5 3.4 16.6 9.4 22.6l173.3 173.3c2.2 2.2 4.7 4 7.4 5.5v1.9h4.2c3.5 1.3 7.2 2 11 2H704c17.7 0 32-14.3 32-32V224c0-17.7-14.3-32-32-32zM350 856.2 263.9 770H350v86.2zM664 888H414V746c0-22.1-17.9-40-40-40H232V264h432v624z"></path></svg></button><pre class="prism-code language-js"><div class=""><div class=""><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">completeWork</span><span class="token punctuation">(</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token parameter literal-property property">current</span><span class="token parameter operator">:</span><span class="token parameter"> </span><span class="token parameter maybe-class-name">Fiber</span><span class="token parameter"> </span><span class="token parameter operator">|</span><span class="token parameter"> </span><span class="token parameter keyword null nil">null</span><span class="token parameter punctuation">,</span><span class="token parameter"></span></div></div><div class=""><div class=""><span class="token parameter">  </span><span class="token parameter literal-property property">workInProgress</span><span class="token parameter operator">:</span><span class="token parameter"> </span><span class="token parameter maybe-class-name">Fiber</span><span class="token parameter punctuation">,</span><span class="token parameter"></span></div></div><div class=""><div class=""><span class="token parameter">  </span><span class="token parameter literal-property property">renderLanes</span><span class="token parameter operator">:</span><span class="token parameter"> </span><span class="token parameter maybe-class-name">Lanes</span><span class="token parameter punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token punctuation">)</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">Fiber</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> newProps </span><span class="token operator">=</span><span class="token plain"> workInProgress</span><span class="token punctuation">.</span><span class="token property-access">pendingProps</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword control-flow">switch</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">workInProgress</span><span class="token punctuation">.</span><span class="token property-access">tag</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token keyword">case</span><span class="token plain"> </span><span class="token literal-property property">ClassComponent</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token comment">// Class类型  不做处理</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token keyword control-flow">return</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token keyword">case</span><span class="token plain"> </span><span class="token literal-property property">HostRoot</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token keyword">const</span><span class="token plain"> fiberRoot </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">workInProgress</span><span class="token punctuation">.</span><span class="token property-access">stateNode</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">FiberRoot</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">fiberRoot</span><span class="token punctuation">.</span><span class="token property-access">pendingContext</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">        fiberRoot</span><span class="token punctuation">.</span><span class="token property-access">context</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> fiberRoot</span><span class="token punctuation">.</span><span class="token property-access">pendingContext</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">        fiberRoot</span><span class="token punctuation">.</span><span class="token property-access">pendingContext</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">current </span><span class="token operator">===</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"> </span><span class="token operator">||</span><span class="token plain"> current</span><span class="token punctuation">.</span><span class="token property-access">child</span><span class="token plain"> </span><span class="token operator">===</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">         </span><span class="token comment">// 设置fiber.flags标记</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">         workInProgress</span><span class="token punctuation">.</span><span class="token property-access">flags</span><span class="token plain"> </span><span class="token operator">|=</span><span class="token plain"> </span><span class="token maybe-class-name">Snapshot</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token keyword control-flow">return</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token keyword">case</span><span class="token plain"> </span><span class="token literal-property property">HostComponent</span><span class="token operator">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token function">popHostContext</span><span class="token punctuation">(</span><span class="token plain">workInProgress</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token keyword">const</span><span class="token plain"> rootContainerInstance </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">getRootHostContainer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token keyword">const</span><span class="token plain"> type </span><span class="token operator">=</span><span class="token plain"> workInProgress</span><span class="token punctuation">.</span><span class="token property-access">type</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">current </span><span class="token operator">!==</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"> </span><span class="token operator">&amp;&amp;</span><span class="token plain"> workInProgress</span><span class="token punctuation">.</span><span class="token property-access">stateNode</span><span class="token plain"> </span><span class="token operator">!=</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">        </span><span class="token comment">// update逻辑, 初次render不会进入</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword control-flow">else</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">        </span><span class="token keyword">const</span><span class="token plain"> currentHostContext </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">getHostContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">        </span><span class="token comment">// 1. 创建DOM对象</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">        </span><span class="token keyword">const</span><span class="token plain"> instance </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">createInstance</span><span class="token punctuation">(</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">          type</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">          newProps</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">          rootContainerInstance</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">          currentHostContext</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">          workInProgress</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">        </span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">        </span><span class="token comment">// 2. 把子树中的DOM对象append到本节点的DOM对象之后</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">        </span><span class="token function">appendAllChildren</span><span class="token punctuation">(</span><span class="token plain">instance</span><span class="token punctuation">,</span><span class="token plain"> workInProgress</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">        </span><span class="token comment">// 设置stateNode属性, 指向DOM对象</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">        workInProgress</span><span class="token punctuation">.</span><span class="token property-access">stateNode</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> instance</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">        </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">          </span><span class="token comment">// 3. 设置DOM对象的属性, 绑定事件等</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">          </span><span class="token function">finalizeInitialChildren</span><span class="token punctuation">(</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">            instance</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">            type</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">            newProps</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">            rootContainerInstance</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">            currentHostContext</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">          </span><span class="token punctuation">)</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">        </span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">          </span><span class="token comment">// 设置fiber.flags标记(Update)</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">          </span><span class="token function">markUpdate</span><span class="token punctuation">(</span><span class="token plain">workInProgress</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">        </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">        </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">workInProgress</span><span class="token punctuation">.</span><span class="token property-access">ref</span><span class="token plain"> </span><span class="token operator">!==</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">          </span><span class="token comment">// 设置fiber.flags标记(Ref)</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">          </span><span class="token function">markRef</span><span class="token punctuation">(</span><span class="token plain">workInProgress</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">        </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">        </span><span class="token keyword control-flow">return</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token punctuation">}</span></div></div></pre></div><p>可以看到在满足条件的时候也会设置<!-- --><code>fiber.flags</code>, 所以设置<!-- --><code>fiber.flags</code>并非只在<!-- --><code>beginWork</code>阶段.<!-- --></p><h2 id="过程图解"><a aria-hidden="true" tabindex="-1" href="#过程图解"><span class="icon icon-link"></span></a>过程图解<!-- --></h2><p>针对本节的示例代码, 将  整个<!-- --><code>fiber</code>树构造过程表示出来:<!-- --></p><p>构造前:</p><p>在上文已经说明, 进入循环构造前会调用<!-- --><code>prepareFreshStack</code>刷新栈帧, 在进入<!-- --><code>fiber树构造</code>循环之前, 保持这这个初始化状态:<!-- --></p><p><img alt="" src="/static/unitofwork0.2b01ce04.png"/></p><p><code>performUnitOfWork</code>第 1 次调用(只执行<!-- --><code>beginWork</code>):<!-- --></p><ul><li>执行前: <!-- --><code>workInProgress</code>指针指向<!-- --><code>HostRootFiber.alternate</code>对象, 此时<!-- --><code>current = workInProgress.alternate</code>指向<!-- --><code>fiberRoot.current</code>是非空的(初次构造, 只在根节点时, <!-- --><code>current</code>非空).<!-- --></li><li>执行过程: 调用<!-- --><code>updateHostRoot</code><ul><li>在<!-- --><code>reconcileChildren</code>阶段, 向下构造<!-- --><code>次级子节点fiber(&lt;App/&gt;)</code>, 同时设置子节点(<!-- --><code>fiber(&lt;App/&gt;)</code>)<!-- --><a href="https://github.com/facebook/react/blob/v17.0.2/packages/react-reconciler/src/ReactChildFiber.old.js#L376-L378">fiber.flags |= Placement</a></li></ul></li><li>执行后: 返回下级节点<!-- --><code>fiber(&lt;App/&gt;)</code>, 移动<!-- --><code>workInProgress</code>指针指向子节点<!-- --><code>fiber(&lt;App/&gt;)</code></li></ul><p><img alt="" src="/static/unitofwork1.20aad56c.png"/></p><p><code>performUnitOfWork</code>第 2 次调用(只执行<!-- --><code>beginWork</code>):<!-- --></p><ul><li>执行前: <!-- --><code>workInProgress</code>指针指向<!-- --><code>fiber(&lt;App/&gt;)</code>节点, 此时<!-- --><code>current = null</code></li><li>执行过程: 调用<!-- --><code>updateClassComponent</code><ul><li>本示例中, class 实例存在生命周期函数<!-- --><code>componentDidMount</code>, 所以会设置<!-- --><code>fiber(&lt;App/&gt;)</code>节点<!-- --><a href="https://github.com/facebook/react/blob/v17.0.2/packages/react-reconciler/src/ReactFiberClassComponent.old.js#L892-L894">workInProgress.flags |= Update</a></li><li>另外也会为了<!-- --><code>React DevTools</code>能够识别状态组件的执行进度, 会设置<!-- --><a href="https://github.com/facebook/react/blob/v17.0.2/packages/react-reconciler/src/ReactFiberBeginWork.old.js#L379">workInProgress.flags |= PerformedWork</a>(在<!-- --><code>commit</code>阶段会排除这个<!-- --><code>flag</code>, 此处只是列出<!-- --><code>workInProgress.flags</code>的设置场景, 不讨论<!-- --><code>React DevTools</code>)<!-- --></li><li>需要注意<!-- --><code>classInstance.render()</code>在本步骤执行后, 虽然返回了<!-- --><code>render</code>方法中所有的<!-- --><code>ReactElement</code>对象, 但是随后<!-- --><code>reconcileChildren</code>只构造<!-- --><code>次级子节点</code></li><li>在<!-- --><code>reconcileChildren</code>阶段, 向下构造<!-- --><code>次级子节点div</code></li></ul></li><li>执行后: 返回下级节点<!-- --><code>fiber(div)</code>, 移动<!-- --><code>workInProgress</code>指针指向子节点<!-- --><code>fiber(div)</code></li></ul><p><img alt="" src="/static/unitofwork2.5c1504a3.png"/></p><p><code>performUnitOfWork</code>第 3 次调用(只执行<!-- --><code>beginWork</code>):<!-- --></p><ul><li>执行前: <!-- --><code>workInProgress</code>指针指向<!-- --><code>fiber(div)</code>节点, 此时<!-- --><code>current = null</code></li><li>执行过程: 调用<!-- --><code>updateHostComponent</code><ul><li>在<!-- --><code>reconcileChildren</code>阶段, 向下构造<!-- --><code>次级子节点</code>(本示例中, <!-- --><code>div</code>有 2 个次级子节点)<!-- --></li></ul></li><li>执行后: 返回下级节点<!-- --><code>fiber(header)</code>, 移动<!-- --><code>workInProgress</code>指针指向子节点<!-- --><code>fiber(header)</code></li></ul><p><img alt="" src="/static/unitofwork3.e67196e2.png"/></p><p><code>performUnitOfWork</code>第 4 次调用(执行<!-- --><code>beginWork</code>和<!-- --><code>completeUnitOfWork</code>):<!-- --></p><ul><li><code>beginWork</code>执行前: <!-- --><code>workInProgress</code>指针指向<!-- --><code>fiber(header)</code>节点, 此时<!-- --><code>current = null</code></li><li><code>beginWork</code>执行过程: 调用<!-- --><code>updateHostComponent</code><ul><li>本示例中<!-- --><code>header</code>的子节点是一个<!-- --><a href="https://github.com/facebook/react/blob/8e5adfbd7e605bda9c5e96c10e015b3dc0df688e/packages/react-dom/src/client/ReactDOMHostConfig.js#L350-L361">直接文本节点</a>,设置<!-- --><a href="https://github.com/facebook/react/blob/v17.0.2/packages/react-reconciler/src/ReactFiberBeginWork.old.js#L1147">nextChildren = null</a>(直接文本节点并不会被当成具体的<!-- --><code>fiber</code>节点进行处理, 而是在宿主环境(父组件)中通过属性进行设置. 所以无需创建<!-- --><code>HostText</code>类型的 fiber 节点, 同时节省了向下遍历开销.).<!-- --></li><li>由于<!-- --><code>nextChildren = null</code>, 经过<!-- --><code>reconcileChildren</code>阶段处理后, 返回值也是<!-- --><code>null</code></li></ul></li><li><code>beginWork</code>执行后: 由于下级节点为<!-- --><code>null</code>, 所以进入<!-- --><code>completeUnitOfWork(unitOfWork)</code>函数, 传入的参数<!-- --><code>unitOfWork</code>实际上就是<!-- --><code>workInProgress</code>(此时指向<!-- --><code>fiber(header)</code>节点)<!-- --></li></ul><p><img alt="" src="/static/unitofwork4.1.b9d81b55.png"/></p><ul><li><code>completeUnitOfWork</code>执行前: <!-- --><code>workInProgress</code>指针指向<!-- --><code>fiber(header)</code>节点<!-- --></li><li><code>completeUnitOfWork</code>执行过程: 以<!-- --><code>fiber(header)</code>为起点, 向上回溯<!-- --></li></ul><p>第 1 次循环:</p><ol><li>执行<!-- --><code>completeWork</code>函数
<!-- --><ul><li>创建<!-- --><code>fiber(header)</code>节点对应的<!-- --><code>DOM</code>实例, 并<!-- --><code>append</code>子节点的<!-- --><code>DOM</code>实例<!-- --></li><li>设置<!-- --><code>DOM</code>属性, 绑定事件等(本示例中, 节点<!-- --><code>fiber(header)</code>没有事件绑定)<!-- --></li></ul></li><li>上移副作用队列: 由于本节点<!-- --><code>fiber(header)</code>没有副作用(<!-- --><code>fiber.flags = 0</code>), 所以执行之后副作用队列没有实质变化(目前为空).<!-- --></li><li>向上回溯: 由于还有兄弟节点, 把<!-- --><code>workInProgress</code>指针指向下一个兄弟节点<!-- --><code>fiber(&lt;Content/&gt;)</code>, 退出<!-- --><code>completeUnitOfWork</code>.<!-- --></li></ol><p><img alt="" src="/static/unitofwork4.2.e7f971ec.png"/></p><p><code>performUnitOfWork</code>第 5 次调用(执行<!-- --><code>beginWork</code>):<!-- --></p><ul><li>执行前:<!-- --><code>workInProgress</code>指针指向<!-- --><code>fiber(&lt;Content/&gt;)</code>节点.<!-- --></li><li>执行过程: 这是一个<!-- --><code>class</code>类型的节点, 与第 2 次调用逻辑一致.<!-- --></li><li>执行后: 返回下级节点<!-- --><code>fiber(p)</code>, 移动<!-- --><code>workInProgress</code>指针指向子节点<!-- --><code>fiber(p)</code></li></ul><p><img alt="" src="/static/unitofwork5.6a117a71.png"/></p><p><code>performUnitOfWork</code>第 6 次调用(执行<!-- --><code>beginWork</code>和<!-- --><code>completeUnitOfWork</code>):与第 4 次调用中创建<!-- --><code>fiber(header)</code>节点的逻辑一致. 先后会执行<!-- --><code>beginWork</code>和<!-- --><code>completeUnitOfWork</code>, 最后构造 DOM 实例, 并将把<!-- --><code>workInProgress</code>指针指向下一个兄弟节点<!-- --><code>fiber(p)</code>.<!-- --></p><p><img alt="" src="/static/unitofwork6.5e595f8a.png"/></p><p><code>performUnitOfWork</code>第 7 次调用(执行<!-- --><code>beginWork</code>和<!-- --><code>completeUnitOfWork</code>):<!-- --></p><ul><li><code>beginWork</code>执行过程: 与上次调用中创建<!-- --><code>fiber(p)</code>节点的逻辑一致<!-- --></li><li><code>completeUnitOfWork</code>执行过程:   以<!-- --><code>fiber(p)</code>为起点, 向上回溯<!-- --></li></ul><p>第 1 次循环:</p><ol><li>执行<!-- --><code>completeWork</code>函数: 创建<!-- --><code>fiber(p)</code>节点对应的<!-- --><code>DOM</code>实例, 并<!-- --><code>append</code>子树节点的<!-- --><code>DOM</code>实例<!-- --></li><li>上移副作用队列: 由于本节点<!-- --><code>fiber(p)</code>没有副作用, 所以执行之后副作用队列没有实质变化(目前为空).<!-- --></li><li>向上回溯: 由于没有兄弟节点, 把<!-- --><code>workInProgress</code>指针指向父节点<!-- --><code>fiber(&lt;Content/&gt;)</code></li></ol><p><img alt="" src="/static/unitofwork7.c44d2d4d.png"/></p><p>第 2 次循环:</p><ol><li>执行<!-- --><code>completeWork</code>函数: class 类型的节点不做处理<!-- --></li><li>上移副作用队列:
<!-- --><ul><li>本节点<!-- --><code>fiber(&lt;Content/&gt;)</code>的<!-- --><code>flags</code>标志位有改动(<!-- --><code>completedWork.flags &gt; PerformedWork</code>), 将本节点添加到父节点(<!-- --><code>fiber(div)</code>)的副作用队列之后(<!-- --><code>firstEffect</code>和<!-- --><code>lastEffect</code>属性分别指向副作用队列的首部和尾部).<!-- --></li></ul></li><li>向上回溯: 把<!-- --><code>workInProgress</code>指针指向父节点<!-- --><code>fiber(div)</code></li></ol><p><img alt="" src="/static/unitofwork7.1.9ab1933f.png"/></p><p>第 3 次循环:</p><ol><li>执行<!-- --><code>completeWork</code>函数: 创建<!-- --><code>fiber(div)</code>节点对应的<!-- --><code>DOM</code>实例, 并<!-- --><code>append</code>子树节点的<!-- --><code>DOM</code>实例<!-- --></li><li>上移副作用队列:
<!-- --><ul><li>本节点<!-- --><code>fiber(div)</code>的副作用队列不为空, 将其拼接到父节点<!-- --><code>fiber&lt;App/&gt;</code>的副作用队列后面.<!-- --></li></ul></li><li>向上回溯: 把<!-- --><code>workInProgress</code>指针指向父节点<!-- --><code>fiber(&lt;App/&gt;)</code></li></ol><p><img alt="" src="/static/unitofwork7.2.ceb09595.png"/></p><p>第 4 次循环:</p><ol><li>执行<!-- --><code>completeWork</code>函数: class 类型的节点不做处理<!-- --></li><li>上移副作用队列:
<!-- --><ul><li>本节点<!-- --><code>fiber(&lt;App/&gt;)</code>的副作用队列不为空, 将其拼接到父节点<!-- --><code>fiber(HostRootFiber)</code>的副作用队列上.<!-- --></li><li>本节点<!-- --><code>fiber(&lt;App/&gt;)</code>的<!-- --><code>flags</code>标志位有改动(<!-- --><code>completedWork.flags &gt; PerformedWork</code>), 将本节点添加到父节点<!-- --><code>fiber(HostRootFiber)</code>的副作用队列之后.<!-- --></li><li>最后队列的顺序是<!-- --><code>子节点在前, 本节点在后</code></li></ul></li><li>向上回溯: 把<!-- --><code>workInProgress</code>指针指向父节点<!-- --><code>fiber(HostRootFiber)</code></li></ol><p><img alt="" src="/static/unitofwork7.3.6620cf39.png"/></p><p>第 5 次循环:</p><ol><li>执行<!-- --><code>completeWork</code>函数: 对于<!-- --><code>HostRoot</code>类型的节点, 初次构造时设置<!-- --><a href="https://github.com/facebook/react/blob/v17.0.2/packages/react-reconciler/src/ReactFiberCompleteWork.old.js#L693">workInProgress.flags |= Snapshot</a></li><li>向上回溯: 由于父节点为空, 无需进入处理副作用队列的逻辑. 最后设置<!-- --><code>workInProgress=null</code>, 并退出<!-- --><code>completeUnitOfWork</code></li></ol><p><img alt="" src="/static/unitofwork7.4.e88061c1.png"/></p><p>到此整个<!-- --><code>fiber树构造循环</code>已经执行完毕, 拥有一棵完整的<!-- --><code>fiber树</code>, 并且在<!-- --><code>fiber树</code>的根节点上挂载了副作用队列, 副作用队列的顺序是层级越深子节点越靠前.<!-- --></p><p><code>renderRootSync</code>函数退出之前, 会重置<!-- --><code>workInProgressRoot = null</code>, 表明没有正在进行中的<!-- --><code>render</code>. 且把最新的<!-- --><code>fiber树</code>挂载到<!-- --><code>fiberRoot.finishedWork</code>上. 这时整个 fiber 树的内存结构如下(注意<!-- --><code>fiberRoot.finishedWork</code>和<!-- --><code>fiberRoot.current</code>指针,在<!-- --><code>commitRoot</code>阶段会进行处理):<!-- --></p><p><img alt="" src="/static/fibertree-beforecommit.682ae607.png"/></p><h2 id="总结"><a aria-hidden="true" tabindex="-1" href="#总结"><span class="icon icon-link"></span></a>总结<!-- --></h2><p>本节演示了初次创建<!-- --><code>fiber树</code>的全部过程, 跟踪了创建过程中内存引用的变化情况. <!-- --><code>fiber树构造循环</code>负责构造新的<!-- --><code>fiber</code>树, 构造过程中同时标记<!-- --><code>fiber.flags</code>, 最终把所有被标记的<!-- --><code>fiber</code>节点收集到一个副作用队列中, 这个副作用队列被挂载到根节点上(<!-- --><code>HostRootFiber.alternate.firstEffect</code>). 此时的<!-- --><code>fiber树</code>和与之对应的<!-- --><code>DOM节点</code>都还在内存当中, 等待<!-- --><code>commitRoot</code>阶段进行渲染.<!-- --></p></div></div><script>$RC("B:2","S:2")</script>