<!DOCTYPE html><html><head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<meta name="keywords" content="react, react原理, 图解react, react fiber原理, react hook原理, react 合成事件, react 基本包结构">
<meta name="description" content="图解React原理系列, 以react核心包结构和运行机制为主线索进行展开. 包括react 基本包结构, react 工作循环, react 启动模式, react fiber原理, react hook原理, react 合成事件等核心内容">
<link rel="shortcut icon" href="/km@2x.png">
<link rel="stylesheet" href="/umi.eb36fa83.css">
<title data-rh="true">合成事件</title>
<meta data-rh="true" property="og:title" content="合成事件"/><meta data-rh="true" name="description" content="从v17.0.0开始, React 不会再将事件处理添加到 document 上, 而是将事件处理添加到渲染 React 树的根 DOM 容器中."/><meta data-rh="true" property="og:description" content="从v17.0.0开始, React 不会再将事件处理添加到 document 上, 而是将事件处理添加到渲染 React 树的根 DOM 容器中."/>
</head>
<body>
<noscript><b>Enable JavaScript to run this app.</b></noscript><div id="root"><!--$?--><template id="B:0"></template><div></div><!--/$--></div><script>window.__UMI_LOADER_DATA__ = {}</script>
<script src="/umi.c14ba5aa.js"></script>

</body></html><div hidden id="S:0"><!--$?--><template id="B:1"></template><div></div><!--/$--></div><script>function $RC(a,b){a=document.getElementById(a);b=document.getElementById(b);b.parentNode.removeChild(b);if(a){a=a.previousSibling;var f=a.parentNode,c=a.nextSibling,e=0;do{if(c&&8===c.nodeType){var d=c.data;if("/$"===d)if(0===e)break;else e--;else"$"!==d&&"$?"!==d&&"$!"!==d||e++}d=c.nextSibling;f.removeChild(c);c=d}while(c);for(;b.firstChild;)f.insertBefore(b.firstChild,c);a.data="$";a._reactRetry&&a._reactRetry()}};$RC("B:0","S:0")</script><div hidden id="S:1"><div class="dumi-default-doc-layout"><div class="dumi-default-header"><div class="dumi-default-header-content"><section class="dumi-default-header-left"><a class="dumi-default-logo" href="/"><img src="/logo.png" alt="图解React"/>图解React<!-- --></a></section><section class="dumi-default-header-right"><ul class="dumi-default-navbar"><li><a class="active" href="/main/macro-structure">原理解析</a></li><li><a href="/algorithm/diff">高频算法</a></li><li><a href="/interview/01-setstate">面试题</a></li></ul><div class="dumi-default-header-right-aside"><div class="dumi-default-search-bar"><svg viewBox="64 64 896 896" class="dumi-default-search-bar-svg"><path d="M909.6 854.5 649.9 594.8C690.2 542.7 712 479 712 412c0-80.2-31.3-155.4-87.9-212.1-56.6-56.7-132-87.9-212.1-87.9s-155.5 31.3-212.1 87.9C143.2 256.5 112 331.8 112 412c0 80.1 31.3 155.5 87.9 212.1C256.5 680.8 331.8 712 412 712c67 0 130.6-21.8 182.7-62l259.7 259.6a8.2 8.2 0 0 0 11.6 0l43.6-43.5a8.2 8.2 0 0 0 0-11.6zM570.4 570.4C528 612.7 471.8 636 412 636s-116-23.3-158.4-65.6C211.3 528 188 471.8 188 412s23.3-116.1 65.6-158.4C296 211.3 352.2 188 412 188s116.1 23.2 158.4 65.6S636 352.2 636 412s-23.3 116.1-65.6 158.4z"></path></svg><input class="dumi-default-search-bar-input" placeholder="输入关键字搜索..."/><span class="dumi-default-search-shortcut">⌘<!-- --> K<!-- --></span></div><span class="dumi-default-color-switch" data-dumi-tooltip="亮色模式" data-dumi-tooltip-bottom="true"><svg viewBox="0 0 16 16"><path d="M8 13a1 1 0 0 1 1 1v1a1 1 0 1 1-2 0v-1a1 1 0 0 1 1-1ZM8 3a1 1 0 0 1-1-1V1a1 1 0 1 1 2 0v1a1 1 0 0 1-1 1Zm7 4a1 1 0 1 1 0 2h-1a1 1 0 1 1 0-2h1ZM3 8a1 1 0 0 1-1 1H1a1 1 0 1 1 0-2h1a1 1 0 0 1 1 1Zm9.95 3.536.707.707a1 1 0 0 1-1.414 1.414l-.707-.707a1 1 0 0 1 1.414-1.414Zm-9.9-7.072-.707-.707a1 1 0 0 1 1.414-1.414l.707.707A1 1 0 0 1 3.05 4.464Zm9.9 0a1 1 0 0 1-1.414-1.414l.707-.707a1 1 0 0 1 1.414 1.414l-.707.707Zm-9.9 7.072a1 1 0 0 1 1.414 1.414l-.707.707a1 1 0 0 1-1.414-1.414l.707-.707ZM8 4a4 4 0 1 0 0 8 4 4 0 0 0 0-8Zm0 6.5a2.5 2.5 0 1 1 0-5 2.5 2.5 0 0 1 0 5Z"></path></svg><select><option value="light" selected="">亮色模式<!-- --></option><option value="dark">暗色模式<!-- --></option><option value="auto">跟随系统<!-- --></option></select></span><a class="dumi-default-icon" data-dumi-tooltip="GitHub" data-dumi-tooltip-bottom="true" target="_blank" href="https://github.com/7kms/react-illustration-series" rel="noreferrer"><svg viewBox="64 64 896 896"><path d="M511.6 76.3C264.3 76.2 64 276.4 64 523.5 64 718.9 189.3 885 363.8 946c23.5 5.9 19.9-10.8 19.9-22.2v-77.5c-135.7 15.9-141.2-73.9-150.3-88.9C215 726 171.5 718 184.5 703c30.9-15.9 62.4 4 98.9 57.9 26.4 39.1 77.9 32.5 104 26 5.7-23.5 17.9-44.5 34.7-60.8-140.6-25.2-199.2-111-199.2-213 0-49.5 16.3-95 48.3-131.7-20.4-60.5 1.9-112.3 4.9-120 58.1-5.2 118.5 41.6 123.2 45.3 33-8.9 70.7-13.6 112.9-13.6 42.4 0 80.2 4.9 113.5 13.9 11.3-8.6 67.3-48.8 121.3-43.9 2.9 7.7 24.7 58.3 5.5 118 32.4 36.8 48.9 82.7 48.9 132.3 0 102.2-59 188.1-200 212.9a127.5 127.5 0 0 1 38.1 91v112.5c.8 9 0 17.9 15 17.9 177.1-59.7 304.6-227 304.6-424.1 0-247.2-200.4-447.3-447.5-447.3z"></path></svg></a></div></section><button type="button" class="dumi-default-header-menu-btn"><svg viewBox="64 64 896 896"><path d="M904 160H120c-4.4 0-8 3.6-8 8v64c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-64c0-4.4-3.6-8-8-8zm0 624H120c-4.4 0-8 3.6-8 8v64c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-64c0-4.4-3.6-8-8-8zm0-312H120c-4.4 0-8 3.6-8 8v64c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-64c0-4.4-3.6-8-8-8z"></path></svg></button></div></div><div class="dumi-default-doc-layout-mobile-bar"><button type="button" class="dumi-default-sidebar-btn"><svg viewBox="64 64 896 896"><path d="M120 230h496c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm0 424h496c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm784 140H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0-424H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8z"></path></svg>侧边菜单<!-- --></button></div><main><div class="dumi-default-sidebar"><dl class="dumi-default-sidebar-group"><dt>基本概念</dt><dd><a title="宏观包结构" class="" href="/main/macro-structure">宏观包结构</a></dd><dd><a title="两大工作循环" class="" href="/main/workloop">两大工作循环</a></dd><dd><a title="高频对象" class="" href="/main/object-structure">高频对象</a></dd></dl><dl class="dumi-default-sidebar-group"><dt>运行核心</dt><dd><a title="启动过程" class="" href="/main/bootstrap">启动过程</a></dd><dd><a title="reconciler 运作流程" class="" href="/main/reconciler-workflow">reconciler 运作流程</a></dd><dd><a title="优先级管理" class="" href="/main/priority">优先级管理</a></dd><dd><a title="调度原理" class="" href="/main/scheduler">调度原理</a></dd><dd><a title="fiber 树构造(基础准备)" class="" href="/main/fibertree-prepare">fiber 树构造(基础准备)</a></dd><dd><a title="fiber 树构造(初次创建)" class="" href="/main/fibertree-create">fiber 树构造(初次创建)</a></dd><dd><a title="fiber 树构造(对比更新)" class="" href="/main/fibertree-update">fiber 树构造(对比更新)</a></dd><dd><a title="fiber 树渲染" class="" href="/main/fibertree-commit">fiber 树渲染</a></dd></dl><dl class="dumi-default-sidebar-group"><dt>状态管理</dt><dd><a title="状态与副作用" class="" href="/main/state-effects">状态与副作用</a></dd><dd><a title="Hook 原理(概览)" class="" href="/main/hook-summary">Hook 原理(概览)</a></dd><dd><a title="Hook 原理(状态Hook)" class="" href="/main/hook-state">Hook 原理(状态Hook)</a></dd><dd><a title="Hook 原理(副作用Hook)" class="" href="/main/hook-effect">Hook 原理(副作用Hook)</a></dd><dd><a title="context 原理" class="" href="/main/context">context 原理</a></dd></dl><dl class="dumi-default-sidebar-group"><dt>交互</dt><dd><a title="合成事件" aria-current="page" class="active" href="/main/synthetic-event">合成事件</a></dd></dl></div><div class="dumi-default-content"><!--$?--><template id="B:2"></template><div></div><!--/$--><div class="dumi-default-footer">Copyright © 2023 | Powered by <a href="https://d.umijs.org" target="_blank" rel="noreferrer">dumi</a></div></div></main></div></div><script>$RC("B:1","S:1")</script><div hidden id="S:2"><div class="markdown"><h1 id="react-合成事件"><a aria-hidden="true" tabindex="-1" href="#react-合成事件"><span class="icon icon-link"></span></a>React 合成事件<!-- --></h1><h2 id="概览"><a aria-hidden="true" tabindex="-1" href="#概览"><span class="icon icon-link"></span></a>概览<!-- --></h2><p>从<!-- --><code>v17.0.0</code>开始, React 不会再将事件处理添加到 <!-- --><code>document</code> 上, 而是将事件处理添加到渲染 React 树的根 DOM 容器中.<!-- --></p><p>引入官方提供的图片:</p><p><img src="https://zh-hans.reactjs.org/static/bb4b10114882a50090b8ff61b3c4d0fd/1e088/react_17_delegation.png" alt=""/></p><p>图中清晰的展示了<!-- --><code>v17.0.0</code>的改动, 无论是在<!-- --><code>document</code>还是<!-- --><code>根 DOM 容器</code>上监听事件, 都可以归为<!-- --><code>事件委托(代理)</code>(<!-- --><a href="https://developer.mozilla.org/zh-CN/docs/Learn/JavaScript/Building_blocks/Events">mdn</a>).<!-- --></p><p>注意: <!-- --><code>react</code>的事件体系, 不是全部都通过<!-- --><code>事件委托</code>来实现的. 有一些<!-- --><a href="https://github.com/facebook/react/blob/v17.0.2/packages/react-dom/src/client/ReactDOMComponent.js#L530-L616">特殊情况</a>, 是直接绑定到对应 DOM 元素上的(如:<!-- --><code>scroll</code>, <!-- --><code>load</code>), 它们都通过<!-- --><a href="https://github.com/facebook/react/blob/v17.0.2/packages/react-dom/src/events/DOMPluginEventSystem.js#L295-L314">listenToNonDelegatedEvent</a>函数进行绑定.<!-- --></p><p>上述特殊事件最大的不同是监听的 DOM 元素不同, 除此之外, 其他地方的实现与正常事件大体一致.</p><p>本节讨论的是可以被<!-- --><code>根 DOM 容器</code>代理的正常事件.<!-- --></p><h2 id="事件绑定"><a aria-hidden="true" tabindex="-1" href="#事件绑定"><span class="icon icon-link"></span></a>事件绑定<!-- --></h2><p>在前文<!-- --><a href="/main/bootstrap#create-global-obj">React 应用的启动过程</a>中介绍了<!-- --><code>React</code>在启动时会创建全局对象, 其中在创建<!-- --><a href="/main/bootstrap#create-root-impl">fiberRoot</a>对象时, 调用<!-- --><a href="https://github.com/facebook/react/blob/v17.0.2/packages/react-dom/src/client/ReactDOMRoot.js#L120-L169">createRootImpl</a>:<!-- --></p><div class="dumi-default-source-code"><button type="button" class="dumi-default-source-code-copy"><svg viewBox="64 64 896 896"><path d="M832 64H296c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h496v688c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8V96c0-17.7-14.3-32-32-32zM704 192H192c-17.7 0-32 14.3-32 32v530.7c0 8.5 3.4 16.6 9.4 22.6l173.3 173.3c2.2 2.2 4.7 4 7.4 5.5v1.9h4.2c3.5 1.3 7.2 2 11 2H704c17.7 0 32-14.3 32-32V224c0-17.7-14.3-32-32-32zM350 856.2 263.9 770H350v86.2zM664 888H414V746c0-22.1-17.9-40-40-40H232V264h432v624z"></path></svg></button><pre class="prism-code language-js"><div class=""><div class=""><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">createRootImpl</span><span class="token punctuation">(</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token parameter literal-property property">container</span><span class="token parameter operator">:</span><span class="token parameter"> </span><span class="token parameter maybe-class-name">Container</span><span class="token parameter punctuation">,</span><span class="token parameter"></span></div></div><div class=""><div class=""><span class="token parameter">  </span><span class="token parameter literal-property property">tag</span><span class="token parameter operator">:</span><span class="token parameter"> </span><span class="token parameter maybe-class-name">RootTag</span><span class="token parameter punctuation">,</span><span class="token parameter"></span></div></div><div class=""><div class=""><span class="token parameter">  </span><span class="token parameter literal-property property">options</span><span class="token parameter operator">:</span><span class="token parameter"> </span><span class="token parameter keyword">void</span><span class="token parameter"> </span><span class="token parameter operator">|</span><span class="token parameter"> </span><span class="token parameter maybe-class-name">RootOptions</span><span class="token parameter punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token comment">// ... 省略无关代码</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">enableEagerRootListeners</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token keyword">const</span><span class="token plain"> rootContainerElement </span><span class="token operator">=</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      container</span><span class="token punctuation">.</span><span class="token property-access">nodeType</span><span class="token plain"> </span><span class="token operator">===</span><span class="token plain"> </span><span class="token constant">COMMENT_NODE</span><span class="token plain"> </span><span class="token operator">?</span><span class="token plain"> container</span><span class="token punctuation">.</span><span class="token property-access">parentNode</span><span class="token plain"> </span><span class="token operator">:</span><span class="token plain"> container</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token function">listenToAllSupportedEvents</span><span class="token punctuation">(</span><span class="token plain">rootContainerElement</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token comment">// ... 省略无关代码</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token punctuation">}</span></div></div></pre></div><p><a href="https://github.com/facebook/react/blob/v17.0.2/packages/react-dom/src/events/DOMPluginEventSystem.js#L316-L349">listenToAllSupportedEvents</a>函数, 实际上完成了事件代理:<!-- --></p><div class="dumi-default-source-code"><button type="button" class="dumi-default-source-code-copy"><svg viewBox="64 64 896 896"><path d="M832 64H296c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h496v688c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8V96c0-17.7-14.3-32-32-32zM704 192H192c-17.7 0-32 14.3-32 32v530.7c0 8.5 3.4 16.6 9.4 22.6l173.3 173.3c2.2 2.2 4.7 4 7.4 5.5v1.9h4.2c3.5 1.3 7.2 2 11 2H704c17.7 0 32-14.3 32-32V224c0-17.7-14.3-32-32-32zM350 856.2 263.9 770H350v86.2zM664 888H414V746c0-22.1-17.9-40-40-40H232V264h432v624z"></path></svg></button><pre class="prism-code language-js"><div class=""><div class=""><span class="token comment">// ... 省略无关代码</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token keyword module">export</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">listenToAllSupportedEvents</span><span class="token punctuation">(</span><span class="token parameter literal-property property">rootContainerElement</span><span class="token parameter operator">:</span><span class="token parameter"> </span><span class="token parameter maybe-class-name">EventTarget</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">enableEagerRootListeners</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token comment">// 1. 节流优化, 保证全局注册只被调用一次</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token plain">rootContainerElement</span><span class="token operator">:</span><span class="token plain"> any</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token plain">listeningMarker</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token keyword control-flow">return</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token punctuation">(</span><span class="token plain">rootContainerElement</span><span class="token operator">:</span><span class="token plain"> any</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token plain">listeningMarker</span><span class="token punctuation">]</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token comment">// 2. 遍历allNativeEvents 监听冒泡和捕获阶段的事件</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    allNativeEvents</span><span class="token punctuation">.</span><span class="token method function property-access">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">domEventName</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token plain">nonDelegatedEvents</span><span class="token punctuation">.</span><span class="token method function property-access">has</span><span class="token punctuation">(</span><span class="token plain">domEventName</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">        </span><span class="token function">listenToNativeEvent</span><span class="token punctuation">(</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">          domEventName</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">          </span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token comment">// 冒泡阶段监听</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">          </span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token plain">rootContainerElement</span><span class="token operator">:</span><span class="token plain"> any</span><span class="token punctuation">)</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">Element</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">          </span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">        </span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token function">listenToNativeEvent</span><span class="token punctuation">(</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">        domEventName</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">        </span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token comment">// 捕获阶段监听</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">        </span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token plain">rootContainerElement</span><span class="token operator">:</span><span class="token plain"> any</span><span class="token punctuation">)</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">Element</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">        </span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token punctuation">}</span></div></div></pre></div><p>核心逻辑:</p><ol><li>节流优化, 保证全局注册只被调用一次.</li><li>遍历<!-- --><code>allNativeEvents</code>, 调用<!-- --><code>listenToNativeEvent</code>监听冒泡和捕获阶段的事件.
<!-- --><ul><li><code>allNativeEvents</code>包括了大量的原生事件名称, 它是在<!-- --><code>DOMPluginEventSystem.js</code>中<!-- --><a href="https://github.com/facebook/react/blob/v17.0.2/packages/react-dom/src/events/DOMPluginEventSystem.js#L89-L93">被初始化</a></li></ul></li></ol><p><a href="https://github.com/facebook/react/blob/v17.0.2/packages/react-dom/src/events/DOMPluginEventSystem.js#L351-L412">listenToNativeEvent</a>:<!-- --></p><div class="dumi-default-source-code"><button type="button" class="dumi-default-source-code-copy"><svg viewBox="64 64 896 896"><path d="M832 64H296c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h496v688c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8V96c0-17.7-14.3-32-32-32zM704 192H192c-17.7 0-32 14.3-32 32v530.7c0 8.5 3.4 16.6 9.4 22.6l173.3 173.3c2.2 2.2 4.7 4 7.4 5.5v1.9h4.2c3.5 1.3 7.2 2 11 2H704c17.7 0 32-14.3 32-32V224c0-17.7-14.3-32-32-32zM350 856.2 263.9 770H350v86.2zM664 888H414V746c0-22.1-17.9-40-40-40H232V264h432v624z"></path></svg></button><pre class="prism-code language-js"><div class=""><div class=""><span class="token comment">// ... 省略无关代码</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token keyword module">export</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">listenToNativeEvent</span><span class="token punctuation">(</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token parameter literal-property property">domEventName</span><span class="token parameter operator">:</span><span class="token parameter"> </span><span class="token parameter maybe-class-name">DOMEventName</span><span class="token parameter punctuation">,</span><span class="token parameter"></span></div></div><div class=""><div class=""><span class="token parameter">  </span><span class="token parameter literal-property property">isCapturePhaseListener</span><span class="token parameter operator">:</span><span class="token parameter"> boolean</span><span class="token parameter punctuation">,</span><span class="token parameter"></span></div></div><div class=""><div class=""><span class="token parameter">  </span><span class="token parameter literal-property property">rootContainerElement</span><span class="token parameter operator">:</span><span class="token parameter"> </span><span class="token parameter maybe-class-name">EventTarget</span><span class="token parameter punctuation">,</span><span class="token parameter"></span></div></div><div class=""><div class=""><span class="token parameter">  </span><span class="token parameter literal-property property">targetElement</span><span class="token parameter operator">:</span><span class="token parameter"> </span><span class="token parameter maybe-class-name">Element</span><span class="token parameter"> </span><span class="token parameter operator">|</span><span class="token parameter"> </span><span class="token parameter keyword null nil">null</span><span class="token parameter punctuation">,</span><span class="token parameter"></span></div></div><div class=""><div class=""><span class="token parameter">  eventSystemFlags</span><span class="token parameter operator">?</span><span class="token parameter operator">:</span><span class="token parameter"> </span><span class="token parameter maybe-class-name">EventSystemFlags</span><span class="token parameter"> </span><span class="token parameter operator">=</span><span class="token parameter"> </span><span class="token parameter number">0</span><span class="token parameter punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token punctuation">)</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword">void</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword">let</span><span class="token plain"> target </span><span class="token operator">=</span><span class="token plain"> rootContainerElement</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">
</span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> listenerSet </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">getEventListenerSet</span><span class="token punctuation">(</span><span class="token plain">target</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> listenerSetKey </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">getListenerSetKey</span><span class="token punctuation">(</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    domEventName</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    isCapturePhaseListener</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token comment">// 利用set数据结构, 保证相同的事件类型只会被注册一 次.</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token plain">listenerSet</span><span class="token punctuation">.</span><span class="token method function property-access">has</span><span class="token punctuation">(</span><span class="token plain">listenerSetKey</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">isCapturePhaseListener</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      eventSystemFlags </span><span class="token operator">|=</span><span class="token plain"> </span><span class="token constant">IS_CAPTURE_PHASE</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token comment">// 注册事件监听</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token function">addTrappedEventListener</span><span class="token punctuation">(</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      target</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      domEventName</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      eventSystemFlags</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      isCapturePhaseListener</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    listenerSet</span><span class="token punctuation">.</span><span class="token method function property-access">add</span><span class="token punctuation">(</span><span class="token plain">listenerSetKey</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token punctuation">}</span></div></div></pre></div><p><a href="https://github.com/facebook/react/blob/v17.0.2/packages/react-dom/src/events/DOMPluginEventSystem.js#L468-L560">addTrappedEventListener</a>:<!-- --></p><div class="dumi-default-source-code"><button type="button" class="dumi-default-source-code-copy"><svg viewBox="64 64 896 896"><path d="M832 64H296c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h496v688c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8V96c0-17.7-14.3-32-32-32zM704 192H192c-17.7 0-32 14.3-32 32v530.7c0 8.5 3.4 16.6 9.4 22.6l173.3 173.3c2.2 2.2 4.7 4 7.4 5.5v1.9h4.2c3.5 1.3 7.2 2 11 2H704c17.7 0 32-14.3 32-32V224c0-17.7-14.3-32-32-32zM350 856.2 263.9 770H350v86.2zM664 888H414V746c0-22.1-17.9-40-40-40H232V264h432v624z"></path></svg></button><pre class="prism-code language-js"><div class=""><div class=""><span class="token comment">// ... 省略无关代码</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">addTrappedEventListener</span><span class="token punctuation">(</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token parameter literal-property property">targetContainer</span><span class="token parameter operator">:</span><span class="token parameter"> </span><span class="token parameter maybe-class-name">EventTarget</span><span class="token parameter punctuation">,</span><span class="token parameter"></span></div></div><div class=""><div class=""><span class="token parameter">  </span><span class="token parameter literal-property property">domEventName</span><span class="token parameter operator">:</span><span class="token parameter"> </span><span class="token parameter maybe-class-name">DOMEventName</span><span class="token parameter punctuation">,</span><span class="token parameter"></span></div></div><div class=""><div class=""><span class="token parameter">  </span><span class="token parameter literal-property property">eventSystemFlags</span><span class="token parameter operator">:</span><span class="token parameter"> </span><span class="token parameter maybe-class-name">EventSystemFlags</span><span class="token parameter punctuation">,</span><span class="token parameter"></span></div></div><div class=""><div class=""><span class="token parameter">  </span><span class="token parameter literal-property property">isCapturePhaseListener</span><span class="token parameter operator">:</span><span class="token parameter"> boolean</span><span class="token parameter punctuation">,</span><span class="token parameter"></span></div></div><div class=""><div class=""><span class="token parameter">  isDeferredListenerForLegacyFBSupport</span><span class="token parameter operator">?</span><span class="token parameter operator">:</span><span class="token parameter"> boolean</span><span class="token parameter punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token comment">// 1. 构造listener</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword">let</span><span class="token plain"> listener </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">createEventListenerWrapperWithPriority</span><span class="token punctuation">(</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    targetContainer</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    domEventName</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    eventSystemFlags</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword">let</span><span class="token plain"> unsubscribeListener</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token comment">// 2. 注册事件监听</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">isCapturePhaseListener</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    unsubscribeListener </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">addEventCaptureListener</span><span class="token punctuation">(</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      targetContainer</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      domEventName</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      listener</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword control-flow">else</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    unsubscribeListener </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">addEventBubbleListener</span><span class="token punctuation">(</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      targetContainer</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      domEventName</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      listener</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">
</span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token comment">// 注册原生事件 冒泡</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token keyword module">export</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">addEventBubbleListener</span><span class="token punctuation">(</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token parameter literal-property property">target</span><span class="token parameter operator">:</span><span class="token parameter"> </span><span class="token parameter maybe-class-name">EventTarget</span><span class="token parameter punctuation">,</span><span class="token parameter"></span></div></div><div class=""><div class=""><span class="token parameter">  </span><span class="token parameter literal-property property">eventType</span><span class="token parameter operator">:</span><span class="token parameter"> string</span><span class="token parameter punctuation">,</span><span class="token parameter"></span></div></div><div class=""><div class=""><span class="token parameter">  </span><span class="token parameter literal-property property">listener</span><span class="token parameter operator">:</span><span class="token parameter"> </span><span class="token parameter known-class-name class-name">Function</span><span class="token parameter punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token punctuation">)</span><span class="token operator">:</span><span class="token plain"> </span><span class="token known-class-name class-name">Function</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  target</span><span class="token punctuation">.</span><span class="token method function property-access">addEventListener</span><span class="token punctuation">(</span><span class="token plain">eventType</span><span class="token punctuation">,</span><span class="token plain"> listener</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword control-flow">return</span><span class="token plain"> listener</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">
</span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token comment">// 注册原生事件 捕获</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token keyword module">export</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">addEventCaptureListener</span><span class="token punctuation">(</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token parameter literal-property property">target</span><span class="token parameter operator">:</span><span class="token parameter"> </span><span class="token parameter maybe-class-name">EventTarget</span><span class="token parameter punctuation">,</span><span class="token parameter"></span></div></div><div class=""><div class=""><span class="token parameter">  </span><span class="token parameter literal-property property">eventType</span><span class="token parameter operator">:</span><span class="token parameter"> string</span><span class="token parameter punctuation">,</span><span class="token parameter"></span></div></div><div class=""><div class=""><span class="token parameter">  </span><span class="token parameter literal-property property">listener</span><span class="token parameter operator">:</span><span class="token parameter"> </span><span class="token parameter known-class-name class-name">Function</span><span class="token parameter punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token punctuation">)</span><span class="token operator">:</span><span class="token plain"> </span><span class="token known-class-name class-name">Function</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  target</span><span class="token punctuation">.</span><span class="token method function property-access">addEventListener</span><span class="token punctuation">(</span><span class="token plain">eventType</span><span class="token punctuation">,</span><span class="token plain"> listener</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword control-flow">return</span><span class="token plain"> listener</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token punctuation">}</span></div></div></pre></div><p>从<!-- --><code>listenToAllSupportedEvents</code>开始, 调用链路比较长, 最后调用<!-- --><code>addEventBubbleListener</code>和<!-- --><code>addEventCaptureListener</code>监听了原生事件.<!-- --></p><h3 id="原生-listener"><a aria-hidden="true" tabindex="-1" href="#原生-listener"><span class="icon icon-link"></span></a>原生 listener<!-- --></h3><p>在注册原生事件的过程中, 需要重点关注一下监听函数, 即<!-- --><code>listener</code>函数. 它实现了把原生事件派发到<!-- --><code>react</code>体系之内, 非常关键.<!-- --></p><blockquote><p>比如点击 DOM 触发原生事件, 原生事件最后会被派发到<!-- --><code>react</code>内部的<!-- --><code>onClick</code>函数. <!-- --><code>listener</code>函数就是这个<!-- --><code>由外至内</code>的关键环节.<!-- --></p></blockquote><p><code>listener</code>是通过<!-- --><code>createEventListenerWrapperWithPriority</code>函数产生:<!-- --></p><div class="dumi-default-source-code"><button type="button" class="dumi-default-source-code-copy"><svg viewBox="64 64 896 896"><path d="M832 64H296c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h496v688c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8V96c0-17.7-14.3-32-32-32zM704 192H192c-17.7 0-32 14.3-32 32v530.7c0 8.5 3.4 16.6 9.4 22.6l173.3 173.3c2.2 2.2 4.7 4 7.4 5.5v1.9h4.2c3.5 1.3 7.2 2 11 2H704c17.7 0 32-14.3 32-32V224c0-17.7-14.3-32-32-32zM350 856.2 263.9 770H350v86.2zM664 888H414V746c0-22.1-17.9-40-40-40H232V264h432v624z"></path></svg></button><pre class="prism-code language-js"><div class=""><div class=""><span class="token keyword module">export</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">createEventListenerWrapperWithPriority</span><span class="token punctuation">(</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token parameter literal-property property">targetContainer</span><span class="token parameter operator">:</span><span class="token parameter"> </span><span class="token parameter maybe-class-name">EventTarget</span><span class="token parameter punctuation">,</span><span class="token parameter"></span></div></div><div class=""><div class=""><span class="token parameter">  </span><span class="token parameter literal-property property">domEventName</span><span class="token parameter operator">:</span><span class="token parameter"> </span><span class="token parameter maybe-class-name">DOMEventName</span><span class="token parameter punctuation">,</span><span class="token parameter"></span></div></div><div class=""><div class=""><span class="token parameter">  </span><span class="token parameter literal-property property">eventSystemFlags</span><span class="token parameter operator">:</span><span class="token parameter"> </span><span class="token parameter maybe-class-name">EventSystemFlags</span><span class="token parameter punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token punctuation">)</span><span class="token operator">:</span><span class="token plain"> </span><span class="token known-class-name class-name">Function</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token comment">// 1. 根据优先级设置 listenerWrapper</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> eventPriority </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">getEventPriorityForPluginSystem</span><span class="token punctuation">(</span><span class="token plain">domEventName</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword">let</span><span class="token plain"> listenerWrapper</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword control-flow">switch</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">eventPriority</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token keyword">case</span><span class="token plain"> </span><span class="token literal-property property">DiscreteEvent</span><span class="token operator">:</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      listenerWrapper </span><span class="token operator">=</span><span class="token plain"> dispatchDiscreteEvent</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token keyword control-flow">break</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token keyword">case</span><span class="token plain"> </span><span class="token literal-property property">UserBlockingEvent</span><span class="token operator">:</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      listenerWrapper </span><span class="token operator">=</span><span class="token plain"> dispatchUserBlockingUpdate</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token keyword control-flow">break</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token keyword">case</span><span class="token plain"> </span><span class="token literal-property property">ContinuousEvent</span><span class="token operator">:</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token keyword module">default</span><span class="token operator">:</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      listenerWrapper </span><span class="token operator">=</span><span class="token plain"> dispatchEvent</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token keyword control-flow">break</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token comment">// 2. 返回 listenerWrapper</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword control-flow">return</span><span class="token plain"> listenerWrapper</span><span class="token punctuation">.</span><span class="token method function property-access">bind</span><span class="token punctuation">(</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    domEventName</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    eventSystemFlags</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    targetContainer</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token punctuation">}</span></div></div></pre></div><p>可以看到, 不同的<!-- --><code>domEventName</code>调用<!-- --><code>getEventPriorityForPluginSystem</code>后返回不同的优先级, 最终会有 3 种情况:<!-- --></p><ol><li><code>DiscreteEvent</code>: 优先级最高, 包括<!-- --><code>click, keyDown, input</code>等事件, <!-- --><a href="https://github.com/facebook/react/blob/v17.0.2/packages/react-dom/src/events/DOMEventProperties.js#L45-L80"> 源码</a><ul><li>对应的<!-- --><code>listener</code>是<!-- --><a href="https://github.com/facebook/react/blob/v17.0.2/packages/react-dom/src/events/ReactDOMEventListener.js#L121-L142">dispatchDiscreteEvent</a></li></ul></li><li><code>UserBlockingEvent</code>: 优先级适中, 包括<!-- --><code>drag, scroll</code>等事件, <!-- --><a href="https://github.com/facebook/react/blob/v17.0.2/packages/react-dom/src/events/DOMEventProperties.js#L100-L116">源码</a><ul><li>对应的<!-- --><code>listener</code>是<!-- --><a href="https://github.com/facebook/react/blob/v17.0.2/packages/react-dom/src/events/ReactDOMEventListener.js#L144-L180">dispatchUserBlockingUpdate</a></li></ul></li><li><code>ContinuousEvent</code>: 优先级最低,包括<!-- --><code>animation, load</code>等事件, <!-- --><a href="https://github.com/facebook/react/blob/v17.0.2/packages/react-dom/src/events/DOMEventProperties.js#L119-L145">源码</a><ul><li>对应的<!-- --><code>listener</code>是<!-- --><a href="https://github.com/facebook/react/blob/v17.0.2/packages/react-dom/src/events/ReactDOMEventListener.js#L182-L271">dispatchEvent</a></li></ul></li></ol><p>这 3 种<!-- --><code>listener</code>实际上都是对<!-- --><a href="https://github.com/facebook/react/blob/v17.0.2/packages/react-dom/src/events/ReactDOMEventListener.js#L182-L271">dispatchEvent</a>的包装:<!-- --></p><div class="dumi-default-source-code"><button type="button" class="dumi-default-source-code-copy"><svg viewBox="64 64 896 896"><path d="M832 64H296c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h496v688c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8V96c0-17.7-14.3-32-32-32zM704 192H192c-17.7 0-32 14.3-32 32v530.7c0 8.5 3.4 16.6 9.4 22.6l173.3 173.3c2.2 2.2 4.7 4 7.4 5.5v1.9h4.2c3.5 1.3 7.2 2 11 2H704c17.7 0 32-14.3 32-32V224c0-17.7-14.3-32-32-32zM350 856.2 263.9 770H350v86.2zM664 888H414V746c0-22.1-17.9-40-40-40H232V264h432v624z"></path></svg></button><pre class="prism-code language-js"><div class=""><div class=""><span class="token comment">// ...省略无关代码</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token keyword module">export</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">dispatchEvent</span><span class="token punctuation">(</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token parameter literal-property property">domEventName</span><span class="token parameter operator">:</span><span class="token parameter"> </span><span class="token parameter maybe-class-name">DOMEventName</span><span class="token parameter punctuation">,</span><span class="token parameter"></span></div></div><div class=""><div class=""><span class="token parameter">  </span><span class="token parameter literal-property property">eventSystemFlags</span><span class="token parameter operator">:</span><span class="token parameter"> </span><span class="token parameter maybe-class-name">EventSystemFlags</span><span class="token parameter punctuation">,</span><span class="token parameter"></span></div></div><div class=""><div class=""><span class="token parameter">  </span><span class="token parameter literal-property property">targetContainer</span><span class="token parameter operator">:</span><span class="token parameter"> </span><span class="token parameter maybe-class-name">EventTarget</span><span class="token parameter punctuation">,</span><span class="token parameter"></span></div></div><div class=""><div class=""><span class="token parameter">  </span><span class="token parameter literal-property property">nativeEvent</span><span class="token parameter operator">:</span><span class="token parameter"> </span><span class="token parameter maybe-class-name">AnyNativeEvent</span><span class="token parameter punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token punctuation">)</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword">void</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token plain">_enabled</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token keyword control-flow">return</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> blockedOn </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">attemptToDispatchEvent</span><span class="token punctuation">(</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    domEventName</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    eventSystemFlags</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    targetContainer</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    nativeEvent</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token punctuation">}</span></div></div></pre></div><h2 id="事件触发"><a aria-hidden="true" tabindex="-1" href="#事件触发"><span class="icon icon-link"></span></a>事件触发<!-- --></h2><p>当原生事件触发之后, 首先会进入到<!-- --><code>dispatchEvent</code>这个回调函数. 而<!-- --><code>dispatchEvent</code>函数是<!-- --><code>react</code>事件体系中最关键的函数, 其调用链路较长, 核心步骤如图所示:<!-- --></p><p><img alt="" src="/static/dispatch-event.46e8e5ef.png"/></p><p>重点关注其中 3 个核心环节:</p><ol><li><code>attemptToDispatchEvent</code></li><li><code>SimpleEventPlugin.extractEvents</code></li><li><code>processDispatchQueue</code></li></ol><h3 id="关联-fiber"><a aria-hidden="true" tabindex="-1" href="#关联-fiber"><span class="icon icon-link"></span></a>关联 fiber<!-- --></h3><p><a href="https://github.com/facebook/react/blob/v17.0.2/packages/react-dom/src/events/ReactDOMEventListener.js#L274-L331">attemptToDispatchEvent</a>把原生事件和<!-- --><code>fiber树</code>关联起来.<!-- --></p><div class="dumi-default-source-code"><button type="button" class="dumi-default-source-code-copy"><svg viewBox="64 64 896 896"><path d="M832 64H296c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h496v688c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8V96c0-17.7-14.3-32-32-32zM704 192H192c-17.7 0-32 14.3-32 32v530.7c0 8.5 3.4 16.6 9.4 22.6l173.3 173.3c2.2 2.2 4.7 4 7.4 5.5v1.9h4.2c3.5 1.3 7.2 2 11 2H704c17.7 0 32-14.3 32-32V224c0-17.7-14.3-32-32-32zM350 856.2 263.9 770H350v86.2zM664 888H414V746c0-22.1-17.9-40-40-40H232V264h432v624z"></path></svg></button><pre class="prism-code language-js"><div class=""><div class=""><span class="token keyword module">export</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">attemptToDispatchEvent</span><span class="token punctuation">(</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token parameter literal-property property">domEventName</span><span class="token parameter operator">:</span><span class="token parameter"> </span><span class="token parameter maybe-class-name">DOMEventName</span><span class="token parameter punctuation">,</span><span class="token parameter"></span></div></div><div class=""><div class=""><span class="token parameter">  </span><span class="token parameter literal-property property">eventSystemFlags</span><span class="token parameter operator">:</span><span class="token parameter"> </span><span class="token parameter maybe-class-name">EventSystemFlags</span><span class="token parameter punctuation">,</span><span class="token parameter"></span></div></div><div class=""><div class=""><span class="token parameter">  </span><span class="token parameter literal-property property">targetContainer</span><span class="token parameter operator">:</span><span class="token parameter"> </span><span class="token parameter maybe-class-name">EventTarget</span><span class="token parameter punctuation">,</span><span class="token parameter"></span></div></div><div class=""><div class=""><span class="token parameter">  </span><span class="token parameter literal-property property">nativeEvent</span><span class="token parameter operator">:</span><span class="token parameter"> </span><span class="token parameter maybe-class-name">AnyNativeEvent</span><span class="token parameter punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token punctuation">)</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> </span><span class="token maybe-class-name">Container</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> </span><span class="token maybe-class-name">SuspenseInstance</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token comment">// ...省略无关代码</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">
</span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token comment">// 1. 定位原生DOM节点</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> nativeEventTarget </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">getEventTarget</span><span class="token punctuation">(</span><span class="token plain">nativeEvent</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token comment">// 2. 获取与DOM节点对应的fiber节点</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword">let</span><span class="token plain"> targetInst </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">getClosestInstanceFromNode</span><span class="token punctuation">(</span><span class="token plain">nativeEventTarget</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token comment">// 3. 通  过插件系统, 派发事件</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token function">dispatchEventForPluginEventSystem</span><span class="token punctuation">(</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    domEventName</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    eventSystemFlags</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    nativeEvent</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    targetInst</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    targetContainer</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword control-flow">return</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token punctuation">}</span></div></div></pre></div><p>核心逻辑:</p><ol><li>定位原生 DOM 节点: 调用<!-- --><code>getEventTarget</code></li><li>获取与 DOM 节点对应的 fiber 节点: 调用<!-- --><code>getClosestInstanceFromNode</code></li><li>通过插件系统, 派发事件: 调用 <!-- --><code>dispatchEventForPluginEventSystem</code></li></ol><h3 id="收集-fiber-上 的-listener"><a aria-hidden="true" tabindex="-1" href="#收集-fiber-上的-listener"><span class="icon icon-link"></span></a>收集 fiber 上的 listener<!-- --></h3><p><code>dispatchEvent</code>函数的调用链路中, 通过不同的插件, 处理不同的事件. 其中最常见的事件都会由<!-- --><code>SimpleEventPlugin.extractEvents</code>进行处理:<!-- --></p><div class="dumi-default-source-code"><button type="button" class="dumi-default-source-code-copy"><svg viewBox="64 64 896 896"><path d="M832 64H296c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h496v688c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8V96c0-17.7-14.3-32-32-32zM704 192H192c-17.7 0-32 14.3-32 32v530.7c0 8.5 3.4 16.6 9.4 22.6l173.3 173.3c2.2 2.2 4.7 4 7.4 5.5v1.9h4.2c3.5 1.3 7.2 2 11 2H704c17.7 0 32-14.3 32-32V224c0-17.7-14.3-32-32-32zM350 856.2 263.9 770H350v86.2zM664 888H414V746c0-22.1-17.9-40-40-40H232V264h432v624z"></path></svg></button><pre class="prism-code language-js"><div class=""><div class=""><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">extractEvents</span><span class="token punctuation">(</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token parameter literal-property property">dispatchQueue</span><span class="token parameter operator">:</span><span class="token parameter"> </span><span class="token parameter maybe-class-name">DispatchQueue</span><span class="token parameter punctuation">,</span><span class="token parameter"></span></div></div><div class=""><div class=""><span class="token parameter">  </span><span class="token parameter literal-property property">domEventName</span><span class="token parameter operator">:</span><span class="token parameter"> </span><span class="token parameter maybe-class-name">DOMEventName</span><span class="token parameter punctuation">,</span><span class="token parameter"></span></div></div><div class=""><div class=""><span class="token parameter">  </span><span class="token parameter literal-property property">targetInst</span><span class="token parameter operator">:</span><span class="token parameter"> </span><span class="token parameter keyword null nil">null</span><span class="token parameter"> </span><span class="token parameter operator">|</span><span class="token parameter"> </span><span class="token parameter maybe-class-name">Fiber</span><span class="token parameter punctuation">,</span><span class="token parameter"></span></div></div><div class=""><div class=""><span class="token parameter">  </span><span class="token parameter literal-property property">nativeEvent</span><span class="token parameter operator">:</span><span class="token parameter"> </span><span class="token parameter maybe-class-name">AnyNativeEvent</span><span class="token parameter punctuation">,</span><span class="token parameter"></span></div></div><div class=""><div class=""><span class="token parameter">  </span><span class="token parameter literal-property property">nativeEventTarget</span><span class="token parameter operator">:</span><span class="token parameter"> </span><span class="token parameter keyword null nil">null</span><span class="token parameter"> </span><span class="token parameter operator">|</span><span class="token parameter"> </span><span class="token parameter maybe-class-name">EventTarget</span><span class="token parameter punctuation">,</span><span class="token parameter"></span></div></div><div class=""><div class=""><span class="token parameter">  </span><span class="token parameter literal-property property">eventSystemFlags</span><span class="token parameter operator">:</span><span class="token parameter"> </span><span class="token parameter maybe-class-name">EventSystemFlags</span><span class="token parameter punctuation">,</span><span class="token parameter"></span></div></div><div class=""><div class=""><span class="token parameter">  </span><span class="token parameter literal-property property">targetContainer</span><span class="token parameter operator">:</span><span class="token parameter"> </span><span class="token parameter maybe-class-name">EventTarget</span><span class="token parameter punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token punctuation">)</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword">void</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> reactName </span><span class="token operator">=</span><span class="token plain"> topLevelEventsToReactNames</span><span class="token punctuation">.</span><span class="token method function property-access">get</span><span class="token punctuation">(</span><span class="token plain">domEventName</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">reactName </span><span class="token operator">===</span><span class="token plain"> </span><span class="token keyword nil">undefined</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token keyword control-flow">return</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword">let</span><span class="token plain"> </span><span class="token maybe-class-name">SyntheticEventCtor</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token maybe-class-name">SyntheticEvent</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword">let</span><span class="token plain"> </span><span class="token literal-property property">reactEventType</span><span class="token operator">:</span><span class="token plain"> string </span><span class="token operator">=</span><span class="token plain"> domEventName</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">
</span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> inCapturePhase </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">eventSystemFlags </span><span class="token operator">&amp;</span><span class="token plain"> </span><span class="token constant">IS_CAPTURE_PHASE</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token operator">!==</span><span class="token plain"> </span><span class="token number">0</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> accumulateTargetOnly </span><span class="token operator">=</span><span class="token plain"> </span><span class="token operator">!</span><span class="token plain">inCapturePhase </span><span class="token operator">&amp;&amp;</span><span class="token plain"> domEventName </span><span class="token operator">===</span><span class="token plain"> </span><span class="token string">&#x27;scroll&#x27;</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token comment">// 1. 收集所有监听该事件的函数.</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> listeners </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">accumulateSinglePhaseListeners</span><span class="token punctuation">(</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    targetInst</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    reactName</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    nativeEvent</span><span class="token punctuation">.</span><span class="token property-access">type</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    inCapturePhase</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    accumulateTargetOnly</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">listeners</span><span class="token punctuation">.</span><span class="token property-access">length</span><span class="token plain"> </span><span class="token operator">&gt;</span><span class="token plain"> </span><span class="token number">0</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token comment">// 2. 构造合成事件, 添加到派发队列</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token keyword">const</span><span class="token plain"> event </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name">SyntheticEventCtor</span><span class="token punctuation">(</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      reactName</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      reactEventType</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token keyword null nil">null</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      nativeEvent</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      nativeEventTarget</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    dispatchQueue</span><span class="token punctuation">.</span><span class="token method function property-access">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token plain"> event</span><span class="token punctuation">,</span><span class="token plain"> listeners </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token punctuation">}</span></div></div></pre></div><p>核心逻辑:</p><ol><li><p>收集所有<!-- --><code>listener</code>回调<!-- --></p><ul><li><p>这里的是<!-- --><code>fiber.memoizedProps.onClick/onClickCapture</code>等绑定在<!-- --><code>fiber</code>节点上的回调函数<!-- --></p></li><li><p>具体逻辑在<!-- --><a href="https://github.com/facebook/react/blob/v17.0.2/packages/react-dom/src/events/DOMPluginEventSystem.js#L712-L803">accumulateSinglePhaseListeners</a>:<!-- --></p><div class="dumi-default-source-code"><button type="button" class="dumi-default-source-code-copy"><svg viewBox="64 64 896 896"><path d="M832 64H296c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h496v688c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8V96c0-17.7-14.3-32-32-32zM704 192H192c-17.7 0-32 14.3-32 32v530.7c0 8.5 3.4 16.6 9.4 22.6l173.3 173.3c2.2 2.2 4.7 4 7.4 5.5v1.9h4.2c3.5 1.3 7.2 2 11 2H704c17.7 0 32-14.3 32-32V224c0-17.7-14.3-32-32-32zM350 856.2 263.9 770H350v86.2zM664 888H414V746c0-22.1-17.9-40-40-40H232V264h432v624z"></path></svg></button><pre class="prism-code language-js"><div class=""><div class=""><span class="token keyword module">export</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">accumulateSinglePhaseListeners</span><span class="token punctuation">(</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token parameter literal-property property">targetFiber</span><span class="token parameter operator">:</span><span class="token parameter"> </span><span class="token parameter maybe-class-name">Fiber</span><span class="token parameter"> </span><span class="token parameter operator">|</span><span class="token parameter"> </span><span class="token parameter keyword null nil">null</span><span class="token parameter punctuation">,</span><span class="token parameter"></span></div></div><div class=""><div class=""><span class="token parameter">  </span><span class="token parameter literal-property property">reactName</span><span class="token parameter operator">:</span><span class="token parameter"> string </span><span class="token parameter operator">|</span><span class="token parameter"> </span><span class="token parameter keyword null nil">null</span><span class="token parameter punctuation">,</span><span class="token parameter"></span></div></div><div class=""><div class=""><span class="token parameter">  </span><span class="token parameter literal-property property">nativeEventType</span><span class="token parameter operator">:</span><span class="token parameter"> string</span><span class="token parameter punctuation">,</span><span class="token parameter"></span></div></div><div class=""><div class=""><span class="token parameter">  </span><span class="token parameter literal-property property">inCapturePhase</span><span class="token parameter operator">:</span><span class="token parameter"> boolean</span><span class="token parameter punctuation">,</span><span class="token parameter"></span></div></div><div class=""><div class=""><span class="token parameter">  </span><span class="token parameter literal-property property">accumulateTargetOnly</span><span class="token parameter operator">:</span><span class="token parameter"> boolean</span><span class="token parameter punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token punctuation">)</span><span class="token operator">:</span><span class="token plain"> </span><span class="token known-class-name class-name">Array</span><span class="token operator">&lt;</span><span class="token maybe-class-name">DispatchListener</span><span class="token operator">&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> captureName </span><span class="token operator">=</span><span class="token plain"> reactName </span><span class="token operator">!==</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token plain"> </span><span class="token operator">?</span><span class="token plain"> reactName </span><span class="token operator">+</span><span class="token plain"> </span><span class="token string">&#x27;Capture&#x27;</span><span class="token plain"> </span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> reactEventName </span><span class="token operator">=</span><span class="token plain"> inCapturePhase </span><span class="token operator">?</span><span class="token plain"> captureName </span><span class="token operator">:</span><span class="token plain"> reactName</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> </span><span class="token literal-property property">listeners</span><span class="token operator">:</span><span class="token plain"> </span><span class="token known-class-name class-name">Array</span><span class="token operator">&lt;</span><span class="token maybe-class-name">DispatchListener</span><span class="token operator">&gt;</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">
</span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword">let</span><span class="token plain"> instance </span><span class="token operator">=</span><span class="token plain"> targetFiber</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword">let</span><span class="token plain"> lastHostComponent </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">
</span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token comment">// 从targetFiber开始, 向上遍历, 直到 root 为止</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword control-flow">while</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">instance </span><span class="token operator">!==</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token keyword">const</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"> stateNode</span><span class="token punctuation">,</span><span class="token plain"> tag </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> instance</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token comment">// 当节点类型是HostComponent时(如: div, span, button等类型)</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">tag </span><span class="token operator">===</span><span class="token plain"> </span><span class="token maybe-class-name">HostComponent</span><span class="token plain"> </span><span class="token operator">&amp;&amp;</span><span class="token plain"> stateNode </span><span class="token operator">!==</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      lastHostComponent </span><span class="token operator">=</span><span class="token plain"> stateNode</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">reactEventName </span><span class="token operator">!==</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">        </span><span class="token comment">// 获取标准的监听函数 (如onClick , onClickCapture等)</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">        </span><span class="token keyword">const</span><span class="token plain"> listener </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">getListener</span><span class="token punctuation">(</span><span class="token plain">instance</span><span class="token punctuation">,</span><span class="token plain"> reactEventName</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">        </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">listener </span><span class="token operator">!=</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">          listeners</span><span class="token punctuation">.</span><span class="token method function property-access">push</span><span class="token punctuation">(</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">            </span><span class="token function">createDispatchListener</span><span class="token punctuation">(</span><span class="token plain">instance</span><span class="token punctuation">,</span><span class="token plain"> listener</span><span class="token punctuation">,</span><span class="token plain"> lastHostComponent</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">          </span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">        </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token comment">// 如果只收集目标节点, 则不用向上遍历, 直接退出</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">accumulateTargetOnly</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token keyword control-flow">break</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    instance </span><span class="token operator">=</span><span class="token plain"> instance</span><span class="token punctuation">.</span><span class="token keyword control-flow">return</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword control-flow">return</span><span class="token plain"> listeners</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token punctuation">}</span></div></div></pre></div></li></ul></li><li><p>构造合成事件(<!-- --><code>SyntheticEvent</code>), 添加到派发队列(<!-- --><code>dispatchQueue</code>)<!-- --></p></li></ol><h3 id="构造合成事件"><a aria-hidden="true" tabindex="-1" href="#构造合成事件"><span class="icon icon-link"></span></a>构造合成事件<!-- --></h3><p><a href="https://github.com/facebook/react/blob/v17.0.2/packages/react-dom/src/events/SyntheticEvent.js#L152">SyntheticEvent</a>, 是<!-- --><code>react</code>内部创建的一个对象, 是原生事件的跨浏览器包装器, 拥有和浏览器原生事件相同的接口(<!-- --><code>stopPropagation</code>,<!-- --><code>preventDefault</code>), 抹平不同浏览器 api 的差异, 兼容性好.<!-- --></p><p>具体的构造过程并不复杂, 可以直接<!-- --><a href="https://github.com/facebook/react/blob/v17.0.2/packages/react-dom/src/events/SyntheticEvent.js#L28-L136">查看源码</a>.<!-- --></p><p>此处我们需要知道, 在<!-- --><code>Plugin.extractEvents</code>过程中, 遍历<!-- --><code>fiber树</code>找到<!-- --><code>listener</code>之后, 就会创建<!-- --><code>SyntheticEvent</code>, 加入到<!-- --><code>dispatchQueue</code>中, 等待派发.<!-- --></p><h3 id="执行派发"><a aria-hidden="true" tabindex="-1" href="# 执行派发"><span class="icon icon-link"></span></a>执行派发<!-- --></h3><p><code>extractEvents</code>完成之后, 逻辑来到<!-- --><a href="https://github.com/facebook/react/blob/v17.0.2/packages/react-dom/src/events/DOMPluginEventSystem.js#L260-L272">processDispatchQueue</a>, 终于要真正执行派发了.<!-- --></p><div class="dumi-default-source-code"><button type="button" class="dumi-default-source-code-copy"><svg viewBox="64 64 896 896"><path d="M832 64H296c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h496v688c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8V96c0-17.7-14.3-32-32-32zM704 192H192c-17.7 0-32 14.3-32 32v530.7c0 8.5 3.4 16.6 9.4 22.6l173.3 173.3c2.2 2.2 4.7 4 7.4 5.5v1.9h4.2c3.5 1.3 7.2 2 11 2H704c17.7 0 32-14.3 32-32V224c0-17.7-14.3-32-32-32zM350 856.2 263.9 770H350v86.2zM664 888H414V746c0-22.1-17.9-40-40-40H232V264h432v624z"></path></svg></button><pre class="prism-code language-js"><div class=""><div class=""><span class="token keyword module">export</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">processDispatchQueue</span><span class="token punctuation">(</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token parameter literal-property property">dispatchQueue</span><span class="token parameter operator">:</span><span class="token parameter"> </span><span class="token parameter maybe-class-name">DispatchQueue</span><span class="token parameter punctuation">,</span><span class="token parameter"></span></div></div><div class=""><div class=""><span class="token parameter">  </span><span class="token parameter literal-property property">eventSystemFlags</span><span class="token parameter operator">:</span><span class="token parameter"> </span><span class="token parameter maybe-class-name">EventSystemFlags</span><span class="token parameter punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token punctuation">)</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword">void</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> inCapturePhase </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">eventSystemFlags </span><span class="token operator">&amp;</span><span class="token plain"> </span><span class="token constant">IS_CAPTURE_PHASE</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token operator">!==</span><span class="token plain"> </span><span class="token number">0</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword control-flow">for</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token keyword">let</span><span class="token plain"> i </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">0</span><span class="token punctuation">;</span><span class="token plain"> i </span><span class="token operator">&lt;</span><span class="token plain"> dispatchQueue</span><span class="token punctuation">.</span><span class="token property-access">length</span><span class="token punctuation">;</span><span class="token plain"> i</span><span class="token operator">++</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token keyword">const</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"> event</span><span class="token punctuation">,</span><span class="token plain"> listeners </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> dispatchQueue</span><span class="token punctuation">[</span><span class="token plain">i</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token function">processDispatchQueueItemsInOrder</span><span class="token punctuation">(</span><span class="token plain">event</span><span class="token punctuation">,</span><span class="token plain"> listeners</span><span class="token punctuation">,</span><span class="token plain"> inCapturePhase</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token comment">// ...省略无关代码</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">
</span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">processDispatchQueueItemsInOrder</span><span class="token punctuation">(</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token parameter literal-property property">event</span><span class="token parameter operator">:</span><span class="token parameter"> </span><span class="token parameter maybe-class-name">ReactSyntheticEvent</span><span class="token parameter punctuation">,</span><span class="token parameter"></span></div></div><div class=""><div class=""><span class="token parameter">  </span><span class="token parameter literal-property property">dispatchListeners</span><span class="token parameter operator">:</span><span class="token parameter"> </span><span class="token parameter known-class-name class-name">Array</span><span class="token parameter operator">&lt;</span><span class="token parameter maybe-class-name">DispatchListener</span><span class="token parameter operator">&gt;</span><span class="token parameter punctuation">,</span><span class="token parameter"></span></div></div><div class=""><div class=""><span class="token parameter">  </span><span class="token parameter literal-property property">inCapturePhase</span><span class="token parameter operator">:</span><span class="token parameter"> boolean</span><span class="token parameter punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token punctuation">)</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword">void</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword">let</span><span class="token plain"> previousInstance</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">inCapturePhase</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token comment">// 1. capture事件: 倒序遍历listeners</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token keyword control-flow">for</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token keyword">let</span><span class="token plain"> i </span><span class="token operator">=</span><span class="token plain"> dispatchListeners</span><span class="token punctuation">.</span><span class="token property-access">length</span><span class="token plain"> </span><span class="token operator">-</span><span class="token plain"> </span><span class="token number">1</span><span class="token punctuation">;</span><span class="token plain"> i </span><span class="token operator">&gt;=</span><span class="token plain"> </span><span class="token number">0</span><span class="token punctuation">;</span><span class="token plain"> i</span><span class="token operator">--</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token keyword">const</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"> instance</span><span class="token punctuation">,</span><span class="token plain"> currentTarget</span><span class="token punctuation">,</span><span class="token plain"> listener </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> dispatchListeners</span><span class="token punctuation">[</span><span class="token plain">i</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">instance </span><span class="token operator">!==</span><span class="token plain"> previousInstance </span><span class="token operator">&amp;&amp;</span><span class="token plain"> event</span><span class="token punctuation">.</span><span class="token method function property-access">isPropagationStopped</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">        </span><span class="token keyword control-flow">return</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token function">executeDispatch</span><span class="token punctuation">(</span><span class="token plain">event</span><span class="token punctuation">,</span><span class="token plain"> listener</span><span class="token punctuation">,</span><span class="token plain"> currentTarget</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      previousInstance </span><span class="token operator">=</span><span class="token plain"> instance</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword control-flow">else</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token comment">// 2. bubble事件: 顺序遍历listeners</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token keyword control-flow">for</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token keyword">let</span><span class="token plain"> i </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">0</span><span class="token punctuation">;</span><span class="token plain"> i </span><span class="token operator">&lt;</span><span class="token plain"> dispatchListeners</span><span class="token punctuation">.</span><span class="token property-access">length</span><span class="token punctuation">;</span><span class="token plain"> i</span><span class="token operator">++</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token keyword">const</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"> instance</span><span class="token punctuation">,</span><span class="token plain"> currentTarget</span><span class="token punctuation">,</span><span class="token plain"> listener </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> dispatchListeners</span><span class="token punctuation">[</span><span class="token plain">i</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">instance </span><span class="token operator">!==</span><span class="token plain"> previousInstance </span><span class="token operator">&amp;&amp;</span><span class="token plain"> event</span><span class="token punctuation">.</span><span class="token method function property-access">isPropagationStopped</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">        </span><span class="token keyword control-flow">return</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token function">executeDispatch</span><span class="token punctuation">(</span><span class="token plain">event</span><span class="token punctuation">,</span><span class="token plain"> listener</span><span class="token punctuation">,</span><span class="token plain"> currentTarget</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      previousInstance </span><span class="token operator">=</span><span class="token plain"> instance</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token punctuation">}</span></div></div></pre></div><p>在<!-- --><a href="https://github.com/facebook/react/blob/v17.0.2/packages/react-dom/src/events/DOMPluginEventSystem.js#L233-L258">processDispatchQueueItemsInOrder</a>遍历<!-- --><code>dispatchListeners</code>数组, 执行<!-- --><a href="https://github.com/facebook/react/blob/v17.0.2/packages/react-dom/src/events/DOMPluginEventSystem.js#L222-L231">executeDispatch</a>派发事件, 在<!-- --><code>fiber</code>节点上绑定的<!-- --><code>listener</code>函数被执行.<!-- --></p><p>在<!-- --><code>processDispatchQueueItemsInOrder</code>函数中, 根据<!-- --><code>捕获(capture)</code>或<!-- --><code>冒泡(bubble)</code>的不同, 采取了不同的遍历方式:<!-- --></p><ol><li><code>capture</code>事件: <!-- --><code>从上至下</code>调用<!-- --><code>fiber树</code>中绑定的回调函数, 所以<!-- --><code>倒序</code>遍历<!-- --><code>dispatchListeners</code>.<!-- --></li><li><code>bubble</code>事件: <!-- --><code>从下至上</code>调用<!-- --><code>fiber树</code>中绑定的回调函数, 所以<!-- --><code>顺序</code>遍历<!-- --><code>dispatchListeners</code>.<!-- --></li></ol><h2 id="总结"><a aria-hidden="true" tabindex="-1" href="#总结"><span class="icon icon-link"></span></a>总结<!-- --></h2><p>从架构上来讲, <!-- --><a href="https://github.com/facebook/react/blob/v17.0.2/packages/react-dom/src/events/SyntheticEvent.js#L152">SyntheticEvent</a>打通了从外部<!-- --><code>原生事件</code>到内部<!-- --><code>fiber树</code>的交互渠道, 使得<!-- --><code>react</code>能够感知到浏览器提供的<!-- --><code>原生事件</code>, 进而做出不同的响应, 修改<!-- --><code>fiber树</code>, 变更视图等.<!-- --></p><p>从实现上讲, 主要分为 3 步:</p><ol><li>监听原生事件: 对齐<!-- --><code>DOM元素</code>和<!-- --><code>fiber元素</code></li><li>收集<!-- --><code>listeners</code>: 遍历<!-- --><code>fiber树</code>, 收集所有监听本事件的<!-- --><code>listener</code>函数.<!-- --></li><li>派发合成事件: 构造合成事件, 遍历<!-- --><code>listeners</code>进行派发.<!-- --></li></ol></div></div><script>$RC("B:2","S:2")</script>