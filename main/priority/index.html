<!DOCTYPE html><html><head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<meta name="keywords" content="react, react原理, 图解react, react fiber原理, react hook原理, react 合成事件, react 基本包结构">
<meta name="description" content="图解React原理系列, 以react核心包结构和运行机制为主线索进行展开. 包括react 基本包结构, react 工作循环, react 启动模式, react fiber原理, react hook原理, react 合成事件等核心内容">
<link rel="shortcut icon" href="/km@2x.png">
<link rel="stylesheet" href="/umi.eb36fa83.css">
<title data-rh="true">优先级管理</title>
<meta data-rh="true" property="og:title" content="优先级管理"/><meta data-rh="true" name="description" content="React内部对于优先级的管理, 根据功能的不同分为LanePriority, SchedulerPriority, ReactPriorityLevel3 种类型. 本文基于react@17.0.2, 梳理源码中的优先级管理体系."/><meta data-rh="true" property="og:description" content="React内部对于优先级的管理, 根据功能的不同分为LanePriority, SchedulerPriority, ReactPriorityLevel3 种类型. 本文基于react@17.0.2, 梳理源码中的优先级管理体系."/>
</head>
<body>
<noscript><b>Enable JavaScript to run this app.</b></noscript><div id="root"><!--$?--><template id="B:0"></template><div></div><!--/$--></div><script>window.__UMI_LOADER_DATA__ = {}</script>
<script src="/umi.c14ba5aa.js"></script>

</body></html><div hidden id="S:0"><!--$?--><template id="B:1"></template><div></div><!--/$--></div><script>function $RC(a,b){a=document.getElementById(a);b=document.getElementById(b);b.parentNode.removeChild(b);if(a){a=a.previousSibling;var f=a.parentNode,c=a.nextSibling,e=0;do{if(c&&8===c.nodeType){var d=c.data;if("/$"===d)if(0===e)break;else e--;else"$"!==d&&"$?"!==d&&"$!"!==d||e++}d=c.nextSibling;f.removeChild(c);c=d}while(c);for(;b.firstChild;)f.insertBefore(b.firstChild,c);a.data="$";a._reactRetry&&a._reactRetry()}};$RC("B:0","S:0")</script><div hidden id="S:1"><div class="dumi-default-doc-layout"><div class="dumi-default-header"><div class="dumi-default-header-content"><section class="dumi-default-header-left"><a class="dumi-default-logo" href="/"><img src="/logo.png" alt="图解React"/>图解React<!-- --></a></section><section class="dumi-default-header-right"><ul class="dumi-default-navbar"><li><a class="active" href="/main/macro-structure">原理解析</a></li><li><a href="/algorithm/diff">高频算法</a></li><li><a href="/interview/01-setstate">面试题</a></li></ul><div class="dumi-default-header-right-aside"><div class="dumi-default-search-bar"><svg viewBox="64 64 896 896" class="dumi-default-search-bar-svg"><path d="M909.6 854.5 649.9 594.8C690.2 542.7 712 479 712 412c0-80.2-31.3-155.4-87.9-212.1-56.6-56.7-132-87.9-212.1-87.9s-155.5 31.3-212.1 87.9C143.2 256.5 112 331.8 112 412c0 80.1 31.3 155.5 87.9 212.1C256.5 680.8 331.8 712 412 712c67 0 130.6-21.8 182.7-62l259.7 259.6a8.2 8.2 0 0 0 11.6 0l43.6-43.5a8.2 8.2 0 0 0 0-11.6zM570.4 570.4C528 612.7 471.8 636 412 636s-116-23.3-158.4-65.6C211.3 528 188 471.8 188 412s23.3-116.1 65.6-158.4C296 211.3 352.2 188 412 188s116.1 23.2 158.4 65.6S636 352.2 636 412s-23.3 116.1-65.6 158.4z"></path></svg><input class="dumi-default-search-bar-input" placeholder="输入关键字搜索..."/><span class="dumi-default-search-shortcut">⌘<!-- --> K<!-- --></span></div><span class="dumi-default-color-switch" data-dumi-tooltip="亮色模式" data-dumi-tooltip-bottom="true"><svg viewBox="0 0 16 16"><path d="M8 13a1 1 0 0 1 1 1v1a1 1 0 1 1-2 0v-1a1 1 0 0 1 1-1ZM8 3a1 1 0 0 1-1-1V1a1 1 0 1 1 2 0v1a1 1 0 0 1-1 1Zm7 4a1 1 0 1 1 0 2h-1a1 1 0 1 1 0-2h1ZM3 8a1 1 0 0 1-1 1H1a1 1 0 1 1 0-2h1a1 1 0 0 1 1 1Zm9.95 3.536.707.707a1 1 0 0 1-1.414 1.414l-.707-.707a1 1 0 0 1 1.414-1.414Zm-9.9-7.072-.707-.707a1 1 0 0 1 1.414-1.414l.707.707A1 1 0 0 1 3.05 4.464Zm9.9 0a1 1 0 0 1-1.414-1.414l.707-.707a1 1 0 0 1 1.414 1.414l-.707.707Zm-9.9 7.072a1 1 0 0 1 1.414 1.414l-.707.707a1 1 0 0 1-1.414-1.414l.707-.707ZM8 4a4 4 0 1 0 0 8 4 4 0 0 0 0-8Zm0 6.5a2.5 2.5 0 1 1 0-5 2.5 2.5 0 0 1 0 5Z"></path></svg><select><option value="light" selected="">亮色模式<!-- --></option><option value="dark">暗色模式<!-- --></option><option value="auto">跟随系统<!-- --></option></select></span><a class="dumi-default-icon" data-dumi-tooltip="GitHub" data-dumi-tooltip-bottom="true" target="_blank" href="https://github.com/7kms/react-illustration-series" rel="noreferrer"><svg viewBox="64 64 896 896"><path d="M511.6 76.3C264.3 76.2 64 276.4 64 523.5 64 718.9 189.3 885 363.8 946c23.5 5.9 19.9-10.8 19.9-22.2v-77.5c-135.7 15.9-141.2-73.9-150.3-88.9C215 726 171.5 718 184.5 703c30.9-15.9 62.4 4 98.9 57.9 26.4 39.1 77.9 32.5 104 26 5.7-23.5 17.9-44.5 34.7-60.8-140.6-25.2-199.2-111-199.2-213 0-49.5 16.3-95 48.3-131.7-20.4-60.5 1.9-112.3 4.9-120 58.1-5.2 118.5 41.6 123.2 45.3 33-8.9 70.7-13.6 112.9-13.6 42.4 0 80.2 4.9 113.5 13.9 11.3-8.6 67.3-48.8 121.3-43.9 2.9 7.7 24.7 58.3 5.5 118 32.4 36.8 48.9 82.7 48.9 132.3 0 102.2-59 188.1-200 212.9a127.5 127.5 0 0 1 38.1 91v112.5c.8 9 0 17.9 15 17.9 177.1-59.7 304.6-227 304.6-424.1 0-247.2-200.4-447.3-447.5-447.3z"></path></svg></a></div></section><button type="button" class="dumi-default-header-menu-btn"><svg viewBox="64 64 896 896"><path d="M904 160H120c-4.4 0-8 3.6-8 8v64c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-64c0-4.4-3.6-8-8-8zm0 624H120c-4.4 0-8 3.6-8 8v64c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-64c0-4.4-3.6-8-8-8zm0-312H120c-4.4 0-8 3.6-8 8v64c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-64c0-4.4-3.6-8-8-8z"></path></svg></button></div></div><div class="dumi-default-doc-layout-mobile-bar"><button type="button" class="dumi-default-sidebar-btn"><svg viewBox="64 64 896 896"><path d="M120 230h496c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm0 424h496c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm784 140H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0-424H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8z"></path></svg>侧边菜单<!-- --></button></div><main><div class="dumi-default-sidebar"><dl class="dumi-default-sidebar-group"><dt>基本概念</dt><dd><a title="宏观包结构" class="" href="/main/macro-structure">宏观包结构</a></dd><dd><a title="两大工作循环" class="" href="/main/workloop">两大工作循环</a></dd><dd><a title="高频对象" class="" href="/main/object-structure">高频对象</a></dd></dl><dl class="dumi-default-sidebar-group"><dt>运行核心</dt><dd><a title="启动过程" class="" href="/main/bootstrap">启动过程</a></dd><dd><a title="reconciler 运作流程" class="" href="/main/reconciler-workflow">reconciler 运作流程</a></dd><dd><a title="优先级管理" aria-current="page" class="active" href="/main/priority">优先级管理</a></dd><dd><a title="调度原理" class="" href="/main/scheduler">调度原理</a></dd><dd><a title="fiber 树构造(基础准备)" class="" href="/main/fibertree-prepare">fiber 树构造(基础准备)</a></dd><dd><a title="fiber 树构造(初次创建)" class="" href="/main/fibertree-create">fiber 树构造(初次创建)</a></dd><dd><a title="fiber 树构造(对比更新)" class="" href="/main/fibertree-update">fiber 树构造(对比更新)</a></dd><dd><a title="fiber 树渲染" class="" href="/main/fibertree-commit">fiber 树渲染</a></dd></dl><dl class="dumi-default-sidebar-group"><dt>状态管理</dt><dd><a title="状态与副作用" class="" href="/main/state-effects">状态与副作用</a></dd><dd><a title="Hook 原理(概览)" class="" href="/main/hook-summary">Hook 原理(概览)</a></dd><dd><a title="Hook 原理(状态Hook)" class="" href="/main/hook-state">Hook 原理(状态Hook)</a></dd><dd><a title="Hook 原理(副作用Hook)" class="" href="/main/hook-effect">Hook 原理(副作用Hook)</a></dd><dd><a title="context 原理" class="" href="/main/context">context 原理</a></dd></dl><dl class="dumi-default-sidebar-group"><dt>交互</dt><dd><a title="合成事件" class="" href="/main/synthetic-event">合成事件</a></dd></dl></div><div class="dumi-default-content"><!--$?--><template id="B:2"></template><div></div><!--/$--><div class="dumi-default-footer">Copyright © 2023 | Powered by <a href="https://d.umijs.org" target="_blank" rel="noreferrer">dumi</a></div></div></main></div></div><script>$RC("B:1","S:1")</script><div hidden id="S:2"><div class="markdown"><h1 id="react-中的优先级管理"><a aria-hidden="true" tabindex="-1" href="#react-中的优先级管理"><span class="icon icon-link"></span></a>React 中的优先级管理<!-- --></h1><blockquote><p><code>React</code>内部对于<!-- --><code>优先级</code>的管理, 根据功能的不同分为<!-- --><code>LanePriority</code>, <!-- --><code>SchedulerPriority</code>, <!-- --><code>ReactPriorityLevel</code>3 种类型. 本文基于<!-- --><code>react@17.0.2</code>, 梳理源码中的优先级管理体系.<!-- --></p></blockquote><p><code>React</code>是一个声明式, 高效且灵活的用于构建用户界面的 JavaScript 库. React 团队一直致力于实现高效渲染, 其中有 2 个十分有名的演讲:<!-- --></p><ol><li><a href="http://conf2017.reactjs.org/speakers/lin">2017 年 Lin Clark 的演讲</a>中介绍了<!-- --><code>fiber</code>架构和<!-- --><code>可中断渲染</code>.<!-- --></li><li><a href="https://zh-hans.reactjs.org/blog/2018/03/01/sneak-peek-beyond-react-16.html">2018 年 Dan 在 JSConf 冰岛的演讲</a>进一步介绍了时间切片(<!-- --><code>time slicing</code>)和异步渲染(<!-- --><code>suspense</code>)等特性.<!-- --></li></ol><p>演讲中所展示的<!-- --><code>可中断渲染</code>,<!-- --><code>时间切片(time slicing)</code>,<!-- --><code>异步渲染(suspense)</code>等特性, 在源码中得以实现都依赖于<!-- --><code>优先级管理</code>.<!-- --></p><p>在<!-- --><code>React@17.0.2</code>源码中, 一共有<!-- --><code>2套优先级体系</code>和<!-- --><code>1套转换体系</code>, 在深入分析之前, 再次回顾一下(<!-- --><a href="/main/reconciler-workflow">reconciler 运作流程</a>):<!-- --></p><p><img alt="" src="/static/reactfiberworkloop.b647e134.png"/></p><p><code>React</code>内部对于<!-- --><code>优先级</code>的管理, 贯穿运作流程的 4 个阶段(从输入到输出), 根据其功能的不同, 可以分为 3 种类型:<!-- --></p><ol><li><code>fiber</code>优  先级(<!-- --><code>LanePriority</code>): 位于<!-- --><code>react-reconciler</code>包, 也就是<!-- --><a href="https://github.com/facebook/react/pull/18796"><code>Lane(车道模型)</code></a>.<!-- --></li><li>调度优先级(<!-- --><code>SchedulerPriority</code>): 位于<!-- --><code>scheduler</code>包.<!-- --></li><li>优先级等级(<!-- --><code>ReactPriorityLevel</code>) : 位于<!-- --><code>react-reconciler</code>包中的<!-- --><a href="https://github.com/facebook/react/blob/v17.0.2/packages/react-reconciler/src/SchedulerWithReactIntegration.old.js"><code>SchedulerWithReactIntegration.js</code></a>, 负责上述 2 套优先级体系的转换.<!-- --></li></ol><h2 id="预备知识"><a aria-hidden="true" tabindex="-1" href="#预备知识"><span class="icon icon-link"></span></a>预备知识<!-- --></h2><p>在深入分析 3 种优先级之前, 为了深入理解<!-- --><code>LanePriority</code>, 需要先了解<!-- --><code>Lane</code>, 这是<!-- --><code>react@17.0.0</code>的新特性.<!-- --></p><h3 id="lane-车道模型"><a aria-hidden="true" tabindex="-1" href="#lane-车道模型"><span class="icon icon-link"></span></a>Lane (车道模型)<!-- --></h3><blockquote><p>英文单词<!-- --><code>lane</code>翻译成中文表示&quot;车道, 航道&quot;的意思, 所以很多文章都将<!-- --><code>Lanes</code>模型称为<!-- --><code>车道模型</code></p></blockquote><p><code>Lane</code>模型的源码在<!-- --><a href="https://github.com/facebook/react/blob/v17.0.2/packages/react-reconciler/src/ReactFiberLane.js">ReactFiberLane.js</a>, 源码中大量使用了位运算(有关位运算的讲解, 可以参考<!-- --><a href="/algorithm/bitfield">React 算法之位运算</a>).<!-- --></p><p>首先引入作者对<!-- --><code>Lane</code>的解释(<!-- --><a href="https://github.com/facebook/react/pull/18796">相应的 pr</a>), 这里简单概括如下:<!-- --></p><ol><li><p><code>Lane</code>类型被定义为二进制变量, 利用了位掩码的特性, 在频繁运算的时候占用内存少, 计算速度快.<!-- --></p><ul><li><code>Lane</code>和<!-- --><code>Lanes</code>就是单数和复数的关系, 代表单个任务的定义为<!-- --><code>Lane</code>, 代表多个任务的定义为<!-- --><code>Lanes</code></li></ul></li><li><p><code>Lane</code>是对于<!-- --><code>expirationTime</code>的重构, 以前使用<!-- --><code>expirationTime</code>表示的字段, 都改为了<!-- --><code>lane</code></p><div class="dumi-default-source-code"><button type="button" class="dumi-default-source-code-copy"><svg viewBox="64 64 896 896"><path d="M832 64H296c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h496v688c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8V96c0-17.7-14.3-32-32-32zM704 192H192c-17.7 0-32 14.3-32 32v530.7c0 8.5 3.4 16.6 9.4 22.6l173.3 173.3c2.2 2.2 4.7 4 7.4 5.5v1.9h4.2c3.5 1.3 7.2 2 11 2H704c17.7 0 32-14.3 32-32V224c0-17.7-14.3-32-32-32zM350 856.2 263.9 770H350v86.2zM664 888H414V746c0-22.1-17.9-40-40-40H232V264h432v624z"></path></svg></button><pre class="prism-code language-js"><div class=""><div class=""><span class="token plain">renderExpirationtime </span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token plain"> renderLanes</span></div></div><div class=""><div class=""><span class="token plain">  update</span><span class="token punctuation">.</span><span class="token property-access">expirationTime</span><span class="token plain"> </span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token plain"> update</span><span class="token punctuation">.</span><span class="token property-access">lane</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  fiber</span><span class="token punctuation">.</span><span class="token property-access">expirationTime</span><span class="token plain"> </span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token plain"> fiber</span><span class="token punctuation">.</span><span class="token property-access">lanes</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  fiber</span><span class="token punctuation">.</span><span class="token property-access">childExpirationTime</span><span class="token plain"> </span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token plain"> fiber</span><span class="token punctuation">.</span><span class="token property-access">childLanes</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  root</span><span class="token punctuation">.</span><span class="token property-access">firstPendingTime</span><span class="token plain"> and root</span><span class="token punctuation">.</span><span class="token property-access">lastPendingTime</span><span class="token plain"> </span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token plain"> fiber</span><span class="token punctuation">.</span><span class="token property-access">pendingLanes</span></div></div></pre></div></li><li><p>使用<!-- --><code>Lanes</code>模型相比<!-- --><code>expirationTime</code>模型的优势:<!-- --></p><ol><li><p><code>Lanes</code>把任务优先级从批量任务中分离出来, 可以更方便的判断单个任务与批量任务的优先级是否重叠.<!-- --></p><div class="dumi-default-source-code"><button type="button" class="dumi-default-source-code-copy"><svg viewBox="64 64 896 896"><path d="M832 64H296c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h496v688c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8V96c0-17.7-14.3-32-32-32zM704 192H192c-17.7 0-32 14.3-32 32v530.7c0 8.5 3.4 16.6 9.4 22.6l173.3 173.3c2.2 2.2 4.7 4 7.4 5.5v1.9h4.2c3.5 1.3 7.2 2 11 2H704c17.7 0 32-14.3 32-32V224c0-17.7-14.3-32-32-32zM350 856.2 263.9 770H350v86.2zM664 888H414V746c0-22.1-17.9-40-40-40H232V264h432v624z"></path></svg></button><pre class="prism-code language-js"><div class=""><div class=""><span class="token comment">// 判断: 单task与batchTask的优先级是否重叠</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token comment">//1. 通过expirationTime判断</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> isTaskIncludedInBatch </span><span class="token operator">=</span><span class="token plain"> priorityOfTask </span><span class="token operator">&gt;=</span><span class="token plain"> priorityOfBatch</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token comment">//2. 通过Lanes判断</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> isTaskIncludedInBatch </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">task </span><span class="token operator">&amp;</span><span class="token plain"> batchOfTasks</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token operator">!==</span><span class="token plain"> </span><span class="token number">0</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">
</span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token comment">// 当同时处理一组任务, 该组内有多个任务, 且每个任务的优先级不一致</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token comment">// 1. 如果通过expirationTime判断. 需要维护一个范围(在Lane重构之前, 源码中就是这样比较的)</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> isTaskIncludedInBatch </span><span class="token operator">=</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  taskPriority </span><span class="token operator">&lt;=</span><span class="token plain"> highestPriorityInRange </span><span class="token operator">&amp;&amp;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  taskPriority </span><span class="token operator">&gt;=</span><span class="token plain"> lowestPriorityInRange</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token comment">//2. 通过Lanes判断</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> isTaskIncludedInBatch </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">task </span><span class="token operator">&amp;</span><span class="token plain"> batchOfTasks</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token operator">!==</span><span class="token plain"> </span><span class="token number">0</span><span class="token punctuation">;</span></div></div></pre></div></li><li><p><code>Lanes</code>使用单个 32 位二进制变量即可代表多个不同的任务, 也就是说一个变量即可代表一个组(<!-- --><code>group</code>), 如果要在一个 group 中分离出单个 task, 非常容易.<!-- --></p><blockquote><p>在<!-- --><code>expirationTime</code>模型设计之初, react 体系中还没有<!-- --><a href="https://zh-hans.reactjs.org/docs/concurrent-mode-suspense.html">Suspense 异步渲染</a>的概念.<!-- --><br/>
现在有 如下场景: 有 3 个任务, 其优先级 <!-- --><code>A &gt; B &gt; C</code>, 正常来讲只需要按照优先级顺序执行就可以了.<!-- --><br/>
但是现在情况变了: A 和 C 任务是<!-- --><code>CPU密集型</code>, 而 B 是<!-- --><code>IO密集型</code>(Suspense 会调用远程 api, 算是 IO 任务), 即 <!-- --><code>A(cpu) &gt; B(IO) &gt; C(cpu)</code>. 此时的需求需要将任务<!-- --><code>B</code>从 group 中分离出来, 先处理 cpu 任务<!-- --><code>A和C</code>.<!-- --></p></blockquote><div class="dumi-default-source-code"><button type="button" class="dumi-default-source-code-copy"><svg viewBox="64 64 896 896"><path d="M832 64H296c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h496v688c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8V96c0-17.7-14.3-32-32-32zM704 192H192c-17.7 0-32 14.3-32 32v530.7c0 8.5 3.4 16.6 9.4 22.6l173.3 173.3c2.2 2.2 4.7 4 7.4 5.5v1.9h4.2c3.5 1.3 7.2 2 11 2H704c17.7 0 32-14.3 32-32V224c0-17.7-14.3-32-32-32zM350 856.2 263.9 770H350v86.2zM664 888H414V746c0-22.1-17.9-40-40-40H232V264h432v624z"></path></svg></button><pre class="prism-code language-js"><div class=""><div class=""><span class="token comment">// 从group中删除或增加task</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">
</span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token comment">//1. 通过expirationTime实现</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token comment">// 0) 维护一个链表, 按照单个task的优先级顺序进行插入</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token comment">// 1) 删除单个task(从链表中删除一个元素)</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">task</span><span class="token punctuation">.</span><span class="token property-access">prev</span><span class="token punctuation">.</span><span class="token property-access">next</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> task</span><span class="token punctuation">.</span><span class="token property-access">next</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token comment">// 2) 增加单个task(需要对比当前task的优先级, 插入到链表正确的位置上)</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token keyword">let</span><span class="token plain"> current </span><span class="token operator">=</span><span class="token plain"> queue</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token keyword control-flow">while</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">task</span><span class="token punctuation">.</span><span class="token property-access">expirationTime</span><span class="token plain"> </span><span class="token operator">&gt;=</span><span class="token plain"> current</span><span class="token punctuation">.</span><span class="token property-access">expirationTime</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  current </span><span class="token operator">=</span><span class="token plain"> current</span><span class="token punctuation">.</span><span class="token property-access">next</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">task</span><span class="token punctuation">.</span><span class="token property-access">next</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> current</span><span class="token punctuation">.</span><span class="token property-access">next</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">current</span><span class="token punctuation">.</span><span class="token property-access">next</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> task</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token comment">// 3) 比较task是否在group中</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> isTaskIncludedInBatch </span><span class="token operator">=</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  taskPriority </span><span class="token operator">&lt;=</span><span class="token plain"> highestPriorityInRange </span><span class="token operator">&amp;&amp;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  taskPriority </span><span class="token operator">&gt;=</span><span class="token plain"> lowestPriorityInRange</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">
</span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token comment">// 2. 通过Lanes实现</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token comment">// 1) 删除单个task</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">batchOfTasks </span><span class="token operator">&amp;=</span><span class="token plain"> </span><span class="token operator">~</span><span class="token plain">task</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token comment">// 2) 增加单个task</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">batchOfTasks </span><span class="token operator">|=</span><span class="token plain"> task</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token comment">// 3) 比较task是否在group中</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> isTaskIncludedInBatch </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">task </span><span class="token operator">&amp;</span><span class="token plain"> batchOfTasks</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token operator">!==</span><span class="token plain"> </span><span class="token number">0</span><span class="token punctuation">;</span></div></div></pre></div><p>通过上述伪代码, 可以看到<!-- --><code>Lanes</code>的优越性, 运用起来代码量少, 简洁高效.<!-- --></p></li></ol></li><li><p><code>Lanes</code>是一个不透明的类型, 只能在<!-- --><a href="https://github.com/facebook/react/blob/v17.0.2/packages/react-reconciler/src/ReactFiberLane.js"><code>ReactFiberLane.js</code></a>这个模块中维护. 如果要在其他文件中使用, 只能通过<!-- --><code>ReactFiberLane.js</code>中提供的工具函数来使用.<!-- --></p></li></ol><p>分析车道模型的源码(<!-- --><a href="https://github.com/facebook/react/blob/v17.0.2/packages/react-reconciler/src/ReactFiberLane.js"><code>ReactFiberLane.js</code></a>中), 可以得到如下结论:<!-- --></p><ol><li>可以使用的比特位一共有 31 位(为什么? 可以参考<!-- --><a href="/algorithm/bitfield">React 算法之位运算</a>中的说明).<!-- --></li><li>共定义了<!-- --><a href="https://github.com/facebook/react/blob/v17.0.2/packages/react-reconciler/src/ReactFiberLane.js#L74-L103">18 种车道(<!-- --><code>Lane/Lanes</code>)变量<!-- --></a>, 每一个变量占有 1 个或多个比特位, 分别定义为<!-- --><code>Lane</code>和<!-- --><code>Lanes</code>类型.<!-- --></li><li>每一种车道(<!-- --><code>Lane/Lanes</code>)都有对应的优先级, 所以源码中定义了 18 种优先级(<!-- --><a href="https://github.com/facebook/react/blob/v17.0.2/packages/react-reconciler/src/ReactFiberLane.js#L12-L30">LanePriority</a>).<!-- --></li><li>占有低位比特位的<!-- --><code>Lane</code>变量对应的优先级越高
<!-- --><ul><li>最高优先级为<!-- --><code>SyncLanePriority</code>对应的车道为<!-- --><code>SyncLane = 0b0000000000000000000000000000001</code>.<!-- --></li><li>最低优先级为<!-- --><code>OffscreenLanePriority</code>对应的车道为<!-- --><code>OffscreenLane = 0b1000000000000000000000000000000</code>.<!-- --></li></ul></li></ol><h2 id="优先级区别和联系"><a aria-hidden="true" tabindex="-1" href="#优先级区别和联系"><span class="icon icon-link"></span></a>优先级区别和联系<!-- --></h2><p>在源码中, 3 种优先级位于不同的 js 文件, 是相互独立的.</p><p>注意:</p><ul><li><code>LanePriority</code>和<!-- --><code>SchedulerPriority</code>从命名上看, 它们代表的是<!-- --><code>优先级</code></li><li><code>ReactPriorityLevel</code>从命名上看, 它代表的是<!-- --><code>等级</code>而不是优先级, 它用于衡量<!-- --><code>LanePriority</code>和<!-- --><code>SchedulerPriority</code>的等级.<!-- --></li></ul><h3 id="lanepriority"><a aria-hidden="true" tabindex="-1" href="#lanepriority"><span class="icon icon-link"></span></a>LanePriority<!-- --></h3><p><code>LanePriority</code>: 属于<!-- --><code>react-reconciler</code>包, 定义于<!-- --><code>ReactFiberLane.js</code>(<!-- --><a href="https://github.com/facebook/react/blob/v17.0.2/packages/react-reconciler/src/ReactFiberLane.js#L46-L70">见源码</a>).<!-- --></p><div class="dumi-default-source-code"><button type="button" class="dumi-default-source-code-copy"><svg viewBox="64 64 896 896"><path d="M832 64H296c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h496v688c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8V96c0-17.7-14.3-32-32-32zM704 192H192c-17.7 0-32 14.3-32 32v530.7c0 8.5 3.4 16.6 9.4 22.6l173.3 173.3c2.2 2.2 4.7 4 7.4 5.5v1.9h4.2c3.5 1.3 7.2 2 11 2H704c17.7 0 32-14.3 32-32V224c0-17.7-14.3-32-32-32zM350 856.2 263.9 770H350v86.2zM664 888H414V746c0-22.1-17.9-40-40-40H232V264h432v624z"></path></svg></button><pre class="prism-code language-js"><div class=""><div class=""><span class="token keyword module">export</span><span class="token plain"> </span><span class="token keyword">const</span><span class="token plain"> </span><span class="token literal-property property">SyncLanePriority</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">LanePriority</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">15</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token keyword module">export</span><span class="token plain"> </span><span class="token keyword">const</span><span class="token plain"> </span><span class="token literal-property property">SyncBatchedLanePriority</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">LanePriority</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">14</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">
</span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> </span><span class="token literal-property property">InputDiscreteHydrationLanePriority</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">LanePriority</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">13</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token keyword module">export</span><span class="token plain"> </span><span class="token keyword">const</span><span class="token plain"> </span><span class="token literal-property property">InputDiscreteLanePriority</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">LanePriority</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">12</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">
</span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token comment">// .....</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">
</span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> </span><span class="token literal-property property">OffscreenLanePriority</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">LanePriority</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">1</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token keyword module">export</span><span class="token plain"> </span><span class="token keyword">const</span><span class="token plain"> </span><span class="token literal-property property">NoLanePriority</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">LanePriority</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">0</span><span class="token punctuation">;</span></div></div></pre></div><p>与<!-- --><code>fiber</code>构造过程相关的优先级(如<!-- --><code>fiber.updateQueue</code>,<!-- --><code>fiber.lanes</code>)都使用<!-- --><code>LanePriority</code>.<!-- --></p><p>由于本节重点介绍优先级体系以及它们的转换关系, 关于<!-- --><code>Lane(车道模型)</code>在<!-- --><code>fiber树构造</code>时的具体使用, 在<!-- --><code>fiber 树构造</code>章节详细解读.<!-- --></p><h3 id="schedulerpriority"><a aria-hidden="true" tabindex="-1" href="#schedulerpriority"><span class="icon icon-link"></span></a>SchedulerPriority<!-- --></h3><p><code>SchedulerPriority</code>, 属于<!-- --><code>scheduler</code>包, 定义于<!-- --><code>SchedulerPriorities.js</code>中(<!-- --><a href="https://github.com/facebook/react/blob/v17.0.2/packages/scheduler/src/SchedulerPriorities.js">见源码</a>).<!-- --></p><div class="dumi-default-source-code"><button type="button" class="dumi-default-source-code-copy"><svg viewBox="64 64 896 896"><path d="M832 64H296c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h496v688c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8V96c0-17.7-14.3-32-32-32zM704 192H192c-17.7 0-32 14.3-32 32v530.7c0 8.5 3.4 16.6 9.4 22.6l173.3 173.3c2.2 2.2 4.7 4 7.4 5.5v1.9h4.2c3.5 1.3 7.2 2 11 2H704c17.7 0 32-14.3 32-32V224c0-17.7-14.3-32-32-32zM350 856.2 263.9 770H350v86.2zM664 888H414V746c0-22.1-17.9-40-40-40H232V264h432v624z"></path></svg></button><pre class="prism-code language-js"><div class=""><div class=""><span class="token keyword module">export</span><span class="token plain"> </span><span class="token keyword">const</span><span class="token plain"> </span><span class="token maybe-class-name">NoPriority</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">0</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token keyword module">export</span><span class="token plain"> </span><span class="token keyword">const</span><span class="token plain"> </span><span class="token maybe-class-name">ImmediatePriority</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">1</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token keyword module">export</span><span class="token plain"> </span><span class="token keyword">const</span><span class="token plain"> </span><span class="token maybe-class-name">UserBlockingPriority</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">2</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token keyword module">export</span><span class="token plain"> </span><span class="token keyword">const</span><span class="token plain"> </span><span class="token maybe-class-name">NormalPriority</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">3</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token keyword module">export</span><span class="token plain"> </span><span class="token keyword">const</span><span class="token plain"> </span><span class="token maybe-class-name">LowPriority</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">4</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token keyword module">export</span><span class="token plain"> </span><span class="token keyword">const</span><span class="token plain"> </span><span class="token maybe-class-name">IdlePriority</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">5</span><span class="token punctuation">;</span></div></div></pre></div><p>与<!-- --><code>scheduler</code>调度中心相关的优先级使用<!-- --><code>SchedulerPriority</code>.<!-- --></p><h3 id="reactprioritylevel"><a aria-hidden="true" tabindex="-1" href="#reactprioritylevel"><span class="icon icon-link"></span></a>ReactPriorityLevel<!-- --></h3><p><code>reactPriorityLevel</code>, 属于<!-- --><code>react-reconciler</code>包, 定义于<!-- --><code>SchedulerWithReactIntegration.js</code>中(<!-- --><a href="https://github.com/facebook/react/blob/v17.0.2/packages/react-reconciler/src/SchedulerWithReactIntegration.old.js#L65-L71">见源码</a>).<!-- --></p><div class="dumi-default-source-code"><button type="button" class="dumi-default-source-code-copy"><svg viewBox="64 64 896 896"><path d="M832 64H296c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h496v688c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8V96c0-17.7-14.3-32-32-32zM704 192H192c-17.7 0-32 14.3-32 32v530.7c0 8.5 3.4 16.6 9.4 22.6l173.3 173.3c2.2 2.2 4.7 4 7.4 5.5v1.9h4.2c3.5 1.3 7.2 2 11 2H704c17.7 0 32-14.3 32-32V224c0-17.7-14.3-32-32-32zM350 856.2 263.9 770H350v86.2zM664 888H414V746c0-22.1-17.9-40-40-40H232V264h432v624z"></path></svg></button><pre class="prism-code language-js"><div class=""><div class=""><span class="token keyword module">export</span><span class="token plain"> </span><span class="token keyword">const</span><span class="token plain"> </span><span class="token literal-property property">ImmediatePriority</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">ReactPriorityLevel</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">99</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token keyword module">export</span><span class="token plain"> </span><span class="token keyword">const</span><span class="token plain"> </span><span class="token literal-property property">UserBlockingPriority</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">ReactPriorityLevel</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">98</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token keyword module">export</span><span class="token plain"> </span><span class="token keyword">const</span><span class="token plain"> </span><span class="token literal-property property">NormalPriority</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">ReactPriorityLevel</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">97</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token keyword module">export</span><span class="token plain"> </span><span class="token keyword">const</span><span class="token plain"> </span><span class="token literal-property property">LowPriority</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">ReactPriorityLevel</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">96</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token keyword module">export</span><span class="token plain"> </span><span class="token keyword">const</span><span class="token plain"> </span><span class="token literal-property property">IdlePriority</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">ReactPriorityLevel</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">95</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token comment">// NoPriority is the absence of priority. Also React-only.</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token keyword module">export</span><span class="token plain"> </span><span class="token keyword">const</span><span class="token plain"> </span><span class="token literal-property property">NoPriority</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">ReactPriorityLevel</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">90</span><span class="token punctuation">;</span></div></div></pre></div><p><code>LanePriority</code>与<!-- --><code>SchedulerPriority</code>通过<!-- --><code>ReactPriorityLevel</code>进行转换<!-- --></p><h3 id="转换关系"><a aria-hidden="true" tabindex="-1" href="#转换关系"><span class="icon icon-link"></span></a>转换关系<!-- --></h3><p>为了能协同调度中心(<!-- --><code>scheduler</code>包)和 fiber 树构造(<!-- --><code>react-reconciler</code>包)中对优先级的使用, 则需要转换<!-- --><code>SchedulerPriority</code>和<!-- --><code>LanePriority</code>, 转换的桥梁正是<!-- --><code>ReactPriorityLevel</code>.<!-- --></p><p>在<!-- --><a href="https://github.com/facebook/react/blob/v17.0.2/packages/react-reconciler/src/SchedulerWithReactIntegration.old.js#L93-L125"><code>SchedulerWithReactIntegration.js</code>中<!-- --></a>, 可以互转<!-- --><code>SchedulerPriority</code> 和 <!-- --><code>ReactPriorityLevel</code>:<!-- --></p><div class="dumi-default-source-code"><button type="button" class="dumi-default-source-code-copy"><svg viewBox="64 64 896 896"><path d="M832 64H296c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h496v688c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8V96c0-17.7-14.3-32-32-32zM704 192H192c-17.7 0-32 14.3-32 32v530.7c0 8.5 3.4 16.6 9.4 22.6l173.3 173.3c2.2 2.2 4.7 4 7.4 5.5v1.9h4.2c3.5 1.3 7.2 2 11 2H704c17.7 0 32-14.3 32-32V224c0-17.7-14.3-32-32-32zM350 856.2 263.9 770H350v86.2zM664 888H414V746c0-22.1-17.9-40-40-40H232V264h432v624z"></path></svg></button><pre class="prism-code language-js"><div class=""><div class=""><span class="token comment">// 把 SchedulerPriority 转换成 ReactPriorityLevel</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token keyword module">export</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">getCurrentPriorityLevel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">ReactPriorityLevel</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword control-flow">switch</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token function maybe-class-name">Scheduler_getCurrentPriorityLevel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token keyword">case</span><span class="token plain"> </span><span class="token literal-property property">Scheduler_ImmediatePriority</span><span class="token operator">:</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token keyword control-flow">return</span><span class="token plain"> </span><span class="token maybe-class-name">ImmediatePriority</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token keyword">case</span><span class="token plain"> </span><span class="token literal-property property">Scheduler_UserBlockingPriority</span><span class="token operator">:</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token keyword control-flow">return</span><span class="token plain"> </span><span class="token maybe-class-name">UserBlockingPriority</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token keyword">case</span><span class="token plain"> </span><span class="token literal-property property">Scheduler_NormalPriority</span><span class="token operator">:</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token keyword control-flow">return</span><span class="token plain"> </span><span class="token maybe-class-name">NormalPriority</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token keyword">case</span><span class="token plain"> </span><span class="token literal-property property">Scheduler_LowPriority</span><span class="token operator">:</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token keyword control-flow">return</span><span class="token plain"> </span><span class="token maybe-class-name">LowPriority</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token keyword">case</span><span class="token plain"> </span><span class="token literal-property property">Scheduler_IdlePriority</span><span class="token operator">:</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token keyword control-flow">return</span><span class="token plain"> </span><span class="token maybe-class-name">IdlePriority</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token keyword module">default</span><span class="token operator">:</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token function">invariant</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token string">&#x27;Unknown priority level.&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">
</span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token comment">// 把 ReactPriorityLevel 转换成 SchedulerPriority</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">reactPriorityToSchedulerPriority</span><span class="token punctuation">(</span><span class="token parameter">reactPriorityLevel</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword control-flow">switch</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">reactPriorityLevel</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token keyword">case</span><span class="token plain"> </span><span class="token literal-property property">ImmediatePriority</span><span class="token operator">:</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token keyword control-flow">return</span><span class="token plain"> </span><span class="token maybe-class-name">Scheduler_ImmediatePriority</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token keyword">case</span><span class="token plain"> </span><span class="token literal-property property">UserBlockingPriority</span><span class="token operator">:</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token keyword control-flow">return</span><span class="token plain"> </span><span class="token maybe-class-name">Scheduler_UserBlockingPriority</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token keyword">case</span><span class="token plain"> </span><span class="token literal-property property">NormalPriority</span><span class="token operator">:</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token keyword control-flow">return</span><span class="token plain"> </span><span class="token maybe-class-name">Scheduler_NormalPriority</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token keyword">case</span><span class="token plain"> </span><span class="token literal-property property">LowPriority</span><span class="token operator">:</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token keyword control-flow">return</span><span class="token plain"> </span><span class="token maybe-class-name">Scheduler_LowPriority</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token keyword">case</span><span class="token plain"> </span><span class="token literal-property property">IdlePriority</span><span class="token operator">:</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token keyword control-flow">return</span><span class="token plain"> </span><span class="token maybe-class-name">Scheduler_IdlePriority</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token keyword module">default</span><span class="token operator">:</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token function">invariant</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token string">&#x27;Unknown priority level.&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token punctuation">}</span></div></div></pre></div><p>在<!-- --><a href="https://github.com/facebook/react/blob/v17.0.2/packages/react-reconciler/src/ReactFiberLane.js#L196-L247"><code>ReactFiberLane.js</code>中<!-- --></a>, 可以互转<!-- --><code>LanePriority</code> 和 <!-- --><code>ReactPriorityLevel</code>:<!-- --></p><div class="dumi-default-source-code"><button type="button" class="dumi-default-source-code-copy"><svg viewBox="64 64 896 896"><path d="M832 64H296c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h496v688c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8V96c0-17.7-14.3-32-32-32zM704 192H192c-17.7 0-32 14.3-32 32v530.7c0 8.5 3.4 16.6 9.4 22.6l173.3 173.3c2.2 2.2 4.7 4 7.4 5.5v1.9h4.2c3.5 1.3 7.2 2 11 2H704c17.7 0 32-14.3 32-32V224c0-17.7-14.3-32-32-32zM350 856.2 263.9 770H350v86.2zM664 888H414V746c0-22.1-17.9-40-40-40H232V264h432v624z"></path></svg></button><pre class="prism-code language-js"><div class=""><div class=""><span class="token keyword module">export</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">schedulerPriorityToLanePriority</span><span class="token punctuation">(</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token parameter literal-property property">schedulerPriorityLevel</span><span class="token parameter operator">:</span><span class="token parameter"> </span><span class="token parameter maybe-class-name">ReactPriorityLevel</span><span class="token parameter punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token punctuation">)</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">LanePriority</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword control-flow">switch</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">schedulerPriorityLevel</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token keyword">case</span><span class="token plain"> </span><span class="token literal-property property">ImmediateSchedulerPriority</span><span class="token operator">:</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token keyword control-flow">return</span><span class="token plain"> </span><span class="token maybe-class-name">SyncLanePriority</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token comment">// ... 省略部分代码</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token keyword module">default</span><span class="token operator">:</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token keyword control-flow">return</span><span class="token plain"> </span><span class="token maybe-class-name">NoLanePriority</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">
</span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token keyword module">export</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">lanePriorityToSchedulerPriority</span><span class="token punctuation">(</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token parameter literal-property property">lanePriority</span><span class="token parameter operator">:</span><span class="token parameter"> </span><span class="token parameter maybe-class-name">LanePriority</span><span class="token parameter punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token punctuation">)</span><span class="token operator">:</span><span class="token plain"> </span><span class="token maybe-class-name">ReactPriorityLevel</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token keyword control-flow">switch</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">lanePriority</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token keyword">case</span><span class="token plain"> </span><span class="token literal-property property">SyncLanePriority</span><span class="token operator">:</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token keyword">case</span><span class="token plain"> </span><span class="token literal-property property">SyncBatchedLanePriority</span><span class="token operator">:</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token keyword control-flow">return</span><span class="token plain"> </span><span class="token maybe-class-name">ImmediateSchedulerPriority</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token comment">// ... 省略部分代码</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">    </span><span class="token keyword module">default</span><span class="token operator">:</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token function">invariant</span><span class="token punctuation">(</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">        </span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">        </span><span class="token string">&#x27;Invalid update priority: %s. This is a bug in React.&#x27;</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">        lanePriority</span><span class="token punctuation">,</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">      </span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div></div><div class=""><div class=""><span class="token plain"></span><span class="token punctuation">}</span></div></div></pre></div><h2 id="优先级使用"><a aria-hidden="true" tabindex="-1" href="#优先级使用"><span class="icon icon-link"></span></a>优先级使用<!-- --></h2><p>通过<!-- --><a href="/main/reconciler-workflow">reconciler 运作流程</a>中的归纳, <!-- --><code>reconciler</code>从输入到输出一共经历了 4 个阶段, 在每个阶段中都会涉及到与<!-- --><code>优先级</code>相关的处理. 正是通过<!-- --><code>优先级</code>的灵活运用, <!-- --><code>React</code>实现了<!-- --><code>可中断渲染</code>,<!-- --><code>时间切片(time slicing)</code>,<!-- --><code>异步渲染(suspense)</code>等特性.<!-- --></p><p>在理解了优先级的基本思路之后, 接下来就正式进入 react 源码分析中的硬核部分(<!-- --><code>scheduler 调度原理</code>和<!-- --><code>fiber树构造</code>)<!-- --></p><h2 id="总结"><a aria-hidden="true" tabindex="-1" href="#总结"><span class="icon icon-link"></span></a>总结<!-- --></h2><p>本文介绍了 react 源码中有关优先级的部分, 并梳理了 3 种优先级之间的区别和联系. 它们贯穿了<!-- --><a href="/main/reconciler-workflow">reconciler 运作流程</a>中的 4 个阶段, 在 react 源码中所占用的代码量比较高, 理解它们的设计思路, 为接下来分析<!-- --><code>调度原理</code>和<!-- --><code>fiber构造</code>打下基础.<!-- --></p></div></div><script>$RC("B:2","S:2")</script>